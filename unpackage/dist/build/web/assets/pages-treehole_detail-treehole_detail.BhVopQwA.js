import{r as e,k as a,a3 as t,o as l,q as n,A as s,a as o,v as i,c as u,w as r,d,C as c,T as m,F as p,j as v,g as _,b as f,B as g,e as y,t as h,x as k,D as w,p as j,I,u as S,n as x,i as C,f as b,J as F}from"./index-I3aG4WZL.js";import{_ as T}from"./view-logs.C4HVuFxK.js";import{_ as $,r as z}from"./_plugin-vue_export-helper.DF4WgY5m.js";import{b as D,_ as R,a as L}from"./comment-input.CvkLMisZ.js";import{_ as A}from"./uni-icons.BQtdpjJ2.js";import{w as M,c as P,b as O}from"./config.BjeWXQ7P.js";import"./common-modal.-arcCNZ3.js";import"./switch-search.B16f2bGk.js";import"./goods-search.gE0Nx2pd.js";import"./search.CsIL0f2m.js";import"./cancel.CnEdunnH.js";import"./common-search.CQlKpRi4.js";import"./image.C3pSdXmG.js";const q=$({__name:"treehole_detail",props:{id:{type:String,required:!0}},setup($){e(!0),e(!1),e("");const q=e(0),J=e(null),B=e(null),E=e(null);e(1);let G=e({});e({});const H=e(!1),K=$,N=({parent:e,target:a})=>{var t;const l=a||e;G.value=l,null==(t=E.value)||t.focusInput()},U=e=>{var a,t,l;let o=v("token");if(!O.isLogin)return void s({title:"请先登录",icon:"none"});console.log("reply_info",G.value);const i={content:e.content,origin:e.origin,target_id:parseInt(q.value),type:5,image_url:e.image_url||"",association_id:e.association_id||0,association_type:e.association_type||0,is_anonymous:e.is_anonymous||0,...G.value.id&&{reply_id:G.value.id,reply_for:G.value.comment,reply_uid:G.value.user_id,parent_id:G.value.parent_id>0?G.value.parent_id:G.value.id}},u={id:Date.now(),content:e.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...e.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:O.userInfo.avatar,username:O.userInfo.nickname,is_anonymous:0},...e.association_id&&{association_id:e.association_id,association_type:e.association_type},...e.image_url&&{image_url:e.image_url},...G.value.id&&{reply_id:G.value.id,reply_for:G.value.comment,reply_uid:G.value.user_id,parent_id:G.value.parent_id>0?G.value.parent_id:G.value.id,reply_username:G.value.is_anonymous?"匿名用户":G.value.username}};G.value.id?0===G.value.parent_id?null==(t=B.value)||t.addReplyComment({...u,parent_id:G.value.id}):null==(l=B.value)||l.addReplyComment({...u,parent_id:G.value.parent_id}):null==(a=B.value)||a.addNewComment(u),n({url:M+"/with-state/add-comment",method:"POST",header:{Authorization:o},data:i,success:a=>{var t,l;if("success"==a.data.status){const l=a.data.data,n={...l,...e.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:O.userInfo.avatar,username:O.userInfo.nickname,is_anonymous:0}};l.reply_uid&&G.value.is_anonymous&&(n.reply_username="匿名用户"),null==(t=B.value)||t.updateTempComment(u.id,n),s({title:"评论成功",icon:"success"})}else null==(l=B.value)||l.removeTempComment(u.id),s({title:a.data.msg,icon:"none"})},fail:e=>{var a;null==(a=B.value)||a.removeTempComment(u.id),s({title:"网络请求失败",icon:"none"})}})};const Y=()=>{if(!O.isLogin)return void S({title:"提示",content:"需要登录后才能点赞",success:e=>{e.confirm&&x({url:"/pages/login/login"})}});const e=v("token"),a=M+(H.value?"/with-state/unlike":"/with-state/add-like");n({url:a,method:"POST",header:{Authorization:e},data:{id:parseInt(K.id),type:5},success:e=>{"success"===e.data.status&&(H.value=!H.value,J.value.like_count+=H.value?1:-1)}})};const Q=a((()=>{var e,a;return(null==(a=null==(e=J.value)?void 0:e.images)?void 0:a.slice(0,9))||[]})),V=a((()=>{var e,a;return((null==(a=null==(e=J.value)?void 0:e.images)?void 0:a.length)||0)-9})),W=a((()=>{var e,a;return((null==(a=null==(e=J.value)?void 0:e.images)?void 0:a.length)||0)>9}));t({title:"投稿详情"});const X=a((()=>{const e=Q.value.length;return 1===e?"single":2===e?"double":"multi"})),Z=e=>{const a=new Date(1e3*e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`};return l((async()=>{q.value=K.id,console.log("pageId",q.value);try{const e=await n({url:`${M}/treehole-detail?id=${K.id}`});"success"===e.data.status&&(J.value=e.data.data)}catch(e){console.log(e),s({title:"加载失败",icon:"none"})}P(),function(){let e=v("token");""!=e&&n({url:M+"/with-state/hasLike?id="+K.id+"&type=5",method:"POST",header:{Authorization:e},success:e=>{console.log(e.data),"success"==e.data.status?e.data.data.id>0?H.value=!0:H.value=!1:s({title:e.data.msg,icon:"none"})},fail:e=>{console.log(e),s({title:"网络请求失败",icon:"none"})}})}()})),(e,a)=>{const t=z(o("view-logs"),T),l=C,n=b,v=_,S=z(o("report-button"),D),x=z(o("uni-icons"),A),$=z(o("comment-list"),R),M=z(o("comment-input"),L);return f(),i(p,null,[J.value?(f(),u(v,{key:0,class:"container"},{default:r((()=>[g("meta",{name:"theme-color",content:"#F8F8F8"}),d(t),d(v,{class:"header"},{default:r((()=>[d(v,{class:"author-info"},{default:r((()=>[d(l,{src:J.value.avatar||"/static/noname.png",class:"avatar",mode:"aspectFill"},null,8,["src"]),d(v,{style:{width:"500rpx"}},{default:r((()=>[d(n,{class:"author-name"},{default:r((()=>[y(h(J.value.author_name),1)])),_:1}),d(v,{class:"time"},{default:r((()=>[y(h(Z(J.value.created_at)),1)])),_:1})])),_:1}),d(v,{style:{width:"120rpx"}},{default:r((()=>[d(S,{"report-type":"3","relation-id":parseInt(K.id),"button-text":"举报","icon-type":"flag","icon-size":"24","icon-color":"#666"},null,8,["relation-id"])])),_:1})])),_:1})])),_:1}),d(v,{class:"content"},{default:r((()=>[y(h(J.value.content),1)])),_:1}),d(v,{class:w(["image-container",X.value])},{default:r((()=>[(f(!0),i(p,null,k(Q.value,((e,a)=>(f(),u(v,{key:a,class:"image-wrapper"},{default:r((()=>[d(l,{src:e,mode:"aspectFill",class:"image-item",onClick:e=>(e=>{F({current:e,urls:J.value.images})})(a)},null,8,["src","onClick"]),W.value&&8===a?(f(),u(v,{key:0,class:"image-overlay"},{default:r((()=>[y(" +"+h(V.value),1)])),_:1})):j("",!0)])),_:2},1024)))),128))])),_:1},8,["class"]),d(v,{class:"action-bar"},{default:r((()=>[d(v,{class:"action-group"},{default:r((()=>[d(v,{class:"action-item",onClick:Y},{default:r((()=>[d(x,{type:H.value?"hand-up-filled":"hand-up",size:"24",color:H.value?"#ff4d4f":"#666"},null,8,["type","color"]),d(n,{class:"action-text"},{default:r((()=>[y(h(J.value.like_count||0),1)])),_:1})])),_:1}),d(v,{class:"action-item",onClick:a[0]||(a[0]=e=>function(e){let a="http://m.dogdogdoll.com/#/pages/treehole_detail/treehole_detail?id="+e.id;I({data:a,success:function(){s({title:"复制链接成功",icon:"none"})}})}(J.value))},{default:r((()=>[d(x,{type:"redo",size:"24",color:"#666"}),d(n,{class:"action-text"},{default:r((()=>[y("分享")])),_:1})])),_:1})])),_:1}),J.value.approve_time>0?(f(),u(n,{key:0,class:"time-text"},{default:r((()=>[y("审核于 "+h(Z(J.value.approve_time)),1)])),_:1})):j("",!0)])),_:1})])),_:1})):(f(),u(v,{key:1,class:"loading"},{default:r((()=>[y("加载中...")])),_:1})),d(v,{style:{padding:"10px"}},{default:r((()=>[d($,{ref_key:"commentListRef",ref:B,type:5,"relation-id":parseInt(K.id),onReply:N},null,8,["relation-id"])])),_:1}),d(M,{ref_key:"commentInputRef",ref:E,"reply-info":c(G),"target-id":q.value,onSubmit:U,"onUpdate:replyInfo":a[1]||(a[1]=e=>m(G)?G.value=e:G=e)},null,8,["reply-info","target-id"]),d(v,{style:{width:"100%",height:"120rpx"}})],64)}}},[["__scopeId","data-v-d3e1cd82"]]);export{q as default};
