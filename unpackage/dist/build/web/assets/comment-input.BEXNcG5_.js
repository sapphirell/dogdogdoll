import{g as e,M as t,j as l,m as a,o as s,c as o,w as u,D as n,z as i,a as c,d,F as r,r as _,x as m,b as p,t as f,H as v,k as h,l as k,f as y,e as g,as as C,X as b,n as w,i as I,h as j,av as A,aw as x,Y as T,aE as z,ao as $,K as S}from"./index-B55GPRQF.js";import{_ as F}from"./uni-icons.B2Wm8RW1.js";import{r as N}from"./uni-app.es.CzHle-z4.js";import{w as M,a as D,e as O}from"./config.BIUptOrH.js";import{_ as q}from"./_plugin-vue_export-helper.BCo6x5W8.js";const B=q({__name:"attitude-widget",props:{targetId:Number,type:Number,attitudeStatus:{type:Number,default:0},attitudeCounts:{type:Object,default:()=>({})}},emits:["change"],setup(C,{emit:b}){const w=C,I=b,j=e(!1),A=e(w.attitudeStatus),x=e({}),T=e([{emoji:"😝",value:1,label:"很有趣"},{emoji:"😨",value:2,label:"这个..."},{emoji:"🤤",value:3,label:"我也想要"},{emoji:"🤦‍♀️",value:4,label:"难以直视"},{emoji:"🤡",value:5,label:"谁的鼻子掉了?"}]);t((()=>w.attitudeCounts),(e=>{T.value.forEach((t=>{x.value[t.value]=Number(e[t.value]??0)})),x.value={...x.value}}),{immediate:!0,deep:!0});const z=l((()=>T.value.map((e=>({...e,count:x.value[e.value]||0}))).filter((e=>e.count>0||e.value===A.value)).filter((e=>e.count>0)))),$=()=>{j.value=!j.value};return(e,t)=>{const l=y,C=g,b=N(a("uni-icons"),F);return s(),o(l,{class:"attitude-container"},{default:u((()=>[j.value?(s(),o(l,{key:0,class:"mask",onClick:n($,["stop"]),onTouchmove:t[0]||(t[0]=n((()=>{}),["stop","prevent"]))})):i("",!0),c(l,{class:"counts-and-expand"},{default:u((()=>[c(l,{class:"global-counts"},{default:u((()=>[(s(!0),d(r,null,_(z.value,(e=>(s(),o(l,{key:e.value,class:m(["count-item",{active:A.value===e.value,"has-count":e.count>0}])},{default:u((()=>[c(C,{class:"emoji"},{default:u((()=>[p(f(e.emoji),1)])),_:2},1024),c(C,{class:"count"},{default:u((()=>[p(f(e.count),1)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1}),c(l,{class:"expand-btn",onClick:n($,["stop"])},{default:u((()=>[c(b,{type:j.value?"arrowup":"plus",size:"16",color:"#888"},null,8,["type"]),c(C,{class:"btn-text"},{default:u((()=>[p(f(j.value?"收起":"表态"),1)])),_:1})])),_:1})])),_:1}),j.value?(s(),o(l,{key:1,class:"attitude-panel"},{default:u((()=>[(s(!0),d(r,null,_(T.value,(e=>(s(),o(l,{key:e.value,class:m(["attitude-btn",{active:A.value===e.value}]),onClick:n((t=>(async e=>{try{const t=v("token");if(!t)return void h({title:"请先登录",icon:"none"});const l=A.value===e,a=`${M}/with-state/attitude/${l?"remove":"add"}`;"success"===(await k({url:a,method:"POST",data:{target_id:w.targetId,type:w.type,action_type:e},header:{Authorization:t}})).data.status&&(l?(x.value[e]--,A.value=0):(A.value>0&&x.value[A.value]--,A.value=e,x.value[e]=(x.value[e]||0)+1),I("change",{status:A.value,counts:{...x.value}}),j.value=!1)}catch(t){console.log(t),h({title:"操作失败",icon:"none"})}})(e.value)),["stop"])},{default:u((()=>[c(C,{class:"emoji"},{default:u((()=>[p(f(e.emoji),1)])),_:2},1024),c(l,{class:"text-container"},{default:u((()=>[c(C,{class:"label"},{default:u((()=>[p(f(e.label),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})):i("",!0)])),_:1})}}},[["__scopeId","data-v-a520d9e4"]]),E=q({__name:"comment-list",props:{type:{type:Number,required:!0},relationId:{type:Number,required:!0}},emits:["reply"],setup(t,{expose:l,emit:n}){const j=t,A=e([]),x=e(1),T=e(0),z=e(!0);C({});const $=n,S=e(!1),O=(e,{status:t,counts:l})=>{e.attitudeStatus=t,e.attitudeCounts=l};l({addNewComment:e=>{A.value.unshift({...e,showAll:!1,localChildren:[],childTotal:0})},addReplyComment:e=>{const t=A.value.find((t=>t.id===e.parent_id));t&&(t.localChildren||(t.localChildren=[]),"number"!=typeof t.childTotal&&(t.childTotal=0),t.localChildren.unshift(e),t.childTotal+=1,!t.showAll&&t.childTotal<=5&&(t.showAll=!0))}}),b((()=>{G()}));const q=e=>!e.showAll&&e.localChildren.length>5?e.localChildren.slice(0,5):e.localChildren,E=async()=>{if(!S.value&&z.value)try{S.value=!0,x.value+=1,await G()}finally{S.value=!1}},V=async e=>{if(D.isLogin)try{const t=v("token"),l=`${M}/with-state/${e.user_like?"unlike":"add-like"}`,a=await k({url:l,method:"POST",header:{Authorization:t},data:{id:e.id,type:6}});"success"===a.data.status?(e.user_like=!e.user_like,e.user_like?e.like_count=(e.like_count||0)+1:e.like_count=Math.max(0,(e.like_count||0)-1),h({title:e.user_like?"点赞成功":"已取消点赞",icon:"none"})):h({title:a.data.msg||"操作失败",icon:"none"})}catch(t){console.error("点赞失败:",t),h({title:"操作失败",icon:"none"})}else h({title:"请先登录",icon:"none"})},H=e=>{w({url:"/pages/user_page/user_page?uid="+e})},P=e=>{const t=new Date(1e3*e);return`${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}`},R=e=>e.length>12?e.slice(0,12)+"...":e,G=async()=>{try{S.value=!0;let e=v("token");const t=await k({url:`${M}/get-comments`,data:{relation_id:j.relationId,type:j.type,page:x.value,page_size:10},header:{Authorization:e}});if("success"===t.data.status){const e=t.data.data,l=e.comment_list.map((e=>({...e,showAll:!1,localChildren:e.children||[],childTotal:e.childTotal||(e.children?e.children.length:0),attitudeStatus:e.user_attitude||0,attitudeCounts:e.attitude_counts||{1:e.count_1||0,2:e.count_2||0,3:e.count_3||0,4:e.count_4||0,5:e.count_5||0}})));1===x.value?A.value=l:A.value.push(...l),console.log("total",e.total),z.value=e.total>A.value.length,T.value=e.total,console.log("是否还有更多?",z.value)}}catch(e){h({title:"加载失败",icon:"none"})}finally{S.value=!1}},K=(e,t=null)=>{$("reply",{parent:e,target:t,relationId:j.relationId})},L=e=>e.childTotal>5&&!e.showAll,U=e=>e.childTotal-Math.min(e.localChildren.length,5);return(e,t)=>{const l=y,n=g,v=I,C=N(a("attitude-widget"),B),b=N(a("uni-icons"),F);return s(),o(l,{class:"comment-container"},{default:u((()=>[A.value.length>0?(s(),o(l,{key:0,class:"comment-count"},{default:u((()=>[p(" 共"+f(T.value)+"条回复 ",1)])),_:1})):(s(),o(l,{key:1,class:"empty-tips"},{default:u((()=>[c(n,null,{default:u((()=>[p("-- 暂无回复 --")])),_:1})])),_:1})),(s(!0),d(r,null,_(A.value,(e=>(s(),o(l,{key:e.id,class:"comment-card"},{default:u((()=>[c(l,{class:"main-comment"},{default:u((()=>[c(v,{onClick:t=>H(e.uid),src:e.avatar,class:"avatar",mode:"aspectFill"},null,8,["onClick","src"]),c(l,{class:"content"},{default:u((()=>[c(l,{class:"header"},{default:u((()=>[c(n,{class:"username",onClick:t=>H(e.uid)},{default:u((()=>[p(f(R(e.username)),1)])),_:2},1032,["onClick"]),c(n,{class:"floor"},{default:u((()=>[p("#"+f(e.floor),1)])),_:2},1024)])),_:2},1024),c(n,{class:"comment-text",onClick:t=>K(e)},{default:u((()=>[p(f(e.comment),1)])),_:2},1032,["onClick"]),c(C,{"target-id":e.id,type:6,"attitude-status":e.attitudeStatus,"attitude-counts":e.attitudeCounts,onChange:t=>O(e,t)},null,8,["target-id","attitude-status","attitude-counts","onChange"]),c(l,{class:"footer"},{default:u((()=>[c(l,{class:"left-actions"},{default:u((()=>[c(n,{class:"time"},{default:u((()=>[p(f(P(e.created_at)),1)])),_:2},1024),c(l,{class:"like-container"},{default:u((()=>[c(l,{class:"like-btn",onClick:t=>V(e)},{default:u((()=>[c(b,{type:e.user_like?"hand-up-filled":"hand-up",size:"18",color:e.user_like?"rgb(100 198 220)":"#999"},null,8,["type","color"]),c(n,{class:m(["like-count",{liked:e.user_like}])},{default:u((()=>[p(f(e.like_count||0),1)])),_:2},1032,["class"])])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),c(l,{class:"right-actions"},{default:u((()=>[c(n,{class:"reply-btn",onClick:t=>K(e)},{default:u((()=>[p("回复")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024),e.localChildren&&e.localChildren.length?(s(),o(l,{key:0,class:"sub-comments"},{default:u((()=>[(s(!0),d(r,null,_(q(e),((t,a)=>(s(),o(l,{key:t.id,class:"sub-comment"},{default:u((()=>[c(v,{onClick:e=>H(t.uid),src:t.avatar,class:"avatar",mode:"aspectFill"},null,8,["onClick","src"]),c(l,{class:"content"},{default:u((()=>[c(l,{class:"header"},{default:u((()=>[c(n,{onClick:e=>H(t.uid),class:"username"},{default:u((()=>[p(f(R(t.username)),1)])),_:2},1032,["onClick"]),t.reply_for?(s(),o(n,{key:0,class:"reply-to"},{default:u((()=>[p("@"+f(t.reply_for),1)])),_:2},1024)):i("",!0)])),_:2},1024),c(n,{class:"comment-text",onClick:t=>K(e)},{default:u((()=>[p(f(t.comment),1)])),_:2},1032,["onClick"]),c(C,{"target-id":t.id,type:6,"attitude-status":e.attitudeStatus,"attitude-counts":e.attitudeCounts,onChange:t=>O(e,t)},null,8,["target-id","attitude-status","attitude-counts","onChange"]),c(l,{class:"footer"},{default:u((()=>[c(l,{class:"left-actions"},{default:u((()=>[c(n,{class:"time"},{default:u((()=>[p(f(P(t.created_at)),1)])),_:2},1024),c(l,{class:"like-container"},{default:u((()=>[c(l,{class:"like-btn",onClick:e=>V(t)},{default:u((()=>[c(b,{type:t.user_like?"hand-up-filled":"hand-up",size:"18",color:t.user_like?"rgb(100 198 220)":"#999"},null,8,["type","color"]),c(n,{class:m(["like-count",{liked:t.user_like}])},{default:u((()=>[p(f(t.like_count||0),1)])),_:2},1032,["class"])])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),c(l,{class:"right-actions"},{default:u((()=>[c(n,{class:"reply-btn",onClick:l=>K(e,t)},{default:u((()=>[p("回复")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),L(e)?(s(),o(l,{key:0,class:"load-more",onClick:t=>(async e=>{if(e.localChildren.length<e.childTotal){const l=Math.ceil(e.localChildren.length/5)+1;try{const t=await k({url:`${M}/get-comments-by-parent-id`,data:{parent_id:e.id,page:l}});"success"===t.data.status&&(e.localChildren=[...e.localChildren,...t.data.data.comment_list],e.childTotal=t.data.data.total,e.localChildren.length>=5&&!e.showAll&&(e.showAll=!0))}catch(t){h({title:"加载失败",icon:"none"})}}else e.showAll=!e.showAll})(e)},{default:u((()=>[c(n,null,{default:u((()=>[p("展开"+f(U(e))+"条回复",1)])),_:2},1024),c(b,{type:"arrow-down",size:"18",color:"#007AFF"})])),_:2},1032,["onClick"])):i("",!0)])),_:2},1024)):i("",!0)])),_:2},1024)))),128)),A.value.length>0?(s(),o(l,{key:2,class:"load-more-box"},{default:u((()=>[z.value?(s(),o(l,{key:0,class:m(["load-more-btn",{loading:S.value}]),onClick:E},{default:u((()=>[S.value?(s(),o(l,{key:1},{default:u((()=>[c(b,{type:"spinner-cycle",size:"16",color:"#888"})])),_:1})):(s(),o(l,{key:0},{default:u((()=>[c(n,null,{default:u((()=>[p(" 加载更多 ")])),_:1}),c(b,{type:"arrow-down",size:"18",color:"#007AFF"})])),_:1}))])),_:1},8,["class"])):(s(),o(l,{key:1,class:"no-more"},{default:u((()=>[c(n,null,{default:u((()=>[p("-- 没有更多了 --")])),_:1})])),_:1}))])),_:1})):i("",!0)])),_:1})}}},[["__scopeId","data-v-c7e1a53f"]]),V=q({__name:"comment-input",props:{replyInfo:{type:Object,default:()=>({})},targetId:{type:String,required:!0},safeBottom:{type:Number,default:10}},emits:["submit","update:replyInfo"],setup(t,{expose:a,emit:o}){const n=t,i=e(null),_=e(!1),f=o,v=e(""),k=e(!1),g=e(0),C=j(),w=l((()=>{var e,t;let l=(null==(e=C.safeAreaInsets)?void 0:e.bottom)||10;console.log("底部安全距离1:",null==(t=C.safeAreaInsets)?void 0:t.bottom,"=>",l);let a=l+g.value;return console.log("底部最终距离2:",a),`${a}px`})),I=()=>{k.value=!0,_.value=!0},F=()=>{k.value=!1,_.value=!1},N=()=>{k.value=!1,_.value=!1,z()},M=()=>{if(!v.value.trim())return void h({title:"请输入评论内容",icon:"none"});let e=O();console.log("scene",e),f("submit",{content:v.value,target_id:n.targetId,type:4,replyInfo:n.replyInfo,origin:e}),v.value="",f("update:replyInfo",{})};return a({focusInput:()=>{_.value=!0}}),b((()=>{console.log("不注册键盘弹出事件")})),(e,l)=>{const a=y,o=$,n=S;return s(),d(r,null,[A(c(a,{class:"mask",onClick:N},null,512),[[x,k.value]]),c(a,{class:"bottom_tab","adjust-position":!1,style:T({paddingBottom:w.value})},{default:u((()=>[c(o,{"disable-default-padding":!0,focus:_.value,class:m(["comment_input unified-textarea",{expanded:_.value}]),ref_key:"inputRef",ref:i,modelValue:v.value,"onUpdate:modelValue":l[0]||(l[0]=e=>v.value=e),onFocus:I,onBlur:F,"adjust-position":!1,placeholder:t.replyInfo.username?"回复@"+t.replyInfo.username+" ":"写评论..."},null,8,["focus","class","modelValue","placeholder"]),c(n,{onClick:M},{default:u((()=>[p("写评论")])),_:1})])),_:1},8,["style"])],64)}}},[["__scopeId","data-v-0af4224c"]]);export{E as _,V as a};
