import{r as e,k as t,a2 as a,o as l,q as s,A as n,a as o,v as i,c as u,w as r,d as c,C as d,T as p,F as m,j as g,g as v,b as f,B as _,e as h,t as y,x as k,D as w,I as S,u as x,n as I,i as b,f as C,p as j,J as F}from"./index-BFzTDSoz.js";import{w as $,c as z,b as A,_ as D}from"./view-logs.yEAac7W9.js";import{_ as L,r as R}from"./_plugin-vue_export-helper.CXFOpRdI.js";import{b as T,_ as O,a as P}from"./comment-input.B__ry1x5.js";import{_ as q}from"./uni-icons.COaeasi-.js";import"./common-modal.DWKlFhUY.js";const B=L({__name:"treehole_detail",props:{id:{type:String,required:!0}},setup(L){e(!0),e(!1),e("");const B=e(0),M=e(null),H=e(null),J=e(null);e(1);let K=e({});const N=e(!1),U=L,Y=({parent:e,target:t})=>{var a;console.log("parent",e),console.log("target",t);let l=e;null!=t&&(l=t),K.value.id!=l.id?(console.log("item",l),K.value=l,null==(a=J.value)||a.focusInput()):K.value={}},E=({content:e,replyInfo:t,origin:a})=>{let l=g("token");if(!A.isLogin)return void n({title:"请先登录",icon:"none"});console.log("reply_info",t);const o={content:e,origin:a,target_id:parseInt(B.value),type:5,...t.id&&{reply_id:t.id,reply_for:t.comment,reply_user_id:t.user_id,parent_id:t.parent_id>0?t.parent_id:t.id}};s({url:$+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:o,success:e=>{var t,a;if("success"==e.data.status){const l=e.data.data;0===l.parent_id?(console.log("添加主评论"),null==(t=H.value)||t.addNewComment(l)):(console.log("添加子评论"),null==(a=H.value)||a.addReplyComment(l)),n({title:"评论成功",icon:"success"})}else n({title:e.data.msg,icon:"none"})},fail:e=>{n({title:"网络请求失败",icon:"none"})}})};const G=()=>{if(!A.isLogin)return void x({title:"提示",content:"需要登录后才能点赞",success:e=>{e.confirm&&I({url:"/pages/login/login"})}});const e=g("token"),t=$+(N.value?"/with-state/unlike":"/with-state/add-like");s({url:t,method:"POST",header:{Authorization:e},data:{id:parseInt(U.id),type:5},success:e=>{"success"===e.data.status&&(N.value=!N.value,M.value.like_count+=N.value?1:-1)}})};const Q=t((()=>{var e,t;return(null==(t=null==(e=M.value)?void 0:e.images)?void 0:t.slice(0,9))||[]})),V=t((()=>{var e,t;return((null==(t=null==(e=M.value)?void 0:e.images)?void 0:t.length)||0)-9})),W=t((()=>{var e,t;return((null==(t=null==(e=M.value)?void 0:e.images)?void 0:t.length)||0)>9}));a({title:"投稿详情"});const X=t((()=>{const e=Q.value.length;return 1===e?"single":2===e?"double":"multi"})),Z=e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return l((async()=>{B.value=U.id,console.log("pageId",B.value);try{const e=await s({url:`${$}/treehole-detail?id=${U.id}`});"success"===e.data.status&&(M.value=e.data.data)}catch(e){console.log(e),n({title:"加载失败",icon:"none"})}z(),function(){let e=g("token");""!=e&&s({url:$+"/with-state/hasLike?id="+U.id+"&type=5",method:"POST",header:{Authorization:e},success:e=>{console.log(e.data),"success"==e.data.status?e.data.data.id>0?N.value=!0:N.value=!1:n({title:e.data.msg,icon:"none"})},fail:e=>{console.log(e),n({title:"网络请求失败",icon:"none"})}})}()})),(e,t)=>{const a=R(o("view-logs"),D),l=b,s=C,g=v,x=R(o("report-button"),T),I=R(o("uni-icons"),q),$=R(o("comment-list"),O),z=R(o("comment-input"),P);return f(),i(m,null,[M.value?(f(),u(g,{key:0,class:"container"},{default:r((()=>[_("meta",{name:"theme-color",content:"#F8F8F8"}),c(a),c(g,{class:"header"},{default:r((()=>[c(g,{class:"author-info"},{default:r((()=>[c(l,{src:M.value.avatar||"/static/noname.png",class:"avatar",mode:"aspectFill"},null,8,["src"]),c(g,{style:{width:"500rpx"}},{default:r((()=>[c(s,{class:"author-name"},{default:r((()=>[h(y(M.value.author_name),1)])),_:1}),c(g,{class:"time"},{default:r((()=>[h(y(Z(M.value.created_at)),1)])),_:1})])),_:1}),c(g,{style:{width:"120rpx"}},{default:r((()=>[c(x,{"report-type":"3","relation-id":parseInt(U.id),"button-text":"举报","icon-type":"flag","icon-size":"24","icon-color":"#666"},null,8,["relation-id"])])),_:1})])),_:1})])),_:1}),c(g,{class:"content"},{default:r((()=>[h(y(M.value.content),1)])),_:1}),c(g,{class:w(["image-container",X.value])},{default:r((()=>[(f(!0),i(m,null,k(Q.value,((e,t)=>(f(),u(g,{key:t,class:"image-wrapper"},{default:r((()=>[c(l,{src:e,mode:"aspectFill",class:"image-item",onClick:e=>(e=>{F({current:e,urls:M.value.images})})(t)},null,8,["src","onClick"]),W.value&&8===t?(f(),u(g,{key:0,class:"image-overlay"},{default:r((()=>[h(" +"+y(V.value),1)])),_:1})):j("",!0)])),_:2},1024)))),128))])),_:1},8,["class"]),c(g,{class:"action-bar"},{default:r((()=>[c(g,{class:"action-group"},{default:r((()=>[c(g,{class:"action-item",onClick:G},{default:r((()=>[c(I,{type:N.value?"hand-up-filled":"hand-up",size:"24",color:N.value?"#ff4d4f":"#666"},null,8,["type","color"]),c(s,{class:"action-text"},{default:r((()=>[h(y(M.value.like_count||0),1)])),_:1})])),_:1}),c(g,{class:"action-item",onClick:t[0]||(t[0]=e=>function(e){let t="http://m.dogdogdoll.com/#/pages/treehole_detail/treehole_detail?id="+e.id;S({data:t,success:function(){n({title:"复制链接成功",icon:"none"})}})}(M.value))},{default:r((()=>[c(I,{type:"redo",size:"24",color:"#666"}),c(s,{class:"action-text"},{default:r((()=>[h("分享")])),_:1})])),_:1})])),_:1}),c(s,{class:"time-text"},{default:r((()=>[h("审核于 "+y(Z(M.value.approve_time)),1)])),_:1})])),_:1})])),_:1})):(f(),u(g,{key:1,class:"loading"},{default:r((()=>[h("加载中...")])),_:1})),c(g,{style:{padding:"10px"}},{default:r((()=>[c($,{ref_key:"commentListRef",ref:H,type:5,"relation-id":parseInt(U.id),onReply:Y},null,8,["relation-id"])])),_:1}),c(z,{ref_key:"commentInputRef",ref:J,"reply-info":d(K),"target-id":B.value,onSubmit:E,"onUpdate:replyInfo":t[1]||(t[1]=e=>p(K)?K.value=e:K=e)},null,8,["reply-info","target-id"]),c(g,{style:{width:"100%",height:"120rpx"}})],64)}}},[["__scopeId","data-v-d258f9f2"]]);export{B as default};
