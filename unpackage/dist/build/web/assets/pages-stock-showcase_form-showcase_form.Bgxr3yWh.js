import{g as a,j as e,_ as o,X as s,m as l,c as t,w as i,l as n,H as d,k as c,f as r,o as u,p,a as m,b as _,z as g,d as h,r as f,F as v,A as y,a7 as w,e as k,i as b,S as x,L as j,ao as C,K as z,t as F,G as L}from"./index-B55GPRQF.js";import{_ as T}from"./relation-picker.C_3PEIrw.js";import{r as V}from"./uni-app.es.CzHle-z4.js";import{_ as $}from"./cancel.CnEdunnH.js";import{_ as A}from"./add2.S6xx6DwX.js";import{_ as I}from"./right2.s_X9TKoF.js";import{w as G,i as D,e as E}from"./config.BIUptOrH.js";import{a as P,g as S,u as U}from"./image.BvaLdYzg.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uni-icons.B2Wm8RW1.js";import"./common-search.OBIzXxZ7.js";import"./search.CsIL0f2m.js";import"./goods-search.DumlFeXD.js";import"./common-modal.MV9iS1Pr.js";import"./uni-transition.CvFnBj2q.js";const H=B({__name:"showcase_form",props:["showcase_id"],setup(B){const H=B,O=a([]),J=a([]),K=a([]),M=a(!1);a(""),a(0),a(""),a(0),a("");const Q=a=>{try{const e={goods_id:a.goods.id||0,goods_name:a.goods.name,goods_image:a.goods.image||"",brand_id:a.brand.id||0,brand_name:a.brand.name||(a.isFuzzy?"":"未知品牌"),type:a.type||(a.isFuzzy?"未知类型":"")};aa.value.some((a=>0!==a.goods_id&&a.goods_id===e.goods_id||a.goods_name===e.goods_name))?c({title:"已存在相同关联项",icon:"none"}):aa.value.push(e)}catch(e){console.error("保存关联数据失败:",e),c({title:"保存关联信息失败",icon:"none"})}},R=()=>{console.log("用户取消选择")},X=()=>{M.value=!0},q=e((()=>[-1,1,3].includes(Z.value))),N=e((()=>H.showcase_id>0)),W=a(""),Y=a(""),Z=a(-1),aa=a([]);function ea(a){L({current:O.value[a],urls:O.value})}async function oa(){y({title:"确认删除",content:"确定要删除这个展示吗？",success:async a=>{if(a.confirm)try{"success"===(await n({url:`${G}/with-state/delete-showcase?id=`+H.showcase_id,method:"POST",header:{Authorization:d("token")}})).data.status&&(c({title:"删除成功"}),setTimeout((()=>w()),1e3))}catch(e){c({title:"删除失败",icon:"none"})}}})}async function sa(){if(!d("token"))return void c({title:"请先登录",icon:"none"});if(!W.value.trim()||!Y.value.trim())return void c({title:"标题和正文不能为空",icon:"none"});if(0===O.value.length)return void c({title:"请至少上传一张图片",icon:"none"});let a=E(),e={name:W.value,description:Y.value,image_urls:O.value.join(","),display:Z.value,origin:a,relations:aa.value.map((a=>({relation_goods_id:a.goods_id,relation_goods_name:a.goods_name,relation_brand_id:a.brand_id,relation_brand_name:a.brand_name,type:a.type,relation_origin:2})))};try{let a=`${G}/with-state/add-showcase`;H.showcase_id&&(a=`${G}/with-state/update-showcase`,e={...e,id:parseInt(H.showcase_id,10)});if("failed"===(await n({url:a,method:"POST",data:e,header:{"Content-Type":"application/json",Authorization:d("token")}})).data.code)return void c({title:"提交失败",icon:"none"});c({title:"提交成功"}),setTimeout((()=>w()),1500)}catch(o){console.log(o),c({title:"提交失败",icon:"none"})}}return o({title:"展示柜"}),s((()=>{n({url:G+"/goods-types",method:"GET",timeout:5e3,success:a=>{console.log(a.data.data),K.value=a.data.data},fail:a=>{console.log(a),c({title:"网络请求失败",icon:"none"})}}),async function(){var a;if(H.showcase_id)try{const e=(await n({url:`${G}/with-state/showcase-detail?id=${H.showcase_id}`,method:"GET",header:{Authorization:d("token")}})).data.data;W.value=e.name,Y.value=e.description,Z.value=e.display,O.value=(null==(a=e.image_urls)?void 0:a.split(","))||[],console.log(e),e.relations&&(aa.value=e.relations.map((a=>({goods_id:a.relation_goods_id,goods_name:a.relation_goods_name,brand_id:a.relation_brand_id,brand_name:a.relation_brand_name,type:a.type,goods_image:a.relation_goods_image}))))}catch(e){c({title:"加载失败",icon:"none"})}}()})),(a,e)=>{const o=k,s=r,n=b,d=x,y=j,w=C,L=V(l("relation-picker"),T),G=z;return u(),t(s,null,{default:i((()=>[p("meta",{name:"theme-color",content:"#F8F8F8"}),q.value?g("",!0):(u(),t(s,{key:0,class:"edit-tip"},{default:i((()=>[m(o,null,{default:i((()=>[_("当前状态不可编辑")])),_:1})])),_:1})),m(s,{style:{width:"100%",overflow:"hidden"}},{default:i((()=>[m(d,{"scroll-x":"true",class:"upload_box","ll-with-animation":"true","show-scrollbar":!1},{default:i((()=>[(u(!0),h(v,null,f(O.value,((a,e)=>(u(),t(s,{class:"upload_item",key:e},{default:i((()=>[m(n,{src:a,class:"uploaded_image",onClick:ea,mode:"aspectFill"},null,8,["src"]),q.value?(u(),t(n,{key:0,src:$,class:"close_icon",onClick:a=>function(a){O.value.splice(a,1)}(e)},null,8,["onClick"])):g("",!0)])),_:2},1024)))),128)),q.value?(u(),t(s,{key:0,class:"uploadImageBox",style:{background:"#f8f8f8"}},{default:i((()=>[m(n,{src:A,class:"upload_img",onClick:e[0]||(e[0]=e=>async function(){try{const a=await P(9);for(const e of a){const a=await S();await U(e,a.token,a.path),O.value.push(D+a.path)}c({title:`成功上传${a.length}张图片`,icon:"success"})}catch(a){console.error("上传出错:",a),c({title:"部分图片上传失败",icon:"none"})}}(a.index)),style:{width:"50px",height:"50px",margin:"25px"}})])),_:1})):g("",!0)])),_:1})])),_:1}),m(y,{modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=a=>W.value=a),type:"text",disabled:!q.value,placeholder:"请输入标题",style:{padding:"10px",margin:"20px 15px 5px 15px",display:"block"}},null,8,["modelValue","disabled"]),m(s,{class:"oneLine"}),m(w,{modelValue:Y.value,"onUpdate:modelValue":e[2]||(e[2]=a=>Y.value=a),disabled:!q.value,placeholder:"请输入描述",style:{padding:"10px",margin:"10px 15px 5px 15px",display:"block","line-height":"28px",width:"calc(100% - 50px)"}},null,8,["modelValue","disabled"]),m(s,{class:"oneLine"}),m(s,{class:""},{default:i((()=>[q.value?(u(),t(s,{key:0,class:"relation-trigger",onClick:X},{default:i((()=>[m(o,{class:"placeholder"},{default:i((()=>[_("点击关联娃物")])),_:1}),m(n,{src:I,class:"arrow-icon"})])),_:1})):g("",!0)])),_:1}),m(s,{class:"publish-detail"},{default:i((()=>[m(o,null,{default:i((()=>[_("* 展示您的宝宝们 🩵。")])),_:1}),m(o,null,{default:i((()=>[_("* 不关联商品的展示柜不会出现在广场中。")])),_:1})])),_:1}),m(s,{class:"saveCollocationDataList"},{default:i((()=>[(u(!0),h(v,null,f(aa.value,((a,e)=>(u(),t(s,{key:e},{default:i((()=>[m(s,{class:"saveCollocationDataItem"},{default:i((()=>[a.goods_image?(u(),t(n,{key:0,src:a.goods_image,mode:"aspectFill",style:{width:"70px",height:"70px"}},null,8,["src"])):(u(),t(o,{key:1,class:"no-image"},{default:i((()=>[_("?")])),_:1})),m(o,{class:"info-tap",style:{width:"calc(100% - 120px)",display:"inline-block"}},{default:i((()=>[_(F(a.type)+" "+F(a.brand_name)+" - "+F(a.goods_name),1)])),_:2},1024),q.value?(u(),t(n,{key:2,src:$,class:"close_icon",onClick:a=>function(a){aa.value.splice(a,1)}(e)},null,8,["onClick"])):g("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),m(L,{visible:M.value,"onUpdate:visible":e[3]||(e[3]=a=>M.value=a),typeList:K.value,goodsList:J.value,onConfirm:Q,onCancel:R},null,8,["visible","typeList","goodsList"]),m(s,{class:"footer"},{default:i((()=>[N.value?(u(),t(G,{key:0,onClick:oa,class:"delete-btn"},{default:i((()=>[_("删除")])),_:1})):g("",!0),m(G,{onClick:sa},{default:i((()=>[_("发表")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-30e0e69a"]]);export{H as default};
