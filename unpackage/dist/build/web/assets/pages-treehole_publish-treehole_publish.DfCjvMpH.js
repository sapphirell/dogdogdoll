import{r as a,a2 as e,m as l,o as s,a as t,c as o,w as n,v as u,b as c,B as i,d as r,C as d,e as m,t as p,k as v,l as f,F as h,A as _,_ as g,j as b,$ as k,ab as y,f as x,g as j,K as C,i as w,S as F,ar as T,W as A,X as B,Y as I,h as S,J as V}from"./index-6ojkiy1R.js";import{_ as z}from"./uni-icons.C75VRGWb.js";import{r as E}from"./uni-app.es.BMFd5FAr.js";import{_ as J}from"./common-page.fI1NTZim.js";import{_ as K}from"./cancel.CnEdunnH.js";import{_ as O}from"./add2.S6xx6DwX.js";import{w as P,i as D}from"./config.Bhvn_Gfs.js";import{a as G,g as N,u as R}from"./image.Davh951g.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";const W=U({__name:"treehole_publish",setup(U){const W=a(""),X=a(0),Y=a([]),$=a([]),q=a(""),H=a(-1),L=a("");function M(a){V({current:Y.value[a],urls:Y.value})}function Q(a){X.value=a.detail.value.length>0?1:0}e({title:"投稿树洞"});function Z(a){const e=a.detail.value;e>=0&&$.value[e]&&(H.value=e,q.value=$.value[e].value,L.value=$.value[e].label)}const aa=l((()=>W.value.trim().length>0&&null!==q.value));async function ea(){if(aa.value)if(q.value)try{g({title:"提交中..."});const a=b("token");if(!a)return void _({title:"请先登录",icon:"none"});const e={content:W.value.trim(),images:Y.value,is_anonymous:X.value,category_id:q.value},l=await u({url:P+"/with-state/add-submission",method:"POST",data:e,header:{"Content-Type":"application/json",Authorization:a}});k(),"success"==l.data.status?(_({title:"已收到您的投稿",icon:"success"}),setTimeout((()=>{W.value="",Y.value=[],X.value=0,y()}),1500)):_({title:l.data.msg||"提交失败",icon:"none"})}catch(a){k(),console.error("提交失败:",a),_({title:"网络请求失败",icon:"none"})}else _({title:"请选择分类",icon:"none"})}return s((()=>{(async()=>{try{const a=await u({url:P+"/treehole-typelist",method:"GET"});"success"===a.data.status&&($.value=Object.entries(a.data.data).map((([a,e])=>({value:Number(a),label:e}))))}catch(a){console.error("获取分类失败:",a)}})()})),(a,e)=>{const l=x,s=E(t("uni-icons"),z),u=j,g=C,b=w,k=F,y=T,V=A,P=B,U=I,la=S,sa=E(t("common-page"),J);return c(),o(sa,{title:"发布树洞"},{default:n((()=>[i("meta",{name:"theme-color",content:"#F8F8F8"}),r(u,{class:"publish-box"},{default:n((()=>[r(g,{class:"category-picker",range:$.value,"range-key":"label",onChange:Z,value:H.value},{default:n((()=>[r(u,{class:"picker-content"},{default:n((()=>[r(l,{class:d(["picker-text",q.value?"":"placeholder"])},{default:n((()=>[m(p(L.value||"请选择分类（必选）"),1)])),_:1},8,["class"]),r(s,{type:"right",size:"22",color:"#888"})])),_:1})])),_:1},8,["range","value"]),r(k,{"scroll-x":"true",class:"upload_box","ll-with-animation":"true","show-scrollbar":!1},{default:n((()=>[(c(!0),v(h,null,f(Y.value,((e,l)=>(c(),o(u,{class:"upload_item",key:l},{default:n((()=>[r(b,{src:e,class:"uploaded_image",onClick:M,mode:"aspectFill"},null,8,["src"]),r(b,{src:K,class:"close_icon",onClick:e=>a.deleteImage(l)},null,8,["onClick"])])),_:2},1024)))),128)),r(u,{class:"uploadImageBox",style:{background:"#f8f8f8"}},{default:n((()=>[r(b,{src:O,class:"upload_img",onClick:e[0]||(e[0]=e=>(a.index,console.log("openSelect"),void G().then((a=>{N().then((e=>{console.log(e),R(a,e.token,e.path).then((a=>{200!=a.statusCode&&_({title:"上传失败",icon:"none"}),console.log(D+e.path),Y.value.push(D+e.path),_({title:"上传成功",icon:"success"})}))}))})))),style:{width:"50px",height:"50px",margin:"25px"}})])),_:1})])),_:1}),r(y,{modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=a=>W.value=a),placeholder:"写下你想说的话...",class:"textarea",maxlength:"500"},null,8,["modelValue"]),r(u,{class:"anonymous"},{default:n((()=>[r(U,{onChange:Q},{default:n((()=>[r(P,null,{default:n((()=>[r(V,{checked:1===X.value,color:"#4cbbd0"},null,8,["checked"]),r(l,null,{default:n((()=>[m("匿名发布")])),_:1})])),_:1})])),_:1})])),_:1}),r(u,{class:"publish-detail"},{default:n((()=>[r(l,null,{default:n((()=>[m("* 目前树洞为非审稿发布，只接受娃圈相关内容。")])),_:1}),r(l,null,{default:n((()=>[m("* 如果勾选匿名发布，他人将无法通过稿件进入您的主页。如果稿件遭到过多点踩或投诉，我们可能会隐藏这封稿件。")])),_:1})])),_:1}),r(la,{class:d(["submit-btn",{disabled:!aa.value}]),onClick:ea},{default:n((()=>[m(" 提交 ")])),_:1},8,["class"])])),_:1})])),_:1})}}},[["__scopeId","data-v-8ced3b2c"]]);export{W as default};
