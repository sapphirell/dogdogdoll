import{g as a,as as l,X as e,h as s,s as o,k as t,l as c,ap as n,m as i,d as u,p as r,a as d,w as f,F as _,at as v,Z as g,o as m,x as p,b as y,c as h,r as k,z as w,Y as C,D as b,n as x,f as j,S as z,e as $,K as S,t as P,i as T}from"./index-B55GPRQF.js";import{_ as E}from"./uni-icons.B2Wm8RW1.js";import{o as F,r as O}from"./uni-app.es.CzHle-z4.js";import{_ as A}from"./uni-transition.CvFnBj2q.js";import{_ as G}from"./goods-search.DumlFeXD.js";import{_ as q}from"./common-modal.MV9iS1Pr.js";import{_ as D}from"./common-page.Bgp-g0xT.js";import{w as I}from"./config.BIUptOrH.js";import{_ as J}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./search.CsIL0f2m.js";import"./cancel.CnEdunnH.js";const K=J({__name:"collocation_square",setup(J){const K=a("find"),Q=a([]),B=a(!1),H=a(!1),M=a(1),N=a(0),R=a(0),U=l([0,0]),W=a(!1),X=a(""),Y=a([]),Z=v(),L=a(null),V=a([]);a(null);const aa=a([]),la=a(!1),ea=a(!1),sa=a(-1),oa=a("全部"),ta=a("全部"),ca=a([]),na=a([]),ia=a(!1),ua=()=>{ia.value=!ia.value},ra=()=>{ia.value=!1},da=()=>{ra(),x({url:"/pages/collocation/collocation"})},fa=()=>{ra(),x({url:"/pages/stock/showcase_form/showcase_form"})},_a=a=>{const l=Q.value[a];return l.position?{left:`${l.position.left}px`,top:`${l.position.top}px`,width:`${R.value}px`}:{}},va=a=>{if(console.log("进入计算布局逻辑"),!a)return void console.log("无法获取instance");if(console.log("获取成功"),!Q.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(a);const l=g().in(a.proxy);console.log("获取到query");const e=Q.value.map(((a,e)=>new Promise((a=>{l.select(`#card-${e}`).boundingClientRect((l=>{a({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),U[0]=0,U[1]=0;const a=await Promise.all(e);a.length?(a.forEach((({index:a,rect:l})=>{if(!l)return void console.error(`卡片${a}元素查询失败`);const e=Q.value[a],s=U[0]<=U[1]?0:1,o=s*(R.value+10),t=U[s]+10;U[s]=t+l.height,e.position={left:o,top:t}})),N.value=Math.max(...U)+20):console.warn("未查询到任何卡片元素")}))},ga=a=>{K.value=a,"find"===a&&(0===ca.value.length&&(ma(),pa()),0===aa.value.length&&ya(!0)),"view"==a&&ka()},ma=async()=>{try{const a=await c({url:`${I}/goods-types`,method:"GET"});"success"===a.data.status&&(ca.value=["全部",...a.data.data])}catch(a){console.error("获取商品分类失败:",a)}},pa=async()=>{try{const a=await c({url:`${I}/sizes`,method:"GET"});if("success"===a.data.status){const l=Object.keys(a.data.data);na.value=["全部",...l]}}catch(a){console.error("获取尺寸分类失败:",a)}},ya=async(a=!1)=>{if(a&&(aa.value=[],sa.value=-1,ea.value=!1),!la.value&&!ea.value)try{la.value=!0;const l={cursor:sa.value,page_size:10,type:"全部"===oa.value?"":oa.value,size:"全部"===ta.value?"":ta.value},e=await c({url:`${I}/random-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if("success"===e.data.status){const l=e.data.data,s=l.goods_list||[];aa.value=a?s:[...aa.value,...s],sa.value=l.next_cursor,ea.value=s.length<10}}catch(l){console.error("获取随机商品失败:",l),t({title:"加载失败",icon:"none"})}finally{la.value=!1}},ha=()=>{ya()};e((()=>{const a=s();R.value=(a.windowWidth-30)/2,ma(),pa(),ya(!0)})),F((async()=>{try{await ka(!0),o()}catch(a){o(),t({title:"刷新失败",icon:"none"})}}));const ka=async(a=!1)=>{if(a&&(Q.value=[],M.value=1,H.value=!1,B.value=!1),B.value||H.value)console.log("正在加载或没有更多数据，停止请求");else try{B.value=!0;const l={page:M.value,page_size:10,filter_goods_id_list:V.value.map((a=>a.goods_id))};console.log("请求参数:",JSON.stringify(l,null,2));const e=await c({url:`${I}/collocation-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if(console.log("接口响应:",e),"success"===e.data.status){const l=e.data.data||{},s=Array.isArray(l.collocation_relation_list)?l.collocation_relation_list:[];Q.value=a?s:[...Q.value,...s],H.value=s.length<10,M.value++,a&&0===s.length&&t({title:"暂无相关搭配",icon:"none"}),console.log("等待next tick"),await n(),console.log("等待完成"),va(Z),setTimeout((()=>{console.log("二次计算布局"),va(Z)}),500)}}catch(l){console.error("请求失败:",l),t({title:"加载失败",icon:"none"})}finally{B.value=!1}},wa=()=>{W.value=!0},Ca=a=>{if(console.log("选择商品:",a),!(null==a?void 0:a.id))return;const l={goods_id:a.id,goods_name:`${a.brand_name?a.brand_name+"·":""}${a.name}`};V.value.some((a=>a.goods_id===l.goods_id))||(V.value=[...V.value,l])},ba=async()=>{W.value=!1,await ka(!0)},xa=()=>{W.value=!1},ja=(a,l)=>{var e;null==(e=null==l?void 0:l.stopPropagation)||e.call(l),V.value=V.value.filter((l=>l.goods_id!==a)),H.value=!1,ka(!0)},za=()=>{L.value=null,X.value="",V.value=[],Y.value=[]};const $a=()=>{H.value||ka()};return(a,l)=>{const e=j,s=z,o=T,t=$,c=S,n=O(i("uni-icons"),E),v=O(i("uni-transition"),A),g=O(i("goods-search"),G),F=O(i("common-modal"),q),I=O(i("common-page"),D);return m(),u(_,null,[r("meta",{name:"theme-color",content:"#f5f5f5"}),d(I,{head_color:"#f5f5f5"},{default:f((()=>[d(e,{class:"tabs"},{default:f((()=>[d(e,{class:p(["tab",{active:"find"===K.value}]),onClick:l[0]||(l[0]=a=>ga("find"))},{default:f((()=>[y("找找")])),_:1},8,["class"]),d(e,{class:p(["tab",{active:"view"===K.value}]),onClick:l[1]||(l[1]=a=>ga("view"))},{default:f((()=>[y("看看")])),_:1},8,["class"])])),_:1}),"find"===K.value?(m(),h(e,{key:0},{default:f((()=>[d(e,{class:"category-container"},{default:f((()=>[d(s,{"scroll-x":"",class:"category-scroll"},{default:f((()=>[(m(!0),u(_,null,k(ca.value,((a,l)=>(m(),h(e,{class:p(["category-item",{active:oa.value===a}]),key:l,onClick:l=>(a=>{oa.value=a,ya(!0)})(a)},{default:f((()=>[y(P(a),1)])),_:2},1032,["class","onClick"])))),128))])),_:1}),d(s,{"scroll-x":"",class:"size-scroll"},{default:f((()=>[(m(!0),u(_,null,k(na.value,((a,l)=>(m(),h(e,{class:p(["size-item",{active:ta.value===a}]),key:l,onClick:l=>(a=>{ta.value=a,ya(!0)})(a)},{default:f((()=>[y(P(a),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),d(s,{class:"goods-list","scroll-y":"",onScrolltolower:ha,"show-scrollbar":!1},{default:f((()=>[d(e,{class:"goods-container"},{default:f((()=>[(m(!0),u(_,null,k(aa.value,((a,l)=>(m(),h(e,{key:a.id,class:"goods-card"},{default:f((()=>[d(o,{src:a.goods_images[0],mode:"aspectFill",class:"goods-image"},null,8,["src"]),d(e,{class:"goods-info"},{default:f((()=>[d(t,{class:"goods-name"},{default:f((()=>[y(P(a.name),1)])),_:2},1024),d(t,{class:"goods-brand"},{default:f((()=>[y(P(a.brand_name),1)])),_:2},1024),d(t,{class:"goods-price"},{default:f((()=>[y(P(a.total_amount)+" "+P(a.currency),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),d(e,{class:"loading-state"},{default:f((()=>[la.value?(m(),h(t,{key:0},{default:f((()=>[y("加载中...")])),_:1})):w("",!0),ea.value?(m(),h(t,{key:1,class:"no-more"},{default:f((()=>[y("没有更多了")])),_:1})):w("",!0)])),_:1})])),_:1})])),_:1})):w("",!0),"view"===K.value?(m(),h(e,{key:1},{default:f((()=>[d(e,{class:"container"},{default:f((()=>[d(e,{class:"filter-bar",style:C("")},{default:f((()=>[d(e,{class:"filter-tags",onClick:wa},{default:f((()=>[d(e,{class:"selected-goods"},{default:f((()=>[(m(!0),u(_,null,k(V.value,(a=>(m(),h(e,{key:a.goods_id,class:"tag",onClick:b((l=>ja(a.goods_id,l)),["stop"])},{default:f((()=>[y(P(a.goods_name)+" ",1),d(t,{class:"remove"},{default:f((()=>[y("×")])),_:1})])),_:2},1032,["onClick"])))),128))])),_:1}),V.value.length?w("",!0):(m(),h(t,{key:0,class:"tip"},{default:f((()=>[y("当前无筛选条件")])),_:1}))])),_:1}),d(c,{class:"submit-btn",onClick:l[2]||(l[2]=a=>ka(!0))},{default:f((()=>[y("筛选")])),_:1})])),_:1},8,["style"]),d(s,{class:"card-list","scroll-y":"",onScrolltolower:$a,"show-scrollbar":!1},{default:f((()=>[d(e,{class:"cards-container",style:C({height:N.value+"px"})},{default:f((()=>[(m(!0),u(_,null,k(Q.value,((a,l)=>(m(),h(e,{key:a.collocation_id,class:"card",id:"card-"+l,style:C(_a(l)),onClick:l=>{return e=a.collocation_id,s=a.origin,void x({url:"/pages/collocation_share/collocation_share?collocation_id="+e+"&origin="+s});var e,s}},{default:f((()=>{var l;return[d(e,{class:"user-info",onClick:b((l=>{return e=a.uid,void x({url:`/pages/user_page/user_page?uid=${e}`});var e}),["stop"])},{default:f((()=>[d(o,{src:a.avatar||"/default_avatar.jpg",class:"avatar",mode:"aspectFill"},null,8,["src"]),d(e,{class:"user-meta"},{default:f((()=>[d(t,{class:"username"},{default:f((()=>{return[y(P((l=a.username,l.length>10?`${l.toString().slice(-8)}...`:l)),1)];var l})),_:2},1024),d(e,{class:"like-count"},{default:f((()=>[d(n,{type:"hand-up",size:"18",color:"#5f85a3"}),d(t,{style:{margin:"0 5rpx",color:"#5f85a3"}},{default:f((()=>[y(P(a.like_count),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),(null==(l=a.image_urls)?void 0:l.length)>0?(m(),h(o,{key:0,src:a.image_urls[0],mode:"aspectFill",class:"card-image","lazy-load":""},null,8,["src"])):w("",!0),d(e,{class:"card-content"},{default:f((()=>[d(t,{class:"title"},{default:f((()=>[y(P(a.title),1)])),_:2},1024),d(t,{class:"desc"},{default:f((()=>[y(P(a.content),1)])),_:2},1024),d(e,{class:"goods-tags"},{default:f((()=>[(m(!0),u(_,null,k(a.relation_list,((a,l)=>(m(),h(e,{class:"tag-box",key:l},{default:f((()=>[d(t,{class:"goods-tag"},{default:f((()=>[y(P(a.relation_goods_name||"未命名商品"),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)]})),_:2},1032,["id","style","onClick"])))),128))])),_:1},8,["style"]),d(e,{class:"loading-state"},{default:f((()=>[B.value?(m(),h(t,{key:0},{default:f((()=>[y("加载中...")])),_:1})):w("",!0),H.value?(m(),h(t,{key:1,class:"no-more"},{default:f((()=>[y("没有更多了")])),_:1})):w("",!0)])),_:1})])),_:1}),d(e,{class:"floating-button",onClick:ua},{default:f((()=>[d(n,{type:"plusempty",size:"30",color:"#fff"})])),_:1}),d(v,{name:"fade",mode:"out-in",duration:300},{default:f((()=>[ia.value?(m(),h(e,{key:0,class:"post-menu-mask",onClick:ra})):w("",!0)])),_:1}),d(e,{class:p(["post-menu",{show:ia.value}])},{default:f((()=>[d(e,{class:"menu-item",onClick:da},{default:f((()=>[d(n,{style:{"margin-right":"10rpx"},type:"color",size:"24",color:"#5f85a3"}),d(t,null,{default:f((()=>[y("发搭配分享")])),_:1})])),_:1}),d(e,{class:"menu-item",onClick:fa},{default:f((()=>[d(n,{style:{"margin-right":"10rpx"},type:"compose",size:"24",color:"#5f85a3"}),d(t,null,{default:f((()=>[y("发展示柜")])),_:1})])),_:1})])),_:1},8,["class"]),d(F,{visible:W.value,"onUpdate:visible":l[3]||(l[3]=a=>W.value=a),top:"0",width:"100%",height:"100%"},{default:f((()=>[d(e,{class:"modal-mask",onClick:b(xa,["stop"])}),d(e,{class:"filter-modal"},{default:f((()=>[d(e,{class:"modal-header",style:C("margin-top:0rpx")},{default:f((()=>[d(t,{class:"title"},{default:f((()=>[y("筛选看想要的娃物搭配吧！")])),_:1}),d(t,{class:"close",onClick:xa},{default:f((()=>[y("×")])),_:1})])),_:1},8,["style"]),d(g,{mode:"fill",onSelect:Ca,background:"#f8f8f8",width:"100%"}),d(e,{class:"selected-goods"},{default:f((()=>[(m(!0),u(_,null,k(V.value,(a=>(m(),h(e,{key:a.goods_id,class:"goods-tag",onClick:b((l=>ja(a.goods_id,l)),["stop"])},{default:f((()=>[y(P(a.goods_name)+" ",1),d(t,{class:"remove"},{default:f((()=>[y("×")])),_:1})])),_:2},1032,["onClick"])))),128))])),_:1}),d(e,{class:"action-btns"},{default:f((()=>[d(c,{class:"btn reset",onClick:za},{default:f((()=>[y("重置")])),_:1}),d(c,{class:"btn confirm",onClick:ba},{default:f((()=>[y("应用筛选")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])])),_:1})])),_:1})):w("",!0)])),_:1})],64)}}},[["__scopeId","data-v-4311f54f"]]);export{K as default};
