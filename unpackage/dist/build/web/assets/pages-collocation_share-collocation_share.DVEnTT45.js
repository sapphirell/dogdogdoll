import{k as a,V as t,c as e,w as l,p as o,q as s,A as i,g as n,o as d,a as c,v as u,b as r,t as _,e as m,r as f,F as g,B as p,G as v,n as y,i as h,f as x,S as k,C as b,O as w,j as S,P as $,x as C}from"./index-D8OtiTi9.js";import{_ as I,a as z}from"./heart2.DWT8AkCv.js";import{b as j}from"./uni-app.es.JSb8JX9v.js";import{a as A,w as E,g as F}from"./config.BPuNpLTQ.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";const P=L({__name:"collocation_share",setup(L){const P=a({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),T=a({userName:"",avatar:""}),G=a(!0),O=a(!1),V=a(""),D=a(0);let M=a(!1),q=a({}),B=a(1),H=a(""),N=a({});t({title:"搭配详情"});const U=async a=>{var t;try{const e=await o({url:E+`/view-collocation?collocation_id=${a}`});if("success"!==e.data.status)return void Y(e.data.msg||"数据加载失败");const l={...e.data.data,image_url_list:Array.isArray(e.data.data.image_url_list)?e.data.data.image_url_list:[e.data.data.image_urls],collocation_relation_list:await Promise.all(e.data.data.collocation_relation_list.map((async a=>{try{const t=a.relation_goods_id>0?await(a=>new Promise(((t,e)=>{a&&0!==a?o({url:`${E}/goods?id=${a}`,method:"GET",timeout:5e3,success:a=>{"success"===a.data.status?t(a.data.data):e(a.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),s({title:"网络请求失败",icon:"none"}),e(a)}}):e("无效的商品ID")})))(a.relation_goods_id):null;return{...a,goodsInfo:t,imageLoaded:!!t,imageError:!t}}catch(t){return console.error("商品信息获取失败:",t),{...a,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};P.value=l,(null==(t=e.data.data)?void 0:t.uid)&&await W(e.data.data.uid)}catch(e){Y("数据加载失败")}finally{G.value=!1}},W=async a=>{try{const t=await o({url:`${E}/user-info?uid=${a}`,method:"GET"});"success"===t.data.status?T.value=t.data.data:console.error("获取用户信息失败:",t.data.msg)}catch(t){console.error("用户信息请求失败:",t),s({title:"作者信息加载失败",icon:"none"})}},Y=a=>{O.value=!0,V.value=a,s({title:a,icon:"none"})};function J(a){let t=i("token");""!=t&&o({url:E+"/with-state/hasLike?id="+a+"&type=3",method:"POST",header:{Authorization:t},success:a=>{"success"==a.data.status?a.data.data.id>0?M.value=!0:M.value=!1:s({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),s({title:"网络请求失败",icon:"none"})}})}function K(a){if(a<1e3)return a.toString();return`${Math.floor(a/1e3)}k+`}function Q(){o({url:E+"/collocation-comment?collocation_id="+D.value+"&page="+B.value,method:"GET",timeout:5e3,success:a=>{console.log(a.data.data),q.value.page_index=a.data.data.page_index,q.value.total=a.data.data.total,q.value.comment_list=q.value.comment_list?q.value.comment_list.concat(a.data.data.comment_list):a.data.data.comment_list,null!=a.data.data.comment_list&&(a.data.data.comment_list.length>0&&(B.value+=1),0==a.data.data.comment_list.length&&B.value>1&&s({title:"没有更多数据了",icon:"none"}))},fail:a=>{console.log(a),s({title:"网络请求失败",icon:"none"})}})}function R(){let a=i("token");if(!F.isLogin)return void s({title:"请先登录",icon:"none"});if(""==H.value)return void s({title:"请输入评论内容",icon:"none"});let t={content:H.value,target_id:parseInt(D.value),type:3};N.value.id&&(t.reply_id=N.value.id,t.reply_for=N.value.comment,t.reply_user_id=N.value.user_id),console.log(t),o({url:E+"/with-state/add-comment",method:"POST",header:{Authorization:a},data:t,success:a=>(console.log(a.data),"success"==a.data.status?(s({title:"评论成功",icon:"success"}),H.value="",B.value=1,q.value={},void Q()):void s({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),s({title:"网络请求失败",icon:"none"})}})}function X(a){const t=new Date(1e3*a),e=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),o=t.getDate().toString().padStart(2,"0"),s=t.getHours().toString().padStart(2,"0"),i=t.getMinutes().toString().padStart(2,"0");return t.getSeconds().toString().padStart(2,"0"),`${e}-${l}-${o} ${s}:${i}`}return j((a=>{if(!a.collocation_id)return O.value=!0,void(V.value="缺少必要参数");D.value=a.collocation_id,U(a.collocation_id),A().then((t=>{console.log(t),J(a.collocation_id)})),Q()})),(a,t)=>{const j=h,A=x,L=n,D=C,B=k,W=b,Y=w;return d(),e(L,{class:"container"},{default:l((()=>[c(L,{style:{position:"relative"}},{default:l((()=>[c(L,{class:"heart",onClick:t[0]||(t[0]=a=>function(){let a=i("token");if(!F.isLogin)return void s({title:"请先登录",icon:"none"});let t={id:parseInt(P.value.id),type:3},e=M.value?"/with-state/unlike":"/with-state/add-like";o({url:E+e,method:"POST",header:{Authorization:a},data:t,success:a=>(console.log(a.data),"success"==a.data.status?(s({title:"操作成功",icon:"success"}),M.value=!M.value,J(P.value.id),void U(P.value.id)):void s({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),s({title:"网络请求失败",icon:"none"})}})}())},{default:l((()=>[u(M)?(d(),e(j,{key:1,src:z})):(d(),e(j,{key:0,src:I})),c(A,null,{default:l((()=>[r(_(K(P.value.like_count)),1)])),_:1})])),_:1}),c(B,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:l((()=>[(d(!0),m(g,null,f(P.value.image_url_list,((a,t)=>(d(),e(D,{key:t},{default:l((()=>[c(j,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>function(a){console.log(P),$({current:P.value.image_url_list[a],urls:P.value.image_url_list})}(t)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),c(L,{class:"author-info",onClick:t[1]||(t[1]=a=>{var t;(t=P.value.uid)&&y({url:`/pages/user/profile?uid=${t}`})})},{default:l((()=>[c(j,{class:"avatar",src:T.value.avatar||"/static/default-avatar.png",mode:"aspectFill"},null,8,["src"]),c(A,{class:"username"},{default:l((()=>[r(_(T.value.user_name||"未知用户"),1)])),_:1})])),_:1}),c(L,{class:"content-box"},{default:l((()=>[c(A,{class:"title"},{default:l((()=>[r(_(P.value.title),1)])),_:1}),c(A,{class:"content"},{default:l((()=>[r(_(P.value.content),1)])),_:1})])),_:1}),c(L,{class:"goods-list"},{default:l((()=>[(d(!0),m(g,null,f(P.value.collocation_relation_list,(a=>(d(),e(L,{key:a.id,class:"goods-item",onClick:t=>{return a.relation_goods_id>0?void(0!=(e=a.relation_goods_id)?y({url:`/pages/goods/goods?goods_id=${e}`}):s({title:"商品暂时没有录入",icon:"none"})):null;var e}},{default:l((()=>[c(L,{class:"image-container"},{default:l((()=>{var t,o;return[0===a.relation_goods_id?(d(),e(L,{key:0,class:"placeholder-box"},{default:l((()=>[c(A,{style:{color:"#fff","font-size":"45px"}},{default:l((()=>[r("?")])),_:1})])),_:1})):(d(),m(g,{key:1},[a.imageLoaded?(d(),e(j,{key:0,src:(null==(o=null==(t=a.goodsInfo)?void 0:t.goods_images)?void 0:o[0])||"/static/goods-default.png",mode:"aspectFill",class:"goods-image"},null,8,["src"])):a.imageError?(d(),e(L,{key:1,class:"error-box"},{default:l((()=>[c(A,null,{default:l((()=>[r("图片加载失败")])),_:1})])),_:1})):(d(),e(L,{key:2,class:"loading-box"},{default:l((()=>[c(A,null,{default:l((()=>[r("加载中...")])),_:1})])),_:1}))],64))]})),_:2},1024),c(L,{class:"goods-info"},{default:l((()=>[c(A,{class:"brand"},{default:l((()=>[r(_(a.relation_brand_name),1)])),_:2},1024),c(A,{class:"category"},{default:l((()=>[r(_(a.type),1)])),_:2},1024),c(A,{class:"name"},{default:l((()=>[r(_(a.relation_goods_name),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),c(L,{style:{padding:"10px"}},{default:l((()=>[c(A,{style:{color:"rgb(100, 198, 220)","font-weight":"bold",isplay:"block",margin:"30px 5px",display:"block"}},{default:l((()=>[r("评论区 ("+_(u(q).total||0)+")",1)])),_:1}),c(L,null,{default:l((()=>[u(q).comment_list?(d(),e(L,{key:0},{default:l((()=>[(d(!0),m(g,null,f(u(q).comment_list,((a,t)=>(d(),e(L,{class:"comment_item",key:a.id,style:{"margin-bottom":"20px"}},{default:l((()=>[c(L,{style:{float:"left",width:"80px",padding:"0px 10px 10px 0px"}},{default:l((()=>[c(j,{style:{width:"50px",height:"50px","border-radius":"100%",display:"block",margin:"10px"},src:a.avatar,mode:"aspectFill"},null,8,["src"]),c(A,{style:{display:"block","white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"}},{default:l((()=>[r(_(a.username),1)])),_:2},1024)])),_:2},1024),c(L,{style:{float:"left",padding:"15px 15px 30px 15px",background:"rgb(245 245 245)",width:"calc(100vw - 170px)","min-height":"60px","border-radius":"15px",position:"relative",top:"2px"}},{default:l((()=>[c(A,{style:{width:"100%","white-space":"normal","word-break":"break-all"}},{default:l((()=>[r(_(a.comment),1)])),_:2},1024),c(A,{style:{color:"#888","font-size":"12px",position:"absolute",bottom:"3px",left:"15px"}},{default:l((()=>[r(_(X(a.created_at))+" floor#"+_(a.floor),1)])),_:2},1024),c(A,{style:S([{fontSize:"12px",position:"absolute",bottom:"3px",right:"15px",fontWeight:"1000"},u(N).id===a.id?{color:"#fd6669"}:{color:"#888"}]),onClick:t=>function(a){N.value.id!=a.id?N.value=a:N.value={}}(a)},{default:l((()=>[r(" 引用此回复 ")])),_:2},1032,["style","onClick"])])),_:2},1024),c(L,{style:{clear:"both"}})])),_:2},1024)))),128)),c(W,{class:"load_more",onClick:Q},{default:l((()=>[r("加载更多")])),_:1})])),_:1})):p("",!0)])),_:1})])),_:1}),c(L,{class:"bottom_tab",style:{display:"flex","align-items":"center",padding:"10px",position:"fixed",bottom:"0px","z-index":"100",width:"100vw",background:"#fff"}},{default:l((()=>[u(N).id?(d(),e(A,{key:0,class:"replyInfo",style:{}},{default:l((()=>[r(_("@"+u(N).username),1)])),_:1})):p("",!0),c(Y,{class:"comment_input",modelValue:u(H),"onUpdate:modelValue":t[2]||(t[2]=a=>v(H)?H.value=a:H=a),style:{}},null,8,["modelValue"]),c(W,{style:{"flex-shrink":"0",width:"90px"},onClick:R},{default:l((()=>[r("写评论")])),_:1})])),_:1}),G.value?(d(),e(L,{key:0,class:"loading"},{default:l((()=>[r("加载中...")])),_:1})):p("",!0),O.value?(d(),e(L,{key:1,class:"error"},{default:l((()=>[r(_(V.value),1)])),_:1})):p("",!0)])),_:1})}}},[["__scopeId","data-v-d05481eb"]]);export{P as default};
