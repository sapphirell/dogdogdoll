import{g as e,X as a,m as l,o,c as s,w as t,a as n,b as i,t as d,x as r,z as u,d as c,F as m,r as v,D as p,e as f,f as g,S as y,j as _,Y as k,L as b,M as h,k as w,l as j,K as z,ap as C}from"./index-B55GPRQF.js";import{_ as L}from"./uni-icons.B2Wm8RW1.js";import{r as S}from"./uni-app.es.CzHle-z4.js";import{_ as E}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as V}from"./common-search.OBIzXxZ7.js";import{_ as x}from"./goods-search.DumlFeXD.js";import{_ as F}from"./common-modal.MV9iS1Pr.js";import{w as T}from"./config.BIUptOrH.js";const A=E({__name:"common-name-picker",props:{dataList:{type:Array,default:()=>[]},placeholder:{type:String,default:"请选择"},defaultValue:{type:String,default:""}},emits:["select"],setup(_,{emit:k}){const b=_,h=k,w=e(!1),j=e(b.defaultValue),z=()=>{w.value=!w.value};return a((()=>{console.log("初始值",w.value),w.value=!1})),(e,a)=>{const k=f,b=S(l("uni-icons"),L),C=g,E=y;return o(),s(C,{class:"select-container",ref:"containerRef"},{default:t((()=>[n(C,{class:"select-input",onClick:z},{default:t((()=>[n(k,{class:"selected-value"},{default:t((()=>[i(d(j.value||_.placeholder),1)])),_:1}),n(C,{class:r(["arrow-icon",{rotate:w.value}])},{default:t((()=>[n(b,{type:"arrowdown",size:"16",color:"#666"})])),_:1},8,["class"])])),_:1}),n(C,{class:"popup-container"},{default:t((()=>[w.value?(o(),s(C,{key:0,class:"mask",onClick:a[0]||(a[0]=e=>z())})):u("",!0),w.value?(o(),s(C,{key:1,class:"options-wrapper"},{default:t((()=>[n(E,{"scroll-y":"true",class:"select-options"},{default:t((()=>[(o(!0),c(m,null,v(_.dataList,((e,a)=>(o(),s(C,{key:a,class:r(["option-item",{selected:j.value===e}]),onClick:p((a=>(e=>{j.value=e,w.value=!1,h("select",e)})(e)),["stop"])},{default:t((()=>[i(d(e)+" ",1),j.value===e?(o(),s(b,{key:0,type:"checkmarkempty",size:"18",color:"#007AFF",class:"check-icon"})):u("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})):u("",!0)])),_:1})])),_:1},512)}}},[["__scopeId","data-v-eb9e34f6"]]),I=E({__name:"custom-picker",props:{dataList:{type:Array,required:!0},margin:{type:String,default:"0"}},emits:["select"],setup(a,{emit:l}){const r=a,p=l,f=e(""),y=e(!1),h=_((()=>r.dataList.filter((e=>e.name.toLowerCase().includes(f.value.toLowerCase()))))),w=()=>{p("select",0,f.value)},j=()=>{y.value=!y.value};return(e,l)=>{const r=b,_=g;return o(),s(_,{class:"custom-select"},{default:t((()=>[n(r,{modelValue:f.value,"onUpdate:modelValue":l[0]||(l[0]=e=>f.value=e),onClick:j,onInput:w,placeholder:"请选择或输入",class:"select-input",style:k({margin:a.margin})},null,8,["modelValue","style"]),y.value?(o(),s(_,{key:0,class:"dropdown"},{default:t((()=>[(o(!0),c(m,null,v(h.value,(e=>(o(),s(_,{key:e.id,onClick:a=>(e=>{f.value=e.name,y.value=!1,p("select",e.id,e.name)})(e),class:"dropdown-item"},{default:t((()=>[i(d(e.name),1)])),_:2},1032,["onClick"])))),128))])),_:1})):u("",!0)])),_:1})}}},[["__scopeId","data-v-795dad92"]]),G=E({__name:"relation-picker",props:{typeList:{type:Array,default:()=>[]},visible:{type:Boolean,default:!1}},emits:["update:visible","confirm","cancel"],setup(a,{emit:d}){const r=a,v=d,p=e([]),y=e(),_=e(),k=e(),b=e(),E=e(!1),G=e(!0),P=e({type:null,brand:{id:0,name:""},goods:{id:0,name:"",image:""}}),U=e(""),D=e=>{G.value=e,B(),P.value={type:null,brand:{id:0,name:""},goods:{id:0,name:"",image:""}}},q=e=>{const a={type:y,brand:_,goods:k,fuzzy:b};Object.entries(a).forEach((([a,l])=>{var o;a!==e&&(null==(o=l.value)?void 0:o.close)&&l.value.close()}))},B=()=>{[y,_,k,b].forEach((e=>{var a;(null==(a=e.value)?void 0:a.reset)&&e.value.reset()}))},J=async e=>{var a;try{if(!(null==e?void 0:e.id))return U.value=e.name,void(P.value={type:"未知类型",brand:{id:0,name:""},goods:{id:0,name:e.name,image:""}});const l=await R(e.id);U.value=e.name,P.value={type:l.type||"未知类型",brand:{id:l.brand_id||0,name:l.brand_name||""},goods:{id:e.id,name:e.name,image:(null==(a=null==l?void 0:l.goods_images)?void 0:a[0])||""}}}catch(l){console.error("商品信息获取失败",l),w({title:"详细信息获取失败，已保存基本信息",icon:"none"}),U.value=e.name,P.value={type:"未知类型",brand:{id:0,name:""},goods:{id:(null==e?void 0:e.id)||0,name:e.name,image:""}}}},K=()=>{E.value=!1,U.value="",B(),C((()=>{P.value={type:null,brand:{id:0,name:""},goods:{id:0,name:"",image:""}}}))};h((()=>r.visible),(e=>{E.value=e})),h(E,(e=>{v("update:visible",e)}));const M=e=>{E.value=e,e||K()},O=e=>{P.value.type=e},R=e=>new Promise(((a,l)=>{j({url:T+"/goods?id="+e,method:"GET",timeout:5e3,success:e=>{a(e.data.data)},fail:e=>{console.error("商品详情获取失败",e),l(e)}})})),X=(e,a)=>{P.value.brand={id:e||0,name:a},e&&function(e){j({url:T+"/goods-name-list?id="+e,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),p.value=e.data.data,console.log(p.value)},fail:e=>{console.log(e),w({title:"网络请求失败",icon:"none"})}})}(e)},Y=async(e,a)=>{var l;try{if(P.value.goods={id:e||0,name:a,image:""},e&&0!==e){const a=await R(e);P.value.goods.image=(null==(l=null==a?void 0:a.goods_images)?void 0:l[0])||""}}catch(o){console.error("商品信息获取失败",o),w({title:"图片信息获取失败，已保存基本信息",icon:"none"})}};const H=async()=>{var e,a;try{let o=null;if(G.value)if(P.value.goods.id&&0!==P.value.goods.id)try{const a=await R(P.value.goods.id);o={isFuzzy:!0,keyword:U.value,goods:{id:a.id||P.value.goods.id,name:a.goods_name||P.value.goods.name,image:(null==(e=null==a?void 0:a.goods_images)?void 0:e[0])||""},brand:{id:a.brand_id||0,name:a.brand_name||""},type:a.type||"未知类型"}}catch(l){console.error("商品信息获取失败，使用缓存数据",l),o={isFuzzy:!0,keyword:U.value,goods:P.value.goods,brand:P.value.brand,type:P.value.type||"未知类型"}}else o={isFuzzy:!0,keyword:U.value,goods:{id:0,name:U.value,image:""},brand:{id:0,name:""},type:"未知类型"};else{if(console.log("jjjjjjjjjjjjjjjj"),P.value.goods.id&&0!==P.value.goods.id)try{const e=await R(P.value.goods.id);P.value.goods.image=(null==(a=null==e?void 0:e.goods_images)?void 0:a[0])||"",P.value.type=e.type||P.value.type}catch(l){console.error("商品信息获取失败，使用缓存数据",l)}if(!P.value.type)throw new Error("请选择商品类型");if(!P.value.brand.name)throw new Error("请填写或选择品牌");if(!P.value.goods.name)throw new Error("请填写或选择商品");o={isFuzzy:!1,type:P.value.type,brand:P.value.brand,goods:P.value.goods}}console.log("确认数据:",o),v("confirm",o),K()}catch(l){w({title:l.message,icon:"none"})}},N=()=>{v("cancel"),K()};return(e,d)=>{const r=S(l("uni-icons"),L),v=f,h=g,w=S(l("common-name-picker"),A),j=S(l("common-search"),V),C=S(l("custom-picker"),I),T=S(l("goods-search"),x),P=z,B=S(l("common-modal"),F);return o(),s(B,{visible:E.value,"onUpdate:visible":M,top:"200rpx"},{default:t((()=>[n(h,{class:"relation-picker-container"},{default:t((()=>[n(h,{class:"picker-header"},{default:t((()=>[n(h,{class:"mode-switch"},{default:t((()=>[G.value?(o(),s(h,{key:0,class:"switch-btn precision-mode",onClick:d[0]||(d[0]=e=>D(!1))},{default:t((()=>[n(r,{type:"search",size:"18",color:"#fff"}),n(v,null,{default:t((()=>[i("切换到精确关联")])),_:1})])),_:1})):u("",!0),G.value?u("",!0):(o(),s(h,{key:1,class:"switch-btn fuzzy-mode",onClick:d[1]||(d[1]=e=>D(!0))},{default:t((()=>[n(r,{type:"list",size:"18",color:"#fff"}),n(v,null,{default:t((()=>[i("切换到模糊关联")])),_:1})])),_:1}))])),_:1})])),_:1}),n(h,{class:"picker-body"},{default:t((()=>[G.value?(o(),s(T,{key:1,ref_key:"fuzzySearch",ref:b,mode:"fill",onSelect:J,modelValue:U.value,"onUpdate:modelValue":d[5]||(d[5]=e=>U.value=e),width:"550rpx",onToggle:d[6]||(d[6]=e=>q("fuzzy")),class:"fuzzy-search"},null,8,["modelValue"])):(o(),c(m,{key:0},[n(w,{ref_key:"typePicker",ref:y,dataList:a.typeList,onSelect:O,onToggle:d[2]||(d[2]=e=>q("type")),class:"type-picker"},null,8,["dataList"]),n(j,{ref_key:"brandSearch",ref:_,background:"#f8f8f8",mode:"fill",onSelect:X,onToggle:d[3]||(d[3]=e=>q("brand")),class:"brand-search",style:{padding:"0px!important"}},null,512),n(C,{ref_key:"goodsPicker",ref:k,background:"#f8f8f8",dataList:p.value,onSelect:Y,onToggle:d[4]||(d[4]=e=>q("goods")),class:"goods-picker"},null,8,["dataList"])],64))])),_:1}),n(h,{class:"picker-footer"},{default:t((()=>[n(P,{class:"cancel-btn",onClick:N},{default:t((()=>[i("取消")])),_:1}),n(P,{class:"confirm-btn",onClick:H},{default:t((()=>[i("确认")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])}}},[["__scopeId","data-v-dc26078d"]]);export{G as _};
