import{r as a,l as e,a2 as t,A as o,a as l,c as s,w as i,q as n,j as r,g as u,b as d,d as c,C as _,e as f,t as g,v as m,x as p,F as v,p as y,T as h,n as k,f as w,i as I,G as S,J as b,E as x}from"./index-BFzTDSoz.js";import{c as $,w as C,_ as j,b as L}from"./view-logs.yEAac7W9.js";import{_ as A,c as E,a as z,r as T}from"./_plugin-vue_export-helper.CXFOpRdI.js";import{_ as F}from"./uni-icons.COaeasi-.js";import{b as P,_ as D,a as O}from"./comment-input.B__ry1x5.js";import"./common-modal.DWKlFhUY.js";const R=A({__name:"collocation_share",props:{collocation_id:{type:String,default:0},origin:{type:String,default:0}},setup(A){const R=a({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),G=a({userName:"",avatar:""});e();const M=a(!0),N=a(!1),q=a(""),B=A,H=a(0),J=a(0);let K=a(!1);const U=a(null),Y=a(null);a(1);let Q=a({});t({title:"搭配详情"});const V=async(a,e)=>{var t;try{const l=await n({url:C+`/view-collocation?collocation_id=${a}&origin=${e}`});if("success"!==l.data.status)return void X(l.data.msg||"数据加载失败");const s={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async a=>{try{const e=a.relation_goods_id>0?await(a=>new Promise(((e,t)=>{a&&0!==a?n({url:`${C}/goods?id=${a}`,method:"GET",timeout:5e3,success:a=>{"success"===a.data.status?e(a.data.data):t(a.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),o({title:"网络请求失败",icon:"none"}),t(a)}}):t("无效的商品ID")})))(a.relation_goods_id):null;return{...a,goodsInfo:e,imageLoaded:!!e,imageError:!e}}catch(e){return console.error("商品信息获取失败:",e),{...a,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};R.value=s,(null==(t=l.data.data)?void 0:t.uid)&&await W(l.data.data.uid)}catch(l){X("数据加载失败")}finally{M.value=!1}},W=async a=>{try{const e=await n({url:`${C}/user-info?uid=${a}`,method:"GET"});"success"===e.data.status?G.value=e.data.data:console.error("获取用户信息失败:",e.data.msg)}catch(e){console.error("用户信息请求失败:",e),o({title:"作者信息加载失败",icon:"none"})}},X=a=>{N.value=!0,q.value=a,o({title:a,icon:"none"})};function Z(a){let e=r("token");if(""==e)return;let t=1==J.value?3:4;n({url:C+"/with-state/hasLike?id="+a+"&type="+t,method:"POST",header:{Authorization:e},success:a=>{"success"==a.data.status?a.data.data.id>0?K.value=!0:K.value=!1:o({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}function aa(a){if(a<1e3)return a.toString();return`${Math.floor(a/1e3)}k+`}const ea=({parent:a,target:e})=>{var t;console.log("parent",a),console.log("target",e);let o=a;null!=e&&(o=e),Q.value.id!=o.id?(console.log("item",o),Q.value=o,null==(t=Y.value)||t.focusInput()):Q.value={}},ta=({content:a,replyInfo:e,origin:t})=>{let l=r("token");if(!L.isLogin)return void o({title:"请先登录",icon:"none"});console.log("reply_info",e);const s={content:a,origin:t,target_id:parseInt(H.value),type:1==B.origin?3:6,...e.id&&{reply_id:e.id,reply_for:e.comment,reply_user_id:e.user_id,parent_id:e.parent_id>0?e.parent_id:e.id}};n({url:C+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:s,success:a=>{var e,t;if("success"==a.data.status){const l=a.data.data;0===l.parent_id?null==(e=U.value)||e.addNewComment(l):null==(t=U.value)||t.addReplyComment(l),o({title:"评论成功",icon:"success"})}else o({title:a.data.msg,icon:"none"})},fail:a=>{o({title:"网络请求失败",icon:"none"})}})};function oa(a){const e=new Date(1e3*a),t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),l=e.getDate().toString().padStart(2,"0"),s=e.getHours().toString().padStart(2,"0"),i=e.getMinutes().toString().padStart(2,"0");return e.getSeconds().toString().padStart(2,"0"),`${t}-${o}-${l} ${s}:${i}`}return E((()=>{})),z((a=>{try{if(!a.collocation_id)return N.value=!0,void(q.value="缺少必要参数Id");if(!a.origin)return N.value=!0,void(q.value="缺少必要参数Origin");H.value=a.collocation_id,J.value=a.origin,V(a.collocation_id,a.origin),$().then((e=>{console.log(e),Z(a.collocation_id)}))}catch(e){console.error("onLoad Error:",e),o({title:"加载失败",icon:"none"})}})),(a,e)=>{const t=T(l("view-logs"),j),$=T(l("uni-icons"),F),A=w,E=u,z=I,B=x,W=S,X=T(l("report-button"),P),la=T(l("comment-list"),D),sa=T(l("comment-input"),O);return d(),s(E,null,{default:i((()=>[c(t),c(E,{style:{position:"relative"}},{default:i((()=>[c(E,{class:"heart",onClick:e[0]||(e[0]=a=>function(){let a=r("token");if(!L.isLogin)return void o({title:"请先登录",icon:"none"});let e=1==J.value?3:4,t={id:parseInt(R.value.id),type:e},l=K.value?"/with-state/unlike":"/with-state/add-like";n({url:C+l,method:"POST",header:{Authorization:a},data:t,success:a=>(console.log(a.data),"success"==a.data.status?(o({title:"操作成功",icon:"success"}),K.value=!K.value,Z(R.value.id),void V(R.value.id,J.value)):void o({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}())},{default:i((()=>[_(K)?(d(),s($,{key:1,type:"heart-filled",size:"28",color:"#ff4d4f"})):(d(),s($,{key:0,type:"heart",size:"28",color:"#ff4d4f"})),c(A,{class:"num"},{default:i((()=>{var a;return[f(g((null==(a=R.value)?void 0:a.like_count)?aa(R.value.like_count):0),1)]})),_:1})])),_:1}),c(W,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:i((()=>[(d(!0),m(v,null,p(R.value.image_url_list,((a,e)=>(d(),s(B,{key:e},{default:i((()=>[c(z,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>function(a){console.log(R),b({current:R.value.image_url_list[a],urls:R.value.image_url_list})}(e)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),c(E,{class:"author-info",onClick:e[1]||(e[1]=a=>{return e=R.value.uid,void k({url:"/pages/user_page/user_page?uid="+e});var e})},{default:i((()=>[c(z,{class:"avatar",src:G.value.avatar,mode:"aspectFill"},null,8,["src"]),c(E,{class:"user-meta"},{default:i((()=>[c(A,{class:"username"},{default:i((()=>[f(g(G.value.user_name||"未知用户"),1)])),_:1}),c(A,{class:"publish-time"},{default:i((()=>[f("发布于 "+g(oa(R.value.created_at)),1)])),_:1})])),_:1})])),_:1}),c(E,{class:"content-box"},{default:i((()=>[c(E,{style:{display:"flex","justify-content":"space-between"}},{default:i((()=>[c(A,{class:"title"},{default:i((()=>[f(g(R.value.title),1)])),_:1}),c(E,{class:"report-container"},{default:i((()=>[c(X,{"report-type":1===J.value?2:1,"relation-id":parseInt(H.value),"icon-type":"flag","icon-color":"#999"},null,8,["report-type","relation-id"])])),_:1})])),_:1}),c(A,{class:"content"},{default:i((()=>[f(g(R.value.content),1)])),_:1})])),_:1}),c(E,{class:"goods-list"},{default:i((()=>[(d(!0),m(v,null,p(R.value.collocation_relation_list,(a=>(d(),s(E,{key:a.id,class:"goods-item",onClick:e=>{return a.relation_goods_id>0?void(0!=(t=a.relation_goods_id)?k({url:`/pages/goods/goods?goods_id=${t}`}):o({title:"商品暂时没有录入",icon:"none"})):null;var t}},{default:i((()=>[c(E,{class:"image-container"},{default:i((()=>{var e,t;return[0===a.relation_goods_id?(d(),s(E,{key:0,class:"placeholder-box"},{default:i((()=>[c(A,{style:{color:"#fff","font-size":"45px"}},{default:i((()=>[f("?")])),_:1})])),_:1})):(d(),m(v,{key:1},[a.imageLoaded?(d(),s(z,{key:0,src:(null==(t=null==(e=a.goodsInfo)?void 0:e.goods_images)?void 0:t[0])||"/static/goods-default.png",mode:"aspectFill",class:"goods-image"},null,8,["src"])):a.imageError?(d(),s(E,{key:1,class:"error-box"},{default:i((()=>[c(A,null,{default:i((()=>[f("图片加载失败")])),_:1})])),_:1})):(d(),s(E,{key:2,class:"loading-box"},{default:i((()=>[c(A,null,{default:i((()=>[f("加载中...")])),_:1})])),_:1}))],64))]})),_:2},1024),c(E,{class:"goods-info"},{default:i((()=>[c(A,{class:"brand"},{default:i((()=>[f(g(a.relation_brand_name)+" - "+g(a.relation_goods_name),1)])),_:2},1024),c(E,null,{default:i((()=>[c(A,{class:"category"},{default:i((()=>[f(g(a.type),1)])),_:2},1024),c(A,{class:"price"},{default:i((()=>[f(" （"+g(a.goodsInfo&&a.goodsInfo.total_amount?a.goodsInfo.total_amount+a.goodsInfo.currency:"贩售价格未收录")+"）",1)])),_:2},1024)])),_:2},1024),c(E,{class:"see font-alimamashuhei"},{default:i((()=>[f(" 去看看 → ")])),_:1})])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),J.value>0?(d(),s(E,{key:0,style:{padding:"10px"}},{default:i((()=>[c(la,{ref_key:"commentListRef",ref:U,type:1==J.value?3:6,"relation-id":parseInt(H.value),onReply:ea},null,8,["type","relation-id"])])),_:1})):y("",!0),R.value.title?(d(),s(sa,{key:1,ref_key:"commentInputRef",ref:Y,"reply-info":_(Q),"target-id":H.value,onSubmit:ta,"onUpdate:replyInfo":e[2]||(e[2]=a=>h(Q)?Q.value=a:Q=a)},null,8,["reply-info","target-id"])):y("",!0),c(E,{style:{width:"100%",height:"120rpx"}}),M.value?(d(),s(E,{key:2,class:"loading"},{default:i((()=>[f("加载中...")])),_:1})):y("",!0),N.value?(d(),s(E,{key:3,class:"error"},{default:i((()=>[f(g(q.value),1)])),_:1})):y("",!0)])),_:1})}}},[["__scopeId","data-v-26af1198"]]);export{R as default};
