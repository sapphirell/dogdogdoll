import{h as a,af as l,aa as e,j as o,k as s,e as t,d as c,a as n,w as i,F as u,l as r,ag as d,o as f,v,r as _,c as m,b as g,Q as p,ah as h,Y as y,g as k,f as x,D as b,W as w,t as C,n as j,i as $}from"./index-u2rUIk8T.js";import{_ as S}from"./common-search.B09gwaSi.js";import{r as P}from"./uni-app.es.DpDa-E5E.js";import{_ as E,a as Q}from"./common-modal.D11NfJ0_.js";import{_ as T}from"./common-page.CNR2v_s0.js";import{w as q}from"./config.DgkxgtZ3.js";import{_ as z}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./cancel.CnEdunnH.js";const F=z({__name:"collocation_square",setup(z){const F=a([]),L=a(!1),W=a(!1),D=a(1),G=a(0),I=a(0),M=l([0,0]),O=a(!1),R=a(""),U=a([]),Y=h(),A=a(null),B=a([]),H=a(null),J=a=>{const l=F.value[a];return l.position?{left:`${l.position.left}px`,top:`${l.position.top}px`,width:`${I.value}px`}:{}},K=a=>{if(console.log("进入计算布局逻辑"),!a)return void console.log("无法获取instance");if(console.log("获取成功"),!F.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(a);const l=y().in(a.proxy);console.log("获取到query");const e=F.value.map(((a,e)=>new Promise((a=>{l.select(`#card-${e}`).boundingClientRect((l=>{a({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),M[0]=0,M[1]=0;const a=await Promise.all(e);a.length?(a.forEach((({index:a,rect:l})=>{if(!l)return void console.error(`卡片${a}元素查询失败`);const e=F.value[a],o=M[0]<=M[1]?0:1,s=o*(I.value+10),t=M[o]+10;M[o]=t+l.height,e.position={left:s,top:t}})),G.value=Math.max(...M)+20):console.warn("未查询到任何卡片元素")}))};e((()=>{const a=o();I.value=(a.windowWidth-30)/2}));const N=async(a=!1)=>{if(L.value||W.value)console.log("正在加载中或没有更多了");else try{L.value=!0,a&&(F.value=[],D.value=1);const l={page:D.value,page_size:10,filter_goods_id_list:B.value.map((a=>a.goods_id))},e=await r({url:`${q}/collocation-list`,method:"POST",data:l});if("success"===e.data.status){const l=e.data.data,o=l.collocation_relation_list;F.value=a?o:[...F.value,...o],W.value=l.total<=10*D.value,D.value++,console.log("等待next tick"),await d(),console.log("等待完成"),K(Y),setTimeout((()=>{console.log("二次计算布局"),K(Y)}),500)}}finally{L.value=!1}},V=()=>O.value=!0,X=(a,l)=>{A.value={id:a,name:l},R.value=l,a&&Z(a)},Z=async a=>{try{const l=await r({url:`${q}/goods-name-list?id=${a}`,method:"GET"});console.log("商品列表:",l.data),"success"===l.data.status&&(U.value=l.data.data)}catch(l){console.error("加载商品失败:",l)}},aa=(a,l)=>{if(a){for(const l of B.value)if(l.goods_id===a)return;H.value={goods_id:a,goods_name:l}}else console.log("未选择有效goods")},la=()=>{A.value=null,R.value="",B.value=[],U.value=[]};const ea=async()=>{B.value.push(H.value),O.value=!1,W.value=!1,await N(!0)},oa=()=>{W.value||N()};return e(N),(a,l)=>{const e=k,o=x,r=b,d=$,h=w,y=P(s("common-search"),S),q=P(s("custom-picker"),E),z=P(s("common-modal"),Q),D=P(s("common-page"),T);return f(),t(u,null,[c("meta",{name:"theme-color",content:"#f5f5f5"}),n(D,{head_color:"#f5f5f5"},{default:i((()=>[n(e,{class:"container"},{default:i((()=>[v("",!0),n(e,{class:"filter-bar"},{default:i((()=>[n(e,{class:"filter-tags",onClick:V},{default:i((()=>[n(e,{class:"selected-goods"},{default:i((()=>[(f(!0),t(u,null,_(B.value,(a=>(f(),m(e,{key:a.goods_id,class:"tag"},{default:i((()=>[g(C(a.goods_name)+" ",1),n(o,{class:"remove",onClick:l=>{return e=a.goods_id,event.stopPropagation(),B.value=B.value.filter((a=>a.goods_id!==e)),W.value=!1,void N(!0);var e}},{default:i((()=>[g("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1}),B.value.length?v("",!0):(f(),m(o,{key:0,class:"tip"},{default:i((()=>[g("当前无筛选条件")])),_:1}))])),_:1}),n(r,{class:"submit-btn",onClick:l[0]||(l[0]=a=>N(!0))},{default:i((()=>[g("筛选")])),_:1})])),_:1}),n(h,{class:"card-list","scroll-y":"",onScrolltolower:oa,"show-scrollbar":!1},{default:i((()=>[n(e,{class:"cards-container",style:p({height:G.value+"px"})},{default:i((()=>[(f(!0),t(u,null,_(F.value,((a,l)=>(f(),m(e,{key:a.collocation_id,class:"card",id:"card-"+l,style:p(J(l)),onClick:l=>{return e=a.collocation_id,o=a.origin,void j({url:"/pages/collocation_share/collocation_share?collocation_id="+e+"&origin="+o});var e,o}},{default:i((()=>[n(d,{src:a.image_urls[0],mode:"aspectFill",class:"card-image","lazy-load":""},null,8,["src"]),n(e,{class:"card-content"},{default:i((()=>[n(o,{class:"title"},{default:i((()=>[g(C(a.title),1)])),_:2},1024),n(o,{class:"desc"},{default:i((()=>[g(C(a.content),1)])),_:2},1024),n(e,{class:"goods-tags"},{default:i((()=>[(f(!0),t(u,null,_(a.relation_list,((a,l)=>(f(),m(e,{class:"tag-box",key:l},{default:i((()=>[n(o,{class:"goods-tag"},{default:i((()=>[g(C(a.relation_goods_name||"未命名商品"),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)])),_:2},1032,["id","style","onClick"])))),128))])),_:1},8,["style"]),n(e,{class:"loading-state"},{default:i((()=>[L.value?(f(),m(o,{key:0},{default:i((()=>[g("加载中...")])),_:1})):v("",!0),W.value?(f(),m(o,{key:1,class:"no-more"},{default:i((()=>[g("没有更多了")])),_:1})):v("",!0)])),_:1})])),_:1}),O.value?(f(),m(z,{key:1,visible:O.value,"onUpdate:visible":l[2]||(l[2]=a=>O.value=a)},{default:i((()=>[n(e,{class:"filter-modal"},{default:i((()=>[n(e,{class:"modal-header"},{default:i((()=>[n(o,{class:"title"},{default:i((()=>[g("筛选条件")])),_:1}),n(o,{class:"close",onClick:l[1]||(l[1]=a=>O.value=!1)},{default:i((()=>[g("×")])),_:1})])),_:1}),n(e,{class:"filter-items"},{default:i((()=>[n(e,{class:"filter-item"},{default:i((()=>[n(y,{mode:"fill",onSelect:X,width:"450rpx"})])),_:1}),A.value?(f(),m(e,{key:0,class:"filter-item"},{default:i((()=>[n(q,{dataList:U.value,onSelect:aa,multiple:""},null,8,["dataList"])])),_:1})):v("",!0)])),_:1}),n(e,{class:"action-btns"},{default:i((()=>[n(r,{class:"btn reset",onClick:la},{default:i((()=>[g("重置")])),_:1}),n(r,{class:"btn confirm submit-btn",onClick:ea},{default:i((()=>[g("确认")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])):v("",!0)])),_:1})])),_:1})],64)}}},[["__scopeId","data-v-951c824e"]]);export{F as default};
