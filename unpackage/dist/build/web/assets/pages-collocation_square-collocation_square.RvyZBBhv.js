import{g as a,ah as l,ac as e,h as o,j as s,d as t,k as c,a as n,w as i,F as u,l as d,ai as r,o as f,v as _,r as v,c as m,b as g,V as p,aj as h,_ as y,f as k,e as w,H as b,S as x,t as j,n as C,i as $}from"./index-CfMR_IzQ.js";import{_ as S}from"./common-search.CyUK2jK_.js";import{r as P}from"./uni-app.es.5AkhYBbN.js";import{_ as T,a as q}from"./common-modal.B0laTwpj.js";import{_ as z}from"./common-page.Di5NKMGw.js";import{w as E}from"./config.BX5UpUDr.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./cancel.CnEdunnH.js";const H=F({__name:"collocation_square",setup(F){const H=a([]),L=a(!1),Q=a(!1),A=a(1),B=a(0),G=a(0),I=l([0,0]),M=a(!1),O=a(""),R=a([]),U=h(),V=a(null),W=a([]),D=a(null),J=a=>{const l=H.value[a];return l.position?{left:`${l.position.left}px`,top:`${l.position.top}px`,width:`${G.value}px`}:{}},K=a=>{if(console.log("进入计算布局逻辑"),!a)return void console.log("无法获取instance");if(console.log("获取成功"),!H.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(a);const l=y().in(a.proxy);console.log("获取到query");const e=H.value.map(((a,e)=>new Promise((a=>{l.select(`#card-${e}`).boundingClientRect((l=>{a({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),I[0]=0,I[1]=0;const a=await Promise.all(e);a.length?(a.forEach((({index:a,rect:l})=>{if(!l)return void console.error(`卡片${a}元素查询失败`);const e=H.value[a],o=I[0]<=I[1]?0:1,s=o*(G.value+10),t=I[o]+10;I[o]=t+l.height,e.position={left:s,top:t}})),B.value=Math.max(...I)+20):console.warn("未查询到任何卡片元素")}))};e((()=>{const a=o();G.value=(a.windowWidth-30)/2}));const N=async(a=!1)=>{if(L.value||Q.value)console.log("正在加载中或没有更多了");else try{L.value=!0,a&&(H.value=[],A.value=1);const l={page:A.value,page_size:10,filter_goods_id_list:W.value.map((a=>a.goods_id))},e=await d({url:`${E}/collocation-list`,method:"POST",data:l});if("success"===e.data.status){const l=e.data.data,o=l.collocation_relation_list;H.value=a?o:[...H.value,...o],Q.value=l.total<=10*A.value,A.value++,console.log("等待next tick"),await r(),console.log("等待完成"),K(U),setTimeout((()=>{console.log("二次计算布局"),K(U)}),500)}}finally{L.value=!1}},X=()=>M.value=!0,Y=(a,l)=>{V.value={id:a,name:l},O.value=l,a&&Z(a)},Z=async a=>{try{const l=await d({url:`${E}/goods-name-list?id=${a}`,method:"GET"});console.log("商品列表:",l.data),"success"===l.data.status&&(R.value=l.data.data)}catch(l){console.error("加载商品失败:",l)}},aa=(a,l)=>{if(a){for(const l of W.value)if(l.goods_id===a)return;D.value={goods_id:a,goods_name:l}}else console.log("未选择有效goods")},la=()=>{V.value=null,O.value="",W.value=[],R.value=[]};const ea=async()=>{W.value.push(D.value),M.value=!1,Q.value=!1,await N(!0)},oa=()=>{Q.value||N()};return e(N),(a,l)=>{const e=k,o=w,d=b,r=$,h=x,y=P(s("common-search"),S),E=P(s("custom-picker"),T),F=P(s("common-modal"),q),A=P(s("common-page"),z);return f(),t(u,null,[c("meta",{name:"theme-color",content:"#f5f5f5"}),n(A,{head_color:"#f5f5f5"},{default:i((()=>[n(e,{class:"container"},{default:i((()=>[_("",!0),n(e,{class:"filter-bar"},{default:i((()=>[n(e,{class:"filter-tags",onClick:X},{default:i((()=>[n(e,{class:"selected-goods"},{default:i((()=>[(f(!0),t(u,null,v(W.value,(a=>(f(),m(e,{key:a.goods_id,class:"tag"},{default:i((()=>[g(j(a.goods_name)+" ",1),n(o,{class:"remove",onClick:l=>{return e=a.goods_id,event.stopPropagation(),W.value=W.value.filter((a=>a.goods_id!==e)),Q.value=!1,void N(!0);var e}},{default:i((()=>[g("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1}),W.value.length?_("",!0):(f(),m(o,{key:0,class:"tip"},{default:i((()=>[g("当前无筛选条件")])),_:1}))])),_:1}),n(d,{class:"submit-btn",onClick:l[0]||(l[0]=a=>N(!0))},{default:i((()=>[g("筛选")])),_:1})])),_:1}),n(h,{class:"card-list","scroll-y":"",onScrolltolower:oa,"show-scrollbar":!1},{default:i((()=>[n(e,{class:"cards-container",style:p({height:B.value+"px"})},{default:i((()=>[(f(!0),t(u,null,v(H.value,((a,l)=>(f(),m(e,{key:a.collocation_id,class:"card",id:"card-"+l,style:p(J(l)),onClick:l=>{return e=a.collocation_id,o=a.origin,void C({url:"/pages/collocation_share/collocation_share?collocation_id="+e+"&origin="+o});var e,o}},{default:i((()=>[n(r,{src:a.image_urls[0],mode:"aspectFill",class:"card-image","lazy-load":""},null,8,["src"]),n(e,{class:"card-content"},{default:i((()=>[n(o,{class:"title"},{default:i((()=>[g(j(a.title),1)])),_:2},1024),n(o,{class:"desc"},{default:i((()=>[g(j(a.content),1)])),_:2},1024),n(e,{class:"goods-tags"},{default:i((()=>[(f(!0),t(u,null,v(a.relation_list,((a,l)=>(f(),m(e,{class:"tag-box",key:l},{default:i((()=>[n(o,{class:"goods-tag"},{default:i((()=>[g(j(a.relation_goods_name||"未命名商品"),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)])),_:2},1032,["id","style","onClick"])))),128))])),_:1},8,["style"]),n(e,{class:"loading-state"},{default:i((()=>[L.value?(f(),m(o,{key:0},{default:i((()=>[g("加载中...")])),_:1})):_("",!0),Q.value?(f(),m(o,{key:1,class:"no-more"},{default:i((()=>[g("没有更多了")])),_:1})):_("",!0)])),_:1})])),_:1}),M.value?(f(),m(F,{key:1,visible:M.value,"onUpdate:visible":l[2]||(l[2]=a=>M.value=a)},{default:i((()=>[n(e,{class:"filter-modal"},{default:i((()=>[n(e,{class:"modal-header"},{default:i((()=>[n(o,{class:"title"},{default:i((()=>[g("筛选条件")])),_:1}),n(o,{class:"close",onClick:l[1]||(l[1]=a=>M.value=!1)},{default:i((()=>[g("×")])),_:1})])),_:1}),n(e,{class:"filter-items"},{default:i((()=>[n(e,{class:"filter-item"},{default:i((()=>[n(y,{mode:"fill",onSelect:Y,width:"450rpx"})])),_:1}),V.value?(f(),m(e,{key:0,class:"filter-item"},{default:i((()=>[n(E,{dataList:R.value,onSelect:aa,multiple:""},null,8,["dataList"])])),_:1})):_("",!0)])),_:1}),n(e,{class:"action-btns"},{default:i((()=>[n(d,{class:"btn reset",onClick:la},{default:i((()=>[g("重置")])),_:1}),n(d,{class:"btn confirm submit-btn",onClick:ea},{default:i((()=>[g("确认")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])):_("",!0)])),_:1})])),_:1})],64)}}},[["__scopeId","data-v-951c824e"]]);export{H as default};
