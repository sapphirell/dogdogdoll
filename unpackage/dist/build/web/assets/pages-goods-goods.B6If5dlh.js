import{r as e,m as t,N as a,o as s,a as l,b as o,c as n,w as i,d,e as c,k as u,F as r,l as _,C as f,t as m,v as p,A as g,j as v,f as h,g as y,M as k,h as b,p as w,_ as C,D as x,u as S,$ as I,B as T,a0 as z,T as $,n as j,i as F,G as A,S as D,a1 as E,J as L,E as M}from"./index-6ojkiy1R.js";import{_ as G}from"./uni-icons.C75VRGWb.js";import{r as O}from"./uni-app.es.BMFd5FAr.js";import{_ as P}from"./common-modal.Biav_mER.js";import{w as R,c as q,b as N}from"./config.Bhvn_Gfs.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{_ as V,a as B}from"./comment-input.WXDjx_KR.js";import{_ as H}from"./right2.s_X9TKoF.js";const J=U({__name:"item-impression",props:{target_id:{type:String,required:!0},type:{type:String,required:!0},goodsType:{type:Number,required:!0}},setup(w){const C=w,x=e([]),S=e([]),I=e(0),T=e(""),z=e(!1),$=e(null),j=t((()=>{const e={};x.value.forEach((t=>{e[t.content]=t}));return[...S.value.map((t=>e[t]?{...e[t],isDefault:!0}:{content:t,count:0,selected:!1,isDefault:!0})),...x.value.filter((e=>!S.value.includes(e.content)))].sort(((e,t)=>t.count-e.count))})),F=async()=>{try{$.value=await q();const e=await p({url:`${R}/impression/counts`,method:"GET",data:{target_id:parseInt(C.target_id,10),type_id:parseInt(C.type,10)}}),t=await p({url:`${R}/with-state/impression/status`,method:"GET",data:{target_id:parseInt(C.target_id,10),type_id:parseInt(C.type,10)},header:{Authorization:v("token")}});if(200===e.statusCode&&"success"===e.data.status){const a=e.data.data;I.value=a.reduce(((e,t)=>e+t.count),0);const s=200===t.statusCode&&"success"===t.data.status?t.data.data.map((e=>e.id)):[];x.value=a.map((e=>({...e,selected:s.includes(e.id)})))}}catch(e){console.error("获取表态数据失败:",e),g({title:"获取表态数据失败",icon:"none"})}},A=(e,t,a=null)=>{const s=x.value.findIndex((t=>t.id===e.id||t.content===e.content));if(-1===s&&t){const t={id:a,content:e.content,count:1,selected:!0};return x.value=[...x.value,t],void I.value++}if(-1!==s){const e=[...x.value],l={...e[s]};t?(l.selected=!0,l.count=(l.count||0)+1,a&&(l.id=a),I.value++):(l.selected=!1,l.count=Math.max(0,l.count-1),I.value--),e[s]=l,x.value=e}},D=()=>{$.value?(T.value="",z.value=!0):g({title:"请先登录",icon:"none"})},E=()=>{z.value=!1},L=async()=>{if(T.value.trim())try{const e=await p({url:`${R}/with-state/impression/add`,method:"POST",header:{Authorization:v("token"),"Content-Type":"application/json"},data:{target_id:parseInt(C.target_id,10),type_id:parseInt(C.type,10),content:T.value.trim()}});200===e.statusCode&&"success"===e.data.status&&(x.value=[...x.value,{id:e.data.data.impression_id,content:T.value.trim(),count:1,selected:!0}],I.value++,z.value=!1,g({title:"添加成功",icon:"success"}))}catch(e){console.error("添加表态失败:",e),g({title:"添加表态失败",icon:"none"})}else g({title:"请输入表态内容",icon:"none"})};return a((()=>[C.target_id,C.type]),F,{immediate:!0}),s((()=>{(async()=>{try{let e=9;switch(C.goodsType){case"整体":e=1;break;case"单头":e=2;break;case"娃衣":e=3;break;case"眼珠":e=4;break;case"假发":e=5;break;default:e=9}const t=await p({url:`${R}/impression/default`,method:"GET",data:{type:e}});200===t.statusCode&&"success"===t.data.status?S.value=t.data.data:(console.error("获取默认表态失败:",t.data),g({title:"获取默认表态失败",icon:"none"}))}catch(e){console.error("获取默认表态失败:",e),g({title:"获取默认表态失败",icon:"none"})}})(),F()})),(e,t)=>{const a=h,s=y,w=k,x=b,S=O(l("common-modal"),P);return o(),n(s,{class:"impression-container"},{default:i((()=>[d(s,{class:"impression-header"},{default:i((()=>[d(a,{class:"title"},{default:i((()=>[c("你对它的印象怎样？")])),_:1}),d(a,{class:"subtitle"},{default:i((()=>[c("（轻触表态）")])),_:1})])),_:1}),d(s,{class:"impression-list"},{default:i((()=>[(o(!0),u(r,null,_(j.value,((e,t)=>(o(),n(s,{key:e.id||"default-"+e.content,class:f(["impression-item",{active:e.selected}]),onClick:t=>(async e=>{if($.value)try{const t={target_id:parseInt(C.target_id,10),type_id:parseInt(C.type,10)};if(e.isDefault&&!e.id?t.content=e.content:t.impression_id=e.id,e.selected){const t=await p({url:`${R}/with-state/impression/remove`,method:"POST",header:{Authorization:v("token"),"Content-Type":"application/json"},data:{impression_id:e.id}});200===t.statusCode&&"success"===t.data.status&&A(e,!1)}else{const a=await p({url:`${R}/with-state/impression/add`,method:"POST",header:{Authorization:v("token"),"Content-Type":"application/json"},data:t});200===a.statusCode&&"success"===a.data.status&&A(e,!0,a.data.data.impression_id)}}catch(t){console.error("操作失败:",t),g({title:"操作失败",icon:"none"})}else g({title:"请先登录",icon:"none"})})(e)},{default:i((()=>[d(a,{class:"impression-text"},{default:i((()=>[c(m(e.content),1)])),_:2},1024),d(a,{class:"impression-count"},{default:i((()=>[c(m(e.count),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128)),d(s,{class:"add-impression",onClick:D},{default:i((()=>[d(a,{class:"plus-icon"},{default:i((()=>[c("+")])),_:1}),d(a,{class:"add-text"},{default:i((()=>[c("添加表态")])),_:1})])),_:1})])),_:1}),d(S,{visible:z.value,"onUpdate:visible":t[1]||(t[1]=e=>z.value=e),width:"80%",top:"30%"},{default:i((()=>[d(s,{class:"modal-content"},{default:i((()=>[d(a,{class:"modal-title"},{default:i((()=>[c("添加新表态")])),_:1}),d(w,{class:"input-field",modelValue:T.value,"onUpdate:modelValue":t[0]||(t[0]=e=>T.value=e),placeholder:"请输入表态内容","placeholder-style":"color: #aaa;",onConfirm:L},null,8,["modelValue"]),d(s,{class:"modal-actions"},{default:i((()=>[d(x,{class:"cancel-btn",onClick:E},{default:i((()=>[c("取消")])),_:1}),d(x,{class:"confirm-btn",onClick:L},{default:i((()=>[c("确定")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])])),_:1})}}},[["__scopeId","data-v-c6822f5f"]]),K=U({__name:"goods",props:["goods_id"],setup(t){const a=t;w(),e(!1),e(!1),e("");const s=e(null),k=e(null);e(1);let b=e({}),P=e({}),U=e(1),K=e(!1),W=e(!1);const Y=e(400),Q=e([]),X=({parent:e,target:t})=>{var a;console.log("parent",e),console.log("target",t);let s=e;null!=t&&(s=t),b.value.id!=s.id?(console.log("item",s),b.value=s,null==(a=k.value)||a.focusInput()):b.value={}},Z=({content:e,replyInfo:t,origin:l})=>{let o=v("token");if(!N.isLogin)return void g({title:"请先登录",icon:"none"});console.log("reply_info",t);const n={content:e,origin:l,target_id:parseInt(a.goods_id),type:2,...t.id&&{reply_id:t.id,reply_for:t.comment,reply_user_id:t.user_id,parent_id:t.parent_id>0?t.parent_id:t.id}};p({url:R+"/with-state/add-comment",method:"POST",header:{Authorization:o},data:n,success:e=>{var t,a;if("success"==e.data.status){const l=e.data.data;0===l.parent_id?null==(t=s.value)||t.addNewComment(l):null==(a=s.value)||a.addReplyComment(l),g({title:"评论成功",icon:"success"})}else g({title:e.data.msg,icon:"none"})},fail:e=>{g({title:"网络请求失败",icon:"none"})}})};function ee(e){console.log(e.detail.current),U.value=e.detail.current+1}function te(){p({url:R+"/goods?id="+a.goods_id,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),P.value=e.data.data},fail:e=>{console.log(e),g({title:"网络请求失败",icon:"none"})},complete:()=>{I()}})}function ae(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}function se(e){if(!e||e<=0)return"未知";const t=new Date(1e3*e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}function le(){let e=v("token");""!=e&&p({url:R+"/with-state/hasLike?id="+a.goods_id+"&type=1",method:"POST",header:{Authorization:e},success:e=>{console.log(e.data),"success"==e.data.status?e.data.data.id>0?K.value=!0:K.value=!1:g({title:e.data.msg,icon:"none"})},fail:e=>{console.log(e),g({title:"网络请求失败",icon:"none"})}})}function oe(){j({url:"/pages/collocation/collocation?goods_id="+a.goods_id+"&brand_id="+P.value.brand_id+"&goods_name="+P.value.name+"&brand_name="+P.value.brand_name+"&type="+P.value.type})}function ne(e){if(!e)return"";return e.split(",")[0].trim()}return C({title:"加载中"}),te(),p({url:R+"/goods-collocation?goods_id="+a.goods_id,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),W.value=e.data.data},fail:e=>{console.log(e),g({title:"网络请求失败",icon:"none"})}}),q().then((e=>{console.log(e),le()})),(e,t)=>{const w=O(l("uni-icons"),G),C=h,I=y,q=F,ie=M,de=A,ce=O(l("item-impression"),J),ue=D,re=O(l("comment-list"),V),_e=O(l("comment-input"),B);return x(P).name?(o(),n(I,{key:0,class:"goods-detail-container"},{default:i((()=>[T("meta",{name:"theme-color",content:"#F8F8F8"}),d(I,{class:"swiper-container"},{default:i((()=>[d(I,{class:"heart",onClick:t[0]||(t[0]=e=>function(){let e=v("token");if(!N.isLogin)return void g({title:"请先登录",icon:"none"});let t={id:parseInt(a.goods_id),type:1},s=K.value?"/with-state/unlike":"/with-state/add-like";p({url:R+s,method:"POST",header:{Authorization:e},data:t,success:e=>(console.log(e.data),"success"==e.data.status?(g({title:"操作成功",icon:"success"}),K.value=!K.value,le(),void te()):void g({title:e.data.msg,icon:"none"})),fail:e=>{console.log(e),g({title:"网络请求失败",icon:"none"})}})}())},{default:i((()=>[d(w,{type:x(K)?"heart-filled":"heart",size:"28",color:"#ff4d4f"},null,8,["type"]),d(C,{class:"num",style:{color:"#ff4d4f"}},{default:i((()=>[c(m(ae(x(P).goods_like_count)),1)])),_:1})])),_:1}),d(de,{interval:3e3,duration:200,onChange:ee,class:"banner-swiper",style:z({height:Y.value+"px"})},{default:i((()=>[(o(!0),u(r,null,_(x(P).goods_images,((e,t)=>(o(),n(ie,{key:t,class:"swiper-item-container"},{default:i((()=>[d(I,{class:"swiper-item"},{default:i((()=>[d(q,{src:e,mode:"widthFix",class:f("swiper-image-"+t),onClick:e=>{L({current:P.value.goods_images.index,urls:P.value.goods_images})},onLoad:e=>function(e){console.log("图片加载完成",e);const t=E();setTimeout((()=>{t.select(`.swiper-image-${e}`).boundingClientRect((t=>{try{if(!t)return void console.warn("未找到图片元素");console.log(t),Q.value[e]=t.height;const a=Q.value.filter((e=>e>0));if(0===a.length)return;Y.value=Math.max(...a)}catch(a){console.error("高度计算异常:",a)}})).exec()}),20)}(t)},null,8,["src","class","onClick","onLoad"])])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["style"]),d(I,{class:"swiper-index"},{default:i((()=>[d(C,null,{default:i((()=>[c(m(x(U))+" / "+m(x(P).goods_images.length),1)])),_:1})])),_:1})])),_:1}),d(I,{class:"goods-info"},{default:i((()=>[d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("名称")])),_:1}),d(q,{src:x(P).goods_name_image,mode:"heightFix",style:{height:"40rpx"}},null,8,["src"])])),_:1}),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("类型")])),_:1}),d(C,{class:"value"},{default:i((()=>[c(m(x(P).type),1)])),_:1})])),_:1}),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("初贩定价")])),_:1}),x(P).goods_price_image?(o(),n(q,{key:0,src:x(P).goods_price_image,mode:"heightFix",style:{height:"40rpx"}},null,8,["src"])):x(P).goods_sales&&x(P).goods_sales.length>0?(o(),n(C,{key:1,class:"value"},{default:i((()=>[c(m(x(P).goods_sales[0].sub_amount+x(P).goods_sales[0].fin_amount)+" "+m(x(P).goods_sales[0].currency),1)])),_:1})):(o(),n(C,{key:2,class:"value"},{default:i((()=>[c("未知")])),_:1}))])),_:1}),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("初贩时间")])),_:1}),d(C,{class:"value"},{default:i((()=>[c(m(x(P).sub_time1>0?se(x(P).sub_time1):"未知"),1)])),_:1})])),_:1}),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("尺寸")])),_:1}),d(C,{class:"value"},{default:i((()=>[c(m(x(P).size)+" / "+m(x(P).size_detail),1)])),_:1})])),_:1}),"单体"===x(P).type||"整体"===x(P).type||"单头"===x(P).type?(o(),n(I,{key:0,class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("可选体型")])),_:1}),d(C,{class:"value"},{default:i((()=>[c(m(x(P).body_size||"未知"),1)])),_:1})])),_:1})):S("",!0),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("可选颜色")])),_:1}),d(C,{class:"value"},{default:i((()=>[c(m(x(P).skin),1)])),_:1})])),_:1}),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("制作方")])),_:1}),x(P).goods_brand_name_image?(o(),n(q,{key:0,onClick:t[1]||(t[1]=e=>{return t=x(P).brand_id,void j({url:"/pages/brand/brand?brand_id="+t});var t}),src:x(P).goods_brand_name_image,mode:"heightFix",style:{height:"40rpx"}},null,8,["src"])):S("",!0)])),_:1}),d(I,{class:"info-item"},{default:i((()=>[d(C,{class:"label"},{default:i((()=>[c("备注")])),_:1}),d(C,{class:"value"},{default:i((()=>[c(m(x(P).desc_content||"暂无备注信息"),1)])),_:1})])),_:1})])),_:1}),x(P).goods_sales&&x(P).goods_sales.length>0?(o(),n(I,{key:0,class:"sales-info"},{default:i((()=>[d(C,{class:"section-title"},{default:i((()=>[c("贩售情报")])),_:1}),d(I,{class:"sales-list"},{default:i((()=>[(o(!0),u(r,null,_(x(P).goods_sales,((e,t)=>(o(),n(I,{key:e.id,class:"sale-item"},{default:i((()=>[d(I,{class:"sale-header"},{default:i((()=>[d(C,{class:"sale-type"},{default:i((()=>[c(m(e.sale_type),1)])),_:2},1024),d(C,{class:"sale-price"},{default:i((()=>[c(m(e.sub_amount+e.fin_amount)+" "+m(e.currency),1)])),_:2},1024)])),_:2},1024),d(I,{class:"sale-period"},{default:i((()=>[d(C,null,{default:i((()=>[c(m(se(e.sub_time)),1)])),_:2},1024),e.sub_time_end>0?(o(),n(C,{key:0,class:"separator"},{default:i((()=>[c("至")])),_:1})):S("",!0),e.sub_time_end>0?(o(),n(C,{key:1},{default:i((()=>[c(m(se(e.sub_time_end)),1)])),_:2},1024)):(o(),n(C,{key:2,class:"separator"},{default:i((()=>[c("开定")])),_:1}))])),_:2},1024),d(I,{class:"sale-size"},{default:i((()=>[d(C,null,{default:i((()=>[c(m(e.size)+" · "+m(e.size_detail),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):(o(),n(I,{key:1,class:"no-sales"},{default:i((()=>[d(C,{class:"section-title"},{default:i((()=>[c("贩售情报")])),_:1}),d(C,{class:"empty-text"},{default:i((()=>[c("暂无贩售信息")])),_:1})])),_:1})),d(ce,{target_id:a.goods_id,type:"2","goods-type":x(P).type},null,8,["target_id","goods-type"]),d(I,{class:"collocation-section"},{default:i((()=>[d(I,{class:"section-header"},{default:i((()=>[d(C,{class:"section-title"},{default:i((()=>[c("搭配参考")])),_:1}),d(I,{class:"more-link",onClick:oe},{default:i((()=>[d(C,null,{default:i((()=>[c("查看更多")])),_:1}),d(q,{src:H})])),_:1})])),_:1}),d(ue,{"scroll-x":"true",class:"collocation-list"},{default:i((()=>[(o(!0),u(r,null,_(x(W).collocation_relation_list,(e=>(o(),n(I,{key:e.collocation_id,class:"collocation-item",onClick:t=>{return a=e.collocation_id,s=e.relation_origin,void j({url:"/pages/collocation_share/collocation_share?collocation_id="+a+"&origin="+s});var a,s}},{default:i((()=>[d(q,{src:ne(e.image_urls),mode:"aspectFill"},null,8,["src"])])),_:2},1032,["onClick"])))),128))])),_:1}),d(I,{onClick:oe,class:"upload-collocation"},{default:i((()=>[d(q,{src:"/assets/paper_plane-DW2p-K8L.png"}),d(C,null,{default:i((()=>[c("上传搭配参考帮助他人")])),_:1})])),_:1})])),_:1}),d(I,{class:"comment-section"},{default:i((()=>[d(re,{ref_key:"commentListRef",ref:s,type:2,"relation-id":parseInt(a.goods_id),onReply:X},null,8,["relation-id"])])),_:1}),d(_e,{ref_key:"commentInputRef",ref:k,"reply-info":x(b),"target-id":a.goods_id,onSubmit:Z,"onUpdate:replyInfo":t[2]||(t[2]=e=>$(b)?b.value=e:b=e)},null,8,["reply-info","target-id"]),d(I,{class:"bottom-placeholder"})])),_:1})):S("",!0)}}},[["__scopeId","data-v-d89efcee"]]);export{K as default};
