import{r as e,N as t,k as l,a,b as o,c as s,w as u,H as n,p as i,d as c,v as d,F as r,x as p,D as m,e as f,t as v,j as _,A as h,q as y,g as k,f as g,aq as b,a0 as C,aC as w,ar as I,h as T,av as x,o as A,n as j,i as z,l as S,aD as $,aE as N,aF as F}from"./index-BFzTDSoz.js";import{_ as q}from"./uni-icons.COaeasi-.js";import{_ as M,r as V}from"./_plugin-vue_export-helper.CXFOpRdI.js";import{w as B,b as D,g as O}from"./view-logs.yEAac7W9.js";import{_ as E}from"./common-modal.DWKlFhUY.js";const P=M({__name:"attitude-widget",props:{targetId:Number,type:Number,attitudeStatus:{type:Number,default:0},attitudeCounts:{type:Object,default:()=>({})}},emits:["change"],setup(b,{emit:C}){const w=b,I=C,T=e(!1),x=e(w.attitudeStatus),A=e({}),j=e([{emoji:"😝",value:1,label:"很有趣"},{emoji:"😨",value:2,label:"这个..."},{emoji:"🤤",value:3,label:"我也想要"},{emoji:"🤦‍♀️",value:4,label:"难以直视"},{emoji:"🤡",value:5,label:"谁的鼻子掉了?"}]);t((()=>w.attitudeCounts),(e=>{j.value.forEach((t=>{A.value[t.value]=Number(e[t.value]??0)})),A.value={...A.value}}),{immediate:!0,deep:!0});const z=l((()=>j.value.map((e=>({...e,count:A.value[e.value]||0}))).filter((e=>e.count>0||e.value===x.value)).filter((e=>e.count>0)))),S=()=>{T.value=!T.value};return(e,t)=>{const l=k,b=g,C=V(a("uni-icons"),q);return o(),s(l,{class:"attitude-container"},{default:u((()=>[T.value?(o(),s(l,{key:0,class:"mask",onClick:n(S,["stop"]),onTouchmove:t[0]||(t[0]=n((()=>{}),["stop","prevent"]))})):i("",!0),c(l,{class:"counts-and-expand"},{default:u((()=>[c(l,{class:"global-counts"},{default:u((()=>[(o(!0),d(r,null,p(z.value,(e=>(o(),s(l,{key:e.value,class:m(["count-item",{active:x.value===e.value,"has-count":e.count>0}])},{default:u((()=>[c(b,{class:"emoji"},{default:u((()=>[f(v(e.emoji),1)])),_:2},1024),c(b,{class:"count"},{default:u((()=>[f(v(e.count),1)])),_:2},1024)])),_:2},1032,["class"])))),128))])),_:1}),c(l,{class:"expand-btn",onClick:n(S,["stop"])},{default:u((()=>[c(C,{type:T.value?"arrowup":"plus",size:"16",color:"#888"},null,8,["type"]),c(b,{class:"btn-text"},{default:u((()=>[f(v(T.value?"收起":"表态"),1)])),_:1})])),_:1})])),_:1}),T.value?(o(),s(l,{key:1,class:"attitude-panel"},{default:u((()=>[(o(!0),d(r,null,p(j.value,(e=>(o(),s(l,{key:e.value,class:m(["attitude-btn",{active:x.value===e.value}]),onClick:n((t=>(async e=>{try{const t=_("token");if(console.log(t),!t)return void h({title:"请先登录",icon:"none"});const l=x.value===e,a=`${B}/with-state/attitude/${l?"remove":"add"}`;"success"===(await y({url:a,method:"POST",data:{target_id:w.targetId,type:w.type,action_type:e},header:{Authorization:t}})).data.status&&(l?(A.value[e]--,x.value=0):(x.value>0&&A.value[x.value]--,x.value=e,A.value[e]=(A.value[e]||0)+1),I("change",{status:x.value,counts:{...A.value}}),T.value=!1)}catch(t){console.log(t),h({title:"操作失败",icon:"none"})}})(e.value)),["stop"])},{default:u((()=>[c(b,{class:"emoji"},{default:u((()=>[f(v(e.emoji),1)])),_:2},1024),c(l,{class:"text-container"},{default:u((()=>[c(b,{class:"label"},{default:u((()=>[f(v(e.label),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})):i("",!0)])),_:1})}}},[["__scopeId","data-v-5c7aade7"]]),U=M({__name:"report-button",props:{reportType:{type:Number,required:!0},relationId:{type:Number,required:!0},buttonText:{type:String,default:"举报"},iconType:{type:String,default:""},iconSize:{type:Number,default:24},iconColor:{type:String,default:"#999"},themeColor:{type:String,default:"#64c6dc"},autoFocus:{type:Boolean,default:!1}},emits:["success","error","cancel","before-submit"],setup(l,{emit:n}){const i=l,x=n,A=e(!1),j=e([]),z=e(""),S=e(""),$=e(!1),N=async()=>{await(async()=>{try{const e=_("token"),t=await y({url:`${B}/report/reasons?type=${i.reportType}`,method:"GET",header:{Authorization:e}});return"success"===t.data.status?(j.value=t.data.data,!0):(h({title:"获取举报原因失败: "+(t.data.msg||""),icon:"none"}),!1)}catch(e){return h({title:"网络请求失败",icon:"none"}),!1}})()&&(z.value="",S.value="",A.value=!0)},F=async()=>{if(!$.value){$.value=!0;try{if(!z.value)return void h({title:"请选择举报原因",icon:"none"});x("before-submit",{type:i.reportType,relationId:i.relationId,reason:z.value,details:S.value});const e=_("token"),t={type:i.reportType,relation_id:i.relationId,reason:z.value,details:S.value};let l=`${B}/with-state/report/submit`;""==e&&(l=`${B}/report/submit`);const a=await y({url:l,method:"POST",header:{Authorization:e,"Content-Type":"application/json"},data:t,timeout:1e4});"success"===a.data.status?(h({title:"举报提交成功",icon:"success",duration:2e3}),A.value=!1,x("success",a.data)):(h({title:a.data.msg||"举报提交失败",icon:"none"}),x("error",a.data))}catch(e){h({title:"举报提交失败: "+(e.errMsg||"网络错误"),icon:"none"}),x("error",e)}finally{$.value=!1}}};return t(A,(e=>{e||x("cancel")})),(e,t)=>{const n=V(a("uni-icons"),q),i=g,_=k,h=w,y=I,x=T,$=V(a("common-modal"),E);return o(),d(r,null,[c(_,{class:"report-button",onClick:N},{default:u((()=>[b(e.$slots,"default",{},(()=>[c(_,{class:"default-button horizontal"},{default:u((()=>[c(n,{"v-if":""!==l.iconType,type:l.iconType,size:l.iconSize,color:l.iconColor},null,8,["v-if","type","size","color"]),c(i,{class:"button-text"},{default:u((()=>[f(v(l.buttonText),1)])),_:1})])),_:1})]),!0)])),_:3}),c($,{visible:A.value,"onUpdate:visible":t[3]||(t[3]=e=>A.value=e),top:"10vh"},{default:u((()=>[c(_,{class:"report-dialog"},{default:u((()=>[c(_,{class:"dialog-header"},{default:u((()=>[c(i,{class:"dialog-title"},{default:u((()=>[f("举报内容")])),_:1}),c(n,{type:"closeempty",size:"24",color:"#999",onClick:t[0]||(t[0]=e=>A.value=!1)})])),_:1}),c(_,{class:"reason-list"},{default:u((()=>[(o(!0),d(r,null,p(j.value,(e=>(o(),s(_,{key:e.id,class:m(["reason-item",{selected:z.value===e.label}]),onClick:t=>(e=>{z.value===e?z.value="":z.value=e})(e.label)},{default:u((()=>[c(h,{value:e.label,checked:z.value===e.label,color:l.themeColor},null,8,["value","checked","color"]),c(i,{class:"reason-label"},{default:u((()=>[f(v(e.label),1)])),_:2},1024)])),_:2},1032,["onClick","class"])))),128))])),_:1}),c(_,{class:"details-box"},{default:u((()=>[c(y,{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=e=>S.value=e),placeholder:"请详细描述举报原因（选填）",class:"details-input",maxlength:"200",focus:l.autoFocus},null,8,["modelValue","focus"]),c(i,{class:"word-count"},{default:u((()=>[f(v(S.value.length)+"/200",1)])),_:1})])),_:1}),c(_,{class:"button-group"},{default:u((()=>[c(x,{class:"cancel-btn",onClick:t[2]||(t[2]=e=>A.value=!1)},{default:u((()=>[f("取消")])),_:1}),c(x,{class:"submit-btn",onClick:F,style:C({backgroundColor:l.themeColor})},{default:u((()=>[f("提交举报")])),_:1},8,["style"])])),_:1})])),_:1})])),_:1},8,["visible"])],64)}}},[["__scopeId","data-v-c773ae3c"]]),H=M({__name:"comment-list",props:{type:{type:Number,required:!0},relationId:{type:Number,required:!0}},emits:["reply"],setup(t,{expose:l,emit:n}){const b=t,C=e([]),w=e(1),I=e(0),T=e(!0);x({});const S=n,$=e(!1),N=(e,{status:t,counts:l})=>{e.attitudeStatus=t,e.attitudeCounts=l};l({addNewComment:e=>{C.value.unshift({...e,showAll:!1,localChildren:[],childTotal:0})},addReplyComment:e=>{const t=C.value.find((t=>t.id===e.parent_id));t&&(t.localChildren||(t.localChildren=[]),"number"!=typeof t.childTotal&&(t.childTotal=0),t.localChildren.unshift(e),t.childTotal+=1,!t.showAll&&t.childTotal<=5&&(t.showAll=!0))}}),A((()=>{G()}));const F=e=>!e.showAll&&e.localChildren.length>5?e.localChildren.slice(0,5):e.localChildren,M=async()=>{if(!$.value&&T.value)try{$.value=!0,w.value+=1,await G()}finally{$.value=!1}},O=async e=>{if(D.isLogin)try{const t=_("token"),l=`${B}/with-state/${e.user_like?"unlike":"add-like"}`,a=await y({url:l,method:"POST",header:{Authorization:t},data:{id:e.id,type:6}});"success"===a.data.status?(e.user_like=!e.user_like,e.user_like?e.like_count=(e.like_count||0)+1:e.like_count=Math.max(0,(e.like_count||0)-1),h({title:e.user_like?"点赞成功":"已取消点赞",icon:"none"})):h({title:a.data.msg||"操作失败",icon:"none"})}catch(t){console.error("点赞失败:",t),h({title:"操作失败",icon:"none"})}else h({title:"请先登录",icon:"none"})},E=e=>{j({url:"/pages/user_page/user_page?uid="+e})},H=e=>{const t=new Date(1e3*e);return`${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}`},R=e=>e.length>12?e.slice(0,12)+"...":e,G=async()=>{try{$.value=!0;let e=_("token");const t=await y({url:`${B}/get-comments`,data:{relation_id:b.relationId,type:b.type,page:w.value,page_size:10},header:{Authorization:e}});if("success"===t.data.status){const e=t.data.data,l=e.comment_list.map((e=>({...e,showAll:!1,localChildren:e.children||[],childTotal:e.childTotal||(e.children?e.children.length:0),attitudeStatus:e.user_attitude||0,attitudeCounts:e.attitude_counts||{1:e.count_1||0,2:e.count_2||0,3:e.count_3||0,4:e.count_4||0,5:e.count_5||0}})));1===w.value?C.value=l:C.value.push(...l),console.log("total",e.total),T.value=e.total>C.value.length,I.value=e.total,console.log("是否还有更多?",T.value)}}catch(e){h({title:"加载失败",icon:"none"})}finally{$.value=!1}},L=(e,t=null)=>{S("reply",{parent:e,target:t,relationId:b.relationId})},J=e=>e.childTotal>5&&!e.showAll,K=e=>e.childTotal-Math.min(e.localChildren.length,5);return(e,t)=>{const l=k,n=g,_=z,b=V(a("attitude-widget"),P),w=V(a("uni-icons"),q),x=V(a("report-button"),U);return o(),s(l,{class:"comment-container"},{default:u((()=>[C.value.length>0?(o(),s(l,{key:0,class:"comment-count"},{default:u((()=>[f(" 共"+v(I.value)+"条回复 ",1)])),_:1})):(o(),s(l,{key:1,class:"empty-tips"},{default:u((()=>[c(n,null,{default:u((()=>[f("-- 暂无回复 --")])),_:1})])),_:1})),(o(!0),d(r,null,p(C.value,(e=>(o(),s(l,{key:e.id,class:"comment-card"},{default:u((()=>[c(l,{class:"main-comment"},{default:u((()=>[c(_,{onClick:t=>E(e.uid),src:e.avatar,class:"avatar",mode:"aspectFill"},null,8,["onClick","src"]),c(l,{class:"content"},{default:u((()=>[c(l,{class:"header"},{default:u((()=>[c(n,{class:"username",onClick:t=>E(e.uid)},{default:u((()=>[f(v(R(e.username)),1)])),_:2},1032,["onClick"]),c(n,{class:"floor"},{default:u((()=>[f("#"+v(e.floor),1)])),_:2},1024)])),_:2},1024),c(n,{class:"comment-text",onClick:t=>L(e)},{default:u((()=>[f(v(e.comment),1)])),_:2},1032,["onClick"]),c(b,{"target-id":e.id,type:6,"attitude-status":e.attitudeStatus,"attitude-counts":e.attitudeCounts,onChange:t=>N(e,t)},null,8,["target-id","attitude-status","attitude-counts","onChange"]),c(l,{class:"footer"},{default:u((()=>[c(l,{class:"left-actions"},{default:u((()=>[c(n,{class:"time"},{default:u((()=>[f(v(H(e.created_at)),1)])),_:2},1024),c(l,{class:"like-container"},{default:u((()=>[c(l,{class:"like-btn",onClick:t=>O(e)},{default:u((()=>[c(w,{type:e.user_like?"hand-up-filled":"hand-up",size:"18",color:e.user_like?"rgb(100 198 220)":"#999"},null,8,["type","color"]),c(n,{class:m(["like-count",{liked:e.user_like}])},{default:u((()=>[f(v(e.like_count||0),1)])),_:2},1032,["class"])])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),c(l,{class:"right-actions"},{default:u((()=>[c(n,{class:"reply-btn",onClick:t=>L(e)},{default:u((()=>[f("回复")])),_:2},1032,["onClick"]),c(x,{"report-type":5,"relation-id":e.id,"button-text":"举报","icon-color":"#999","theme-color":"#64c6dc"},null,8,["relation-id"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024),e.localChildren&&e.localChildren.length?(o(),s(l,{key:0,class:"sub-comments"},{default:u((()=>[(o(!0),d(r,null,p(F(e),((t,a)=>(o(),s(l,{key:t.id,class:"sub-comment"},{default:u((()=>[c(_,{onClick:e=>E(t.uid),src:t.avatar,class:"avatar",mode:"aspectFill"},null,8,["onClick","src"]),c(l,{class:"content"},{default:u((()=>[c(l,{class:"header"},{default:u((()=>[c(n,{onClick:e=>E(t.uid),class:"username"},{default:u((()=>[f(v(R(t.username)),1)])),_:2},1032,["onClick"]),t.reply_for?(o(),s(n,{key:0,class:"reply-to"},{default:u((()=>[f("@"+v(t.reply_for),1)])),_:2},1024)):i("",!0)])),_:2},1024),c(n,{class:"comment-text",onClick:t=>L(e)},{default:u((()=>[f(v(t.comment),1)])),_:2},1032,["onClick"]),c(b,{"target-id":t.id,type:6,"attitude-status":e.attitudeStatus,"attitude-counts":e.attitudeCounts,onChange:t=>N(e,t)},null,8,["target-id","attitude-status","attitude-counts","onChange"]),c(l,{class:"footer"},{default:u((()=>[c(l,{class:"left-actions"},{default:u((()=>[c(n,{class:"time"},{default:u((()=>[f(v(H(t.created_at)),1)])),_:2},1024),c(l,{class:"like-container"},{default:u((()=>[c(l,{class:"like-btn",onClick:e=>O(t)},{default:u((()=>[c(w,{type:t.user_like?"hand-up-filled":"hand-up",size:"18",color:t.user_like?"rgb(100 198 220)":"#999"},null,8,["type","color"]),c(n,{class:m(["like-count",{liked:t.user_like}])},{default:u((()=>[f(v(t.like_count||0),1)])),_:2},1032,["class"])])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),c(l,{class:"right-actions"},{default:u((()=>[c(n,{class:"reply-btn",onClick:l=>L(e,t)},{default:u((()=>[f("回复")])),_:2},1032,["onClick"]),c(x,{"report-type":5,"relation-id":t.id,"button-text":"举报","icon-color":"#999","theme-color":"#64c6dc"},null,8,["relation-id"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),J(e)?(o(),s(l,{key:0,class:"load-more",onClick:t=>(async e=>{if(e.localChildren.length<e.childTotal){const l=Math.ceil(e.localChildren.length/5)+1;try{const t=await y({url:`${B}/get-comments-by-parent-id`,data:{parent_id:e.id,page:l}});"success"===t.data.status&&(e.localChildren=[...e.localChildren,...t.data.data.comment_list],e.childTotal=t.data.data.total,e.localChildren.length>=5&&!e.showAll&&(e.showAll=!0))}catch(t){h({title:"加载失败",icon:"none"})}}else e.showAll=!e.showAll})(e)},{default:u((()=>[c(n,null,{default:u((()=>[f("展开"+v(K(e))+"条回复",1)])),_:2},1024),c(w,{type:"arrow-down",size:"18",color:"#007AFF"})])),_:2},1032,["onClick"])):i("",!0)])),_:2},1024)):i("",!0)])),_:2},1024)))),128)),C.value.length>0?(o(),s(l,{key:2,class:"load-more-box"},{default:u((()=>[T.value?(o(),s(l,{key:0,class:m(["load-more-btn",{loading:$.value}]),onClick:M},{default:u((()=>[$.value?(o(),s(l,{key:1},{default:u((()=>[c(w,{type:"spinner-cycle",size:"16",color:"#888"})])),_:1})):(o(),s(l,{key:0},{default:u((()=>[c(n,null,{default:u((()=>[f(" 加载更多 ")])),_:1}),c(w,{type:"arrow-down",size:"18",color:"#007AFF"})])),_:1}))])),_:1},8,["class"])):(o(),s(l,{key:1,class:"no-more"},{default:u((()=>[c(n,null,{default:u((()=>[f("-- 没有更多了 --")])),_:1})])),_:1}))])),_:1})):i("",!0)])),_:1})}}},[["__scopeId","data-v-d5d885a8"]]),R=M({__name:"comment-input",props:{replyInfo:{type:Object,default:()=>({})},targetId:{type:String,required:!0},safeBottom:{type:Number,default:10}},emits:["submit","update:replyInfo"],setup(t,{expose:a,emit:s}){const n=t,i=e(null),p=e(!1),v=s,_=e(""),y=e(!1),g=e(0),b=S(),w=l((()=>{var e,t;let l=(null==(e=b.safeAreaInsets)?void 0:e.bottom)||10;console.log("底部安全距离1:",null==(t=b.safeAreaInsets)?void 0:t.bottom,"=>",l);let a=l+g.value;return console.log("底部最终距离2:",a),`${a}px`})),x=()=>{y.value=!0,p.value=!0},j=()=>{y.value=!1,p.value=!1},z=()=>{y.value=!1,p.value=!1,F()},q=()=>{if(!_.value.trim())return void h({title:"请输入评论内容",icon:"none"});let e=O();console.log("scene",e),v("submit",{content:_.value,target_id:n.targetId,type:4,replyInfo:n.replyInfo,origin:e}),_.value="",v("update:replyInfo",{})};return a({focusInput:()=>{p.value=!0}}),A((()=>{console.log("不注册键盘弹出事件")})),(e,l)=>{const a=k,s=I,n=T;return o(),d(r,null,[$(c(a,{class:"mask",onClick:z},null,512),[[N,y.value]]),c(a,{class:"bottom_tab","adjust-position":!1,style:C({paddingBottom:w.value})},{default:u((()=>[c(s,{"disable-default-padding":!0,focus:p.value,class:m(["comment_input unified-textarea",{expanded:p.value}]),ref_key:"inputRef",ref:i,modelValue:_.value,"onUpdate:modelValue":l[0]||(l[0]=e=>_.value=e),onFocus:x,onBlur:j,"adjust-position":!1,placeholder:t.replyInfo.username?"回复@"+t.replyInfo.username+" ":"写评论..."},null,8,["focus","class","modelValue","placeholder"]),c(n,{onClick:q},{default:u((()=>[f("写评论")])),_:1})])),_:1},8,["style"])],64)}}},[["__scopeId","data-v-0af4224c"]]);export{H as _,R as a,U as b};
