import{r as a,l as e,a3 as t,A as o,a as l,c as i,w as n,q as s,j as r,g as u,b as d,d as c,C as _,e as m,t as p,v,x as g,F as f,p as y,T as h,n as k,f as w,i as I,G as b,J as S,E as j}from"./index-I3aG4WZL.js";import{_ as C}from"./view-logs.C4HVuFxK.js";import{_ as $,c as x,a as L,r as T}from"./_plugin-vue_export-helper.DF4WgY5m.js";import{_ as E}from"./uni-icons.BQtdpjJ2.js";import{b as z,_ as A,a as D}from"./comment-input.CvkLMisZ.js";import{c as F,w as P,b as R}from"./config.BjeWXQ7P.js";import"./common-modal.-arcCNZ3.js";import"./switch-search.B16f2bGk.js";import"./goods-search.gE0Nx2pd.js";import"./search.CsIL0f2m.js";import"./cancel.CnEdunnH.js";import"./common-search.CQlKpRi4.js";import"./image.C3pSdXmG.js";const M=$({__name:"collocation_share",props:{collocation_id:{type:String,default:0},origin:{type:String,default:0}},setup($){const M=a({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),G=a({userName:"",avatar:""});e();const O=a(!0),J=a(!1),N=a(""),q=a(0),H=a(0);let K=a(!1);const U=a(null),Y=a(null);a(1);let B=a({});t({title:"搭配详情"});const Q=async(a,e)=>{var t;try{const l=await s({url:P+`/view-collocation?collocation_id=${a}&origin=${e}`});if("success"!==l.data.status)return void W(l.data.msg||"数据加载失败");const i={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async a=>{try{const e=a.relation_goods_id>0?await(a=>new Promise(((e,t)=>{a&&0!==a?s({url:`${P}/goods?id=${a}`,method:"GET",timeout:5e3,success:a=>{"success"===a.data.status?e(a.data.data):t(a.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),o({title:"网络请求失败",icon:"none"}),t(a)}}):t("无效的商品ID")})))(a.relation_goods_id):null;return{...a,goodsInfo:e,imageLoaded:!!e,imageError:!e}}catch(e){return console.error("商品信息获取失败:",e),{...a,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};M.value=i,(null==(t=l.data.data)?void 0:t.uid)&&await V(l.data.data.uid)}catch(l){W("数据加载失败")}finally{O.value=!1}},V=async a=>{try{const e=await s({url:`${P}/user-info?uid=${a}`,method:"GET"});"success"===e.data.status?G.value=e.data.data:console.error("获取用户信息失败:",e.data.msg)}catch(e){console.error("用户信息请求失败:",e),o({title:"作者信息加载失败",icon:"none"})}},W=a=>{J.value=!0,N.value=a,o({title:a,icon:"none"})};function X(a){let e=r("token");if(""==e)return;let t=1==H.value?3:4;s({url:P+"/with-state/hasLike?id="+a+"&type="+t,method:"POST",header:{Authorization:e},success:a=>{"success"==a.data.status?a.data.data.id>0?K.value=!0:K.value=!1:o({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}function Z(a){if(a<1e3)return a.toString();return`${Math.floor(a/1e3)}k+`}const aa=({parent:a,target:e})=>{var t;console.log("parent",a),console.log("target",e);let o=a;null!=e&&(o=e),B.value.id!=o.id?(console.log("item",o),B.value=o,null==(t=Y.value)||t.focusInput()):B.value={}},ea=a=>{var e,t,l;let i=r("token");if(!R.isLogin)return void o({title:"请先登录",icon:"none"});const n=1==H.value?3:6,u={content:a.content,origin:a.origin,target_id:parseInt(q.value),type:n,image_url:a.image_url||"",association_id:a.association_id||0,association_type:a.association_type||0,is_anonymous:a.is_anonymous||0,...B.value.id&&{reply_id:B.value.id,reply_for:B.value.comment,reply_uid:B.value.user_id,parent_id:B.value.parent_id>0?B.value.parent_id:B.value.id}},d={id:Date.now(),content:a.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:R.userInfo.avatar,username:R.userInfo.nickname,is_anonymous:0},...a.association_id&&{association_id:a.association_id,association_type:a.association_type},...a.image_url&&{image_url:a.image_url},...B.value.id&&{reply_id:B.value.id,reply_for:B.value.comment,reply_uid:B.value.user_id,parent_id:B.value.parent_id>0?B.value.parent_id:B.value.id,reply_username:B.value.is_anonymous?"匿名用户":B.value.username}};B.value.id?0===B.value.parent_id?null==(t=U.value)||t.addReplyComment({...d,parent_id:B.value.id}):null==(l=U.value)||l.addReplyComment({...d,parent_id:B.value.parent_id}):null==(e=U.value)||e.addNewComment(d),s({url:P+"/with-state/add-comment",method:"POST",header:{Authorization:i},data:u,success:e=>{var t,l;if("success"==e.data.status){const l=e.data.data,i={...l,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:R.userInfo.avatar,username:R.userInfo.nickname,is_anonymous:0}};l.reply_uid&&B.value.is_anonymous&&(i.reply_username="匿名用户"),null==(t=U.value)||t.updateTempComment(d.id,i),o({title:"评论成功",icon:"success"})}else null==(l=U.value)||l.removeTempComment(d.id),o({title:e.data.msg,icon:"none"})},fail:a=>{var e;null==(e=U.value)||e.removeTempComment(d.id),o({title:"网络请求失败",icon:"none"})}})};function ta(a){const e=new Date(1e3*a),t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),l=e.getDate().toString().padStart(2,"0"),i=e.getHours().toString().padStart(2,"0"),n=e.getMinutes().toString().padStart(2,"0");return e.getSeconds().toString().padStart(2,"0"),`${t}-${o}-${l} ${i}:${n}`}return x((()=>{})),L((a=>{try{if(!a.collocation_id)return J.value=!0,void(N.value="缺少必要参数Id");if(!a.origin)return J.value=!0,void(N.value="缺少必要参数Origin");q.value=a.collocation_id,H.value=a.origin,Q(a.collocation_id,a.origin),F().then((e=>{console.log(e),X(a.collocation_id)}))}catch(e){console.error("onLoad Error:",e),o({title:"加载失败",icon:"none"})}})),(a,e)=>{const t=T(l("view-logs"),C),$=T(l("uni-icons"),E),x=w,L=u,F=I,V=j,W=b,oa=T(l("report-button"),z),la=T(l("comment-list"),A),ia=T(l("comment-input"),D);return d(),i(L,null,{default:n((()=>[c(t),c(L,{style:{position:"relative"}},{default:n((()=>[c(L,{class:"heart",onClick:e[0]||(e[0]=a=>function(){let a=r("token");if(!R.isLogin)return void o({title:"请先登录",icon:"none"});let e=1==H.value?3:4,t={id:parseInt(M.value.id),type:e},l=K.value?"/with-state/unlike":"/with-state/add-like";s({url:P+l,method:"POST",header:{Authorization:a},data:t,success:a=>(console.log(a.data),"success"==a.data.status?(o({title:"操作成功",icon:"success"}),K.value=!K.value,X(M.value.id),void Q(M.value.id,H.value)):void o({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}())},{default:n((()=>[_(K)?(d(),i($,{key:1,type:"heart-filled",size:"28",color:"#ff4d4f"})):(d(),i($,{key:0,type:"heart",size:"28",color:"#ff4d4f"})),c(x,{class:"num"},{default:n((()=>{var a;return[m(p((null==(a=M.value)?void 0:a.like_count)?Z(M.value.like_count):0),1)]})),_:1})])),_:1}),c(W,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:n((()=>[(d(!0),v(f,null,g(M.value.image_url_list,((a,e)=>(d(),i(V,{key:e},{default:n((()=>[c(F,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>function(a){console.log(M),S({current:M.value.image_url_list[a],urls:M.value.image_url_list})}(e)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),c(L,{class:"author-info",onClick:e[1]||(e[1]=a=>{return e=M.value.uid,void k({url:"/pages/user_page/user_page?uid="+e});var e})},{default:n((()=>[c(F,{class:"avatar",src:G.value.avatar,mode:"aspectFill"},null,8,["src"]),c(L,{class:"user-meta"},{default:n((()=>[c(x,{class:"username"},{default:n((()=>[m(p(G.value.user_name||"未知用户"),1)])),_:1}),c(x,{class:"publish-time"},{default:n((()=>[m("发布于 "+p(ta(M.value.created_at)),1)])),_:1})])),_:1})])),_:1}),c(L,{class:"content-box"},{default:n((()=>[c(L,{style:{display:"flex","justify-content":"space-between"}},{default:n((()=>[c(x,{class:"title"},{default:n((()=>[m(p(M.value.title),1)])),_:1}),c(L,{class:"report-container"},{default:n((()=>[c(oa,{"report-type":1===H.value?2:1,"relation-id":parseInt(q.value),"icon-type":"flag","icon-color":"#999"},null,8,["report-type","relation-id"])])),_:1})])),_:1}),c(x,{class:"content"},{default:n((()=>[m(p(M.value.content),1)])),_:1})])),_:1}),c(L,{class:"goods-list"},{default:n((()=>[(d(!0),v(f,null,g(M.value.collocation_relation_list,(a=>(d(),i(L,{key:a.id,class:"goods-item",onClick:e=>(a=>{a.relation_goods_id>0?k({url:`/pages/goods/goods?goods_id=${a.relation_goods_id}`}):a.relation_brand_id>0?k({url:`/pages/brand/brand?brand_id=${a.relation_brand_id}`}):o({title:"暂无商品和品牌信息",icon:"none"})})(a)},{default:n((()=>[c(L,{class:"image-container"},{default:n((()=>{var e,t;return[0===a.relation_goods_id?(d(),i(L,{key:0,class:"placeholder-box"},{default:n((()=>[c(x,{style:{color:"#fff","font-size":"45px"}},{default:n((()=>[m("?")])),_:1})])),_:1})):(d(),v(f,{key:1},[a.imageLoaded?(d(),i(F,{key:0,src:(null==(t=null==(e=a.goodsInfo)?void 0:e.goods_images)?void 0:t[0])||"/static/goods-default.png",mode:"aspectFill",class:"goods-image"},null,8,["src"])):a.imageError?(d(),i(L,{key:1,class:"error-box"},{default:n((()=>[c(x,null,{default:n((()=>[m("图片加载失败")])),_:1})])),_:1})):(d(),i(L,{key:2,class:"loading-box"},{default:n((()=>[c(x,null,{default:n((()=>[m("加载中...")])),_:1})])),_:1}))],64))]})),_:2},1024),c(L,{class:"goods-info"},{default:n((()=>[c(x,{class:"brand"},{default:n((()=>[m(p(a.relation_brand_name)+" - "+p(a.relation_goods_name),1)])),_:2},1024),c(L,null,{default:n((()=>[c(x,{class:"category"},{default:n((()=>[m(p(a.type),1)])),_:2},1024),c(x,{class:"price"},{default:n((()=>[m(" （"+p(a.goodsInfo&&a.goodsInfo.total_amount?a.goodsInfo.total_amount+a.goodsInfo.currency:"贩售价格未收录")+"）",1)])),_:2},1024)])),_:2},1024),c(L,{class:"see font-alimamashuhei"},{default:n((()=>[m(" 去看看 → ")])),_:1})])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),H.value>0?(d(),i(L,{key:0,style:{padding:"10px"}},{default:n((()=>[c(la,{ref_key:"commentListRef",ref:U,type:1==H.value?3:6,"relation-id":parseInt(q.value),onReply:aa},null,8,["type","relation-id"])])),_:1})):y("",!0),M.value.title?(d(),i(ia,{key:1,ref_key:"commentInputRef",ref:Y,"reply-info":_(B),"target-id":q.value,onSubmit:ea,"onUpdate:replyInfo":e[2]||(e[2]=a=>h(B)?B.value=a:B=a)},null,8,["reply-info","target-id"])):y("",!0),c(L,{style:{width:"100%",height:"120rpx"}}),O.value?(d(),i(L,{key:2,class:"loading"},{default:n((()=>[m("加载中...")])),_:1})):y("",!0),J.value?(d(),i(L,{key:3,class:"error"},{default:n((()=>[m(p(N.value),1)])),_:1})):y("",!0)])),_:1})}}},[["__scopeId","data-v-1c41b17b"]]);export{M as default};
