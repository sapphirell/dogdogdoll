import{g as a,h as t,U as e,$ as l,j as o,c as s,w as i,l as n,m as d,C as u,f as r,o as c,a as _,u as f,b as m,t as g,d as v,r as p,F as y,v as h,N as x,V as k,W as b,X as w,Y as S,n as $,e as I,i as C,y as z,H as j,Z as A,B as F,D as E}from"./index-CfMR_IzQ.js";import{_ as L}from"./uni-icons.sjYK3Gk_.js";import{b as T,c as P,o as D,r as O}from"./uni-app.es.5AkhYBbN.js";import{b as V,w as B,a as G}from"./config.BX5UpUDr.js";import{_ as M}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=M({__name:"collocation_share",setup(M){const H=a({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),N=a({userName:"",avatar:""}),U=t(),W=a(0),Y=a(!1);function X(){Y.value=!0}function Z(){Y.value=!1}const q=()=>{Y.value=!1,S()};T((()=>{})),P((()=>{}));const J=e((()=>{var a;let t=(null==(a=U.safeAreaInsets)?void 0:a.bottom)||10;W.value>0&&(t+=W.value);let e=`${t}px`;return console.log("footer-brand:"+e),e})),K=a(!0),Q=a(!1),R=a(""),aa=a(0),ta=a(0);let ea=a(!1),la=a({}),oa=a(1),sa=a(""),ia=a({});l({title:"搭配详情"});const na=async(a,t)=>{var e;try{const l=await n({url:B+`/view-collocation?collocation_id=${a}&origin=${t}`});if("success"!==l.data.status)return void ua(l.data.msg||"数据加载失败");const o={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async a=>{try{const t=a.relation_goods_id>0?await(a=>new Promise(((t,e)=>{a&&0!==a?n({url:`${B}/goods?id=${a}`,method:"GET",timeout:5e3,success:a=>{"success"===a.data.status?t(a.data.data):e(a.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),d({title:"网络请求失败",icon:"none"}),e(a)}}):e("无效的商品ID")})))(a.relation_goods_id):null;return{...a,goodsInfo:t,imageLoaded:!!t,imageError:!t}}catch(t){return console.error("商品信息获取失败:",t),{...a,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};H.value=o,(null==(e=l.data.data)?void 0:e.uid)&&await da(l.data.data.uid)}catch(l){ua("数据加载失败")}finally{K.value=!1}},da=async a=>{try{const t=await n({url:`${B}/user-info?uid=${a}`,method:"GET"});"success"===t.data.status?N.value=t.data.data:console.error("获取用户信息失败:",t.data.msg)}catch(t){console.error("用户信息请求失败:",t),d({title:"作者信息加载失败",icon:"none"})}},ua=a=>{Q.value=!0,R.value=a,d({title:a,icon:"none"})};function ra(a){let t=u("token");if(""==t)return;let e=1==ta.value?3:4;n({url:B+"/with-state/hasLike?id="+a+"&type="+e,method:"POST",header:{Authorization:t},success:a=>{"success"==a.data.status?a.data.data.id>0?ea.value=!0:ea.value=!1:d({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),d({title:"网络请求失败",icon:"none"})}})}function ca(a){if(a<1e3)return a.toString();return`${Math.floor(a/1e3)}k+`}function _a(){n({url:B+"/collocation-comment?collocation_id="+aa.value+"&page="+oa.value,method:"GET",timeout:5e3,success:a=>{console.log(a.data.data),la.value.page_index=a.data.data.page_index,la.value.total=a.data.data.total,la.value.comment_list=la.value.comment_list?la.value.comment_list.concat(a.data.data.comment_list):a.data.data.comment_list,null!=a.data.data.comment_list&&(a.data.data.comment_list.length>0&&(oa.value+=1),0==a.data.data.comment_list.length&&oa.value>1&&d({title:"没有更多数据了",icon:"none"}))},fail:a=>{console.log(a),d({title:"网络请求失败",icon:"none"})}})}function fa(){let a=u("token");if(!G.isLogin)return void d({title:"请先登录",icon:"none"});if(""==sa.value)return void d({title:"请输入评论内容",icon:"none"});let t=getScene(),e={content:sa.value,target_id:parseInt(aa.value),type:3,origin:t};ia.value.id&&(e.reply_id=ia.value.id,e.reply_for=ia.value.comment,e.reply_user_id=ia.value.user_id),console.log(e),n({url:B+"/with-state/add-comment",method:"POST",header:{Authorization:a},data:e,success:a=>(console.log(a.data),"success"==a.data.status?(d({title:"评论成功",icon:"success"}),sa.value="",oa.value=1,la.value={},void _a()):void d({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),d({title:"网络请求失败",icon:"none"})}})}function ma(a){const t=new Date(1e3*a),e=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),o=t.getDate().toString().padStart(2,"0"),s=t.getHours().toString().padStart(2,"0"),i=t.getMinutes().toString().padStart(2,"0");return t.getSeconds().toString().padStart(2,"0"),`${e}-${l}-${o} ${s}:${i}`}return T((()=>{})),D((a=>a.collocation_id?a.origin?(aa.value=a.collocation_id,ta.value=a.origin,na(a.collocation_id,a.origin),V().then((t=>{console.log(t),ra(a.collocation_id)})),void _a()):(Q.value=!0,void(R.value="缺少必要参数Origin")):(Q.value=!0,void(R.value="缺少必要参数Id")))),(a,t)=>{const e=O(o("uni-icons"),L),l=I,S=r,T=C,P=E,D=z,V=j,M=A;return c(),s(S,null,{default:i((()=>[_(S,{style:{position:"relative"}},{default:i((()=>[_(S,{class:"heart",onClick:t[0]||(t[0]=a=>function(){let a=u("token");if(!G.isLogin)return void d({title:"请先登录",icon:"none"});let t=1==ta.value?3:4,e={id:parseInt(H.value.id),type:t},l=ea.value?"/with-state/unlike":"/with-state/add-like";n({url:B+l,method:"POST",header:{Authorization:a},data:e,success:a=>(console.log(a.data),"success"==a.data.status?(d({title:"操作成功",icon:"success"}),ea.value=!ea.value,ra(H.value.id),void na(H.value.id,ta.value)):void d({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),d({title:"网络请求失败",icon:"none"})}})}())},{default:i((()=>[f(ea)?(c(),s(e,{key:1,type:"heart-filled",size:"28",color:"#ff4d4f"})):(c(),s(e,{key:0,type:"heart",size:"28",color:"#ff4d4f"})),_(l,{class:"num"},{default:i((()=>{var a;return[m(g((null==(a=H.value)?void 0:a.like_count)?ca(H.value.like_count):0),1)]})),_:1})])),_:1}),_(D,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:i((()=>[(c(!0),v(y,null,p(H.value.image_url_list,((a,t)=>(c(),s(P,{key:t},{default:i((()=>[_(T,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>function(a){console.log(H),F({current:H.value.image_url_list[a],urls:H.value.image_url_list})}(t)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),_(S,{class:"author-info",onClick:t[1]||(t[1]=a=>{var t;(t=H.value.uid)&&$({url:`/pages/user/profile?uid=${t}`})})},{default:i((()=>[_(T,{class:"avatar",src:N.value.avatar,mode:"aspectFill"},null,8,["src"]),_(l,{class:"username"},{default:i((()=>[m(g(N.value.user_name||"未知用户"),1)])),_:1})])),_:1}),_(S,{class:"content-box"},{default:i((()=>[_(l,{class:"title"},{default:i((()=>[m(g(H.value.title),1)])),_:1}),_(l,{class:"content"},{default:i((()=>[m(g(H.value.content),1)])),_:1})])),_:1}),_(S,{class:"goods-list"},{default:i((()=>[(c(!0),v(y,null,p(H.value.collocation_relation_list,(a=>(c(),s(S,{key:a.id,class:"goods-item",onClick:t=>{return a.relation_goods_id>0?void(0!=(e=a.relation_goods_id)?$({url:`/pages/goods/goods?goods_id=${e}`}):d({title:"商品暂时没有录入",icon:"none"})):null;var e}},{default:i((()=>[_(S,{class:"image-container"},{default:i((()=>{var t,e;return[0===a.relation_goods_id?(c(),s(S,{key:0,class:"placeholder-box"},{default:i((()=>[_(l,{style:{color:"#fff","font-size":"45px"}},{default:i((()=>[m("?")])),_:1})])),_:1})):(c(),v(y,{key:1},[a.imageLoaded?(c(),s(T,{key:0,src:(null==(e=null==(t=a.goodsInfo)?void 0:t.goods_images)?void 0:e[0])||"/static/goods-default.png",mode:"aspectFill",class:"goods-image"},null,8,["src"])):a.imageError?(c(),s(S,{key:1,class:"error-box"},{default:i((()=>[_(l,null,{default:i((()=>[m("图片加载失败")])),_:1})])),_:1})):(c(),s(S,{key:2,class:"loading-box"},{default:i((()=>[_(l,null,{default:i((()=>[m("加载中...")])),_:1})])),_:1}))],64))]})),_:2},1024),_(S,{class:"goods-info"},{default:i((()=>[_(l,{class:"brand"},{default:i((()=>[m(g(a.relation_brand_name)+" - "+g(a.relation_goods_name),1)])),_:2},1024),_(S,null,{default:i((()=>[_(l,{class:"category"},{default:i((()=>[m(g(a.type),1)])),_:2},1024),_(l,{class:"price"},{default:i((()=>[m(" （"+g(a.goodsInfo&&a.goodsInfo.total_amount?a.goodsInfo.total_amount+a.goodsInfo.currency:"贩售价格未收录")+"）",1)])),_:2},1024)])),_:2},1024),_(S,{class:"see font-alimamashuhei"},{default:i((()=>[m(" 去看看 → ")])),_:1})])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),_(S,{style:{padding:"10px"}},{default:i((()=>[f(la).total?(c(),s(l,{key:0,style:{color:"rgb(100, 198, 220)","font-weight":"bold",isplay:"block",margin:"30px 5px",display:"block"}},{default:i((()=>[m("评论区 ("+g(f(la).total||0)+")",1)])),_:1})):h("",!0),_(S,null,{default:i((()=>[f(la).comment_list?(c(),s(S,{key:0},{default:i((()=>[(c(!0),v(y,null,p(f(la).comment_list,((a,t)=>(c(),s(S,{class:"comment_item",key:a.id,style:{"margin-bottom":"20px"}},{default:i((()=>[_(S,{style:{float:"left",width:"80px",padding:"0px 10px 10px 0px"}},{default:i((()=>[_(T,{style:{width:"50px",height:"50px","border-radius":"100%",display:"block",margin:"10px"},src:a.avatar,mode:"aspectFill"},null,8,["src"]),_(l,{style:{display:"block","white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"}},{default:i((()=>[m(g(a.username),1)])),_:2},1024)])),_:2},1024),_(S,{style:{float:"left",padding:"15px 15px 30px 15px",background:"rgb(245 245 245)",width:"calc(100vw - 170px)","min-height":"60px","border-radius":"15px",position:"relative",top:"2px"}},{default:i((()=>[_(l,{style:{width:"100%","white-space":"normal","word-break":"break-all"}},{default:i((()=>[m(g(a.comment),1)])),_:2},1024),_(l,{style:{color:"#888","font-size":"12px",position:"absolute",bottom:"3px",left:"15px"}},{default:i((()=>[m(g(ma(a.created_at))+" floor#"+g(a.floor),1)])),_:2},1024),_(l,{style:k([{fontSize:"12px",position:"absolute",bottom:"3px",right:"15px",fontWeight:"1000"},f(ia).id===a.id?{color:"#fd6669"}:{color:"#888"}]),onClick:t=>function(a){ia.value.id!=a.id?ia.value=a:ia.value={}}(a)},{default:i((()=>[m(" 引用此回复 ")])),_:2},1032,["style","onClick"])])),_:2},1024),_(S,{style:{clear:"both"}})])),_:2},1024)))),128))])),_:1})):h("",!0),_(S,{style:{width:"100%",height:"50rpx"}}),f(la).total?h("",!0):(c(),s(S,{key:1,style:{"font-size":"12px",color:"#888",margin:"20rpx 10rpx",width:"100%","text-align":"center"}},{default:i((()=>[m("- 暂无回复 -")])),_:1})),f(la).total?(c(),s(V,{key:2,class:"load_more",onClick:_a},{default:i((()=>[m("加载更多")])),_:1})):h("",!0)])),_:1})])),_:1}),_(S,{class:"bottom_tab","adjust-position":!1,style:k({paddingBottom:J.value})},{default:i((()=>[f(ia).id?(c(),s(l,{key:0,class:"replyInfo",style:{}},{default:i((()=>[m(g("@"+f(ia).username),1)])),_:1})):h("",!0),_(M,{class:"comment_input",modelValue:f(sa),"onUpdate:modelValue":t[2]||(t[2]=a=>x(sa)?sa.value=a:sa=a),onClick:X,onFocus:X,onBlur:Z,style:{},"adjust-position":!1},null,8,["modelValue"]),_(V,{style:{"flex-shrink":"0",width:"90px"},onClick:fa},{default:i((()=>[m("写评论")])),_:1})])),_:1},8,["style"]),_(S,{style:{width:"100%",height:"120rpx"}}),b(_(S,{class:"mask",onClick:q},null,512),[[w,Y.value]]),K.value?(c(),s(S,{key:0,class:"loading"},{default:i((()=>[m("加载中...")])),_:1})):h("",!0),Q.value?(c(),s(S,{key:1,class:"error"},{default:i((()=>[m(g(R.value),1)])),_:1})):h("",!0)])),_:1})}}},[["__scopeId","data-v-99ac0bc3"]]);export{H as default};
