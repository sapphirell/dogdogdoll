import{g as a,ad as l,a8 as e,h as o,j as s,d as t,k as c,a as n,w as i,F as u,l as d,ae as r,o as f,v as _,r as v,c as m,b as g,U as p,af as y,V as h,f as k,e as w,H as x,S as b,t as C,n as j,i as $}from"./index-CAhh9jg-.js";import{_ as S}from"./common-search.CCwQUJ9J.js";import{r as P}from"./uni-app.es.CI_TJZj7.js";import{_ as T,a as q}from"./common-modal.CGmcSZAO.js";import{_ as z}from"./common-page.BrPj6MFC.js";import{w as E}from"./config.D_tpLRWx.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./cancel.CnEdunnH.js";const L=F({__name:"collocation_square",setup(F){const L=a([]),Q=a(!1),U=a(!1),A=a(1),D=a(0),G=a(0),H=l([0,0]),I=a(!1),K=a(""),M=a([]),O=y(),R=a(null),V=a([]),W=a(null),B=a=>{const l=L.value[a];return l.position?{left:`${l.position.left}px`,top:`${l.position.top}px`,width:`${G.value}px`}:{}},J=a=>{if(console.log("进入计算布局逻辑"),!a)return void console.log("无法获取instance");if(console.log("获取成功"),!L.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(a);const l=h().in(a.proxy);console.log("获取到query");const e=L.value.map(((a,e)=>new Promise((a=>{l.select(`#card-${e}`).boundingClientRect((l=>{a({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),H[0]=0,H[1]=0;const a=await Promise.all(e);a.length?(a.forEach((({index:a,rect:l})=>{if(!l)return void console.error(`卡片${a}元素查询失败`);const e=L.value[a],o=H[0]<=H[1]?0:1,s=o*(G.value+10),t=H[o]+10;H[o]=t+l.height,e.position={left:s,top:t}})),D.value=Math.max(...H)+20):console.warn("未查询到任何卡片元素")}))};e((()=>{const a=o();G.value=(a.windowWidth-30)/2}));const N=async(a=!1)=>{if(Q.value||U.value)console.log("正在加载中或没有更多了");else try{Q.value=!0,a&&(L.value=[],A.value=1);const l={page:A.value,page_size:10,filter_goods_id_list:V.value.map((a=>a.goods_id))},e=await d({url:`${E}/collocation-list`,method:"POST",data:l});if("success"===e.data.status){const l=e.data.data,o=l.collocation_relation_list;L.value=a?o:[...L.value,...o],U.value=l.total<=10*A.value,A.value++,console.log("等待next tick"),await r(),console.log("等待完成"),J(O),setTimeout((()=>{console.log("二次计算布局"),J(O)}),500)}}finally{Q.value=!1}},X=()=>I.value=!0,Y=(a,l)=>{R.value={id:a,name:l},K.value=l,a&&Z(a)},Z=async a=>{try{const l=await d({url:`${E}/goods-name-list?id=${a}`,method:"GET"});console.log("商品列表:",l.data),"success"===l.data.status&&(M.value=l.data.data)}catch(l){console.error("加载商品失败:",l)}},aa=(a,l)=>{if(a){for(const l of V.value)if(l.goods_id===a)return;W.value={goods_id:a,goods_name:l}}else console.log("未选择有效goods")},la=()=>{R.value=null,K.value="",V.value=[],M.value=[]};const ea=async()=>{V.value.push(W.value),I.value=!1,U.value=!1,await N(!0)},oa=()=>{U.value||N()};return e(N),(a,l)=>{const e=k,o=w,d=x,r=$,y=b,h=P(s("common-search"),S),E=P(s("custom-picker"),T),F=P(s("common-modal"),q),A=P(s("common-page"),z);return f(),t(u,null,[c("meta",{name:"theme-color",content:"#f5f5f5"}),n(A,{head_color:"#f5f5f5"},{default:i((()=>[n(e,{class:"container"},{default:i((()=>[_("",!0),n(e,{class:"filter-bar"},{default:i((()=>[n(e,{class:"filter-tags",onClick:X},{default:i((()=>[n(e,{class:"selected-goods"},{default:i((()=>[(f(!0),t(u,null,v(V.value,(a=>(f(),m(e,{key:a.goods_id,class:"tag"},{default:i((()=>[g(C(a.goods_name)+" ",1),n(o,{class:"remove",onClick:l=>{return e=a.goods_id,event.stopPropagation(),V.value=V.value.filter((a=>a.goods_id!==e)),U.value=!1,void N(!0);var e}},{default:i((()=>[g("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1}),V.value.length?_("",!0):(f(),m(o,{key:0,class:"tip"},{default:i((()=>[g("当前无筛选条件")])),_:1}))])),_:1}),n(d,{class:"submit-btn",onClick:l[0]||(l[0]=a=>N(!0))},{default:i((()=>[g("筛选")])),_:1})])),_:1}),n(y,{class:"card-list","scroll-y":"",onScrolltolower:oa,"show-scrollbar":!1},{default:i((()=>[n(e,{class:"cards-container",style:p({height:D.value+"px"})},{default:i((()=>[(f(!0),t(u,null,v(L.value,((a,l)=>(f(),m(e,{key:a.collocation_id,class:"card",id:"card-"+l,style:p(B(l)),onClick:l=>{return e=a.collocation_id,o=a.origin,void j({url:"/pages/collocation_share/collocation_share?collocation_id="+e+"&origin="+o});var e,o}},{default:i((()=>[n(r,{src:a.image_urls[0],mode:"aspectFill",class:"card-image","lazy-load":""},null,8,["src"]),n(e,{class:"card-content"},{default:i((()=>[n(o,{class:"title"},{default:i((()=>[g(C(a.title),1)])),_:2},1024),n(o,{class:"desc"},{default:i((()=>[g(C(a.content),1)])),_:2},1024),n(e,{class:"goods-tags"},{default:i((()=>[(f(!0),t(u,null,v(a.relation_list,((a,l)=>(f(),m(e,{class:"tag-box",key:l},{default:i((()=>[n(o,{class:"goods-tag"},{default:i((()=>[g(C(a.relation_goods_name||"未命名商品"),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)])),_:2},1032,["id","style","onClick"])))),128))])),_:1},8,["style"]),n(e,{class:"loading-state"},{default:i((()=>[Q.value?(f(),m(o,{key:0},{default:i((()=>[g("加载中...")])),_:1})):_("",!0),U.value?(f(),m(o,{key:1,class:"no-more"},{default:i((()=>[g("没有更多了")])),_:1})):_("",!0)])),_:1})])),_:1}),I.value?(f(),m(F,{key:1,visible:I.value,"onUpdate:visible":l[2]||(l[2]=a=>I.value=a)},{default:i((()=>[n(e,{class:"filter-modal"},{default:i((()=>[n(e,{class:"modal-header"},{default:i((()=>[n(o,{class:"title"},{default:i((()=>[g("筛选条件")])),_:1}),n(o,{class:"close",onClick:l[1]||(l[1]=a=>I.value=!1)},{default:i((()=>[g("×")])),_:1})])),_:1}),n(e,{class:"filter-items"},{default:i((()=>[n(e,{class:"filter-item"},{default:i((()=>[n(h,{mode:"fill",onSelect:Y,width:"450rpx"})])),_:1}),R.value?(f(),m(e,{key:0,class:"filter-item"},{default:i((()=>[n(E,{dataList:M.value,onSelect:aa,multiple:""},null,8,["dataList"])])),_:1})):_("",!0)])),_:1}),n(e,{class:"action-btns"},{default:i((()=>[n(d,{class:"btn reset",onClick:la},{default:i((()=>[g("重置")])),_:1}),n(d,{class:"btn confirm submit-btn",onClick:ea},{default:i((()=>[g("确认")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])):_("",!0)])),_:1})])),_:1})],64)}}},[["__scopeId","data-v-951c824e"]]);export{L as default};
