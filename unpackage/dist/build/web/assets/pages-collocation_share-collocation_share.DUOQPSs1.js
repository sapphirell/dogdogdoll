import{r as a,p as e,a2 as t,A as o,a as l,c as i,w as s,v as n,j as r,g as u,b as d,d as c,D as _,e as f,t as g,k as p,l as m,F as v,u as y,T as h,n as k,f as w,i as I,G as S,J as b,E as $}from"./index-6ojkiy1R.js";import{_ as x}from"./uni-icons.C75VRGWb.js";import{c as j,a as C,r as L}from"./uni-app.es.BMFd5FAr.js";import{b as E,_ as A,a as z}from"./comment-input.WXDjx_KR.js";import{c as T,w as D,b as F}from"./config.Bhvn_Gfs.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./common-modal.Biav_mER.js";const O=P({__name:"collocation_share",props:{collocation_id:{type:String,default:0},origin:{type:String,default:0}},setup(P){const O=a({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),R=a({userName:"",avatar:""});e();const G=a(!0),M=a(!1),N=a(""),B=P,H=a(0),J=a(0);let U=a(!1);const Y=a(null),q=a(null);a(1);let K=a({});t({title:"搭配详情"});const Q=async(a,e)=>{var t;try{const l=await n({url:D+`/view-collocation?collocation_id=${a}&origin=${e}`});if("success"!==l.data.status)return void W(l.data.msg||"数据加载失败");const i={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async a=>{try{const e=a.relation_goods_id>0?await(a=>new Promise(((e,t)=>{a&&0!==a?n({url:`${D}/goods?id=${a}`,method:"GET",timeout:5e3,success:a=>{"success"===a.data.status?e(a.data.data):t(a.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),o({title:"网络请求失败",icon:"none"}),t(a)}}):t("无效的商品ID")})))(a.relation_goods_id):null;return{...a,goodsInfo:e,imageLoaded:!!e,imageError:!e}}catch(e){return console.error("商品信息获取失败:",e),{...a,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};O.value=i,(null==(t=l.data.data)?void 0:t.uid)&&await V(l.data.data.uid)}catch(l){W("数据加载失败")}finally{G.value=!1}},V=async a=>{try{const e=await n({url:`${D}/user-info?uid=${a}`,method:"GET"});"success"===e.data.status?R.value=e.data.data:console.error("获取用户信息失败:",e.data.msg)}catch(e){console.error("用户信息请求失败:",e),o({title:"作者信息加载失败",icon:"none"})}},W=a=>{M.value=!0,N.value=a,o({title:a,icon:"none"})};function X(a){let e=r("token");if(""==e)return;let t=1==J.value?3:4;n({url:D+"/with-state/hasLike?id="+a+"&type="+t,method:"POST",header:{Authorization:e},success:a=>{"success"==a.data.status?a.data.data.id>0?U.value=!0:U.value=!1:o({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}function Z(a){if(a<1e3)return a.toString();return`${Math.floor(a/1e3)}k+`}const aa=({parent:a,target:e})=>{var t;console.log("parent",a),console.log("target",e);let o=a;null!=e&&(o=e),K.value.id!=o.id?(console.log("item",o),K.value=o,null==(t=q.value)||t.focusInput()):K.value={}},ea=({content:a,replyInfo:e,origin:t})=>{let l=r("token");if(!F.isLogin)return void o({title:"请先登录",icon:"none"});console.log("reply_info",e);const i={content:a,origin:t,target_id:parseInt(H.value),type:1==B.origin?3:6,...e.id&&{reply_id:e.id,reply_for:e.comment,reply_user_id:e.user_id,parent_id:e.parent_id>0?e.parent_id:e.id}};n({url:D+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:i,success:a=>{var e,t;if("success"==a.data.status){const l=a.data.data;0===l.parent_id?null==(e=Y.value)||e.addNewComment(l):null==(t=Y.value)||t.addReplyComment(l),o({title:"评论成功",icon:"success"})}else o({title:a.data.msg,icon:"none"})},fail:a=>{o({title:"网络请求失败",icon:"none"})}})};function ta(a){const e=new Date(1e3*a),t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),l=e.getDate().toString().padStart(2,"0"),i=e.getHours().toString().padStart(2,"0"),s=e.getMinutes().toString().padStart(2,"0");return e.getSeconds().toString().padStart(2,"0"),`${t}-${o}-${l} ${i}:${s}`}return j((()=>{})),C((a=>{try{if(!a.collocation_id)return M.value=!0,void(N.value="缺少必要参数Id");if(!a.origin)return M.value=!0,void(N.value="缺少必要参数Origin");H.value=a.collocation_id,J.value=a.origin,Q(a.collocation_id,a.origin),T().then((e=>{console.log(e),X(a.collocation_id)}))}catch(e){console.error("onLoad Error:",e),o({title:"加载失败",icon:"none"})}})),(a,e)=>{const t=L(l("uni-icons"),x),j=w,C=u,T=I,P=$,B=S,V=L(l("report-button"),E),W=L(l("comment-list"),A),oa=L(l("comment-input"),z);return d(),i(C,null,{default:s((()=>[c(C,{style:{position:"relative"}},{default:s((()=>[c(C,{class:"heart",onClick:e[0]||(e[0]=a=>function(){let a=r("token");if(!F.isLogin)return void o({title:"请先登录",icon:"none"});let e=1==J.value?3:4,t={id:parseInt(O.value.id),type:e},l=U.value?"/with-state/unlike":"/with-state/add-like";n({url:D+l,method:"POST",header:{Authorization:a},data:t,success:a=>(console.log(a.data),"success"==a.data.status?(o({title:"操作成功",icon:"success"}),U.value=!U.value,X(O.value.id),void Q(O.value.id,J.value)):void o({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}())},{default:s((()=>[_(U)?(d(),i(t,{key:1,type:"heart-filled",size:"28",color:"#ff4d4f"})):(d(),i(t,{key:0,type:"heart",size:"28",color:"#ff4d4f"})),c(j,{class:"num"},{default:s((()=>{var a;return[f(g((null==(a=O.value)?void 0:a.like_count)?Z(O.value.like_count):0),1)]})),_:1})])),_:1}),c(B,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:s((()=>[(d(!0),p(v,null,m(O.value.image_url_list,((a,e)=>(d(),i(P,{key:e},{default:s((()=>[c(T,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>function(a){console.log(O),b({current:O.value.image_url_list[a],urls:O.value.image_url_list})}(e)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),c(C,{class:"author-info",onClick:e[1]||(e[1]=a=>{return e=O.value.uid,void k({url:"/pages/user_page/user_page?uid="+e});var e})},{default:s((()=>[c(T,{class:"avatar",src:R.value.avatar,mode:"aspectFill"},null,8,["src"]),c(C,{class:"user-meta"},{default:s((()=>[c(j,{class:"username"},{default:s((()=>[f(g(R.value.user_name||"未知用户"),1)])),_:1}),c(j,{class:"publish-time"},{default:s((()=>[f("发布于 "+g(ta(O.value.created_at)),1)])),_:1})])),_:1})])),_:1}),c(C,{class:"content-box"},{default:s((()=>[c(C,{style:{display:"flex","justify-content":"space-between"}},{default:s((()=>[c(j,{class:"title"},{default:s((()=>[f(g(O.value.title),1)])),_:1}),c(C,{class:"report-container"},{default:s((()=>[c(V,{"report-type":1===J.value?2:1,"relation-id":parseInt(H.value),"icon-type":"flag","icon-color":"#999"},null,8,["report-type","relation-id"])])),_:1})])),_:1}),c(j,{class:"content"},{default:s((()=>[f(g(O.value.content),1)])),_:1})])),_:1}),c(C,{class:"goods-list"},{default:s((()=>[(d(!0),p(v,null,m(O.value.collocation_relation_list,(a=>(d(),i(C,{key:a.id,class:"goods-item",onClick:e=>{return a.relation_goods_id>0?void(0!=(t=a.relation_goods_id)?k({url:`/pages/goods/goods?goods_id=${t}`}):o({title:"商品暂时没有录入",icon:"none"})):null;var t}},{default:s((()=>[c(C,{class:"image-container"},{default:s((()=>{var e,t;return[0===a.relation_goods_id?(d(),i(C,{key:0,class:"placeholder-box"},{default:s((()=>[c(j,{style:{color:"#fff","font-size":"45px"}},{default:s((()=>[f("?")])),_:1})])),_:1})):(d(),p(v,{key:1},[a.imageLoaded?(d(),i(T,{key:0,src:(null==(t=null==(e=a.goodsInfo)?void 0:e.goods_images)?void 0:t[0])||"/static/goods-default.png",mode:"aspectFill",class:"goods-image"},null,8,["src"])):a.imageError?(d(),i(C,{key:1,class:"error-box"},{default:s((()=>[c(j,null,{default:s((()=>[f("图片加载失败")])),_:1})])),_:1})):(d(),i(C,{key:2,class:"loading-box"},{default:s((()=>[c(j,null,{default:s((()=>[f("加载中...")])),_:1})])),_:1}))],64))]})),_:2},1024),c(C,{class:"goods-info"},{default:s((()=>[c(j,{class:"brand"},{default:s((()=>[f(g(a.relation_brand_name)+" - "+g(a.relation_goods_name),1)])),_:2},1024),c(C,null,{default:s((()=>[c(j,{class:"category"},{default:s((()=>[f(g(a.type),1)])),_:2},1024),c(j,{class:"price"},{default:s((()=>[f(" （"+g(a.goodsInfo&&a.goodsInfo.total_amount?a.goodsInfo.total_amount+a.goodsInfo.currency:"贩售价格未收录")+"）",1)])),_:2},1024)])),_:2},1024),c(C,{class:"see font-alimamashuhei"},{default:s((()=>[f(" 去看看 → ")])),_:1})])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),J.value>0?(d(),i(C,{key:0,style:{padding:"10px"}},{default:s((()=>[c(W,{ref_key:"commentListRef",ref:Y,type:1==J.value?3:6,"relation-id":parseInt(H.value),onReply:aa},null,8,["type","relation-id"])])),_:1})):y("",!0),O.value.title?(d(),i(oa,{key:1,ref_key:"commentInputRef",ref:q,"reply-info":_(K),"target-id":H.value,onSubmit:ea,"onUpdate:replyInfo":e[2]||(e[2]=a=>h(K)?K.value=a:K=a)},null,8,["reply-info","target-id"])):y("",!0),c(C,{style:{width:"100%",height:"120rpx"}}),G.value?(d(),i(C,{key:2,class:"loading"},{default:s((()=>[f("加载中...")])),_:1})):y("",!0),M.value?(d(),i(C,{key:3,class:"error"},{default:s((()=>[f(g(N.value),1)])),_:1})):y("",!0)])),_:1})}}},[["__scopeId","data-v-763075ad"]]);export{O as default};
