import{l as t,W as e,s as i,X as h,q as o,u as a,R as s,Y as r,Z as n,_ as c,$ as l,o as p,c as g,w as d,a as u,e as m,F as w,h as f,B as R,j as y,i as x,g as v,a0 as I,a1 as T,K as S,D as b,a2 as M,m as C,a3 as P,b as k,C as H}from"./index-D8OtiTi9.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as _}from"./uni-app.es.JSb8JX9v.js";const z=t();function N(t){if("number"==typeof t||!isNaN(Number(t)))return e(t);if("string"==typeof t){if(t.endsWith("rpx"))return N(t.replace("rpx",""));if(t.endsWith("px"))return Number(t.replace("px",""));if(t.endsWith("vw"))return Number(t.replace("vw",""))*z.screenWidth/100;if(t.endsWith("vh"))return Number(t.replace("vh",""))*z.screenHeight/100}return 0}var W=[],$=0,D=[],j=0,q=null,F=null,X="",Y=null,B=null,U=null,L=0,O={imageRect:null,cropperRect:null};function Z(){var t=O.imageRect;q.setStyle({left:t.left+"px",top:t.top+"px",width:t.width+"px",height:t.height+"px",transform:"rotate("+L+"deg)"})}function E(){var t=O.cropperRect;F.setStyle({left:t.left+"px",top:t.top+"px",width:t.width+"px",height:t.height+"px"})}function G(t){var e=U.width*(t-1),i=U.height*(t-1);O.imageRect={width:U.width+e,height:U.height+i,left:U.left-e*D[0],top:U.top-i*D[1]}}function K(t){return t/180*Math.PI}function J(){var t=O.imageRect.width,e=O.imageRect.height,i=O.imageRect.left,h=O.imageRect.top,o=Math.sqrt(t*t+e*e),a=Math.atan(e/t)/Math.PI*180,s=L%90,r=Math.floor(L/90),n=o*Math.cos(K(a-s)),c=o*Math.sin(K(a+s));if(r%2==1){var l=n;n=c,c=l}return{width:n,height:c,left:i-(n-t)/2,top:h-(c-e)/2,dw:n-t,dh:c-e}}const Q={touchStart:function(t,e){t.preventDefault(),t.stopPropagation(),Y=t.instance;var i=t.instance.getDataset();if(X=i.type,W=t.touches,e.callMethod("onTouchStart"),2==W.length){X="image";var h=W[0].clientX,o=W[0].clientY,a=W[1].clientX,s=W[1].clientY,r=Math.pow(a-h,2)+Math.pow(s-o,2);$=Math.sqrt(r);var n=((h+a)/2-U.left)/U.width,c=((o+s)/2-U.top)/U.height;D=[n,c]}return!1},touchMove:function(t,e){if(""==X)return!1;t.preventDefault(),t.stopPropagation();var i=t.touches,h=i[0].clientX-W[0].clientX,o=i[0].clientY-W[0].clientY;if(1==W.length){if("image"===X)O.imageRect.left=U.left+h,O.imageRect.top=U.top+o,Z();else if("controller"===X){var a=0;Y.hasClass("left")&&(a=-1),Y.hasClass("right")&&(a=1);var s=0;Y.hasClass("top")&&(s=-1),Y.hasClass("bottom")&&(s=1);var r=h*a,n=o*s;0!==j&&(a*s!=0?r/j>n?r=(n=r/j)*j:n=(r=n*j)/j:0==a?r=n*j:n=r/j);var c=J(),l=B.width+r,p=B.height+n,g=c.left+c.width,d=c.top+c.height;if(-1!=a)B.left+l>g&&(l=g-B.left,0!==j&&(p=l/j));else B.left-r<c.left&&(l=B.left+B.width-c.left,0!==j&&(p=l/j));if(-1!=s)B.top+p>d&&(p=d-B.top,0!==j&&(l=p*j));else B.top-n<c.top&&(p=B.top+B.height-c.top,0!==j&&(l=p*j));-1==a&&(O.cropperRect.left=B.left+B.width-l),-1==s&&(O.cropperRect.top=B.top+B.height-p),O.cropperRect.width=l,O.cropperRect.height=p,E()}}else if(2==i.length&&2==W.length){var u=i[0].clientX-i[1].clientX,m=i[0].clientY-i[1].clientY,w=Math.pow(u,2)+Math.pow(m,2);G((w=Math.sqrt(w))/$),Z()}return!1},touchEnd:function(t,e){if("image"===X){var i=B.left,h=B.left+B.width,o=B.top,a=o+B.height,s=B.width/B.height,r=J(),n=r.width/r.height;if(r.width<B.width||r.height<B.height){var c=1;c=n<s?B.width/r.width:B.height/r.height,U.width=O.imageRect.width,U.height=O.imageRect.height,G(c)}i<r.left&&(O.imageRect.left=i+r.dw/2),h>r.left+r.width&&(O.imageRect.left=h-r.width+r.dw/2),o<r.top&&(O.imageRect.top=o+r.dh/2),a>r.top+r.height&&(O.imageRect.top=a-r.height+r.dh/2),Z()}return e.callMethod("updateData",{cropperRect:O.cropperRect,imageRect:O.imageRect}),X="",W=[],!1},changeRatio:function(t){j=t},changeRotateAngle:function(t){L=t,q&&Z(),J()},changeImageRect:function(t,e,i){t&&(U=t,O.imageRect={left:t.left,top:t.top,width:t.width,height:t.height},setTimeout((function(){q=i.selectComponent(".mainContent > .image"),Z()})))},changeCropper:function(t,e,i){t&&(B=t,O.cropperRect={left:t.left,top:t.top,width:t.width,height:t.height},setTimeout((function(){F=i.selectComponent(".mainContent > .cropper"),E()})))}},V=t=>{t.$wxs||(t.$wxs=[]),t.$wxs.push("wxsModule"),t.mixins||(t.mixins=[]),t.mixins.push({beforeCreate(){this.wxsModule=Q}})},tt={name:"bt-cropper",props:{imageSrc:{type:String,default:"",required:!0},mask:{type:String,default:""},containerSize:{type:Object,default:null},fileType:{type:String,default:"png"},dWidth:Number,maxWidth:{type:Number,default:2e3},ratio:{type:Number,default:0,validator:t=>"number"==typeof t&&!(t<0)},rotate:Number,showGrid:{type:Boolean,default:!1},quality:{type:Number,default:1},canvas2d:{type:Boolean,default:!1},initPosition:{type:Object,default:()=>null},autoZoom:{type:Boolean,default:!0}},data:()=>({canvasId:"bt-cropper",containerRect:null,imageInfo:null,operationHistory:[],operationIndex:0,anim:!1,timer:null,type2d:!1,pixel:1,imageRect:null,cropperRect:null,target:{width:0,height:0}}),watch:{imageSrc:{handler(t){"string"==typeof t&&""!==t?this.imageInit(t):this.imageInfo=null},immediate:!0},ratio(){0!=this.ratio&&(this.startAnim(),this.init())}},computed:{containerStyle(){return this.containerSize&&this.containerRect?{width:this.containerRect.width+"px",height:this.containerRect.height+"px"}:{}},rotateAngle(){const t=Number(this.rotate);return isNaN(t)?0:t%360}},methods:{startAnim(){this.stopAnim(),this.anim=!0,this.timer=setTimeout((()=>{this.anim=!1}),200)},stopAnim(){this.anim=!1,clearTimeout(this.timer)},imageInit(t){i({title:"载入中..."}),h({src:t,success:t=>{this.imageInfo=t,this.$nextTick((()=>{this.getContainer().then((t=>{this.containerRect=t,this.init()}))}))},fail:t=>{this.$emit("loadFail",t),o({title:"图片下载失败!",icon:"none"})},complete(t){a()}})},initCropper(){const t=this.imageInfo.width/this.imageInfo.height,e=this.containerRect.width/this.containerRect.height,i={};let h=this.ratio;0==h&&(h=this.cropperRect?this.cropperRect.width/this.cropperRect.height:1);const o={};return e>h?(o.height=.85*this.containerRect.height,o.width=o.height*h):(o.width=.85*this.containerRect.width,o.height=o.width/h),h>t?(i.width=o.width,i.height=i.width/t):(i.height=o.height,i.width=i.height*t),i.left=(this.containerRect.width-i.width)/2,i.top=(this.containerRect.height-i.height)/2,o.left=i.left+(i.width-o.width)/2,o.top=i.top+(i.height-o.height)/2,{imageRect:i,cropperRect:o}},init(){const{imageRect:t,cropperRect:e}=this.initCropper();if(this.initPosition){const i=this.imageInfo.width/t.width,{left:h,top:o,width:a,height:s}=this.initPosition;void 0!==h&&void 0!==o&&void 0!==a&&void 0!==s&&(e.width=a/i,e.height=s/i,e.left=h/i,e.top=o/i,this.$nextTick(this.zoomToFill))}this.imageRect=t,this.cropperRect=e,this.operationHistory=[{imageRect:t,cropperRect:e}],this.operationIndex=0,this.setTarget(),this.type2d=!1},setTarget(){const t=this.cropperRect.width/this.cropperRect.height;if(this.dWidth)this.target={width:this.dWidth,height:this.dWidth/(t||1)};else{const e=Math.min(this.maxWidth,this.cropperRect.width*(this.imageInfo.width/this.imageRect.width));this.target={width:e,height:e/(t||1)}}},addHistory({imageRect:t,cropperRect:e}){this.operationIndex!==this.operationHistory.length-1&&(this.operationHistory=this.operationHistory.slice(0,this.operationIndex)),this.operationHistory.push({imageRect:t,cropperRect:e}),this.operationHistory.length>10&&this.operationHistory.shift(),this.operationIndex=this.operationHistory.length-1},updateData(t){this.imageRect=t.imageRect,this.cropperRect=t.cropperRect,this.addHistory(t),this.setTarget(),this.autoZoom&&(this.timer=setTimeout((()=>{this.zoomToFill()}),600));const{imageRect:e,cropperRect:i}=t,h=e.width/this.imageInfo.width;this.$emit("change",{left:(i.left-e.left)/h,top:(i.top-e.top)/h,width:i.width/h,height:i.height/h})},getContainer(){if(null!==this.containerSize&&"object"==typeof this.containerSize){const{width:t,height:e}=this.containerSize;return Promise.resolve({width:N(t),height:N(e)})}return new Promise((t=>{s().in(this).select(".mainContent").boundingClientRect((e=>{t(e)})).exec()}))},zoomToFill(){this.startAnim();const t={...this.cropperRect};this.imageRect,this.cropperRect,this.cropperRect=this.initCropper().cropperRect;const e=this.cropperRect.width/t.width,i=t.left-this.imageRect.left,h=t.top-this.imageRect.top;this.imageRect={width:this.imageRect.width*e,height:this.imageRect.height*e,left:this.imageRect.left+(this.cropperRect.left-t.left)-(e-1)*i,top:this.imageRect.top+(this.cropperRect.top-t.top)-(e-1)*h}},onTouchStart(){this.stopAnim()},undo(){return this.operationIndex>0&&(this.operationIndex--,this.imageRect=this.operationHistory[this.operationIndex].imageRect,this.cropperRect=this.operationHistory[this.operationIndex].cropperRect,!0)},resume(){return this.operationIndex<this.operationHistory.length-1&&(this.operationIndex++,this.imageRect=this.operationHistory[this.operationIndex].imageRect,this.cropperRect=this.operationHistory[this.operationIndex].cropperRect,!0)},async drawImage(t,e,i,o,a,s){if(this.type2d)await new Promise((t=>e.onload=t)),t.drawImage(e,i*this.pixel,o*this.pixel,a*this.pixel,s*this.pixel);else{const r=await new Promise((t=>{h({src:e,success({path:e}){t(e)}})}));t.drawImage(r,i*this.pixel,o*this.pixel,a*this.pixel,s*this.pixel),await new Promise((e=>t.draw(!1,e)))}},async crop(){let t,e;if(this.$emit("cropStart"),this.setTarget(),this.type2d){const i=s().in(this);e=await new Promise((t=>i.select(".bt-canvas").node((({node:e})=>t(e))).exec())),e.width=this.target.width*this.pixel,e.height=this.target.height*this.pixel,t=e.getContext("2d")}else t=r(this.canvasId,this);const i=this.cropperRect.width/this.target.width,h=(this.cropperRect.left-this.imageRect.left)/i,o=(this.cropperRect.top-this.imageRect.top)/i;let a;this.type2d?(a=e.createImage(),a.src=this.imageSrc):a=this.imageSrc;const p=-h,g=-o,d=this.imageRect.width/i,u=this.imageRect.height/i;if(t.save(),t.translate(p+d/2,g+u/2),t.rotate(this.rotateAngle*Math.PI/180),t.translate(-(p+d/2),-(g+u/2)),await this.drawImage(t,a,p,g,d,u),t.restore(),""!==this.mask){let e,i;e=this.type2d?t.getImageData(0,0,this.target.width,this.target.height):await new Promise((t=>{n({canvasId:this.canvasId,x:0,y:0,width:this.target.width,height:this.target.height,success(e){t(e)}},this)})),t.clearRect(0,0,this.target.width,this.target.height),this.type2d?a.src=this.mask:a=this.mask,await this.drawImage(t,a,0,0,this.target.width,this.target.height),i=this.type2d?t.getImageData(0,0,this.target.width,this.target.height):await new Promise(((t,e)=>{n({canvasId:this.canvasId,x:0,y:0,width:this.target.width,height:this.target.height,success(e){t(e)}},this)})),t.clearRect(0,0,this.target.width,this.target.height);for(let t=3;t<i.data.length;t+=4){0!==i.data[t]&&(e.data[t]=0)}this.type2d?t.putImageData(e,0,0):await new Promise((t=>{c({canvasId:this.canvasId,x:0,y:0,width:e.width,height:e.height,data:e.data,complete:e=>{t(e)}},this)}))}return new Promise(((t,i)=>{const h={};this.type2d?h.canvas=e:h.canvasId=this.canvasId,l({...h,destWidth:this.target.width,destHeight:this.target.height,quality:Number(this.quality)||1,fileType:this.fileType,success:({tempFilePath:e})=>{for(var i=e.split(","),h=i[0].match(/:(.*?);/)[1],o=atob(i[1]),a=o.length,s=new Uint8Array(a),r=0;r<a;r++)s[r]=o.charCodeAt(r);var n=URL||webkitURL;t(n.createObjectURL(new Blob([s],{type:h}))),t(e)},fail(t){console.log("保存失败，错误信息：",t),i(t)}},this)}))}}};V(tt);const et=A(tt,[["render",function(t,e,i,h,o,a){const s=x,r=v,n=I;return p(),g(r,{class:"bt-container",style:y([a.containerStyle])},{default:d((()=>[u(r,{class:"mainContent","data-type":"image",onTouchstart:t.wxsModule.touchStart,onTouchmove:t.wxsModule.touchMove,onTouchend:t.wxsModule.touchEnd},{default:d((()=>[o.imageRect&&o.cropperRect?(p(),m(w,{key:0},[u(s,{mode:"aspectFit",src:i.imageSrc,class:f(["image",{anim:o.anim}]),rotateAngle:a.rotateAngle,"change:rotateAngle":t.wxsModule.changeRotateAngle,"change:imageRect":t.wxsModule.changeImageRect,imageRect:o.imageRect},null,8,["src","rotateAngle","change:rotateAngle","change:imageRect","imageRect","class"]),u(r,{class:f(["cropper",{anim:o.anim}]),"change:cropperRect":t.wxsModule.changeCropper,cropperRect:o.cropperRect,"change:ratio":t.wxsModule.changeRatio,ratio:i.ratio},{default:d((()=>[u(s,{class:"mask",src:i.mask},null,8,["src"]),i.showGrid?(p(),m(w,{key:0},[u(r,{class:"line row row1"}),u(r,{class:"line row row2"}),u(r,{class:"line col col1"}),u(r,{class:"line col col2"})],64)):R("",!0),u(r,{class:"controller vertical left",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller vertical right",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller horizon top",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller horizon bottom",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller left top",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller left bottom",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller right top",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller right bottom",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"])])),_:1},8,["class","change:cropperRect","cropperRect","change:ratio","ratio"])],64)):R("",!0)])),_:1},8,["onTouchstart","onTouchmove","onTouchend"]),o.type2d?(p(),g(n,{key:0,type:"2d",class:"bt-canvas",width:o.target.width,height:o.target.height},null,8,["width","height"])):(p(),g(n,{key:1,"canvas-id":o.canvasId,class:"bt-canvas",style:y({width:o.target.width+"px",height:o.target.height+"px"}),width:o.target.width*o.pixel,height:o.target.height*o.pixel},null,8,["canvas-id","style","width","height"]))])),_:1},8,["style"])}],["__scopeId","data-v-503f171e"]]);const it=A({data:()=>({imageSrc:"",dist:"",mask:"",ratio:1,containerSize:{width:600,height:600},initPosition:null}),onLoad(t){this.imageSrc=decodeURIComponent(t.src)},onPullDownRefresh(){T()},methods:{openPopup(){this.$refs.pop.open()},change(){S({count:1,sizeType:["original"],success:t=>{let e=t.tempFilePaths[0];this.src=e,this.initPosition=null}})},close(){this.$refs.pop.close()},onChange(t){this.initPosition=t},undo(){this.$refs.cropper.undo()},resume(){this.$refs.cropper.resume()},crop(){this.$refs.cropper.crop().then((t=>{this.dist=t;const e=b(),i=e[e.length-2];console.log(i),i.returnParam=t,M({delta:1})}))}}},[["render",function(t,e,i,h,o,a){const s=_(C("bt-cropper"),et),r=H,n=v,c=P("uni-popup");return p(),g(n,{class:"container"},{default:d((()=>[u(c,{ref:"pop"},{default:d((()=>[u(n,{class:"content"},{default:d((()=>[u(s,{ref:"cropper",imageSrc:o.imageSrc,mask:o.mask,ratio:o.ratio,initPosition:o.initPosition,dWidth:800,fileType:"png",containerSize:o.containerSize,onChange:a.onChange},null,8,["imageSrc","mask","ratio","initPosition","containerSize","onChange"]),u(n,{class:"btns"},{default:d((()=>[u(r,{class:"button",onClick:a.crop},{default:d((()=>[k("裁剪")])),_:1},8,["onClick"]),u(r,{class:"button",onClick:a.undo},{default:d((()=>[k("撤销")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-ec9524e6"]]);export{it as default};
