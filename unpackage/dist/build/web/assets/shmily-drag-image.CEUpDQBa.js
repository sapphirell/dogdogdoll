import{r as e,k as a,o as l,l as u,aw as t,as as o,a2 as s,M as n,b as d,c as i,w as v,a1 as r,v as c,F as h,x as m,d as p,D as y,e as f,t as x,p as b,aN as g,n as Y,i as _,f as X,g as M,aO as E,aP as w}from"./index-I3aG4WZL.js";import"./config.BjeWXQ7P.js";import{_ as T}from"./_plugin-vue_export-helper.DF4WgY5m.js";const N=T({__name:"shmily-drag-image",props:{value:{type:Array,default:()=>[]},modelValue:{type:Array,default:()=>[]},keyName:{type:String,default:"image_url"},number:{type:Number,default:6},imageWidth:{type:Number,default:0},cols:{type:Number,default:3},borderRadius:{type:String,default:0},padding:{type:Number,default:10},scale:{type:Number,default:1.1},opacity:{type:Number,default:.7},itemMargin:{type:Number,default:10},imageRatio:{type:Number,default:.7}},emits:["input","update:modelValue","sort-change"],setup(T,{emit:N}){const k=T,I=N,V=e([]),z=e(0),C=e({x:0,y:0}),W=e(0),R=e(0),j=e(0),q=e(null),A=e(null),D=e(!0);e(!0);const F=e(!0),P=e(0),S=e(null),G=e(!1),O=e(!1),B=a((()=>V.value.length<k.number?Math.ceil((V.value.length+1)/W.value)*j.value+"px":Math.ceil(V.value.length/W.value)*j.value+"px")),H=a((()=>R.value-2*ue(k.padding)+"px")),J=a((()=>j.value-2*ue(k.padding)+"px")),K=e=>null!==k.keyName?e[k.keyName]:e,L=e=>({id:e.id,src:K(e),name:e.name,price:e.price,type:e.type}),Q=(e,a)=>{const l=V.value.findIndex((a=>a.id===e.id));-1!==l&&l!==a&&(V.value.splice(a,0,V.value.splice(l,1)[0]),V.value.forEach(((e,a)=>{e.index=a})),le())},U=(e,a)=>{e.index+=a,e.offset=0,e.x=e.oldX,e.y=e.oldY,e.absX=e.index%W.value,e.absY=Math.floor(e.index/W.value),setTimeout((()=>{o((()=>{e.x=e.absX*R.value,e.y=e.absY*j.value}))}),0)},Z=(e,a)=>{console.log("进入touchstart"),V.value.forEach((e=>{e.zIndex=e.index+9})),e.zIndex=99,e.moveEnd=!0,q.value=e,A.value=setTimeout((()=>{e.scale=k.scale,e.opacity=k.opacity,clearTimeout(A.value),A.value=null}),200)},$=e=>{var a;if(!e)return"";const l=(null==(a=e.split(",")[0])?void 0:a.trim())||"";return l.startsWith("http")?l:""},ee=()=>{V.value.forEach((e=>{e.disable=!1}))},ae=()=>{q.value&&(V.value.forEach((e=>{e.disable=!0,e.zIndex=e.index+9,e.offset=0,e.moveEnd=!1,e.id===q.value.id&&(A.value&&(clearTimeout(A.value),A.value=null),e.scale=1,e.opacity=1,e.x=e.oldX,e.y=e.oldY,o((()=>{e.x=e.absX*R.value,e.y=e.absY*j.value,q.value=null})))})),D.value=!0)};const le=()=>{const e=[],a=k.modelValue.length?k.modelValue:k.value,l=[...V.value].sort(((e,a)=>e.index-a.index));for(let u of l){const l=a.find((e=>K(e)===u.src));l?e.push(l):null!==k.keyName?e.push({[k.keyName]:u.src}):e.push(u.src)}I("input",e),I("update:modelValue",e)},ue=e=>z.value*e/750,te=e(null);l((()=>{z.value=u().windowWidth,te.value=t(),o((()=>{s().in(te.value.proxy).select(".con").boundingClientRect((e=>{if(!e)return void console.error("未找到 .con 元素");W.value=k.cols,R.value=e.width/k.cols,j.value=1.3*R.value,k.imageWidth>0&&(R.value=ue(k.imageWidth),j.value=1.3*R.value,W.value=Math.floor(e.width/R.value));(k.modelValue.length?k.modelValue:k.value).forEach((e=>{(e=>{const a=L(e),l=V.value.length%W.value,u=Math.floor(V.value.length/W.value),t=l*R.value,o=u*j.value;V.value.push({...a,x:t,y:o,oldX:t,oldY:o,absX:l,absY:u,scale:1,zIndex:9,opacity:1,index:V.value.length,id:e.id,disable:!1,offset:0,moveEnd:!1}),C.value.x=V.value.length%W.value*R.value,C.value.y=Math.floor(V.value.length/W.value)*j.value})(e)})),F.value=!1})).exec()})),O.value=!0}));n((()=>k.modelValue),(e=>{O.value&&o((()=>{new Promise((e=>{if(!te.value||!te.value.proxy)return console.warn("Component instance not available for selector query"),e();s().in(te.value.proxy).select(".con").boundingClientRect((a=>{if(!a)return e();W.value=k.cols,R.value=a.width/k.cols,j.value=1.3*R.value,k.imageWidth>0&&(R.value=ue(k.imageWidth),j.value=1.3*R.value,W.value=Math.floor(a.width/R.value)),e()})).exec()})).then((()=>{oe(e)}))}))}),{deep:!0,immediate:!0});const oe=e=>{const a=V.value.reduce(((e,a)=>(e[a.id]=a,e)),{});V.value=e.map((e=>{const l=a[e.id];return l?{...l,...L(e)}:se(e)})),V.value.forEach(((e,a)=>{e.index=a;const l=a%W.value,u=Math.floor(a/W.value);e.x=l*R.value,e.y=u*j.value,e.oldX=e.x,e.oldY=e.y,e.absX=l,e.absY=u}))},se=e=>{const a=L(e),l=V.value.length%W.value,u=Math.floor(V.value.length/W.value);return{...a,x:l*R.value,y:u*j.value,oldX:l*R.value,oldY:u*j.value,absX:l,absY:u,scale:1,zIndex:9,opacity:1,index:V.value.length,disable:!1,offset:0,moveEnd:!1,ready:!1}};return(e,a)=>{const l=_,u=X,t=M,s=E,n=w;return d(),i(t,{class:"con"},{default:v((()=>[R.value?(d(),i(n,{key:0,class:"area",style:r({height:B.value}),onMouseenter:ee,onMouseleave:ae},{default:v((()=>[(d(!0),c(h,null,m(V.value,((e,a)=>(d(),i(s,{key:e.id,class:"view",direction:"all",y:e.y,x:e.x,damping:40,disabled:e.disable||!e.ready,onChange:a=>((e,a)=>{if(a&&(a.oldX=e.detail.x,a.oldY=e.detail.y,"touch"===e.detail.source)){a.moveEnd&&(a.offset=Math.sqrt(Math.pow(a.oldX-a.absX*R.value,2)+Math.pow(a.oldY-a.absY*j.value,2)));let l=Math.floor((e.detail.x+R.value/2)/R.value);if(l>=W.value)return;let u=Math.floor((e.detail.y+j.value/2)/j.value),t=W.value*u+l;a.index!==t&&t<V.value.length&&(D.value=!1,V.value.forEach((e=>{a.index>t&&e.index>=t&&e.index<a.index?U(e,1):a.index<t&&e.index<=t&&e.index>a.index?U(e,-1):e.id!==a.id&&(e.offset=0,e.x=e.oldX,e.y=e.oldY,setTimeout((()=>{o((()=>{e.x=e.absX*R.value,e.y=e.absY*j.value}))}),0))})),Q(a,t),a.index=t,a.absX=l,a.absY=u,a.moveEnd||setTimeout((()=>{o((()=>{a.x=a.absX*R.value,a.y=a.absY*j.value}))}),0),le())}})(a,e),onTouchstart:a=>((e,a)=>{P.value=a.touches[0].clientY,S.value&&(clearTimeout(S.value),S.value=null),V.value.forEach((e=>{e.ready=!1,e.disable=!0})),console.log("长按开始"),S.value=setTimeout((()=>{console.log("长按成功！"),g({success:()=>{console.log("触感反馈")}}),e.ready=!0,e.disable=!1,G.value=!0,Z(e)}),240)})(e,a),onTouchend:a=>(e=>{if(e.scale=1,e.opacity=1,e.x=e.oldX,e.y=e.oldY,e.offset=0,e.moveEnd=!1,console.log("结束点击，清理ready"),V.value.forEach((e=>{e.ready=!1,e.disable=!0})),1==G.value){console.log("来自于拖拽的结束,上报排序事件");const e=V.value.map((e=>e.id));I("sort-change",e)}G.value=!1,S.value&&(clearTimeout(S.value),S.value=null),setTimeout((()=>{V.value.forEach((e=>{e.ready||(e.x=e.absX*R.value,e.y=e.absY*j.value,e.offset=0,e.moveEnd=!1)})),o((()=>{e.x=e.absX*R.value,e.y=e.absY*j.value,q.value=null,D.value=!0}))}),50)})(e),onClick:a=>{return l=e.id,void Y({url:"/pages/account_book_preview/account_book_preview?account_book_id="+l});var l},onTouchmove:e=>((e,a)=>{if(G.value)return;const l=e.touches[0].clientY;Math.abs(l-P.value)>10&&S.value&&(clearTimeout(S.value),S.value=null)})(e),style:r({width:R.value+"px",height:j.value+"px","z-index":e.zIndex,opacity:e.opacity})},{default:v((()=>[p(t,{class:y(["area-con",{ready:!e.disable&&e.ready}]),style:r({width:H.value,height:J.value,borderRadius:T.borderRadius+"rpx",transform:"scale("+e.scale+")",margin:T.itemMargin+"px"})},{default:v((()=>[p(l,{class:"pre-image",src:$(e.src),mode:"aspectFill"},null,8,["src"]),p(t,{class:"info-container"},{default:v((()=>[p(u,{class:"name"},{default:v((()=>[f(x(e.name),1)])),_:2},1024),p(u,{class:"price"},{default:v((()=>[f(x(e.price),1)])),_:2},1024),p(u,{class:"type"},{default:v((()=>[f(x(e.type),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["style","class"])])),_:2},1032,["y","x","disabled","onChange","onTouchstart","onTouchend","onClick","onTouchmove","style"])))),128))])),_:1},8,["style"])):b("",!0)])),_:1})}}},[["__scopeId","data-v-599cb54b"]]);export{N as _};
