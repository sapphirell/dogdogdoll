import{h as t,a1 as e,s as i,a2 as a,m as h,p as o,_ as s,a3 as r,a4 as n,a5 as c,a6 as l,o as p,c as g,w as d,a as u,d as m,F as w,q as f,v as R,V as y,i as x,f as v,a7 as I,a8 as T,R as S,L as b,a9 as M,j as C,aa as P,b as k,H}from"./index-CfMR_IzQ.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as _}from"./uni-app.es.5AkhYBbN.js";const z=t();function N(t){if("number"==typeof t||!isNaN(Number(t)))return e(t);if("string"==typeof t){if(t.endsWith("rpx"))return N(t.replace("rpx",""));if(t.endsWith("px"))return Number(t.replace("px",""));if(t.endsWith("vw"))return Number(t.replace("vw",""))*z.screenWidth/100;if(t.endsWith("vh"))return Number(t.replace("vh",""))*z.screenHeight/100}return 0}var W=[],$=0,D=[],j=0,q=null,F=null,X="",Y=null,L=null,U=null,B=0,O={imageRect:null,cropperRect:null};function E(){var t=O.imageRect;q.setStyle({left:t.left+"px",top:t.top+"px",width:t.width+"px",height:t.height+"px",transform:"rotate("+B+"deg)"})}function G(){var t=O.cropperRect;F.setStyle({left:t.left+"px",top:t.top+"px",width:t.width+"px",height:t.height+"px"})}function Z(t){var e=U.width*(t-1),i=U.height*(t-1);O.imageRect={width:U.width+e,height:U.height+i,left:U.left-e*D[0],top:U.top-i*D[1]}}function V(t){return t/180*Math.PI}function J(){var t=O.imageRect.width,e=O.imageRect.height,i=O.imageRect.left,a=O.imageRect.top,h=Math.sqrt(t*t+e*e),o=Math.atan(e/t)/Math.PI*180,s=B%90,r=Math.floor(B/90),n=h*Math.cos(V(o-s)),c=h*Math.sin(V(o+s));if(r%2==1){var l=n;n=c,c=l}return{width:n,height:c,left:i-(n-t)/2,top:a-(c-e)/2,dw:n-t,dh:c-e}}const K={touchStart:function(t,e){t.preventDefault(),t.stopPropagation(),Y=t.instance;var i=t.instance.getDataset();if(X=i.type,W=t.touches,e.callMethod("onTouchStart"),2==W.length){X="image";var a=W[0].clientX,h=W[0].clientY,o=W[1].clientX,s=W[1].clientY,r=Math.pow(o-a,2)+Math.pow(s-h,2);$=Math.sqrt(r);var n=((a+o)/2-U.left)/U.width,c=((h+s)/2-U.top)/U.height;D=[n,c]}return!1},touchMove:function(t,e){if(""==X)return!1;t.preventDefault(),t.stopPropagation();var i=t.touches,a=i[0].clientX-W[0].clientX,h=i[0].clientY-W[0].clientY;if(1==W.length){if("image"===X)O.imageRect.left=U.left+a,O.imageRect.top=U.top+h,E();else if("controller"===X){var o=0;Y.hasClass("left")&&(o=-1),Y.hasClass("right")&&(o=1);var s=0;Y.hasClass("top")&&(s=-1),Y.hasClass("bottom")&&(s=1);var r=a*o,n=h*s;0!==j&&(o*s!=0?r/j>n?r=(n=r/j)*j:n=(r=n*j)/j:0==o?r=n*j:n=r/j);var c=J(),l=L.width+r,p=L.height+n,g=c.left+c.width,d=c.top+c.height;if(-1!=o)L.left+l>g&&(l=g-L.left,0!==j&&(p=l/j));else L.left-r<c.left&&(l=L.left+L.width-c.left,0!==j&&(p=l/j));if(-1!=s)L.top+p>d&&(p=d-L.top,0!==j&&(l=p*j));else L.top-n<c.top&&(p=L.top+L.height-c.top,0!==j&&(l=p*j));-1==o&&(O.cropperRect.left=L.left+L.width-l),-1==s&&(O.cropperRect.top=L.top+L.height-p),O.cropperRect.width=l,O.cropperRect.height=p,G()}}else if(2==i.length&&2==W.length){var u=i[0].clientX-i[1].clientX,m=i[0].clientY-i[1].clientY,w=Math.pow(u,2)+Math.pow(m,2);Z((w=Math.sqrt(w))/$),E()}return!1},touchEnd:function(t,e){if("image"===X){var i=L.left,a=L.left+L.width,h=L.top,o=h+L.height,s=L.width/L.height,r=J(),n=r.width/r.height;if(r.width<L.width||r.height<L.height){var c=1;c=n<s?L.width/r.width:L.height/r.height,U.width=O.imageRect.width,U.height=O.imageRect.height,Z(c)}i<r.left&&(O.imageRect.left=i+r.dw/2),a>r.left+r.width&&(O.imageRect.left=a-r.width+r.dw/2),h<r.top&&(O.imageRect.top=h+r.dh/2),o>r.top+r.height&&(O.imageRect.top=o-r.height+r.dh/2),E()}return e.callMethod("updateData",{cropperRect:O.cropperRect,imageRect:O.imageRect}),X="",W=[],!1},changeRatio:function(t){j=t},changeRotateAngle:function(t){B=t,q&&E(),J()},changeImageRect:function(t,e,i){t&&(U=t,O.imageRect={left:t.left,top:t.top,width:t.width,height:t.height},setTimeout((function(){q=i.selectComponent(".mainContent > .image"),E()})))},changeCropper:function(t,e,i){t&&(L=t,O.cropperRect={left:t.left,top:t.top,width:t.width,height:t.height},setTimeout((function(){F=i.selectComponent(".mainContent > .cropper"),G()})))}},Q=t=>{t.$wxs||(t.$wxs=[]),t.$wxs.push("wxsModule"),t.mixins||(t.mixins=[]),t.mixins.push({beforeCreate(){this.wxsModule=K}})},tt={name:"bt-cropper",props:{imageSrc:{type:String,default:"",required:!0},mask:{type:String,default:""},containerSize:{type:Object,default:null},fileType:{type:String,default:"png"},dWidth:Number,maxWidth:{type:Number,default:2e3},ratio:{type:Number,default:0,validator:t=>"number"==typeof t&&!(t<0)},rotate:Number,showGrid:{type:Boolean,default:!1},quality:{type:Number,default:1},canvas2d:{type:Boolean,default:!1},initPosition:{type:Object,default:()=>null},autoZoom:{type:Boolean,default:!0}},data:()=>({canvasId:"bt-cropper",containerRect:null,imageInfo:null,operationHistory:[],operationIndex:0,anim:!1,timer:null,type2d:!1,pixel:1,imageRect:null,cropperRect:null,target:{width:0,height:0}}),watch:{imageSrc:{handler(t){"string"==typeof t&&""!==t?this.imageInit(t):this.imageInfo=null},immediate:!0},ratio(){0!=this.ratio&&(this.startAnim(),this.init())}},computed:{containerStyle(){return this.containerSize&&this.containerRect?{width:this.containerRect.width+"px",height:this.containerRect.height+"px"}:{}},rotateAngle(){const t=Number(this.rotate);return isNaN(t)?0:t%360}},methods:{startAnim(){this.stopAnim(),this.anim=!0,this.timer=setTimeout((()=>{this.anim=!1}),200)},stopAnim(){this.anim=!1,clearTimeout(this.timer)},imageInit(t){i({title:"载入中..."}),a({src:t,success:t=>{this.imageInfo=t,this.$nextTick((()=>{this.getContainer().then((t=>{this.containerRect=t,this.init()}))}))},fail:t=>{this.$emit("loadFail",t),h({title:"图片下载失败!",icon:"none"})},complete(t){o()}})},initCropper(){const t=this.imageInfo.width/this.imageInfo.height,e=this.containerRect.width/this.containerRect.height,i={};let a=this.ratio;0==a&&(a=this.cropperRect?this.cropperRect.width/this.cropperRect.height:1);const h={};return e>a?(h.height=.85*this.containerRect.height,h.width=h.height*a):(h.width=.85*this.containerRect.width,h.height=h.width/a),a>t?(i.width=h.width,i.height=i.width/t):(i.height=h.height,i.width=i.height*t),i.left=(this.containerRect.width-i.width)/2,i.top=(this.containerRect.height-i.height)/2,h.left=i.left+(i.width-h.width)/2,h.top=i.top+(i.height-h.height)/2,{imageRect:i,cropperRect:h}},init(){const{imageRect:t,cropperRect:e}=this.initCropper();if(this.initPosition){const i=this.imageInfo.width/t.width,{left:a,top:h,width:o,height:s}=this.initPosition;void 0!==a&&void 0!==h&&void 0!==o&&void 0!==s&&(e.width=o/i,e.height=s/i,e.left=a/i,e.top=h/i,this.$nextTick(this.zoomToFill))}this.imageRect=t,this.cropperRect=e,this.operationHistory=[{imageRect:t,cropperRect:e}],this.operationIndex=0,this.setTarget(),this.type2d=!1},setTarget(){const t=this.cropperRect.width/this.cropperRect.height;if(this.dWidth)this.target={width:this.dWidth,height:this.dWidth/(t||1)};else{const e=Math.min(this.maxWidth,this.cropperRect.width*(this.imageInfo.width/this.imageRect.width));this.target={width:e,height:e/(t||1)}}},addHistory({imageRect:t,cropperRect:e}){this.operationIndex!==this.operationHistory.length-1&&(this.operationHistory=this.operationHistory.slice(0,this.operationIndex)),this.operationHistory.push({imageRect:t,cropperRect:e}),this.operationHistory.length>10&&this.operationHistory.shift(),this.operationIndex=this.operationHistory.length-1},updateData(t){this.imageRect=t.imageRect,this.cropperRect=t.cropperRect,this.addHistory(t),this.setTarget(),this.autoZoom&&(this.timer=setTimeout((()=>{this.zoomToFill()}),600));const{imageRect:e,cropperRect:i}=t,a=e.width/this.imageInfo.width;this.$emit("change",{left:(i.left-e.left)/a,top:(i.top-e.top)/a,width:i.width/a,height:i.height/a})},getContainer(){if(null!==this.containerSize&&"object"==typeof this.containerSize){const{width:t,height:e}=this.containerSize;return Promise.resolve({width:N(t),height:N(e)})}return new Promise((t=>{s().in(this).select(".mainContent").boundingClientRect((e=>{t(e)})).exec()}))},zoomToFill(){this.startAnim();const t={...this.cropperRect};this.imageRect,this.cropperRect,this.cropperRect=this.initCropper().cropperRect;const e=this.cropperRect.width/t.width,i=t.left-this.imageRect.left,a=t.top-this.imageRect.top;this.imageRect={width:this.imageRect.width*e,height:this.imageRect.height*e,left:this.imageRect.left+(this.cropperRect.left-t.left)-(e-1)*i,top:this.imageRect.top+(this.cropperRect.top-t.top)-(e-1)*a}},onTouchStart(){this.stopAnim()},undo(){return this.operationIndex>0&&(this.operationIndex--,this.imageRect=this.operationHistory[this.operationIndex].imageRect,this.cropperRect=this.operationHistory[this.operationIndex].cropperRect,!0)},resume(){return this.operationIndex<this.operationHistory.length-1&&(this.operationIndex++,this.imageRect=this.operationHistory[this.operationIndex].imageRect,this.cropperRect=this.operationHistory[this.operationIndex].cropperRect,!0)},async drawImage(t,e,i,h,o,s){if(this.type2d)await new Promise((t=>e.onload=t)),t.drawImage(e,i*this.pixel,h*this.pixel,o*this.pixel,s*this.pixel);else{const r=await new Promise((t=>{a({src:e,success({path:e}){t(e)}})}));t.drawImage(r,i*this.pixel,h*this.pixel,o*this.pixel,s*this.pixel),await new Promise((e=>t.draw(!1,e)))}},async crop(){let t,e;if(this.$emit("cropStart"),this.setTarget(),this.type2d){const i=s().in(this);e=await new Promise((t=>i.select(".bt-canvas").node((({node:e})=>t(e))).exec())),e.width=this.target.width*this.pixel,e.height=this.target.height*this.pixel,t=e.getContext("2d")}else t=r(this.canvasId,this);const i=this.cropperRect.width/this.target.width,a=(this.cropperRect.left-this.imageRect.left)/i,h=(this.cropperRect.top-this.imageRect.top)/i;let o;this.type2d?(o=e.createImage(),o.src=this.imageSrc):o=this.imageSrc;const p=-a,g=-h,d=this.imageRect.width/i,u=this.imageRect.height/i;if(t.save(),t.translate(p+d/2,g+u/2),t.rotate(this.rotateAngle*Math.PI/180),t.translate(-(p+d/2),-(g+u/2)),await this.drawImage(t,o,p,g,d,u),t.restore(),""!==this.mask){let e,i;e=this.type2d?t.getImageData(0,0,this.target.width,this.target.height):await new Promise((t=>{n({canvasId:this.canvasId,x:0,y:0,width:this.target.width,height:this.target.height,success(e){t(e)}},this)})),t.clearRect(0,0,this.target.width,this.target.height),this.type2d?o.src=this.mask:o=this.mask,await this.drawImage(t,o,0,0,this.target.width,this.target.height),i=this.type2d?t.getImageData(0,0,this.target.width,this.target.height):await new Promise(((t,e)=>{n({canvasId:this.canvasId,x:0,y:0,width:this.target.width,height:this.target.height,success(e){t(e)}},this)})),t.clearRect(0,0,this.target.width,this.target.height);for(let t=3;t<i.data.length;t+=4){0!==i.data[t]&&(e.data[t]=0)}this.type2d?t.putImageData(e,0,0):await new Promise((t=>{c({canvasId:this.canvasId,x:0,y:0,width:e.width,height:e.height,data:e.data,complete:e=>{t(e)}},this)}))}return new Promise(((t,i)=>{const a={};this.type2d?a.canvas=e:a.canvasId=this.canvasId,l({...a,destWidth:this.target.width,destHeight:this.target.height,quality:Number(this.quality)||1,fileType:this.fileType,success:({tempFilePath:e})=>{for(var i=e.split(","),a=i[0].match(/:(.*?);/)[1],h=atob(i[1]),o=h.length,s=new Uint8Array(o),r=0;r<o;r++)s[r]=h.charCodeAt(r);var n=URL||webkitURL;t(n.createObjectURL(new Blob([s],{type:a}))),t(e)},fail(t){console.log("保存失败，错误信息：",t),i(t)}},this)}))}}};Q(tt);const et=A(tt,[["render",function(t,e,i,a,h,o){const s=x,r=v,n=I;return p(),g(r,{class:"bt-container",style:y([o.containerStyle])},{default:d((()=>[u(r,{class:"mainContent","data-type":"image",onTouchstart:t.wxsModule.touchStart,onTouchmove:t.wxsModule.touchMove,onTouchend:t.wxsModule.touchEnd},{default:d((()=>[h.imageRect&&h.cropperRect?(p(),m(w,{key:0},[u(s,{mode:"aspectFit",src:i.imageSrc,class:f(["image",{anim:h.anim}]),rotateAngle:o.rotateAngle,"change:rotateAngle":t.wxsModule.changeRotateAngle,"change:imageRect":t.wxsModule.changeImageRect,imageRect:h.imageRect},null,8,["src","rotateAngle","change:rotateAngle","change:imageRect","imageRect","class"]),u(r,{class:f(["cropper",{anim:h.anim}]),"change:cropperRect":t.wxsModule.changeCropper,cropperRect:h.cropperRect,"change:ratio":t.wxsModule.changeRatio,ratio:i.ratio},{default:d((()=>[u(s,{class:"mask",src:i.mask},null,8,["src"]),i.showGrid?(p(),m(w,{key:0},[u(r,{class:"line row row1"}),u(r,{class:"line row row2"}),u(r,{class:"line col col1"}),u(r,{class:"line col col2"})],64)):R("",!0),u(r,{class:"controller vertical left",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller vertical right",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller horizon top",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller horizon bottom",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller left top",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller left bottom",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller right top",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"]),u(r,{class:"controller right bottom",onTouchstart:t.wxsModule.touchStart,"data-type":"controller"},null,8,["onTouchstart"])])),_:1},8,["class","change:cropperRect","cropperRect","change:ratio","ratio"])],64)):R("",!0)])),_:1},8,["onTouchstart","onTouchmove","onTouchend"]),h.type2d?(p(),g(n,{key:0,type:"2d",class:"bt-canvas",width:h.target.width,height:h.target.height},null,8,["width","height"])):(p(),g(n,{key:1,"canvas-id":h.canvasId,class:"bt-canvas",style:y({width:h.target.width+"px",height:h.target.height+"px"}),width:h.target.width*h.pixel,height:h.target.height*h.pixel},null,8,["canvas-id","style","width","height"]))])),_:1},8,["style"])}],["__scopeId","data-v-503f171e"]]);const it=A({data:()=>({imageSrc:"",dist:"",mask:"",ratio:1,containerSize:{width:600,height:600},initPosition:null}),onLoad(t){this.imageSrc=decodeURIComponent(t.src)},onPullDownRefresh(){T()},methods:{openPopup(){this.$refs.pop.open()},change(){S({count:1,sizeType:["original"],success:t=>{let e=t.tempFilePaths[0];this.src=e,this.initPosition=null}})},close(){this.$refs.pop.close()},onChange(t){this.initPosition=t},undo(){this.$refs.cropper.undo()},resume(){this.$refs.cropper.resume()},crop(){this.$refs.cropper.crop().then((t=>{this.dist=t;const e=b(),i=e[e.length-2];console.log(i),i.returnParam=t,M({delta:1})}))}}},[["render",function(t,e,i,a,h,o){const s=_(C("bt-cropper"),et),r=H,n=v,c=P("uni-popup");return p(),g(n,{class:"container"},{default:d((()=>[u(c,{ref:"pop"},{default:d((()=>[u(n,{class:"content"},{default:d((()=>[u(s,{ref:"cropper",imageSrc:h.imageSrc,mask:h.mask,ratio:h.ratio,initPosition:h.initPosition,dWidth:800,fileType:"png",containerSize:h.containerSize,onChange:o.onChange},null,8,["imageSrc","mask","ratio","initPosition","containerSize","onChange"]),u(n,{class:"btns"},{default:d((()=>[u(r,{class:"button",onClick:o.crop},{default:d((()=>[k("裁剪")])),_:1},8,["onClick"]),u(r,{class:"button",onClick:o.undo},{default:d((()=>[k("撤销")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-ec9524e6"]]);export{it as default};
