import{g as e,a6 as t,W as a,a8 as l,l as s,m as n,j as o,d as i,c as u,w as r,a as c,u as d,N as p,F as m,C as g,f as v,o as f,k as _,b as h,t as y,r as k,q as S,A as w,x,n as I,i as C,e as F,v as j,B as $}from"./index-CAhh9jg-.js";import{_ as b}from"./uni-icons.DApveqxl.js";import{r as z}from"./uni-app.es.CI_TJZj7.js";import{_ as A,a as L}from"./comment-input.Koi9PTNE.js";import{w as R,b as O,a as P}from"./config.D_tpLRWx.js";import{_ as T}from"./_plugin-vue_export-helper.BCo6x5W8.js";const q=T({__name:"treehole_detail",props:{id:{type:String,required:!0}},setup(T){e(!0),e(!1),e("");const q=e(0),D=e(null),M=e(null),N=e(null);e(1);let B=e({});const H=e(!1),U=T,W=({parent:e,target:t})=>{var a;console.log("parent",e),console.log("target",t);let l=e;null!=t&&(l=t),B.value.id!=l.id?(console.log("item",l),B.value=l,null==(a=N.value)||a.focusInput()):B.value={}},Y=({content:e,replyInfo:t,origin:a})=>{let l=g("token");if(!P.isLogin)return void n({title:"请先登录",icon:"none"});console.log("reply_info",t);const o={content:e,origin:a,target_id:parseInt(q.value),type:5,...t.id&&{reply_id:t.id,reply_for:t.comment,reply_user_id:t.user_id,parent_id:t.parent_id>0?t.parent_id:t.id}};s({url:R+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:o,success:e=>{var t,a;if("success"==e.data.status){const l=e.data.data;0===l.parent_id?(console.log("添加主评论"),null==(t=M.value)||t.addNewComment(l)):(console.log("添加子评论"),null==(a=M.value)||a.addReplyComment(l)),n({title:"评论成功",icon:"success"})}else n({title:e.data.msg,icon:"none"})},fail:e=>{n({title:"网络请求失败",icon:"none"})}})};const E=()=>{if(!P.isLogin)return void x({title:"提示",content:"需要登录后才能点赞",success:e=>{e.confirm&&I({url:"/pages/login/login"})}});const e=g("token"),t=R+(H.value?"/with-state/unlike":"/with-state/add-like");s({url:t,method:"POST",header:{Authorization:e},data:{id:parseInt(U.id),type:5},success:e=>{"success"===e.data.status&&(H.value=!H.value,D.value.like_count+=H.value?1:-1)}})};const G=t((()=>{var e,t;return(null==(t=null==(e=D.value)?void 0:e.images)?void 0:t.slice(0,9))||[]})),J=t((()=>{var e,t;return((null==(t=null==(e=D.value)?void 0:e.images)?void 0:t.length)||0)-9})),K=t((()=>{var e,t;return((null==(t=null==(e=D.value)?void 0:e.images)?void 0:t.length)||0)>9}));a({title:"投稿详情"});const Q=t((()=>{const e=G.value.length;return 1===e?"single":2===e?"double":"multi"})),V=e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return l((async()=>{q.value=U.id,console.log("pageId",q.value);try{const e=await s({url:`${R}/treehole-detail?id=${U.id}`});"success"===e.data.status&&(D.value=e.data.data)}catch(e){console.log(e),n({title:"加载失败",icon:"none"})}O(),function(){let e=g("token");""!=e&&s({url:R+"/with-state/hasLike?id="+U.id+"&type=5",method:"POST",header:{Authorization:e},success:e=>{console.log(e.data),"success"==e.data.status?e.data.data.id>0?H.value=!0:H.value=!1:n({title:e.data.msg,icon:"none"})},fail:e=>{console.log(e),n({title:"网络请求失败",icon:"none"})}})}()})),(e,t)=>{const a=C,l=F,s=v,g=z(o("uni-icons"),b),x=z(o("comment-list"),A),I=z(o("comment-input"),L);return f(),i(m,null,[D.value?(f(),u(s,{key:0,class:"container"},{default:r((()=>[_("meta",{name:"theme-color",content:"#F8F8F8"}),c(s,{class:"header"},{default:r((()=>[c(s,{class:"author-info"},{default:r((()=>[c(a,{src:D.value.avatar||"/static/noname.png",class:"avatar",mode:"aspectFill"},null,8,["src"]),c(s,{style:{width:"500rpx"}},{default:r((()=>[c(l,{class:"author-name"},{default:r((()=>[h(y(D.value.author_name),1)])),_:1}),c(s,{class:"time"},{default:r((()=>[h(y(V(D.value.created_at)),1)])),_:1})])),_:1})])),_:1})])),_:1}),c(s,{class:"content"},{default:r((()=>[h(y(D.value.content),1)])),_:1}),c(s,{class:S(["image-container",Q.value])},{default:r((()=>[(f(!0),i(m,null,k(G.value,((e,t)=>(f(),u(s,{key:t,class:"image-wrapper"},{default:r((()=>[c(a,{src:e,mode:"aspectFill",class:"image-item",onClick:e=>(e=>{$({current:e,urls:D.value.images})})(t)},null,8,["src","onClick"]),K.value&&8===t?(f(),u(s,{key:0,class:"image-overlay"},{default:r((()=>[h(" +"+y(J.value),1)])),_:1})):j("",!0)])),_:2},1024)))),128))])),_:1},8,["class"]),c(s,{class:"action-bar"},{default:r((()=>[c(s,{class:"action-group"},{default:r((()=>[c(s,{class:"action-item",onClick:E},{default:r((()=>[c(g,{type:H.value?"hand-up-filled":"hand-up",size:"24",color:H.value?"#ff4d4f":"#666"},null,8,["type","color"]),c(l,{class:"action-text"},{default:r((()=>[h(y(D.value.like_count||0),1)])),_:1})])),_:1}),c(s,{class:"action-item",onClick:t[0]||(t[0]=e=>function(e){let t="http://m.dogdogdoll.com/#/pages/treehole_detail/treehole_detail?id="+e.id;w({data:t,success:function(){n({title:"复制链接成功",icon:"none"})}})}(D.value))},{default:r((()=>[c(g,{type:"redo",size:"24",color:"#666"}),c(l,{class:"action-text"},{default:r((()=>[h("分享")])),_:1})])),_:1})])),_:1}),c(l,{class:"time-text"},{default:r((()=>[h("审核于 "+y(V(D.value.approve_time)),1)])),_:1})])),_:1})])),_:1})):(f(),u(s,{key:1,class:"loading"},{default:r((()=>[h("加载中...")])),_:1})),c(s,{style:{padding:"10px"}},{default:r((()=>[c(x,{ref_key:"commentListRef",ref:M,type:5,"relation-id":parseInt(U.id),onReply:W},null,8,["relation-id"])])),_:1}),c(I,{ref_key:"commentInputRef",ref:N,"reply-info":d(B),"target-id":q.value,onSubmit:Y,"onUpdate:replyInfo":t[1]||(t[1]=e=>p(B)?B.value=e:B=e)},null,8,["reply-info","target-id"]),c(s,{style:{width:"100%",height:"120rpx"}})],64)}}},[["__scopeId","data-v-399d6b92"]]);export{q as default};
