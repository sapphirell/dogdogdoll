import{r as a,k as e,a3 as o,a as s,c as t,w as l,q as i,A as n,a0 as d,j as c,g as r,b as u,B as _,d as m,e as p,p as g,v as h,x as f,F as v,u as y,ab as w,f as b,i as k,S as x,N as j,ar as C,h as F,t as L,J as T}from"./index-I3aG4WZL.js";import{_ as z}from"./view-logs.C4HVuFxK.js";import{_ as I,a as V,r as $}from"./_plugin-vue_export-helper.DF4WgY5m.js";import{_ as A}from"./relation-picker.n1AK3sgz.js";import{_ as E}from"./cancel.CnEdunnH.js";import{_ as G}from"./add2.S6xx6DwX.js";import{_ as U}from"./right2.s_X9TKoF.js";import{w as D,i as P,g as S}from"./config.BjeWXQ7P.js";import{c as B,g as J,u as O}from"./image.C3pSdXmG.js";import"./uni-icons.BQtdpjJ2.js";import"./common-search.CQlKpRi4.js";import"./search.CsIL0f2m.js";import"./goods-search.gE0Nx2pd.js";import"./common-modal.-arcCNZ3.js";const q=I({__name:"showcase_form",props:["showcase_id"],setup(I){const q=I,K=a([]),M=a([]),N=a([]),Q=a(!1);a(""),a(0),a(""),a(0),a("");const R=a=>{try{const e={goods_id:a.goods.id||0,goods_name:a.goods.name,goods_image:a.goods.image||"",brand_id:a.brand.id||0,brand_name:a.brand.name||(a.isFuzzy?"":"未知品牌"),type:a.type||(a.isFuzzy?"未知类型":"")};oa.value.some((a=>0!==a.goods_id&&a.goods_id===e.goods_id||a.goods_name===e.goods_name))?n({title:"已存在相同关联项",icon:"none"}):oa.value.push(e)}catch(e){console.error("保存关联数据失败:",e),n({title:"保存关联信息失败",icon:"none"})}},H=()=>{console.log("用户取消选择")},W=()=>{Q.value=!0},X=e((()=>[-1,1,3].includes(ea.value))),Y=e((()=>q.showcase_id>0)),Z=a(""),aa=a(""),ea=a(-1);const oa=a([]);function sa(a){T({current:K.value[a],urls:K.value})}async function ta(){y({title:"确认删除",content:"确定要删除这个展示吗？",success:async a=>{if(a.confirm)try{"success"===(await i({url:`${D}/with-state/delete-showcase?id=`+q.showcase_id,method:"POST",header:{Authorization:c("token")}})).data.status&&(n({title:"删除成功"}),setTimeout((()=>w()),1e3))}catch(e){n({title:"删除失败",icon:"none"})}}})}async function la(){if(!c("token"))return void n({title:"请先登录",icon:"none"});if(!Z.value.trim()||!aa.value.trim())return void n({title:"标题和正文不能为空",icon:"none"});if(0===K.value.length)return void n({title:"请至少上传一张图片",icon:"none"});let a=S(),e={name:Z.value,description:aa.value,image_urls:K.value.join(","),display:ea.value,origin:a,relations:oa.value.map((a=>({relation_goods_id:a.goods_id,relation_goods_name:a.goods_name,relation_brand_id:a.brand_id,relation_brand_name:a.brand_name,type:a.type,relation_origin:2})))};try{let a=`${D}/with-state/add-showcase`;q.showcase_id&&(a=`${D}/with-state/update-showcase`,e={...e,id:parseInt(q.showcase_id,10)});if("failed"===(await i({url:a,method:"POST",data:e,header:{"Content-Type":"application/json",Authorization:c("token")}})).data.code)return void n({title:"提交失败",icon:"none"});n({title:"提交成功"}),setTimeout((()=>w()),1500)}catch(o){console.log(o),n({title:"提交失败",icon:"none"})}}return o({title:"展示柜"}),V((async a=>{if(a.goods_id&&a.goods_name&&a.brand_id&&a.brand_name&&a.type){let s="";try{s=(await(e=parseInt(a.goods_id),new Promise(((a,o)=>{i({url:D+"/goods?id="+e,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),a(e.data)},fail:a=>{console.log(a),n({title:"网络请求失败",icon:"none"}),o(a)},complete:()=>{d()}})})))).data.goods_images[0]||""}catch(o){console.error("获取商品图片失败:",o)}oa.value.push({brand_id:parseInt(a.brand_id,10),goods_id:parseInt(a.goods_id,10),brand_name:a.brand_name,goods_name:a.goods_name,goods_image:s,type:a.type})}var e;i({url:D+"/goods-types",method:"GET",timeout:5e3,success:a=>{console.log(a.data.data),N.value=a.data.data},fail:a=>{console.log(a),n({title:"网络请求失败",icon:"none"})}}),async function(){var a;if(q.showcase_id)try{const e=(await i({url:`${D}/with-state/showcase-detail?id=${q.showcase_id}`,method:"GET",header:{Authorization:c("token")}})).data.data;Z.value=e.name,aa.value=e.description,ea.value=e.display,K.value=(null==(a=e.image_urls)?void 0:a.split(","))||[],console.log(e),e.relations&&(oa.value=e.relations.map((a=>({goods_id:a.relation_goods_id,goods_name:a.relation_goods_name,brand_id:a.relation_brand_id,brand_name:a.relation_brand_name,type:a.type,goods_image:a.relation_goods_image}))))}catch(e){n({title:"加载失败",icon:"none"})}}()})),(a,e)=>{const o=$(s("view-logs"),z),i=b,d=r,c=k,y=x,w=j,T=C,I=$(s("relation-picker"),A),V=F;return u(),t(d,null,{default:l((()=>[_("meta",{name:"theme-color",content:"#F8F8F8"}),m(o),X.value?g("",!0):(u(),t(d,{key:0,class:"edit-tip"},{default:l((()=>[m(i,null,{default:l((()=>[p("当前状态不可编辑")])),_:1})])),_:1})),m(d,{style:{width:"100%",overflow:"hidden"}},{default:l((()=>[m(y,{"scroll-x":"true",class:"upload_box","ll-with-animation":"true","show-scrollbar":!1},{default:l((()=>[(u(!0),h(v,null,f(K.value,((a,e)=>(u(),t(d,{class:"upload_item",key:e},{default:l((()=>[m(c,{src:a,class:"uploaded_image",onClick:sa,mode:"aspectFill"},null,8,["src"]),X.value?(u(),t(c,{key:0,src:E,class:"close_icon",onClick:a=>function(a){K.value.splice(a,1)}(e)},null,8,["onClick"])):g("",!0)])),_:2},1024)))),128)),X.value?(u(),t(d,{key:0,class:"uploadImageBox",style:{background:"#f8f8f8"}},{default:l((()=>[m(c,{src:G,class:"upload_img",onClick:e[0]||(e[0]=e=>async function(){try{const a=await B(9);for(const e of a){const a=await J();await O(e,a.token,a.path),K.value.push(P+a.path)}n({title:`成功上传${a.length}张图片`,icon:"success"})}catch(a){console.error("上传出错:",a),n({title:"部分图片上传失败",icon:"none"})}}(a.index)),style:{width:"50px",height:"50px",margin:"25px"}})])),_:1})):g("",!0)])),_:1})])),_:1}),m(w,{modelValue:Z.value,"onUpdate:modelValue":e[1]||(e[1]=a=>Z.value=a),type:"text",disabled:!X.value,placeholder:"请输入标题",style:{padding:"10px",margin:"20px 15px 5px 15px",display:"block"}},null,8,["modelValue","disabled"]),m(d,{class:"oneLine"}),m(T,{modelValue:aa.value,"onUpdate:modelValue":e[2]||(e[2]=a=>aa.value=a),disabled:!X.value,placeholder:"请输入描述",style:{padding:"10px",margin:"10px 15px 5px 15px",display:"block","line-height":"28px",width:"calc(100% - 50px)"}},null,8,["modelValue","disabled"]),m(d,{class:"oneLine"}),m(d,{class:""},{default:l((()=>[X.value?(u(),t(d,{key:0,class:"relation-trigger",onClick:W},{default:l((()=>[m(i,{class:"placeholder"},{default:l((()=>[p("点击关联娃物")])),_:1}),m(c,{src:U,class:"arrow-icon"})])),_:1})):g("",!0)])),_:1}),m(d,{class:"publish-detail"},{default:l((()=>[m(i,null,{default:l((()=>[p("* 展示您的宝宝们 🩵。")])),_:1}),m(i,null,{default:l((()=>[p("* 不关联商品的展示柜不会出现在广场中。")])),_:1})])),_:1}),m(d,{class:"saveCollocationDataList"},{default:l((()=>[(u(!0),h(v,null,f(oa.value,((a,e)=>(u(),t(d,{key:e},{default:l((()=>[m(d,{class:"saveCollocationDataItem"},{default:l((()=>[a.goods_image?(u(),t(c,{key:0,src:a.goods_image,mode:"aspectFill",style:{width:"70px",height:"70px"}},null,8,["src"])):(u(),t(i,{key:1,class:"no-image"},{default:l((()=>[p("?")])),_:1})),m(i,{class:"info-tap",style:{width:"calc(100% - 120px)",display:"inline-block"}},{default:l((()=>[p(L(a.type)+" "+L(a.brand_name)+" - "+L(a.goods_name),1)])),_:2},1024),X.value?(u(),t(c,{key:2,src:E,class:"close_icon",onClick:a=>function(a){oa.value.splice(a,1)}(e)},null,8,["onClick"])):g("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),m(I,{visible:Q.value,"onUpdate:visible":e[3]||(e[3]=a=>Q.value=a),typeList:N.value,goodsList:M.value,onConfirm:R,onCancel:H},null,8,["visible","typeList","goodsList"]),m(d,{class:"footer"},{default:l((()=>[Y.value?(u(),t(V,{key:0,onClick:ta,class:"delete-btn"},{default:l((()=>[p("删除")])),_:1})):g("",!0),m(V,{onClick:la},{default:l((()=>[p("发表")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-11416105"]]);export{q as default};
