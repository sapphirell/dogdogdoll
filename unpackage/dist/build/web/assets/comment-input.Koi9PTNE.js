import{g as l,ad as e,a8 as a,l as t,m as s,j as o,o as n,c,w as u,b as i,t as d,a as r,d as m,F as p,r as f,v as _,q as h,n as y,f as v,e as C,i as g,h as k,a6 as w,aj as b,ak as I,U as A,al as x,a9 as T,H as j}from"./index-CAhh9jg-.js";import{_ as F}from"./uni-icons.DApveqxl.js";import{r as $,b as z}from"./uni-app.es.CI_TJZj7.js";import{w as q,d as M}from"./config.D_tpLRWx.js";import{_ as N}from"./_plugin-vue_export-helper.BCo6x5W8.js";const B=N({__name:"comment-list",props:{type:{type:Number,required:!0},relationId:{type:Number,required:!0}},emits:["reply"],setup(k,{expose:w,emit:b}){const I=k,A=l([]),x=l(1),T=l(0),j=l(!0);e({});const z=b,M=l(!1);w({addNewComment:l=>{A.value.unshift({...l,showAll:!1,localChildren:[],childTotal:0})},addReplyComment:l=>{const e=A.value.find((e=>e.id===l.parent_id));e&&(e.localChildren||(e.localChildren=[]),"number"!=typeof e.childTotal&&(e.childTotal=0),e.localChildren.unshift(l),e.childTotal+=1,!e.showAll&&e.childTotal<=5&&(e.showAll=!0))}}),a((()=>{R()}));const N=l=>!l.showAll&&l.localChildren.length>5?l.localChildren.slice(0,5):l.localChildren,B=async()=>{if(!M.value&&j.value)try{M.value=!0,x.value+=1,await R()}finally{M.value=!1}},V=l=>{y({url:"/pages/user_page/user_page?uid="+l})},D=l=>{const e=new Date(1e3*l);return`${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}`},H=l=>l.length>12?l.slice(0,12)+"...":l,R=async()=>{try{M.value=!0;const l=await t({url:`${q}/get-comments`,data:{relation_id:I.relationId,type:I.type,page:x.value,page_size:10}});if("success"===l.data.status){const e=l.data.data,a=e.comment_list.map((l=>({...l,showAll:!1,localChildren:l.children||[],childTotal:l.childTotal||(l.children?l.children.length:0)})));1===x.value?A.value=a:A.value.push(...a),console.log("total",e.total),j.value=e.total>A.value.length,T.value=e.total,console.log("是否还有更多?",j.value)}}catch(l){s({title:"加载失败",icon:"none"})}finally{M.value=!1}},U=(l,e=null)=>{z("reply",{parent:l,target:e,relationId:I.relationId})},O=l=>l.childTotal>5&&!l.showAll,S=l=>l.childTotal-Math.min(l.localChildren.length,5);return(l,e)=>{const a=v,y=C,k=g,w=$(o("uni-icons"),F);return n(),c(a,{class:"comment-container"},{default:u((()=>[A.value.length>0?(n(),c(a,{key:0,class:"comment-count"},{default:u((()=>[i(" 共"+d(T.value)+"条回复 ",1)])),_:1})):(n(),c(a,{key:1,class:"empty-tips"},{default:u((()=>[r(y,null,{default:u((()=>[i("-- 暂无回复 --")])),_:1})])),_:1})),(n(!0),m(p,null,f(A.value,(l=>(n(),c(a,{key:l.id,class:"comment-card"},{default:u((()=>[r(a,{class:"main-comment"},{default:u((()=>[r(k,{onClick:e=>V(l.uid),src:l.avatar,class:"avatar",mode:"aspectFill"},null,8,["onClick","src"]),r(a,{class:"content"},{default:u((()=>[r(a,{class:"header"},{default:u((()=>[r(y,{class:"username",onClick:e=>V(l.uid)},{default:u((()=>[i(d(H(l.username)),1)])),_:2},1032,["onClick"]),r(y,{class:"floor"},{default:u((()=>[i("#"+d(l.floor),1)])),_:2},1024)])),_:2},1024),r(y,{class:"comment-text",onClick:e=>U(l)},{default:u((()=>[i(d(l.comment),1)])),_:2},1032,["onClick"]),r(a,{class:"footer"},{default:u((()=>[r(y,{class:"time"},{default:u((()=>[i(d(D(l.created_at)),1)])),_:2},1024),r(a,{class:"actions"},{default:u((()=>[r(y,{class:"reply-btn",onClick:e=>U(l)},{default:u((()=>[i("回复")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024),l.localChildren&&l.localChildren.length?(n(),c(a,{key:0,class:"sub-comments"},{default:u((()=>[(n(!0),m(p,null,f(N(l),((e,t)=>(n(),c(a,{key:e.id,class:"sub-comment"},{default:u((()=>[r(k,{onClick:l=>V(e.uid),src:e.avatar,class:"avatar",mode:"aspectFill"},null,8,["onClick","src"]),r(a,{class:"content"},{default:u((()=>[r(a,{class:"header"},{default:u((()=>[r(y,{onClick:l=>V(e.uid),class:"username"},{default:u((()=>[i(d(H(e.username)),1)])),_:2},1032,["onClick"]),e.reply_for?(n(),c(y,{key:0,class:"reply-to"},{default:u((()=>[i("@"+d(e.reply_for),1)])),_:2},1024)):_("",!0)])),_:2},1024),r(y,{class:"comment-text",onClick:e=>U(l)},{default:u((()=>[i(d(e.comment),1)])),_:2},1032,["onClick"]),r(a,{class:"footer"},{default:u((()=>[r(y,{class:"time"},{default:u((()=>[i(d(D(e.created_at)),1)])),_:2},1024),r(a,{class:"actions"},{default:u((()=>[r(y,{class:"reply-btn",onClick:a=>U(l,e)},{default:u((()=>[i("回复")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),O(l)?(n(),c(a,{key:0,class:"load-more",onClick:e=>(async l=>{if(l.localChildren.length<l.childTotal){const a=Math.ceil(l.localChildren.length/5)+1;try{const e=await t({url:`${q}/get-comments-by-parent-id`,data:{parent_id:l.id,page:a}});"success"===e.data.status&&(l.localChildren=[...l.localChildren,...e.data.data.comment_list],l.childTotal=e.data.data.total,l.localChildren.length>=5&&!l.showAll&&(l.showAll=!0))}catch(e){s({title:"加载失败",icon:"none"})}}else l.showAll=!l.showAll})(l)},{default:u((()=>[r(y,null,{default:u((()=>[i("展开"+d(S(l))+"条回复",1)])),_:2},1024),r(w,{type:"arrow-down",size:"18",color:"#007AFF"})])),_:2},1032,["onClick"])):_("",!0)])),_:2},1024)):_("",!0)])),_:2},1024)))),128)),A.value.length>0?(n(),c(a,{key:2,class:"load-more-box"},{default:u((()=>[j.value?(n(),c(a,{key:0,class:h(["load-more-btn",{loading:M.value}]),onClick:B},{default:u((()=>[M.value?(n(),c(a,{key:1},{default:u((()=>[r(w,{type:"spinner-cycle",size:"16",color:"#888"})])),_:1})):(n(),c(a,{key:0},{default:u((()=>[r(y,null,{default:u((()=>[i(" 加载更多 ")])),_:1}),r(w,{type:"arrow-down",size:"18",color:"#007AFF"})])),_:1}))])),_:1},8,["class"])):(n(),c(a,{key:1,class:"no-more"},{default:u((()=>[r(y,null,{default:u((()=>[i("-- 没有更多了 --")])),_:1})])),_:1}))])),_:1})):_("",!0)])),_:1})}}},[["__scopeId","data-v-5245de6d"]]),V=N({__name:"comment-input",props:{replyInfo:{type:Object,default:()=>({})},targetId:{type:String,required:!0},safeBottom:{type:Number,default:10}},emits:["submit","update:replyInfo"],setup(e,{expose:a,emit:t}){const o=e,c=l(null),d=l(!1),f=t,_=l(""),y=l(!1),C=l(0),g=k(),F=w((()=>{var l,e;let a=(null==(l=g.safeAreaInsets)?void 0:l.bottom)||10;console.log("底部安全距离1:",null==(e=g.safeAreaInsets)?void 0:e.bottom,"=>",a);return`${a+C.value}px`})),$=()=>{y.value=!0,d.value=!0},q=()=>{y.value=!1,d.value=!1},N=()=>{y.value=!1,d.value=!1,x()},B=()=>{if(!_.value.trim())return void s({title:"请输入评论内容",icon:"none"});let l=M();console.log("scene",l),f("submit",{content:_.value,target_id:o.targetId,type:4,replyInfo:o.replyInfo,origin:l}),_.value="",f("update:replyInfo",{})};return a({focusInput:()=>{d.value=!0}}),z((()=>{})),(l,a)=>{const t=v,s=T,o=j;return n(),m(p,null,[b(r(t,{class:"mask",onClick:N},null,512),[[I,y.value]]),r(t,{class:"bottom_tab","adjust-position":!1,style:A({paddingBottom:F.value})},{default:u((()=>[r(s,{focus:d.value,class:h(["comment_input unified-textarea",{expanded:d.value}]),ref_key:"inputRef",ref:c,modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=l=>_.value=l),onFocus:$,onBlur:q,"adjust-position":!1,placeholder:e.replyInfo.username?"回复@"+e.replyInfo.username+" ":"写评论..."},null,8,["focus","class","modelValue","placeholder"]),r(o,{onClick:B},{default:u((()=>[i("写评论")])),_:1})])),_:1},8,["style"])],64)}}},[["__scopeId","data-v-958d699a"]]);export{B as _,V as a};
