import{g as a,h as e,W as t,m as o,j as l,c as s,w as i,l as n,C as r,f as u,o as d,a as c,u as _,b as g,t as f,d as m,r as v,F as p,v as y,N as h,n as k,e as w,i as S,y as I,B as $,D as b}from"./index-CAhh9jg-.js";import{_ as x}from"./uni-icons.DApveqxl.js";import{b as C,o as L,r as j}from"./uni-app.es.CI_TJZj7.js";import{_ as z,a as E}from"./comment-input.Koi9PTNE.js";import{b as F,w as A,a as P}from"./config.D_tpLRWx.js";import{_ as T}from"./_plugin-vue_export-helper.BCo6x5W8.js";const D=T({__name:"collocation_share",props:{collocation_id:{type:String,default:0},origin:{type:String,default:0}},setup(T){const D=a({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),O=a({userName:"",avatar:""});e();const R=a(!0),M=a(!1),N=a(""),G=T,B=a(0),H=a(0);let U=a(!1);const W=a(null),Y=a(null);a(1);let q=a({});t({title:"搭配详情"});const J=async(a,e)=>{var t;try{const l=await n({url:A+`/view-collocation?collocation_id=${a}&origin=${e}`});if("success"!==l.data.status)return void Q(l.data.msg||"数据加载失败");const s={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async a=>{try{const e=a.relation_goods_id>0?await(a=>new Promise(((e,t)=>{a&&0!==a?n({url:`${A}/goods?id=${a}`,method:"GET",timeout:5e3,success:a=>{"success"===a.data.status?e(a.data.data):t(a.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),o({title:"网络请求失败",icon:"none"}),t(a)}}):t("无效的商品ID")})))(a.relation_goods_id):null;return{...a,goodsInfo:e,imageLoaded:!!e,imageError:!e}}catch(e){return console.error("商品信息获取失败:",e),{...a,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};D.value=s,(null==(t=l.data.data)?void 0:t.uid)&&await K(l.data.data.uid)}catch(l){Q("数据加载失败")}finally{R.value=!1}},K=async a=>{try{const e=await n({url:`${A}/user-info?uid=${a}`,method:"GET"});"success"===e.data.status?O.value=e.data.data:console.error("获取用户信息失败:",e.data.msg)}catch(e){console.error("用户信息请求失败:",e),o({title:"作者信息加载失败",icon:"none"})}},Q=a=>{M.value=!0,N.value=a,o({title:a,icon:"none"})};function V(a){let e=r("token");if(""==e)return;let t=1==H.value?3:4;n({url:A+"/with-state/hasLike?id="+a+"&type="+t,method:"POST",header:{Authorization:e},success:a=>{"success"==a.data.status?a.data.data.id>0?U.value=!0:U.value=!1:o({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}function X(a){if(a<1e3)return a.toString();return`${Math.floor(a/1e3)}k+`}const Z=({parent:a,target:e})=>{var t;console.log("parent",a),console.log("target",e);let o=a;null!=e&&(o=e),q.value.id!=o.id?(console.log("item",o),q.value=o,null==(t=Y.value)||t.focusInput()):q.value={}},aa=({content:a,replyInfo:e,origin:t})=>{let l=r("token");if(!P.isLogin)return void o({title:"请先登录",icon:"none"});console.log("reply_info",e);const s={content:a,origin:t,target_id:parseInt(B.value),type:1==G.origin?3:6,...e.id&&{reply_id:e.id,reply_for:e.comment,reply_user_id:e.user_id,parent_id:e.parent_id>0?e.parent_id:e.id}};n({url:A+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:s,success:a=>{var e,t;if("success"==a.data.status){const l=a.data.data;0===l.parent_id?null==(e=W.value)||e.addNewComment(l):null==(t=W.value)||t.addReplyComment(l),o({title:"评论成功",icon:"success"})}else o({title:a.data.msg,icon:"none"})},fail:a=>{o({title:"网络请求失败",icon:"none"})}})};function ea(a){const e=new Date(1e3*a),t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),l=e.getDate().toString().padStart(2,"0"),s=e.getHours().toString().padStart(2,"0"),i=e.getMinutes().toString().padStart(2,"0");return e.getSeconds().toString().padStart(2,"0"),`${t}-${o}-${l} ${s}:${i}`}return C((()=>{})),L((a=>{try{if(!a.collocation_id)return M.value=!0,void(N.value="缺少必要参数Id");if(!a.origin)return M.value=!0,void(N.value="缺少必要参数Origin");B.value=a.collocation_id,H.value=a.origin,J(a.collocation_id,a.origin),F().then((e=>{console.log(e),V(a.collocation_id)}))}catch(e){console.error("onLoad Error:",e),o({title:"加载失败",icon:"none"})}})),(a,e)=>{const t=j(l("uni-icons"),x),C=w,L=u,F=S,T=b,G=I,K=j(l("comment-list"),z),Q=j(l("comment-input"),E);return d(),s(L,null,{default:i((()=>[c(L,{style:{position:"relative"}},{default:i((()=>[c(L,{class:"heart",onClick:e[0]||(e[0]=a=>function(){let a=r("token");if(!P.isLogin)return void o({title:"请先登录",icon:"none"});let e=1==H.value?3:4,t={id:parseInt(D.value.id),type:e},l=U.value?"/with-state/unlike":"/with-state/add-like";n({url:A+l,method:"POST",header:{Authorization:a},data:t,success:a=>(console.log(a.data),"success"==a.data.status?(o({title:"操作成功",icon:"success"}),U.value=!U.value,V(D.value.id),void J(D.value.id,H.value)):void o({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),o({title:"网络请求失败",icon:"none"})}})}())},{default:i((()=>[_(U)?(d(),s(t,{key:1,type:"heart-filled",size:"28",color:"#ff4d4f"})):(d(),s(t,{key:0,type:"heart",size:"28",color:"#ff4d4f"})),c(C,{class:"num"},{default:i((()=>{var a;return[g(f((null==(a=D.value)?void 0:a.like_count)?X(D.value.like_count):0),1)]})),_:1})])),_:1}),c(G,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:i((()=>[(d(!0),m(p,null,v(D.value.image_url_list,((a,e)=>(d(),s(T,{key:e},{default:i((()=>[c(F,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>function(a){console.log(D),$({current:D.value.image_url_list[a],urls:D.value.image_url_list})}(e)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),c(L,{class:"author-info",onClick:e[1]||(e[1]=a=>{return e=D.value.uid,void k({url:"/pages/user_page/user_page?uid="+e});var e})},{default:i((()=>[c(F,{class:"avatar",src:O.value.avatar,mode:"aspectFill"},null,8,["src"]),c(L,{class:"user-meta"},{default:i((()=>[c(C,{class:"username"},{default:i((()=>[g(f(O.value.user_name||"未知用户"),1)])),_:1}),c(C,{class:"publish-time"},{default:i((()=>[g("发布于 "+f(ea(D.value.created_at)),1)])),_:1})])),_:1})])),_:1}),c(L,{class:"content-box"},{default:i((()=>[c(C,{class:"title"},{default:i((()=>[g(f(D.value.title),1)])),_:1}),c(C,{class:"content"},{default:i((()=>[g(f(D.value.content),1)])),_:1})])),_:1}),c(L,{class:"goods-list"},{default:i((()=>[(d(!0),m(p,null,v(D.value.collocation_relation_list,(a=>(d(),s(L,{key:a.id,class:"goods-item",onClick:e=>{return a.relation_goods_id>0?void(0!=(t=a.relation_goods_id)?k({url:`/pages/goods/goods?goods_id=${t}`}):o({title:"商品暂时没有录入",icon:"none"})):null;var t}},{default:i((()=>[c(L,{class:"image-container"},{default:i((()=>{var e,t;return[0===a.relation_goods_id?(d(),s(L,{key:0,class:"placeholder-box"},{default:i((()=>[c(C,{style:{color:"#fff","font-size":"45px"}},{default:i((()=>[g("?")])),_:1})])),_:1})):(d(),m(p,{key:1},[a.imageLoaded?(d(),s(F,{key:0,src:(null==(t=null==(e=a.goodsInfo)?void 0:e.goods_images)?void 0:t[0])||"/static/goods-default.png",mode:"aspectFill",class:"goods-image"},null,8,["src"])):a.imageError?(d(),s(L,{key:1,class:"error-box"},{default:i((()=>[c(C,null,{default:i((()=>[g("图片加载失败")])),_:1})])),_:1})):(d(),s(L,{key:2,class:"loading-box"},{default:i((()=>[c(C,null,{default:i((()=>[g("加载中...")])),_:1})])),_:1}))],64))]})),_:2},1024),c(L,{class:"goods-info"},{default:i((()=>[c(C,{class:"brand"},{default:i((()=>[g(f(a.relation_brand_name)+" - "+f(a.relation_goods_name),1)])),_:2},1024),c(L,null,{default:i((()=>[c(C,{class:"category"},{default:i((()=>[g(f(a.type),1)])),_:2},1024),c(C,{class:"price"},{default:i((()=>[g(" （"+f(a.goodsInfo&&a.goodsInfo.total_amount?a.goodsInfo.total_amount+a.goodsInfo.currency:"贩售价格未收录")+"）",1)])),_:2},1024)])),_:2},1024),c(L,{class:"see font-alimamashuhei"},{default:i((()=>[g(" 去看看 → ")])),_:1})])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),H.value>0?(d(),s(L,{key:0,style:{padding:"10px"}},{default:i((()=>[c(K,{ref_key:"commentListRef",ref:W,type:1==H.value?3:6,"relation-id":parseInt(B.value),onReply:Z},null,8,["type","relation-id"])])),_:1})):y("",!0),c(Q,{ref_key:"commentInputRef",ref:Y,"reply-info":_(q),"target-id":B.value,onSubmit:aa,"onUpdate:replyInfo":e[2]||(e[2]=a=>h(q)?q.value=a:q=a)},null,8,["reply-info","target-id"]),c(L,{style:{width:"100%",height:"120rpx"}}),R.value?(d(),s(L,{key:1,class:"loading"},{default:i((()=>[g("加载中...")])),_:1})):y("",!0),M.value?(d(),s(L,{key:2,class:"error"},{default:i((()=>[g(f(N.value),1)])),_:1})):y("",!0)])),_:1})}}},[["__scopeId","data-v-600ec406"]]);export{D as default};
