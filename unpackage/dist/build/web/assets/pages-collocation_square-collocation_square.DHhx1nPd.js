import{r as a,av as l,o as e,l as s,z as o,A as t,q as c,as as n,a as i,v as u,B as r,d,w as f,F as v,a1 as _,b as g,D as m,c as p,x as y,e as h,p as k,a0 as w,H as b,aw as C,n as x,i as j,g as $,S as z,f as S,h as E,t as F}from"./index-BFzTDSoz.js";import{w as O,_ as P}from"./view-logs.yEAac7W9.js";import{_ as T,o as A,r as q}from"./_plugin-vue_export-helper.CXFOpRdI.js";import{_ as B}from"./goods-search.DW_4Fo2f.js";import{_ as D}from"./uni-icons.COaeasi-.js";import{a as G,_ as H}from"./common-modal.DWKlFhUY.js";import{_ as I}from"./loading-toast.Ct1e0P5S.js";import{_ as J}from"./common-page.Dhg03y__.js";import"./search.CsIL0f2m.js";import"./cancel.CnEdunnH.js";const Q=T({__name:"collocation_square",setup(T){const Q=a("find"),L=a([]),M=a(!1),N=a(!1),R=a(1),U=a(0),W=a(0),Z=l([0,0]),K=a(!1),V=a(""),X=a([]),Y=C(),aa=a(null),la=a([]);a(null);const ea=a([]),sa=a(!1),oa=a(!1),ta=a(-1),ca=a("全部"),na=a("全部"),ia=a([]),ua=a([]),ra=a(!1),da=()=>{ra.value=!ra.value},fa=()=>{ra.value=!1},va=()=>{fa(),x({url:"/pages/collocation/collocation"})},_a=()=>{fa(),x({url:"/pages/stock/showcase_form/showcase_form"})},ga=a=>{const l=L.value[a];return l.position?{left:`${l.position.left}px`,top:`${l.position.top}px`,width:`${W.value}px`}:{}},ma=a=>{if(console.log("进入计算布局逻辑"),!a)return void console.log("无法获取instance");if(console.log("获取成功"),!L.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(a);const l=_().in(a.proxy);console.log("获取到query");const e=L.value.map(((a,e)=>new Promise((a=>{l.select(`#card-${e}`).boundingClientRect((l=>{a({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),Z[0]=0,Z[1]=0;const a=await Promise.all(e);a.length?(a.forEach((({index:a,rect:l})=>{if(!l)return void console.error(`卡片${a}元素查询失败`);const e=L.value[a],s=Z[0]<=Z[1]?0:1,o=s*(W.value+10),t=Z[s]+10;Z[s]=t+l.height,e.position={left:o,top:t}})),U.value=Math.max(...Z)+20):console.warn("未查询到任何卡片元素")}))},pa=a=>{ra.value=!1,K.value=!1,"view"===Q.value&&(L.value.forEach((a=>{delete a.position})),Z[0]=0,Z[1]=0),ya(a)},ya=a=>{Q.value=a,"find"===a&&(0===ia.value.length&&(ha(),ka()),0===ea.value.length&&wa(!0)),"view"==a&&Ca()},ha=async()=>{try{const a=await c({url:`${O}/goods-types`,method:"GET"});"success"===a.data.status&&(ia.value=["全部",...a.data.data])}catch(a){console.error("获取商品分类失败:",a)}},ka=async()=>{try{const a=await c({url:`${O}/sizes?show_type=hot`,method:"GET"});if("success"===a.data.status){const l=Object.keys(a.data.data);ua.value=["全部",...l]}}catch(a){console.error("获取尺寸分类失败:",a)}},wa=async(a=!1)=>{if(a&&(ea.value=[],ta.value=-1,oa.value=!1),!sa.value&&!oa.value)try{sa.value=!0;const l={cursor:ta.value,page_size:10,type:"全部"===ca.value?"":ca.value,size:"全部"===na.value?"":na.value},e=await c({url:`${O}/random-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if("success"===e.data.status){const l=e.data.data,s=l.goods_list||[];ea.value=a?s:[...ea.value,...s],ta.value=l.next_cursor,oa.value=s.length<10}}catch(l){console.error("获取随机商品失败:",l),t({title:"加载失败",icon:"none"})}finally{sa.value=!1}},ba=()=>{wa()};e((()=>{const a=s();W.value=(a.windowWidth-30)/2,ha(),ka(),wa(!0)})),A((async()=>{try{"view"===Q.value?await Ca(!0):"find"===Q.value&&await wa(!0),o()}catch(a){o(),t({title:"刷新失败",icon:"none"})}}));const Ca=async(a=!1)=>{if(a&&(L.value=[],R.value=1,N.value=!1,M.value=!1),M.value||N.value)return console.log("正在加载或没有更多数据，停止请求"),void xa();try{M.value=!0;const l={page:R.value,page_size:10,filter_goods_id_list:la.value.map((a=>a.goods_id))};console.log("请求参数:",JSON.stringify(l,null,2));const e=await c({url:`${O}/collocation-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if(console.log("接口响应:",e),"success"===e.data.status){const l=e.data.data||{},s=Array.isArray(l.collocation_relation_list)?l.collocation_relation_list:[];L.value=a?s:[...L.value,...s],N.value=s.length<10,R.value++,a&&0===s.length&&t({title:"暂无相关搭配",icon:"none"}),xa()}}catch(l){console.error("请求失败:",l),t({title:"加载失败",icon:"none"})}finally{M.value=!1}},xa=async()=>{console.log("等待next tick"),await n(),console.log("等待完成"),ma(Y),setTimeout((()=>{console.log("二次计算布局"),ma(Y)}),500)},ja=()=>{K.value=!0},$a=a=>{if(console.log("选择商品:",a),!(null==a?void 0:a.id))return;const l={goods_id:a.id,goods_name:`${a.brand_name?a.brand_name+"·":""}${a.name}`};la.value.some((a=>a.goods_id===l.goods_id))||(la.value=[...la.value,l])};const za=async()=>{K.value=!1,await Ca(!0)},Sa=()=>{K.value=!1},Ea=(a,l)=>{var e;null==(e=null==l?void 0:l.stopPropagation)||e.call(l),la.value=la.value.filter((l=>l.goods_id!==a)),N.value=!1,Ca(!0)},Fa=()=>{aa.value=null,V.value="",la.value=[],X.value=[]};const Oa=()=>{N.value||Ca()};return(a,l)=>{const e=q(i("view-logs"),P),s=j,o=$,t=q(i("goods-search"),B),c=z,n=S,_=E,C=q(i("uni-icons"),D),O=q(i("uni-transition"),G),T=q(i("common-modal"),H),A=q(i("loading-toast"),I),R=q(i("common-page"),J);return g(),u(v,null,[r("meta",{name:"theme-color",content:"#def9ff"}),d(e),d(R,{head_color:"#def9ff"},{default:f((()=>[d(o,{class:"tabs"},{default:f((()=>[d(o,{class:m(["tab",{active:"find"===Q.value}]),onClick:l[0]||(l[0]=a=>pa("find"))},{default:f((()=>[d(s,{src:"/assets/findfind-BcxoDLxZ.gif",class:"tab-image"})])),_:1},8,["class"]),d(o,{class:m(["tab",{active:"view"===Q.value}]),onClick:l[1]||(l[1]=a=>pa("view"))},{default:f((()=>[d(s,{src:"/assets/sesee-CekStySO.png",class:"tab-image",style:{position:"relative",bottom:"5rpx"}})])),_:1},8,["class"])])),_:1}),"find"===Q.value?(g(),p(o,{key:0},{default:f((()=>[d(o,{class:"category-container"},{default:f((()=>[d(o,{style:{margin:"10rpx 0 40rpx 0"}},{default:f((()=>[d(t,{"hidden-icon":!1,width:"670rpx"})])),_:1}),d(c,{"scroll-x":"",class:"category-scroll","show-scrollbar":!1},{default:f((()=>[(g(!0),u(v,null,y(ia.value,((a,l)=>(g(),p(o,{class:m(["category-item",{active:ca.value===a}]),key:l,onClick:l=>(a=>{ca.value=a,wa(!0)})(a)},{default:f((()=>[h(F(a),1)])),_:2},1032,["class","onClick"])))),128))])),_:1}),d(c,{"scroll-x":"",class:"size-scroll","show-scrollbar":!1},{default:f((()=>[(g(!0),u(v,null,y(ua.value,((a,l)=>(g(),p(o,{class:m(["size-item",{active:na.value===a}]),key:l,onClick:l=>(a=>{na.value=a,wa(!0)})(a)},{default:f((()=>[h(F(a),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),d(c,{class:"goods-list","scroll-y":"",onScrolltolower:ba,"show-scrollbar":!1},{default:f((()=>[d(o,{class:"goods-container"},{default:f((()=>[(g(!0),u(v,null,y(ea.value,((a,l)=>(g(),p(o,{key:a.id,class:"goods-card",onClick:l=>{return e=a.id,void x({url:"/pages/goods/goods?goods_id="+e});var e}},{default:f((()=>[d(s,{src:a.goods_images[0],mode:"aspectFill",class:"goods-image"},null,8,["src"]),d(o,{class:"goods-info"},{default:f((()=>[d(n,{class:"goods-name"},{default:f((()=>[h(F(a.name),1)])),_:2},1024),d(n,{class:"goods-brand"},{default:f((()=>[h(F(a.brand_name),1)])),_:2},1024),d(n,{class:"goods-price"},{default:f((()=>[h(F(a.total_amount)+" "+F(a.currency),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),d(o,{class:"loading-state"},{default:f((()=>[sa.value?(g(),p(n,{key:0},{default:f((()=>[h("加载中...")])),_:1})):k("",!0),oa.value?(g(),p(n,{key:1,class:"no-more"},{default:f((()=>[h("没有更多了")])),_:1})):k("",!0)])),_:1})])),_:1})])),_:1})):k("",!0),"view"===Q.value?(g(),p(o,{key:1},{default:f((()=>[d(o,{class:"filter-bar-container"},{default:f((()=>[d(o,{class:"filter-bar"},{default:f((()=>[d(o,{class:"filter-tags",onClick:ja},{default:f((()=>[d(o,{class:"selected-goods"},{default:f((()=>[(g(!0),u(v,null,y(la.value,(a=>(g(),p(o,{key:a.goods_id,class:"tag",onClick:b((l=>Ea(a.goods_id,l)),["stop"])},{default:f((()=>[h(F(a.goods_name)+" ",1),d(n,{class:"remove"},{default:f((()=>[h("×")])),_:1})])),_:2},1032,["onClick"])))),128))])),_:1}),la.value.length?k("",!0):(g(),p(n,{key:0,class:"tip"},{default:f((()=>[h("当前无筛选条件")])),_:1}))])),_:1}),d(_,{class:"submit-btn",onClick:l[2]||(l[2]=a=>Ca(!0))},{default:f((()=>[h("筛选")])),_:1})])),_:1})])),_:1}),d(o,{class:"container"},{default:f((()=>[d(c,{class:"card-list","scroll-y":"",onScrolltolower:Oa,"show-scrollbar":!1},{default:f((()=>[d(o,{class:"cards-container",style:w({height:U.value+"px"})},{default:f((()=>[(g(!0),u(v,null,y(L.value,((a,l)=>(g(),p(o,{key:a.collocation_id,class:"card",id:"card-"+l,style:w(ga(l)),onClick:l=>{return e=a.collocation_id,s=a.origin,void x({url:"/pages/collocation_share/collocation_share?collocation_id="+e+"&origin="+s});var e,s}},{default:f((()=>{var l;return[d(o,{class:"user-info",onClick:b((l=>{return e=a.uid,void x({url:`/pages/user_page/user_page?uid=${e}`});var e}),["stop"])},{default:f((()=>[d(s,{src:a.avatar||"/default_avatar.jpg",class:"avatar",mode:"aspectFill"},null,8,["src"]),d(o,{class:"user-meta"},{default:f((()=>[d(n,{class:"username"},{default:f((()=>{return[h(F((l=a.username,l.length>10?`${l.toString().slice(-8)}...`:l)),1)];var l})),_:2},1024),d(o,{class:"like-count"},{default:f((()=>[d(C,{type:"hand-up",size:"18",color:"#5f85a3"}),d(n,{style:{margin:"0 5rpx",color:"#5f85a3"}},{default:f((()=>[h(F(a.like_count),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),(null==(l=a.image_urls)?void 0:l.length)>0?(g(),p(s,{key:0,src:a.image_urls[0],mode:"aspectFill",class:"card-image","lazy-load":""},null,8,["src"])):k("",!0),d(o,{class:"card-content"},{default:f((()=>[d(n,{class:"title"},{default:f((()=>[h(F(a.title),1)])),_:2},1024),d(n,{class:"desc"},{default:f((()=>[h(F(a.content),1)])),_:2},1024),d(o,{class:"goods-tags"},{default:f((()=>[(g(!0),u(v,null,y(a.relation_list,((a,l)=>(g(),p(o,{class:"tag-box",key:l},{default:f((()=>[d(n,{class:"goods-tag"},{default:f((()=>[h(F(a.relation_goods_name||"未命名商品"),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)]})),_:2},1032,["id","style","onClick"])))),128))])),_:1},8,["style"]),d(o,{class:"loading-state"},{default:f((()=>[M.value?(g(),p(n,{key:0},{default:f((()=>[h("加载中...")])),_:1})):k("",!0),N.value?(g(),p(n,{key:1,class:"no-more"},{default:f((()=>[h("没有更多了")])),_:1})):k("",!0)])),_:1})])),_:1}),d(o,{class:"floating-button",onClick:da},{default:f((()=>[d(C,{type:"plusempty",size:"30",color:"#fff"})])),_:1}),d(O,{name:"fade",mode:"out-in",duration:300},{default:f((()=>[ra.value?(g(),p(o,{key:0,class:"post-menu-mask",onClick:fa})):k("",!0)])),_:1}),d(o,{class:m(["post-menu",{show:ra.value}])},{default:f((()=>[d(o,{class:"menu-item",onClick:va},{default:f((()=>[d(C,{style:{"margin-right":"10rpx"},type:"color",size:"24",color:"#5f85a3"}),d(n,null,{default:f((()=>[h("发搭配分享")])),_:1})])),_:1}),d(o,{class:"menu-item",onClick:_a},{default:f((()=>[d(C,{style:{"margin-right":"10rpx"},type:"compose",size:"24",color:"#5f85a3"}),d(n,null,{default:f((()=>[h("发展示柜")])),_:1})])),_:1})])),_:1},8,["class"]),d(T,{visible:K.value,"onUpdate:visible":l[3]||(l[3]=a=>K.value=a),top:"0",width:"100%",height:"100%"},{default:f((()=>[d(o,{class:"modal-mask",onClick:b(Sa,["stop"])}),d(o,{class:"filter-modal"},{default:f((()=>[d(o,{class:"modal-header",style:w("margin-top:0rpx")},{default:f((()=>[d(n,{class:"title"},{default:f((()=>[h("筛选看想要的娃物搭配吧！")])),_:1}),d(n,{class:"close",onClick:Sa},{default:f((()=>[h("×")])),_:1})])),_:1},8,["style"]),d(t,{mode:"fill",onSelect:$a,background:"#f8f8f8",width:"100%"}),d(o,{class:"selected-goods"},{default:f((()=>[(g(!0),u(v,null,y(la.value,(a=>(g(),p(o,{key:a.goods_id,class:"goods-tag",onClick:b((l=>Ea(a.goods_id,l)),["stop"])},{default:f((()=>[h(F(a.goods_name)+" ",1),d(n,{class:"remove"},{default:f((()=>[h("×")])),_:1})])),_:2},1032,["onClick"])))),128))])),_:1}),d(o,{class:"action-btns"},{default:f((()=>[d(_,{class:"btn reset",onClick:Fa},{default:f((()=>[h("重置")])),_:1}),d(_,{class:"btn confirm",onClick:za},{default:f((()=>[h("应用筛选")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])])),_:1})])),_:1})):k("",!0),d(A,{show:sa.value||M.value},null,8,["show"])])),_:1})],64)}}},[["__scopeId","data-v-1d129cc4"]]);export{Q as default};
