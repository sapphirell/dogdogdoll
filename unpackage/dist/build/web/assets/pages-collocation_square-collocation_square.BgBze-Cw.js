import{r as a,av as l,o as e,p as s,z as o,A as t,v as c,as as n,a as i,k as u,B as r,d,w as f,F as v,a1 as _,b as g,C as m,c as p,l as y,e as h,u as k,a0 as w,H as C,aw as b,n as x,i as j,g as $,S as z,f as S,h as E,t as F}from"./index-6ojkiy1R.js";import{_ as O}from"./goods-search.BuQh0O7r.js";import{o as P,r as T}from"./uni-app.es.BMFd5FAr.js";import{_ as A}from"./uni-icons.C75VRGWb.js";import{a as B,_ as G}from"./common-modal.Biav_mER.js";import{_ as q}from"./loading-toast.DerU_Gz0.js";import{_ as H}from"./common-page.fI1NTZim.js";import{w as I}from"./config.Bhvn_Gfs.js";import{_ as J}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./search.CsIL0f2m.js";import"./cancel.CnEdunnH.js";const K=J({__name:"collocation_square",setup(J){const K=a("find"),Q=a([]),D=a(!1),M=a(!1),N=a(1),R=a(0),U=a(0),W=l([0,0]),L=a(!1),V=a(""),X=a([]),Y=b(),Z=a(null),aa=a([]);a(null);const la=a([]),ea=a(!1),sa=a(!1),oa=a(-1),ta=a("全部"),ca=a("全部"),na=a([]),ia=a([]),ua=a(!1),ra=()=>{ua.value=!ua.value},da=()=>{ua.value=!1},fa=()=>{da(),x({url:"/pages/collocation/collocation"})},va=()=>{da(),x({url:"/pages/stock/showcase_form/showcase_form"})},_a=a=>{const l=Q.value[a];return l.position?{left:`${l.position.left}px`,top:`${l.position.top}px`,width:`${U.value}px`}:{}},ga=a=>{if(console.log("进入计算布局逻辑"),!a)return void console.log("无法获取instance");if(console.log("获取成功"),!Q.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(a);const l=_().in(a.proxy);console.log("获取到query");const e=Q.value.map(((a,e)=>new Promise((a=>{l.select(`#card-${e}`).boundingClientRect((l=>{a({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),W[0]=0,W[1]=0;const a=await Promise.all(e);a.length?(a.forEach((({index:a,rect:l})=>{if(!l)return void console.error(`卡片${a}元素查询失败`);const e=Q.value[a],s=W[0]<=W[1]?0:1,o=s*(U.value+10),t=W[s]+10;W[s]=t+l.height,e.position={left:o,top:t}})),R.value=Math.max(...W)+20):console.warn("未查询到任何卡片元素")}))},ma=a=>{ua.value=!1,L.value=!1,"view"===K.value&&(Q.value.forEach((a=>{delete a.position})),W[0]=0,W[1]=0),pa(a)},pa=a=>{K.value=a,"find"===a&&(0===na.value.length&&(ya(),ha()),0===la.value.length&&ka(!0)),"view"==a&&Ca()},ya=async()=>{try{const a=await c({url:`${I}/goods-types`,method:"GET"});"success"===a.data.status&&(na.value=["全部",...a.data.data])}catch(a){console.error("获取商品分类失败:",a)}},ha=async()=>{try{const a=await c({url:`${I}/sizes?show_type=hot`,method:"GET"});if("success"===a.data.status){const l=Object.keys(a.data.data);ia.value=["全部",...l]}}catch(a){console.error("获取尺寸分类失败:",a)}},ka=async(a=!1)=>{if(a&&(la.value=[],oa.value=-1,sa.value=!1),!ea.value&&!sa.value)try{ea.value=!0;const l={cursor:oa.value,page_size:10,type:"全部"===ta.value?"":ta.value,size:"全部"===ca.value?"":ca.value},e=await c({url:`${I}/random-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if("success"===e.data.status){const l=e.data.data,s=l.goods_list||[];la.value=a?s:[...la.value,...s],oa.value=l.next_cursor,sa.value=s.length<10}}catch(l){console.error("获取随机商品失败:",l),t({title:"加载失败",icon:"none"})}finally{ea.value=!1}},wa=()=>{ka()};e((()=>{const a=s();U.value=(a.windowWidth-30)/2,ya(),ha(),ka(!0)})),P((async()=>{try{"view"===K.value?await Ca(!0):"find"===K.value&&await ka(!0),o()}catch(a){o(),t({title:"刷新失败",icon:"none"})}}));const Ca=async(a=!1)=>{if(a&&(Q.value=[],N.value=1,M.value=!1,D.value=!1),D.value||M.value)return console.log("正在加载或没有更多数据，停止请求"),void ba();try{D.value=!0;const l={page:N.value,page_size:10,filter_goods_id_list:aa.value.map((a=>a.goods_id))};console.log("请求参数:",JSON.stringify(l,null,2));const e=await c({url:`${I}/collocation-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if(console.log("接口响应:",e),"success"===e.data.status){const l=e.data.data||{},s=Array.isArray(l.collocation_relation_list)?l.collocation_relation_list:[];Q.value=a?s:[...Q.value,...s],M.value=s.length<10,N.value++,a&&0===s.length&&t({title:"暂无相关搭配",icon:"none"}),ba()}}catch(l){console.error("请求失败:",l),t({title:"加载失败",icon:"none"})}finally{D.value=!1}},ba=async()=>{console.log("等待next tick"),await n(),console.log("等待完成"),ga(Y),setTimeout((()=>{console.log("二次计算布局"),ga(Y)}),500)},xa=()=>{L.value=!0},ja=a=>{if(console.log("选择商品:",a),!(null==a?void 0:a.id))return;const l={goods_id:a.id,goods_name:`${a.brand_name?a.brand_name+"·":""}${a.name}`};aa.value.some((a=>a.goods_id===l.goods_id))||(aa.value=[...aa.value,l])};const $a=async()=>{L.value=!1,await Ca(!0)},za=()=>{L.value=!1},Sa=(a,l)=>{var e;null==(e=null==l?void 0:l.stopPropagation)||e.call(l),aa.value=aa.value.filter((l=>l.goods_id!==a)),M.value=!1,Ca(!0)},Ea=()=>{Z.value=null,V.value="",aa.value=[],X.value=[]};const Fa=()=>{M.value||Ca()};return(a,l)=>{const e=j,s=$,o=T(i("goods-search"),O),t=z,c=S,n=E,_=T(i("uni-icons"),A),b=T(i("uni-transition"),B),P=T(i("common-modal"),G),I=T(i("loading-toast"),q),J=T(i("common-page"),H);return g(),u(v,null,[r("meta",{name:"theme-color",content:"#def9ff"}),d(J,{head_color:"#def9ff"},{default:f((()=>[d(s,{class:"tabs"},{default:f((()=>[d(s,{class:m(["tab",{active:"find"===K.value}]),onClick:l[0]||(l[0]=a=>ma("find"))},{default:f((()=>[d(e,{src:"/assets/findfind-ChBSsG6K.png",class:"tab-image"})])),_:1},8,["class"]),d(s,{class:m(["tab",{active:"view"===K.value}]),onClick:l[1]||(l[1]=a=>ma("view"))},{default:f((()=>[d(e,{src:"/assets/sesee-CekStySO.png",class:"tab-image",style:{position:"relative",bottom:"5rpx"}})])),_:1},8,["class"])])),_:1}),"find"===K.value?(g(),p(s,{key:0},{default:f((()=>[d(s,{class:"category-container"},{default:f((()=>[d(s,{style:{margin:"10rpx 0 40rpx 0"}},{default:f((()=>[d(o,{"hidden-icon":!1,width:"670rpx"})])),_:1}),d(t,{"scroll-x":"",class:"category-scroll","show-scrollbar":!1},{default:f((()=>[(g(!0),u(v,null,y(na.value,((a,l)=>(g(),p(s,{class:m(["category-item",{active:ta.value===a}]),key:l,onClick:l=>(a=>{ta.value=a,ka(!0)})(a)},{default:f((()=>[h(F(a),1)])),_:2},1032,["class","onClick"])))),128))])),_:1}),d(t,{"scroll-x":"",class:"size-scroll","show-scrollbar":!1},{default:f((()=>[(g(!0),u(v,null,y(ia.value,((a,l)=>(g(),p(s,{class:m(["size-item",{active:ca.value===a}]),key:l,onClick:l=>(a=>{ca.value=a,ka(!0)})(a)},{default:f((()=>[h(F(a),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),d(t,{class:"goods-list","scroll-y":"",onScrolltolower:wa,"show-scrollbar":!1},{default:f((()=>[d(s,{class:"goods-container"},{default:f((()=>[(g(!0),u(v,null,y(la.value,((a,l)=>(g(),p(s,{key:a.id,class:"goods-card",onClick:l=>{return e=a.id,void x({url:"/pages/goods/goods?goods_id="+e});var e}},{default:f((()=>[d(e,{src:a.goods_images[0],mode:"aspectFill",class:"goods-image"},null,8,["src"]),d(s,{class:"goods-info"},{default:f((()=>[d(c,{class:"goods-name"},{default:f((()=>[h(F(a.name),1)])),_:2},1024),d(c,{class:"goods-brand"},{default:f((()=>[h(F(a.brand_name),1)])),_:2},1024),d(c,{class:"goods-price"},{default:f((()=>[h(F(a.total_amount)+" "+F(a.currency),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),d(s,{class:"loading-state"},{default:f((()=>[ea.value?(g(),p(c,{key:0},{default:f((()=>[h("加载中...")])),_:1})):k("",!0),sa.value?(g(),p(c,{key:1,class:"no-more"},{default:f((()=>[h("没有更多了")])),_:1})):k("",!0)])),_:1})])),_:1})])),_:1})):k("",!0),"view"===K.value?(g(),p(s,{key:1},{default:f((()=>[d(s,{class:"filter-bar-container"},{default:f((()=>[d(s,{class:"filter-bar"},{default:f((()=>[d(s,{class:"filter-tags",onClick:xa},{default:f((()=>[d(s,{class:"selected-goods"},{default:f((()=>[(g(!0),u(v,null,y(aa.value,(a=>(g(),p(s,{key:a.goods_id,class:"tag",onClick:C((l=>Sa(a.goods_id,l)),["stop"])},{default:f((()=>[h(F(a.goods_name)+" ",1),d(c,{class:"remove"},{default:f((()=>[h("×")])),_:1})])),_:2},1032,["onClick"])))),128))])),_:1}),aa.value.length?k("",!0):(g(),p(c,{key:0,class:"tip"},{default:f((()=>[h("当前无筛选条件")])),_:1}))])),_:1}),d(n,{class:"submit-btn",onClick:l[2]||(l[2]=a=>Ca(!0))},{default:f((()=>[h("筛选")])),_:1})])),_:1})])),_:1}),d(s,{class:"container"},{default:f((()=>[d(t,{class:"card-list","scroll-y":"",onScrolltolower:Fa,"show-scrollbar":!1},{default:f((()=>[d(s,{class:"cards-container",style:w({height:R.value+"px"})},{default:f((()=>[(g(!0),u(v,null,y(Q.value,((a,l)=>(g(),p(s,{key:a.collocation_id,class:"card",id:"card-"+l,style:w(_a(l)),onClick:l=>{return e=a.collocation_id,s=a.origin,void x({url:"/pages/collocation_share/collocation_share?collocation_id="+e+"&origin="+s});var e,s}},{default:f((()=>{var l;return[d(s,{class:"user-info",onClick:C((l=>{return e=a.uid,void x({url:`/pages/user_page/user_page?uid=${e}`});var e}),["stop"])},{default:f((()=>[d(e,{src:a.avatar||"/default_avatar.jpg",class:"avatar",mode:"aspectFill"},null,8,["src"]),d(s,{class:"user-meta"},{default:f((()=>[d(c,{class:"username"},{default:f((()=>{return[h(F((l=a.username,l.length>10?`${l.toString().slice(-8)}...`:l)),1)];var l})),_:2},1024),d(s,{class:"like-count"},{default:f((()=>[d(_,{type:"hand-up",size:"18",color:"#5f85a3"}),d(c,{style:{margin:"0 5rpx",color:"#5f85a3"}},{default:f((()=>[h(F(a.like_count),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),(null==(l=a.image_urls)?void 0:l.length)>0?(g(),p(e,{key:0,src:a.image_urls[0],mode:"aspectFill",class:"card-image","lazy-load":""},null,8,["src"])):k("",!0),d(s,{class:"card-content"},{default:f((()=>[d(c,{class:"title"},{default:f((()=>[h(F(a.title),1)])),_:2},1024),d(c,{class:"desc"},{default:f((()=>[h(F(a.content),1)])),_:2},1024),d(s,{class:"goods-tags"},{default:f((()=>[(g(!0),u(v,null,y(a.relation_list,((a,l)=>(g(),p(s,{class:"tag-box",key:l},{default:f((()=>[d(c,{class:"goods-tag"},{default:f((()=>[h(F(a.relation_goods_name||"未命名商品"),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)]})),_:2},1032,["id","style","onClick"])))),128))])),_:1},8,["style"]),d(s,{class:"loading-state"},{default:f((()=>[D.value?(g(),p(c,{key:0},{default:f((()=>[h("加载中...")])),_:1})):k("",!0),M.value?(g(),p(c,{key:1,class:"no-more"},{default:f((()=>[h("没有更多了")])),_:1})):k("",!0)])),_:1})])),_:1}),d(s,{class:"floating-button",onClick:ra},{default:f((()=>[d(_,{type:"plusempty",size:"30",color:"#fff"})])),_:1}),d(b,{name:"fade",mode:"out-in",duration:300},{default:f((()=>[ua.value?(g(),p(s,{key:0,class:"post-menu-mask",onClick:da})):k("",!0)])),_:1}),d(s,{class:m(["post-menu",{show:ua.value}])},{default:f((()=>[d(s,{class:"menu-item",onClick:fa},{default:f((()=>[d(_,{style:{"margin-right":"10rpx"},type:"color",size:"24",color:"#5f85a3"}),d(c,null,{default:f((()=>[h("发搭配分享")])),_:1})])),_:1}),d(s,{class:"menu-item",onClick:va},{default:f((()=>[d(_,{style:{"margin-right":"10rpx"},type:"compose",size:"24",color:"#5f85a3"}),d(c,null,{default:f((()=>[h("发展示柜")])),_:1})])),_:1})])),_:1},8,["class"]),d(P,{visible:L.value,"onUpdate:visible":l[3]||(l[3]=a=>L.value=a),top:"0",width:"100%",height:"100%"},{default:f((()=>[d(s,{class:"modal-mask",onClick:C(za,["stop"])}),d(s,{class:"filter-modal"},{default:f((()=>[d(s,{class:"modal-header",style:w("margin-top:0rpx")},{default:f((()=>[d(c,{class:"title"},{default:f((()=>[h("筛选看想要的娃物搭配吧！")])),_:1}),d(c,{class:"close",onClick:za},{default:f((()=>[h("×")])),_:1})])),_:1},8,["style"]),d(o,{mode:"fill",onSelect:ja,background:"#f8f8f8",width:"100%"}),d(s,{class:"selected-goods"},{default:f((()=>[(g(!0),u(v,null,y(aa.value,(a=>(g(),p(s,{key:a.goods_id,class:"goods-tag",onClick:C((l=>Sa(a.goods_id,l)),["stop"])},{default:f((()=>[h(F(a.goods_name)+" ",1),d(c,{class:"remove"},{default:f((()=>[h("×")])),_:1})])),_:2},1032,["onClick"])))),128))])),_:1}),d(s,{class:"action-btns"},{default:f((()=>[d(n,{class:"btn reset",onClick:Ea},{default:f((()=>[h("重置")])),_:1}),d(n,{class:"btn confirm",onClick:$a},{default:f((()=>[h("应用筛选")])),_:1})])),_:1})])),_:1})])),_:1},8,["visible"])])),_:1})])),_:1})):k("",!0),d(I,{show:ea.value||D.value},null,8,["show"])])),_:1})],64)}}},[["__scopeId","data-v-88373245"]]);export{K as default};
