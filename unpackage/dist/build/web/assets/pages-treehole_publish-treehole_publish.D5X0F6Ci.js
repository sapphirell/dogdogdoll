import{r as a,a3 as e,k as l,o as s,a as t,c as o,w as n,q as u,g as c,b as i,B as r,d,D as m,e as v,t as p,v as f,x as h,F as _,A as g,$ as b,j as k,a0 as x,ab as y,f as j,K as w,i as C,S as F,ar as T,W as V,X as I,Y as S,h as z,J as A}from"./index-I3aG4WZL.js";import{_ as B}from"./view-logs.C4HVuFxK.js";import{_ as D,r as E}from"./_plugin-vue_export-helper.DF4WgY5m.js";import{_ as G}from"./uni-icons.BQtdpjJ2.js";import{_ as O}from"./cancel.CnEdunnH.js";import{_ as q}from"./add2.S6xx6DwX.js";import{w as J,i as K}from"./config.BjeWXQ7P.js";import{a as M,g as N,u as P}from"./image.C3pSdXmG.js";const R=D({__name:"treehole_publish",setup(D){const R=a(""),U=a(0),W=a([]),X=a([]),Y=a(""),$=a(-1),H=a("");function L(a){A({current:W.value[a],urls:W.value})}function Q(a){U.value=a.detail.value.length>0?1:0}e({title:"投稿树洞"});function Z(a){const e=a.detail.value;e>=0&&X.value[e]&&($.value=e,Y.value=X.value[e].value,H.value=X.value[e].label)}const aa=l((()=>R.value.trim().length>0&&null!==Y.value));async function ea(){if(aa.value)if(Y.value)try{b({title:"提交中..."});const a=k("token");if(!a)return void g({title:"请先登录",icon:"none"});const e={content:R.value.trim(),images:W.value,is_anonymous:U.value,category_id:Y.value},l=await u({url:J+"/with-state/add-submission",method:"POST",data:e,header:{"Content-Type":"application/json",Authorization:a}});x(),"success"==l.data.status?(g({title:"已收到您的投稿",icon:"success"}),setTimeout((()=>{R.value="",W.value=[],U.value=0,y()}),1500)):g({title:l.data.msg||"提交失败",icon:"none"})}catch(a){x(),console.error("提交失败:",a),g({title:"网络请求失败",icon:"none"})}else g({title:"请选择分类",icon:"none"})}return s((()=>{(async()=>{try{const a=await u({url:J+"/treehole-typelist",method:"GET"});"success"===a.data.status&&(X.value=Object.entries(a.data.data).map((([a,e])=>({value:Number(a),label:e}))))}catch(a){console.error("获取分类失败:",a)}})()})),(a,e)=>{const l=E(t("view-logs"),B),s=j,u=E(t("uni-icons"),G),b=c,k=w,x=C,y=F,A=T,D=V,J=I,la=S,sa=z;return i(),o(b,{title:"发布树洞"},{default:n((()=>[r("meta",{name:"theme-color",content:"#F8F8F8"}),d(l),d(b,{class:"publish-box"},{default:n((()=>[d(k,{class:"category-picker",range:X.value,"range-key":"label",onChange:Z,value:$.value},{default:n((()=>[d(b,{class:"picker-content"},{default:n((()=>[d(s,{class:m(["picker-text",Y.value?"":"placeholder"])},{default:n((()=>[v(p(H.value||"请选择分类（必选）"),1)])),_:1},8,["class"]),d(u,{type:"right",size:"22",color:"#888"})])),_:1})])),_:1},8,["range","value"]),d(y,{"scroll-x":"true",class:"upload_box","ll-with-animation":"true","show-scrollbar":!1},{default:n((()=>[(i(!0),f(_,null,h(W.value,((e,l)=>(i(),o(b,{class:"upload_item",key:l},{default:n((()=>[d(x,{src:e,class:"uploaded_image",onClick:L,mode:"aspectFill"},null,8,["src"]),d(x,{src:O,class:"close_icon",onClick:e=>a.deleteImage(l)},null,8,["onClick"])])),_:2},1024)))),128)),d(b,{class:"uploadImageBox",style:{background:"#f8f8f8"}},{default:n((()=>[d(x,{src:q,class:"upload_img",onClick:e[0]||(e[0]=e=>(a.index,console.log("openSelect"),void M().then((a=>{N().then((e=>{console.log(e),P(a,e.token,e.path).then((a=>{200!=a.statusCode&&g({title:"上传失败",icon:"none"}),console.log(K+e.path),W.value.push(K+e.path),g({title:"上传成功",icon:"success"})}))}))})))),style:{width:"50px",height:"50px",margin:"25px"}})])),_:1})])),_:1}),d(A,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=a=>R.value=a),placeholder:"写下你想说的话...",class:"textarea",maxlength:"500"},null,8,["modelValue"]),d(b,{class:"anonymous"},{default:n((()=>[d(la,{onChange:Q},{default:n((()=>[d(J,null,{default:n((()=>[d(D,{checked:1===U.value,color:"#4cbbd0"},null,8,["checked"]),d(s,null,{default:n((()=>[v("匿名发布")])),_:1})])),_:1})])),_:1})])),_:1}),d(b,{class:"publish-detail"},{default:n((()=>[d(s,null,{default:n((()=>[v("* 目前树洞为非审稿发布，只接受娃圈相关内容。")])),_:1}),d(s,null,{default:n((()=>[v("* 如果勾选匿名发布，他人将无法通过稿件进入您的主页。如果稿件遭到过多点踩或投诉，我们可能会隐藏这封稿件。")])),_:1})])),_:1}),d(sa,{class:m(["submit-btn",{disabled:!aa.value}]),onClick:ea},{default:n((()=>[v(" 提交 ")])),_:1},8,["class"])])),_:1})])),_:1})}}},[["__scopeId","data-v-f5b348d7"]]);export{R as default};
