import{r as a,l as e,a3 as t,a as s,v as l,d as n,w as o,F as i,q as r,j as u,g as d,b as c,B as m,x as _,e as p,t as v,a1 as g,c as f,p as y,C as h,T as k,n as b,A as w,i as j,G as S,f as C,J as I,E as x}from"./index-I3aG4WZL.js";import{_ as $}from"./view-logs.C4HVuFxK.js";import{_ as F,a as T,r as D}from"./_plugin-vue_export-helper.DF4WgY5m.js";import{_ as E,a as L}from"./comment-input.CvkLMisZ.js";import{c as R,w as A,b as M}from"./config.BjeWXQ7P.js";import"./uni-icons.BQtdpjJ2.js";import"./common-modal.-arcCNZ3.js";import"./switch-search.B16f2bGk.js";import"./goods-search.gE0Nx2pd.js";import"./search.CsIL0f2m.js";import"./cancel.CnEdunnH.js";import"./common-search.CQlKpRi4.js";import"./image.C3pSdXmG.js";const P=F({__name:"sale_news",setup(F){const P=a({title:"",content:"",image_list:[],created_at:0}),z=a({brand_name:"",logo:""}),O=a(!0),G=a(!1),J=a(""),q=a(0),B=a(0),H=a(!1),K=a(null),N=a(null);a(1);let U=a({});e();const Y=({parent:a,target:e})=>{var t;console.log("parent",a),console.log("target",e);let s=a;null!=e&&(s=e),U.value.id!=s.id?(console.log("item",s),U.value=s,null==(t=N.value)||t.focusInput()):U.value={}};function Q(a){b({url:"/pages/brand/brand?brand_id="+a})}t({title:"图透详情"});const V=a=>{var e,t,s;let l=u("token");if(!M.isLogin)return void w({title:"请先登录",icon:"none"});console.log("reply_info",U.value);const n={content:a.content,origin:a.origin,target_id:parseInt(q.value),type:4,image_url:a.image_url||"",association_id:a.association_id||0,association_type:a.association_type||0,is_anonymous:a.is_anonymous||0,...U.value.id&&{reply_id:U.value.id,reply_for:U.value.comment,reply_uid:U.value.user_id,parent_id:U.value.parent_id>0?U.value.parent_id:U.value.id}},o={id:Date.now(),content:a.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:M.userInfo.avatar,username:M.userInfo.nickname,is_anonymous:0},...a.association_id&&{association_id:a.association_id,association_type:a.association_type},...a.image_url&&{image_url:a.image_url},...U.value.id&&{reply_id:U.value.id,reply_for:U.value.comment,reply_uid:U.value.user_id,parent_id:U.value.parent_id>0?U.value.parent_id:U.value.id,reply_username:U.value.is_anonymous?"匿名用户":U.value.username}};U.value.id?0===U.value.parent_id?null==(t=K.value)||t.addReplyComment({...o,parent_id:U.value.id}):null==(s=K.value)||s.addReplyComment({...o,parent_id:U.value.parent_id}):null==(e=K.value)||e.addNewComment(o),r({url:A+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:n,success:e=>{var t,s;if("success"==e.data.status){const s=e.data.data,l={...s,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:M.userInfo.avatar,username:M.userInfo.nickname,is_anonymous:0}};s.reply_uid&&U.value.is_anonymous&&(l.reply_username="匿名用户"),null==(t=K.value)||t.updateTempComment(o.id,l),w({title:"评论成功",icon:"success"})}else null==(s=K.value)||s.removeTempComment(o.id),w({title:e.data.msg,icon:"none"})},fail:a=>{var e;null==(e=K.value)||e.removeTempComment(o.id),w({title:"网络请求失败",icon:"none"})}})};function W(a){const e=new Date(1e3*a),t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),l=e.getDate().toString().padStart(2,"0"),n=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0");return e.getSeconds().toString().padStart(2,"0"),`${t}-${s}-${l} ${n}:${o}`}const X=()=>{r({url:A+"/brand-info?id="+B.value,success:a=>{"success"===a.data.status&&(z.value=a.data.data,t({title:a.data.data.brand_name}),aa())},fail:()=>handleError("品牌信息加载失败")})},Z=async()=>{if(!M.isLogin)return void w({title:"请先登录",icon:"none"});const a="/with-state/"+(H.value?"unlike":"add-like");r({url:A+a,method:"POST",header:{Authorization:u("token")},data:{id:parseInt(B.value),type:2},success:a=>{"success"===a.data.status&&(H.value=!H.value,w({title:H.value?"关注成功":"已取消关注",icon:"none"}))}})},aa=()=>{M.isLogin&&r({url:`${A}/with-state/hasLike?id=${B.value}&type=2`,method:"POST",header:{Authorization:u("token")},success:a=>{var e;H.value=(null==(e=a.data.data)?void 0:e.id)>0}})};return T((a=>{a.id?(q.value=a.id,(async a=>{try{const e=await r({url:`${A}/sale-news-detail?id=${a}`,timeout:5e3});"success"===e.data.status?(P.value={...e.data.data,image_list:e.data.data.image_list||[]},B.value=e.data.data.brand_id,X()):handleError(e.data.msg||"数据加载失败")}catch(e){console.error("请求失败:",e),handleError("网络请求失败")}finally{O.value=!1}})(a.id),R().then(aa)):handleError("缺少必要参数")})),(a,e)=>{const t=D(s("view-logs"),$),r=j,u=x,b=S,w=d,F=C,T=D(s("comment-list"),E),R=D(s("comment-input"),L);return c(),l(i,null,[n(t),n(w,null,{default:o((()=>[m("meta",{name:"theme-color",content:"#F8F8F8"}),n(w,{style:{position:"relative"}},{default:o((()=>[n(b,{class:"swiper-box","indicator-dots":!0,autoplay:!1},{default:o((()=>[(c(!0),l(i,null,_(P.value.image_list,((a,e)=>(c(),f(u,{key:e},{default:o((()=>[n(r,{src:a,mode:"aspectFill",class:"swiper-image",onClick:a=>{I({current:goods.value.goods_images.index,urls:goods.value.goods_images})}},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),n(w,{class:"brand-info"},{default:o((()=>[n(r,{class:"brand-logo",src:z.value.logo_image,mode:"aspectFill",onClick:e[0]||(e[0]=a=>Q(z.value.id))},null,8,["src"]),n(w,{class:"brand-details",onClick:e[1]||(e[1]=a=>Q(z.value.id))},{default:o((()=>[n(F,{class:"brand-name"},{default:o((()=>[p(v(z.value.brand_name),1)])),_:1}),n(F,{class:"publish-time"},{default:o((()=>[p(v(W(P.value.created_at)),1)])),_:1})])),_:1}),n(F,{class:"follow",onClick:Z,style:g({background:H.value?"#ff6a6c":"#65C3D6"})},{default:o((()=>[p(v(H.value?"已关注":"+ 关注品牌"),1)])),_:1},8,["style"])])),_:1}),n(w,{class:"content-box"},{default:o((()=>[n(w,null,{default:o((()=>[n(F,{class:"title"},{default:o((()=>[p(v(P.value.title),1)])),_:1})])),_:1}),n(w,{style:{margin:"20rpx 0rpx"}},{default:o((()=>[n(F,{class:"content"},{default:o((()=>[p(v(P.value.content),1)])),_:1})])),_:1})])),_:1}),n(w,{style:{padding:"10px"}},{default:o((()=>[n(T,{ref_key:"commentListRef",ref:K,type:4,"relation-id":parseInt(q.value),onReply:Y},null,8,["relation-id"])])),_:1}),O.value?(c(),f(w,{key:0,class:"loading"},{default:o((()=>[p("加载中...")])),_:1})):y("",!0),G.value?(c(),f(w,{key:1,class:"error"},{default:o((()=>[p(v(J.value),1)])),_:1})):y("",!0),n(R,{ref_key:"commentInputRef",ref:N,"reply-info":h(U),"target-id":q.value,onSubmit:V,"onUpdate:replyInfo":e[2]||(e[2]=a=>k(U)?U.value=a:U=a)},null,8,["reply-info","target-id"]),n(w,{style:{width:"100%",height:"120rpx"}})])),_:1})],64)}}},[["__scopeId","data-v-af75bf38"]]);export{P as default};
