"use strict";const e=require("./vendor.js"),o="https://api.fantuanpu.com";let t=e.reactive({isLogin:!1,userInfo:{}});function n(){const t=e.index.getStorageSync("token");if(console.log("token:",t),!t)return console.log("没有token，无法获取用户信息"),void i();console.log("请求接口"),e.index.request({url:`${o}/with-state/mine`,method:"GET",header:{Authorization:t},success:e=>{const o=e.data.data;o?(console.log("获取用户信息成功,进行存储",o),s(o)):(console.log("无法获取，清理用户状态"),i())},fail:e=>{r(e,"获取用户信息失败")}})}function s(o){e.index.setStorageSync("userInfo",o),e.index.setStorageSync("token",o.last_token),t.userInfo=o,t.isLogin=!0}function i(){e.index.removeStorageSync("userInfo"),t.userInfo={},t.isLogin=!1}function r(o,t="请求失败"){console.error(o),e.index.showToast({title:t,icon:"none"})}exports.asyncGetUserInfo=function(){return new Promise(((t,n)=>{const a=e.index.getStorageSync("token");if(!a)return i(),void t(null);e.index.request({url:`${o}/with-state/mine`,method:"GET",header:{Authorization:a},success:e=>{const o=e.data.data;o?(console.log("返回：",o),s(o),t(o)):(i(),t(null))},fail:e=>{r(e,"获取用户信息失败"),t(null)}})}))},exports.getScene=function(){return 4},exports.getUserInfo=n,exports.global=t,exports.image1Url="https://images1.fantuanpu.com/",exports.websiteUrl=o,exports.wechatSignLogin=function(){e.index.login({provider:"weixin",onlyAuthorize:!0,success:t=>{const{code:s}=t;s?e.index.request({url:`${o}/login-with-wechat`,method:"POST",data:{js_token:s},success:o=>{const t=o.data.data;console.log(t),"success"==o.data.status?t.jwt_token&&(console.log("data.token:",t.jwt_token),e.index.setStorageSync("token",t.jwt_token),n()):e.index.showToast({title:t.msg,icon:"none"})},fail:e=>{r(e,"微信登录失败")}}):e.index.showToast({title:"微信登录失败，授权初始化失败",icon:"none"})},fail:e=>{r(e,"微信授权失败")}})};
