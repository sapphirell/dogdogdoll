"use strict";const e=require("./vendor.js"),t="https://api.fantuanpu.com";let o=e.reactive({isLogin:!1,userInfo:{}});function n(){const o=e.index.getStorageSync("token");if(console.log("token:",o),!o)return console.log("没有token，无法获取用户信息"),void i();console.log("请求接口"),e.index.request({url:`${t}/with-state/mine`,method:"GET",header:{Authorization:o},success:e=>{const t=e.data.data;t?(console.log("获取用户信息成功,进行存储",t),s(t)):(console.log("无法获取，清理用户状态"),i())},fail:e=>{c(e,"获取用户信息失败")}})}function s(t){e.index.setStorageSync("userInfo",t),e.index.setStorageSync("token",t.last_token),o.userInfo=t,o.isLogin=!0}function i(){e.index.removeStorageSync("userInfo"),o.userInfo={},o.isLogin=!1}function c(t,o="请求失败"){console.error(t),e.index.showToast({title:o,icon:"none"})}exports.asyncGetUserInfo=function(){return new Promise(((o,n)=>{const a=e.index.getStorageSync("token");if(!a)return i(),void o(null);e.index.request({url:`${t}/with-state/mine`,method:"GET",header:{Authorization:a},success:e=>{const t=e.data.data;t?(console.log("返回：",t),s(t),o(t)):(i(),o(null))},fail:e=>{c(e,"获取用户信息失败"),o(null)}})}))},exports.bindWechat=function(){return new Promise(((o,s)=>{e.index.login({provider:"weixin",onlyAuthorize:!0,success:i=>{const{code:a}=i;if(!a)return e.index.showToast({title:"微信授权失败，请重试",icon:"none"}),void s("微信授权失败");const r=e.index.getStorageSync("token");if(!r)return e.index.showToast({title:"请先登录",icon:"none"}),void s("用户未登录");e.index.request({url:`${t}/with-state/bind-wechat`,method:"POST",header:{Authorization:r},data:{js_token:a},success:t=>{if("success"===t.data.status)n(),e.index.showToast({title:"微信绑定成功",icon:"success"}),o(!0);else{const o=t.data.msg||"微信绑定失败";e.index.showToast({title:o,icon:"none"}),s(o)}},fail:e=>{c(e,"绑定微信失败"),s(e)}})},fail:e=>{c(e,"微信授权失败"),s(e)}})}))},exports.getScene=function(){return 4},exports.getUserInfo=n,exports.global=o,exports.image1Url="https://images1.fantuanpu.com/",exports.websiteUrl=t,exports.wechatSignLogin=function(){e.index.login({provider:"weixin",onlyAuthorize:!0,success:o=>{const{code:s}=o;s?e.index.request({url:`${t}/login-with-wechat`,method:"POST",data:{js_token:s},success:t=>{const o=t.data.data;console.log(o),"success"==t.data.status?o.jwt_token&&(console.log("data.token:",o.jwt_token),e.index.setStorageSync("token",o.jwt_token),n()):e.index.showToast({title:o.msg,icon:"none"})},fail:e=>{c(e,"微信登录失败")}}):e.index.showToast({title:"微信登录失败，授权初始化失败",icon:"none"})},fail:e=>{c(e,"微信授权失败")}})};
