"use strict";const t=require("../../../../common/vendor.js"),e=require("./utils/tools.js"),i=t=>{t.wxsCallMethods||(t.wxsCallMethods=[]),t.wxsCallMethods.push("onTouchStart","updateData")},h={name:"bt-cropper",props:{imageSrc:{type:String,default:"",required:!0},mask:{type:String,default:""},containerSize:{type:Object,default:null},fileType:{type:String,default:"png"},dWidth:Number,maxWidth:{type:Number,default:2e3},ratio:{type:Number,default:0,validator:t=>"number"==typeof t&&!(t<0)},rotate:Number,showGrid:{type:Boolean,default:!1},quality:{type:Number,default:1},canvas2d:{type:Boolean,default:!1},initPosition:{type:Object,default:()=>null},autoZoom:{type:Boolean,default:!0}},data:()=>({canvasId:"bt-cropper",containerRect:null,imageInfo:null,operationHistory:[],operationIndex:0,anim:!1,timer:null,type2d:!1,pixel:1,imageRect:null,cropperRect:null,target:{width:0,height:0}}),watch:{imageSrc:{handler(t){"string"==typeof t&&""!==t?this.imageInit(t):this.imageInfo=null},immediate:!0},ratio(){0!=this.ratio&&(this.startAnim(),this.init())}},computed:{containerStyle(){return this.containerSize&&this.containerRect?{width:this.containerRect.width+"px",height:this.containerRect.height+"px"}:{}},rotateAngle(){const t=Number(this.rotate);return isNaN(t)?0:t%360}},methods:{startAnim(){this.stopAnim(),this.anim=!0,this.timer=setTimeout((()=>{this.anim=!1}),200)},stopAnim(){this.anim=!1,clearTimeout(this.timer)},imageInit(e){t.index.showLoading({title:"载入中..."}),t.index.getImageInfo({src:e,success:t=>{this.imageInfo=t,this.$nextTick((()=>{this.getContainer().then((t=>{this.containerRect=t,this.init()}))}))},fail:e=>{this.$emit("loadFail",e),t.index.showToast({title:"图片下载失败!",icon:"none"})},complete(e){t.index.hideLoading()}})},initCropper(){const t=this.imageInfo.width/this.imageInfo.height,e=this.containerRect.width/this.containerRect.height,i={};let h=this.ratio;0==h&&(h=this.cropperRect?this.cropperRect.width/this.cropperRect.height:1);const s={};return e>h?(s.height=.85*this.containerRect.height,s.width=s.height*h):(s.width=.85*this.containerRect.width,s.height=s.width/h),h>t?(i.width=s.width,i.height=i.width/t):(i.height=s.height,i.width=i.height*t),i.left=(this.containerRect.width-i.width)/2,i.top=(this.containerRect.height-i.height)/2,s.left=i.left+(i.width-s.width)/2,s.top=i.top+(i.height-s.height)/2,{imageRect:i,cropperRect:s}},init(){const{imageRect:e,cropperRect:i}=this.initCropper();if(this.initPosition){const t=this.imageInfo.width/e.width,{left:h,top:s,width:a,height:o}=this.initPosition;void 0!==h&&void 0!==s&&void 0!==a&&void 0!==o&&(i.width=a/t,i.height=o/t,i.left=h/t,i.top=s/t,this.$nextTick(this.zoomToFill))}this.imageRect=e,this.cropperRect=i,this.operationHistory=[{imageRect:e,cropperRect:i}],this.operationIndex=0,this.setTarget();const h=t.index.getSystemInfoSync();!1===this.canvas2d||"windows"===h.platform||"mac"===h.platform?this.type2d=!1:(this.type2d=!0,this.pixel=h.pixelRatio)},setTarget(){const t=this.cropperRect.width/this.cropperRect.height;if(this.dWidth)this.target={width:this.dWidth,height:this.dWidth/(t||1)};else{const e=Math.min(this.maxWidth,this.cropperRect.width*(this.imageInfo.width/this.imageRect.width));this.target={width:e,height:e/(t||1)}}},addHistory({imageRect:t,cropperRect:e}){this.operationIndex!==this.operationHistory.length-1&&(this.operationHistory=this.operationHistory.slice(0,this.operationIndex)),this.operationHistory.push({imageRect:t,cropperRect:e}),this.operationHistory.length>10&&this.operationHistory.shift(),this.operationIndex=this.operationHistory.length-1},updateData(t){this.imageRect=t.imageRect,this.cropperRect=t.cropperRect,this.addHistory(t),this.setTarget(),this.autoZoom&&(this.timer=setTimeout((()=>{this.zoomToFill()}),600));const{imageRect:e,cropperRect:i}=t,h=e.width/this.imageInfo.width;this.$emit("change",{left:(i.left-e.left)/h,top:(i.top-e.top)/h,width:i.width/h,height:i.height/h})},getContainer(){if(null!==this.containerSize&&"object"==typeof this.containerSize){const{width:t,height:i}=this.containerSize;return Promise.resolve({width:e.parseUnit(t),height:e.parseUnit(i)})}return new Promise((e=>{t.index.createSelectorQuery().in(this).select(".mainContent").boundingClientRect((t=>{e(t)})).exec()}))},zoomToFill(){this.startAnim();const t={...this.cropperRect};this.imageRect,this.cropperRect,this.cropperRect=this.initCropper().cropperRect;const e=this.cropperRect.width/t.width,i=t.left-this.imageRect.left,h=t.top-this.imageRect.top;this.imageRect={width:this.imageRect.width*e,height:this.imageRect.height*e,left:this.imageRect.left+(this.cropperRect.left-t.left)-(e-1)*i,top:this.imageRect.top+(this.cropperRect.top-t.top)-(e-1)*h}},onTouchStart(){this.stopAnim()},undo(){return this.operationIndex>0&&(this.operationIndex--,this.imageRect=this.operationHistory[this.operationIndex].imageRect,this.cropperRect=this.operationHistory[this.operationIndex].cropperRect,!0)},resume(){return this.operationIndex<this.operationHistory.length-1&&(this.operationIndex++,this.imageRect=this.operationHistory[this.operationIndex].imageRect,this.cropperRect=this.operationHistory[this.operationIndex].cropperRect,!0)},async drawImage(e,i,h,s,a,o){if(this.type2d)await new Promise((t=>i.onload=t)),e.drawImage(i,h*this.pixel,s*this.pixel,a*this.pixel,o*this.pixel);else{const r=await new Promise((e=>{t.index.getImageInfo({src:i,success({path:t}){e(t)}})}));e.drawImage(r,h*this.pixel,s*this.pixel,a*this.pixel,o*this.pixel),await new Promise((t=>e.draw(!1,t)))}},async crop(){let e,i;if(this.$emit("cropStart"),this.setTarget(),this.type2d){const h=t.index.createSelectorQuery().in(this);i=await new Promise((t=>h.select(".bt-canvas").node((({node:e})=>t(e))).exec())),i.width=this.target.width*this.pixel,i.height=this.target.height*this.pixel,e=i.getContext("2d")}else e=t.index.createCanvasContext(this.canvasId,this);const h=this.cropperRect.width/this.target.width,s=(this.cropperRect.left-this.imageRect.left)/h,a=(this.cropperRect.top-this.imageRect.top)/h;let o;this.type2d?(o=i.createImage(),o.src=this.imageSrc):o=this.imageSrc;const r=-s,n=-a,c=this.imageRect.width/h,p=this.imageRect.height/h;if(e.save(),e.translate(r+c/2,n+p/2),e.rotate(this.rotateAngle*Math.PI/180),e.translate(-(r+c/2),-(n+p/2)),await this.drawImage(e,o,r,n,c,p),e.restore(),""!==this.mask){let i,h;i=this.type2d?e.getImageData(0,0,this.target.width,this.target.height):await new Promise((e=>{t.index.canvasGetImageData({canvasId:this.canvasId,x:0,y:0,width:this.target.width,height:this.target.height,success(t){e(t)}},this)})),e.clearRect(0,0,this.target.width,this.target.height),this.type2d?o.src=this.mask:o=this.mask,await this.drawImage(e,o,0,0,this.target.width,this.target.height),h=this.type2d?e.getImageData(0,0,this.target.width,this.target.height):await new Promise(((e,i)=>{t.index.canvasGetImageData({canvasId:this.canvasId,x:0,y:0,width:this.target.width,height:this.target.height,success(t){e(t)}},this)})),e.clearRect(0,0,this.target.width,this.target.height);for(let t=3;t<h.data.length;t+=4){0!==h.data[t]&&(i.data[t]=0)}this.type2d?e.putImageData(i,0,0):await new Promise((e=>{t.index.canvasPutImageData({canvasId:this.canvasId,x:0,y:0,width:i.width,height:i.height,data:i.data,complete:t=>{e(t)}},this)}))}return new Promise(((e,h)=>{const s={};this.type2d?s.canvas=i:s.canvasId=this.canvasId,t.index.canvasToTempFilePath({...s,destWidth:this.target.width,destHeight:this.target.height,quality:Number(this.quality)||1,fileType:this.fileType,success:({tempFilePath:t})=>{e(t)},fail(t){console.log("保存失败，错误信息：",t),h(t)}},this)}))}}};i(h);const s=t._export_sfc(h,[["render",function(e,i,h,s,a,o){return t.e({a:a.imageRect&&a.cropperRect},a.imageRect&&a.cropperRect?t.e({b:h.imageSrc,c:o.rotateAngle,d:a.imageRect,e:a.anim?1:"",f:h.mask,g:h.showGrid},(h.showGrid,{}),{h:a.anim?1:"",i:a.cropperRect,j:h.ratio}):{},{k:a.type2d},a.type2d?{l:a.target.width,m:a.target.height}:{n:a.canvasId,o:a.target.width+"px",p:a.target.height+"px",q:a.target.width*a.pixel,r:a.target.height*a.pixel},{s:t.s(o.containerStyle)})}],["__scopeId","data-v-0f0ed778"]]);wx.createComponent(s);
