"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const n={__name:"treehole_detail",props:{id:{type:String,required:!0}},setup(n){e.ref(!0),e.ref(!1),e.ref("");const o=e.ref(0),a=e.ref(null),i=e.ref(null),l=e.ref(null);e.ref(1);let s=e.ref({});const r=e.ref(!1),u=n,d=({parent:e,target:t})=>{var n;console.log("parent",e),console.log("target",t);let o=e;null!=t&&(o=t),s.value.id!=o.id?(console.log("item",o),s.value=o,null==(n=l.value)||n.focusInput()):s.value={}},c=({content:n,replyInfo:a,origin:l})=>{let s=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",a);const r={content:n,origin:l,target_id:parseInt(o.value),type:5,...a.id&&{reply_id:a.id,reply_for:a.comment,reply_user_id:a.user_id,parent_id:a.parent_id>0?a.parent_id:a.id}};e.index.request({url:t.websiteUrl+"/with-state/add-comment",method:"POST",header:{Authorization:s},data:r,success:t=>{var n,o;if("success"==t.data.status){const a=t.data.data;0===a.parent_id?(console.log("添加主评论"),null==(n=i.value)||n.addNewComment(a)):(console.log("添加子评论"),null==(o=i.value)||o.addReplyComment(a)),e.index.showToast({title:"评论成功",icon:"success"})}else e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{e.index.showToast({title:"网络请求失败",icon:"none"})}})};const v=()=>{if(!t.global.isLogin)return void e.index.showModal({title:"提示",content:"需要登录后才能点赞",success:t=>{t.confirm&&e.index.navigateTo({url:"/pages/login/login"})}});const n=e.index.getStorageSync("token"),o=t.websiteUrl+(r.value?"/with-state/unlike":"/with-state/add-like");e.index.request({url:o,method:"POST",header:{Authorization:n},data:{id:parseInt(u.id),type:5},success:e=>{"success"===e.data.status&&(r.value=!r.value,a.value.like_count+=r.value?1:-1)}})};const p=e.computed((()=>{var e,t;return(null==(t=null==(e=a.value)?void 0:e.images)?void 0:t.slice(0,9))||[]})),g=e.computed((()=>{var e,t;return((null==(t=null==(e=a.value)?void 0:e.images)?void 0:t.length)||0)-9})),m=e.computed((()=>{var e,t;return((null==(t=null==(e=a.value)?void 0:e.images)?void 0:t.length)||0)>9}));e.index.setNavigationBarTitle({title:"投稿详情"});const f=e.computed((()=>{const e=p.value.length;return 1===e?"single":2===e?"double":"multi"})),h=e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return e.onMounted((async()=>{o.value=u.id,console.log("pageId",o.value);try{const n=await e.index.request({url:`${t.websiteUrl}/treehole-detail?id=${u.id}`});"success"===n.data.status&&(a.value=n.data.data)}catch(n){console.log(n),e.index.showToast({title:"加载失败",icon:"none"})}t.asyncGetUserInfo(),function(){let n=e.index.getStorageSync("token");""!=n&&e.index.request({url:t.websiteUrl+"/with-state/hasLike?id="+u.id+"&type=5",method:"POST",header:{Authorization:n},success:t=>{console.log(t.data),"success"==t.data.status?t.data.data.id>0?r.value=!0:r.value=!1:e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}()})),(t,n)=>e.e({a:a.value},a.value?{b:a.value.avatar||"/static/noname.png",c:e.t(a.value.author_name),d:e.t(h(a.value.created_at)),e:e.t(a.value.content),f:e.f(p.value,((t,n,o)=>e.e({a:t,b:e.o((t=>(t=>{e.index.previewImage({current:t,urls:a.value.images})})(n)),n),c:m.value&&8===n},m.value&&8===n?{d:e.t(g.value)}:{},{e:n}))),g:e.n(f.value),h:e.p({type:r.value?"hand-up-filled":"hand-up",size:"24",color:r.value?"#ff4d4f":"#666"}),i:e.t(a.value.like_count||0),j:e.o(v),k:e.p({type:"redo",size:"24",color:"#666"}),l:e.o((t=>function(t){let n="http://m.dogdogdoll.com/#/pages/treehole_detail/treehole_detail?id="+t.id;e.index.setClipboardData({data:n,success:function(){e.index.showToast({title:"复制链接成功",icon:"none"})}})}(a.value))),m:e.t(h(a.value.approve_time))}:{},{n:e.sr(i,"f102c4f6-2",{k:"commentListRef"}),o:e.o(d),p:e.p({type:5,"relation-id":parseInt(u.id)}),q:e.sr(l,"f102c4f6-3",{k:"commentInputRef"}),r:e.o(c),s:e.o((t=>e.isRef(s)?s.value=t:s=t)),t:e.p({"reply-info":e.unref(s),"target-id":o.value})})},__runtimeHooks:2};wx.createPage(n);
