"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("report-button")+e.resolveComponent("uni-icons")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../components/report-button/report-button.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const a={__name:"treehole_detail",props:{id:{type:String,required:!0}},setup(a){e.ref(!0),e.ref(!1),e.ref("");const n=e.ref(0),o=e.ref(null),i=e.ref(null),l=e.ref(null);e.ref(1);let s=e.ref({});e.ref({});const u=e.ref(!1),r=a,d=({parent:e,target:t})=>{var a;const n=t||e;s.value=n,null==(a=l.value)||a.focusInput()},c=a=>{var o,l,u;let r=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",s.value);const d={content:a.content,origin:a.origin,target_id:parseInt(n.value),type:5,image_url:a.image_url||"",association_id:a.association_id||0,association_type:a.association_type||0,is_anonymous:a.is_anonymous||0,...s.value.id&&{reply_id:s.value.id,reply_for:s.value.comment,reply_uid:s.value.user_id,parent_id:s.value.parent_id>0?s.value.parent_id:s.value.id}},c={id:Date.now(),content:a.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:t.global.userInfo.avatar,username:t.global.userInfo.nickname,is_anonymous:0},...a.association_id&&{association_id:a.association_id,association_type:a.association_type},...a.image_url&&{image_url:a.image_url},...s.value.id&&{reply_id:s.value.id,reply_for:s.value.comment,reply_uid:s.value.user_id,parent_id:s.value.parent_id>0?s.value.parent_id:s.value.id,reply_username:s.value.is_anonymous?"匿名用户":s.value.username}};s.value.id?0===s.value.parent_id?null==(l=i.value)||l.addReplyComment({...c,parent_id:s.value.id}):null==(u=i.value)||u.addReplyComment({...c,parent_id:s.value.parent_id}):null==(o=i.value)||o.addNewComment(c),e.index.request({url:t.websiteUrl.value+"/with-state/add-comment",method:"POST",header:{Authorization:r},data:d,success:n=>{var o,l;if("success"==n.data.status){const l=n.data.data,u={...l,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:t.global.userInfo.avatar,username:t.global.userInfo.nickname,is_anonymous:0}};l.reply_uid&&s.value.is_anonymous&&(u.reply_username="匿名用户"),null==(o=i.value)||o.updateTempComment(c.id,u),e.index.showToast({title:"评论成功",icon:"success"})}else null==(l=i.value)||l.removeTempComment(c.id),e.index.showToast({title:n.data.msg,icon:"none"})},fail:t=>{var a;null==(a=i.value)||a.removeTempComment(c.id),e.index.showToast({title:"网络请求失败",icon:"none"})}})};const v=()=>{if(!t.global.isLogin)return void e.index.showModal({title:"提示",content:"需要登录后才能点赞",success:t=>{t.confirm&&e.index.navigateTo({url:"/pages/login/login"})}});const a=e.index.getStorageSync("token"),n=t.websiteUrl.value+(u.value?"/with-state/unlike":"/with-state/add-like");e.index.request({url:n,method:"POST",header:{Authorization:a},data:{id:parseInt(r.id),type:5},success:e=>{"success"===e.data.status&&(u.value=!u.value,o.value.like_count+=u.value?1:-1)}})};const m=e.computed((()=>{var e,t;return(null==(t=null==(e=o.value)?void 0:e.images)?void 0:t.slice(0,9))||[]})),p=e.computed((()=>{var e,t;return((null==(t=null==(e=o.value)?void 0:e.images)?void 0:t.length)||0)-9})),g=e.computed((()=>{var e,t;return((null==(t=null==(e=o.value)?void 0:e.images)?void 0:t.length)||0)>9}));e.index.setNavigationBarTitle({title:"投稿详情"});const _=e.computed((()=>{const e=m.value.length;return 1===e?"single":2===e?"double":"multi"})),f=e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`};return e.onMounted((async()=>{n.value=r.id,console.log("pageId",n.value);try{const a=await e.index.request({url:`${t.websiteUrl.value}/treehole-detail?id=${r.id}`});"success"===a.data.status&&(o.value=a.data.data)}catch(a){console.log(a),e.index.showToast({title:"加载失败",icon:"none"})}t.asyncGetUserInfo(),function(){let a=e.index.getStorageSync("token");""!=a&&e.index.request({url:t.websiteUrl.value+"/with-state/hasLike?id="+r.id+"&type=5",method:"POST",header:{Authorization:a},success:t=>{console.log(t.data),"success"==t.data.status?t.data.data.id>0?u.value=!0:u.value=!1:e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}()})),(t,a)=>e.e({a:o.value},o.value?e.e({b:o.value.avatar||"/static/noname.png",c:e.t(o.value.author_name),d:e.t(f(o.value.created_at)),e:e.p({"report-type":"3","relation-id":parseInt(r.id),"button-text":"举报","icon-type":"flag","icon-size":"24","icon-color":"#666"}),f:e.t(o.value.content),g:e.f(m.value,((t,a,n)=>e.e({a:t,b:e.o((t=>(t=>{e.index.previewImage({current:t,urls:o.value.images})})(a)),a),c:g.value&&8===a},g.value&&8===a?{d:e.t(p.value)}:{},{e:a}))),h:e.n(_.value),i:e.p({type:u.value?"hand-up-filled":"hand-up",size:"24",color:u.value?"#ff4d4f":"#666"}),j:e.t(o.value.like_count||0),k:e.o(v),l:e.p({type:"redo",size:"24",color:"#666"}),m:e.o((t=>function(t){let a="http://m.dogdogdoll.com/#/pages/treehole_detail/treehole_detail?id="+t.id;e.index.setClipboardData({data:a,success:function(){e.index.showToast({title:"复制链接成功",icon:"none"})}})}(o.value))),n:o.value.approve_time>0},o.value.approve_time>0?{o:e.t(f(o.value.approve_time))}:{}):{},{p:e.sr(i,"f102c4f6-4",{k:"commentListRef"}),q:e.o(d),r:e.p({type:5,"relation-id":parseInt(r.id)}),s:e.sr(l,"f102c4f6-5",{k:"commentInputRef"}),t:e.o(c),v:e.o((t=>e.isRef(s)?s.value=t:s=t)),w:e.p({"reply-info":e.unref(s),"target-id":n.value})})},__runtimeHooks:2};wx.createPage(a);
