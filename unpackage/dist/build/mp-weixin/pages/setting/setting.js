"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../common/config.js"),o={__name:"setting",setup(o){e.index.setNavigationBarTitle({title:"设置"});const n=e.computed((()=>[{label:"更改用户名",action:u,status:!!a.global.userInfo.password,displayValue:a.global.userInfo.password?"去修改":"未设置"},{label:"更改密码",action:d,status:!!a.global.userInfo.password,displayValue:a.global.userInfo.password?"去修改":"未设置"},{label:"绑定手机号",action:r,status:!!a.global.userInfo.tel_phone,displayValue:a.global.userInfo.tel_phone?a.global.userInfo.tel_phone.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"去绑定"},{label:"绑定微信",action:f,status:!!a.global.userInfo.wechat_open_id,displayValue:a.global.userInfo.wechat_open_id?"已绑定":"去绑定"},{label:"检查更新",action:h,status:s.value.version,displayValue:l.value}]));e.ref({});let s=e.ref({});const i=e.ref(!1);e.ref(!1);const l=e.ref("检查更新");let c=e.ref(0);function d(){e.index.navigateTo({url:"/pages/setting/password/password"})}function r(){e.index.navigateTo({url:"/pages/setting/tel_phone/tel_phone"})}function u(){e.index.navigateTo({url:"/pages/setting/username/username"})}function f(){a.global.userInfo.wechat_open_id?e.index.showToast({title:"已绑定微信",icon:"none"}):a.bindWechat().then((()=>{console.log("微信绑定成功"),e.index.showToast({title:"微信绑定成功",icon:"none"})})).catch((t=>{console.error("微信绑定失败:",t),e.index.showToast({title:"微信绑定失败",icon:"none"})}))}const h=async()=>{e.index.getSystemInfoSync().platform;{c.value++,e.index.getAppBaseInfo().appVersion;const t=await e.index.request({url:`${a.websiteUrl}/latest-version?version=1.0.40`,method:"GET"});t&&t.data&&("success"===t.data.status&&t.data.data?(l.value="有新版本:"+t.data.data.version,s.value=!0):c.value>1&&e.index.showToast({title:"当前已是最新版本",icon:"none"}))}};async function g(){i.value?e.index.showModal({title:"取消注销申请",content:"确定要取消账号注销申请吗？",success:async t=>{t.confirm&&await async function(){const t=e.index.getStorageSync("token");if(!t)return void e.index.showToast({title:"请先登录",icon:"none"});e.index.showLoading({title:"处理中...",mask:!0});try{const o=await e.index.request({url:`${a.websiteUrl}/with-state/cancel-delete`,method:"POST",header:{Authorization:t}});if(e.index.hideLoading(),"success"!==o.data.status)throw new Error(o.data.msg||"取消注销失败");i.value=!1,a.global.userInfo.deleteApplyAt=0,e.index.showToast({title:"已取消注销申请",icon:"success",duration:3e3})}catch(o){e.index.hideLoading(),e.index.showToast({title:o.message||"操作失败，请稍后重试",icon:"none",duration:3e3})}}()}}):e.index.showModal({title:"申请注销账号",content:"确定要申请注销账号吗？注销后账号将不可恢复！",confirmText:"确认注销",confirmColor:"#f56c6c",success:async t=>{t.confirm&&await async function(){const t=e.index.getStorageSync("token");if(!t)return void e.index.showToast({title:"请先登录",icon:"none"});e.index.showLoading({title:"处理中...",mask:!0});try{const o=await e.index.request({url:`${a.websiteUrl}/with-state/apply-delete`,method:"POST",header:{Authorization:t}});if(e.index.hideLoading(),"success"!==o.data.status)throw new Error(o.data.msg||"申请注销失败");i.value=!0,a.global.userInfo.deleteApplyAt=Math.floor(Date.now()/1e3),e.index.showToast({title:"已申请注销账号",icon:"success",duration:3e3}),setTimeout((()=>{e.index.showModal({title:"注销申请已提交",content:"您的账号将在30天后正式注销。在此期间您可以正常使用所有功能，并可随时取消注销申请。",showCancel:!1,confirmText:"知道了"})}),1e3)}catch(o){e.index.hideLoading(),e.index.showToast({title:o.message||"操作失败，请稍后重试",icon:"none",duration:3e3})}}()}})}return e.onMounted((()=>{a.asyncGetUserInfo().then((e=>{i.value=e.delete_apply_at>0})),h()})),(a,o)=>e.e({a:e.f(n.value,((t,a,o)=>({a:e.t(t.label),b:e.t(t.displayValue),c:e.n(t.status?"active":"inactive"),d:a,e:e.o((e=>t.action(t)),a)}))),b:t._imports_0$6,c:e.t(i.value?"取消注销申请":"申请注销账号"),d:e.o(g),e:i.value?"#f56c6c":"#cfcad8",f:i.value},(i.value,{}))}},n=e._export_sfc(o,[["__scopeId","data-v-39d3f2aa"]]);wx.createPage(n);
