"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("uni-swipe-action-item")+e.resolveComponent("uni-swipe-action"))()}Math||((()=>"../../uni_modules/uni-swipe-action/components/uni-swipe-action-item/uni-swipe-action-item.js")+(()=>"../../uni_modules/uni-swipe-action/components/uni-swipe-action/uni-swipe-action.js"))();const a={__name:"message_list",setup(a){const i=e.ref([]),n=e.ref(0),s=e.ref(1),o=e.ref(!1),d=e.ref(!0),r=e.ref(!1),c=e=>[{text:"删除",style:{backgroundColor:"#dd524d"},data:{type:"delete",id:e.id}},{text:e.is_read?"已读":"标记已读",style:{backgroundColor:"#6fd0d4"},data:{type:"read",id:e.id}}];e.onMounted((async()=>{await t.asyncGetUserInfo(),u(),g(),e.index.setNavigationBarTitle({title:"消息"})}));const u=async(a=!1)=>{try{r.value=!0;const n=a?s.value:1,c=await e.index.request({url:`${t.websiteUrl}/with-state/user-messages?page=${n}`,header:{Authorization:e.index.getStorageSync("token")}});if("success"===c.data.status){const e=c.data.data.message_list;i.value=a?[...i.value,...e]:e,d.value=e.length>=10,s.value=n+(d.value?1:0)}}catch(n){e.index.showToast({title:"消息加载失败",icon:"none"})}finally{r.value=!1,o.value=!1}},l=()=>{console.log("触发加载更多",r.value,d.value),!r.value&&d.value&&u(!0)},g=async()=>{try{const a=await e.index.request({url:`${t.websiteUrl}/with-state/unread-message-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===a.data.status&&(n.value=a.data.data.count)}catch(a){e.index.showToast({title:"未读数获取失败",icon:"none"})}},h=e=>{const{type:t,id:a}=e.content.data;"delete"===t?m(a):"read"===t&&w(a)},m=t=>{e.index.showModal({title:"删除确认",content:"确定要删除这条消息吗？",success:e=>{e.confirm&&v(t)}})},v=async a=>{try{await e.index.request({url:`${t.websiteUrl}/with-state/delete-message`,method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{message_id:a}}),i.value=i.value.filter((e=>e.id!==a)),g(),e.index.showToast({title:"删除成功"})}catch(n){e.index.showToast({title:"删除失败",icon:"none"})}},w=async a=>{try{await e.index.request({url:`${t.websiteUrl}/with-state/mark-message-read`,method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{message_id:a}});const s=i.value.find((e=>e.id===a));s&&!s.is_read&&(s.is_read=1,n.value--)}catch(s){e.index.showToast({title:"标记失败",icon:"none"})}},p=e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`};return(t,a)=>e.e({a:e.f(i.value,((t,a,i)=>({a:t.cover_image,b:e.t(t.title),c:e.t(t.msg),d:t.is_read?"":1,e:e.t(p(t.created_at)),f:e.o((a=>{return i=t.id,void e.index.navigateTo({url:`/pages/message_info/message_info?message_id=${i}`});var i}),t.id),g:t.id,h:e.o(h,t.id),i:"cb03c942-1-"+i+",cb03c942-0",j:e.p({"right-options":c(t),threshold:.4})}))),b:r.value},(r.value,{}),{c:!d.value},(d.value,{}),{d:e.o(l)})}};wx.createPage(a);
