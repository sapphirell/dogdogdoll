"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("uni-rate")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../uni_modules/uni-rate/components/uni-rate/uni-rate.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const a={__name:"brand",props:["brand_id"],setup(a){const n=a;console.log(n);const o=e.ref(!1);let i=e.ref([]),s=e.ref({page_index:1,page_size:3,total:0});e.index.showLoading({title:"加载中"}),e.index.getSystemInfoSync();let l=e.ref(0);const d=e.ref(0),r=e.ref(null),u=e.ref(null);e.ref(1);let c=e.ref({});const g=({parent:e,target:t})=>{var a;console.log("parent",e),console.log("target",t);let n=e;null!=t&&(n=t),c.value.id!=n.id?(console.log("item",n),c.value=n,null==(a=u.value)||a.focusInput()):c.value={}},m=a=>{var o,i,s;let l=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",c.value);const d={content:a.content,origin:a.origin,target_id:parseInt(n.brand_id),type:1,image_url:a.image_url||"",association_id:a.association_id||0,association_type:a.association_type||0,is_anonymous:a.is_anonymous||0,...c.value.id&&{reply_id:c.value.id,reply_for:c.value.comment,reply_uid:c.value.user_id,parent_id:c.value.parent_id>0?c.value.parent_id:c.value.id}},u={id:Date.now(),content:a.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:t.global.userInfo.avatar,username:t.global.userInfo.nickname,is_anonymous:0},...a.association_id&&{association_id:a.association_id,association_type:a.association_type},...a.image_url&&{image_url:a.image_url},...c.value.id&&{reply_id:c.value.id,reply_for:c.value.comment,reply_uid:c.value.user_id,parent_id:c.value.parent_id>0?c.value.parent_id:c.value.id,reply_username:c.value.is_anonymous?"匿名用户":c.value.username}};c.value.id?0===c.value.parent_id?null==(i=r.value)||i.addReplyComment({...u,parent_id:c.value.id}):null==(s=r.value)||s.addReplyComment({...u,parent_id:c.value.parent_id}):null==(o=r.value)||o.addNewComment(u),e.index.request({url:t.websiteUrl+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:d,success:n=>{var o,i;if("success"==n.data.status){const i=n.data.data,s={...i,...a.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:t.global.userInfo.avatar,username:t.global.userInfo.nickname,is_anonymous:0}};i.reply_uid&&c.value.is_anonymous&&(s.reply_username="匿名用户"),null==(o=r.value)||o.updateTempComment(u.id,s),e.index.showToast({title:"评论成功",icon:"success"})}else null==(i=r.value)||i.removeTempComment(u.id),e.index.showToast({title:n.data.msg,icon:"none"})},fail:t=>{var a;null==(a=r.value)||a.removeTempComment(u.id),e.index.showToast({title:"网络请求失败",icon:"none"})}})},_=a=>{if(console.log(a),!t.global.isLogin)return e.index.showToast({title:"请先登录",icon:"none"}),void(l.value=0);l.value=a.value,d.value=a.value,async function(){if(0==l.value)return void e.index.showToast({title:"请先评分",icon:"none"});try{let a=e.index.getStorageSync("token");if(!a)return void e.index.showToast({title:"请先登录",icon:"none"});e.index.showLoading({title:"提交中..."});const o=await e.index.request({url:t.websiteUrl+"/with-state/add-vote-score",method:"POST",header:{Authorization:a,"Content-Type":"application/json"},data:{type:1,score:l.value,target_id:parseInt(n.brand_id)}});e.index.hideLoading(),"success"===o.data.status?(v(),e.index.showToast({title:"评分成功",icon:"success"})):e.index.showToast({title:o.data.msg||"评分失败",icon:"none"})}catch(a){e.index.hideLoading(),console.error("评分失败:",a),e.index.showToast({title:"评分失败，请重试",icon:"none"})}}()};function v(){e.index.request({url:t.websiteUrl+"/brand-info?id="+n.brand_id,method:"GET",timeout:5e3,success:t=>{console.log(t.data.data),b.value=t.data.data,e.index.setNavigationBarTitle({title:t.data.data.brand_name}),f()},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{e.index.hideLoading()}})}const p=async()=>{let a=e.index.getStorageSync("token");if(t.global.isLogin)try{const i=`${t.websiteUrl}/with-state/${o.value?"unlike":"add-like"}`,s=await e.index.request({url:i,method:"POST",header:{Authorization:a},data:{id:parseInt(n.brand_id),type:2}});"success"===s.data.status?(o.value=!o.value,e.index.showToast({title:o.value?"关注成功":"已取消关注",icon:"none"}),v()):e.index.showToast({title:s.data.msg,icon:"none"})}catch(i){console.error(i),e.index.showToast({title:"操作失败",icon:"none"})}else e.index.showToast({title:"请先登录",icon:"none"})},f=async()=>{var a;try{const i=await e.index.request({url:`${t.websiteUrl}/with-state/hasLike?id=${parseInt(n.brand_id)}&type=2`,method:"POST",header:{Authorization:e.index.getStorageSync("token")}});o.value=(null==(a=i.data.data)?void 0:a.id)>0}catch(i){console.error("获取关注状态失败:",i)}};function h(e){const t=new Date(1e3*e),a=t.getFullYear(),n=(t.getMonth()+1).toString().padStart(2,"0"),o=t.getDate().toString().padStart(2,"0"),i=t.getHours().toString().padStart(2,"0"),s=t.getMinutes().toString().padStart(2,"0");return t.getSeconds().toString().padStart(2,"0"),`${a}-${n}-${o} ${i}:${s}`}function w(){e.index.request({url:t.websiteUrl+"/brand-goods?brand_id="+n.brand_id+"&page="+x.value,method:"GET",timeout:5e3,success:t=>{console.log(t.data.data),y.value.page_index=t.data.data.page_index,y.value.total=t.data.data.total,y.value.goods_list=y.value.goods_list?y.value.goods_list.concat(t.data.data.goods_list):t.data.data.goods_list,t.data.data.goods_list.length>0&&(x.value+=1),0==t.data.data.goods_list.length&&x.value>1&&e.index.showToast({title:"没有更多数据了",icon:"none"})},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}let y=e.ref({}),x=e.ref(1),b=e.ref({});return e.onShow((()=>{t.getUserInfo(),v(),w(),e.index.request({url:`${t.websiteUrl}/brand-news-list?brand_id=${n.brand_id}&page=${s.value.page_index}&page_size=${s.value.page_size}`,method:"GET",success:t=>{if("success"===t.data.status){const e=t.data.data;i.value=[...i.value,...e.news_list],s.value.total=e.total,e.news_list.length>0&&(s.value.page_index+=1)}else e.index.showToast({title:t.data.msg||"获取图透失败",icon:"none"})},fail:t=>{e.index.showToast({title:"网络请求失败",icon:"none"})}}),t.global.isLogin?function(a,n){let o=e.index.getStorageSync("token");o&&t.global.isLogin&&e.index.request({url:t.websiteUrl+"/with-state/my-vote-record",method:"GET",header:{Authorization:o,"Content-Type":"application/json"},data:{target_id:parseInt(n),type:a},success:t=>(console.log(t.data.data),"success"==t.data.status?(d.value=t.data.data.score,t.data.data.score):(e.index.showToast({title:t.data.msg,icon:"none"}),0)),fail:t=>(console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"}),0)})}(1,n.brand_id):l.value=0})),(t,a)=>({a:e.unref(b).logo_image,b:e.unref(b).brand_name_image,c:e.t(e.unref(b).country_name),d:e.t(e.unref(b).type),e:e.o(_),f:e.p({value:e.unref(b).score,"allow-half":"true",activeColor:"#65C3D6","is-fill":"false"}),g:e.t(e.unref(b).score),h:e.t(e.unref(b).vote_number),i:e.t(o.value?"已关注":"+ 关注品牌"),j:e.o(p),k:o.value?"#ff6a6c":"#65C3D6",l:e.t(e.unref(b).nickname_list),m:e.t(e.unref(b).description),n:e.t(e.unref(y).total),o:e.f(e.unref(y).goods_list,((t,a,n)=>({a:t.goods_images[0],b:e.t(t.name),c:e.o((a=>{return n=t.id,void e.index.navigateTo({url:"/pages/goods/goods?goods_id="+n});var n}),t.id),d:t.id}))),p:e.o(w),q:e.t(e.unref(s).total),r:e.f(e.unref(i),((t,a,n)=>e.e({a:e.t(t.title),b:t.image_list&&t.image_list.length>0},t.image_list&&t.image_list.length>0?{c:e.f(t.image_list,((a,n,o)=>({a:a,b:e.o((n=>{return o=a,i=t.image_list,void e.index.previewImage({current:o,urls:i});var o,i}),n),c:n})))}:{},{d:e.t(t.content),e:e.t(h(t.created_at)),f:e.o((a=>function(t){e.index.navigateTo({url:`/pages/sale_news/sale_news?id=${t.id}&brand_id=${t.brand_id}`})}(t)),t.id),g:t.id}))),s:e.sr(r,"2e986380-2",{k:"commentListRef"}),t:e.o(g),v:e.p({type:1,"relation-id":parseInt(n.brand_id)}),w:e.sr(u,"2e986380-3",{k:"commentInputRef"}),x:e.o(m),y:e.o((t=>e.isRef(c)?c.value=t:c=t)),z:e.p({"reply-info":e.unref(c),"target-id":n.brand_id})})}},n=e._export_sfc(a,[["__scopeId","data-v-2e986380"]]);a.__runtimeHooks=2,wx.createPage(n);
