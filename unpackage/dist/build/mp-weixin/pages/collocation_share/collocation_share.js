"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const o={__name:"collocation_share",props:{collocation_id:{type:String,default:0},origin:{type:String,default:0}},setup(o){const a=e.ref({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),n=e.ref({userName:"",avatar:""});e.index.getSystemInfoSync();const i=e.ref(!0),l=e.ref(!1),r=e.ref(""),s=o,d=e.ref(0),u=e.ref(0);let c=e.ref(!1);const g=e.ref(null),v=e.ref(null);e.ref(1);let m=e.ref({});e.index.setNavigationBarTitle({title:"搭配详情"});const _=async(o,n)=>{var l;try{const r=await e.index.request({url:t.websiteUrl+`/view-collocation?collocation_id=${o}&origin=${n}`});if("success"!==r.data.status)return void p(r.data.msg||"数据加载失败");const s={...r.data.data,image_url_list:Array.isArray(r.data.data.image_url_list)?r.data.data.image_url_list:[r.data.data.image_urls],collocation_relation_list:await Promise.all(r.data.data.collocation_relation_list.map((async o=>{try{const a=o.relation_goods_id>0?await(o=>new Promise(((a,n)=>{o&&0!==o?e.index.request({url:`${t.websiteUrl}/goods?id=${o}`,method:"GET",timeout:5e3,success:e=>{"success"===e.data.status?a(e.data.data):n(e.data.msg||"获取商品信息失败")},fail:t=>{console.error(t),e.index.showToast({title:"网络请求失败",icon:"none"}),n(t)}}):n("无效的商品ID")})))(o.relation_goods_id):null;return{...o,goodsInfo:a,imageLoaded:!!a,imageError:!a}}catch(a){return console.error("商品信息获取失败:",a),{...o,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};a.value=s,(null==(l=r.data.data)?void 0:l.uid)&&await f(r.data.data.uid)}catch(r){p("数据加载失败")}finally{i.value=!1}},f=async o=>{try{const a=await e.index.request({url:`${t.websiteUrl}/user-info?uid=${o}`,method:"GET"});"success"===a.data.status?n.value=a.data.data:console.error("获取用户信息失败:",a.data.msg)}catch(a){console.error("用户信息请求失败:",a),e.index.showToast({title:"作者信息加载失败",icon:"none"})}},p=t=>{l.value=!0,r.value=t,e.index.showToast({title:t,icon:"none"})};function h(o){let a=e.index.getStorageSync("token");if(""==a)return;let n=1==u.value?3:4;e.index.request({url:t.websiteUrl+"/with-state/hasLike?id="+o+"&type="+n,method:"POST",header:{Authorization:a},success:t=>{"success"==t.data.status?t.data.data.id>0?c.value=!0:c.value=!1:e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function w(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}const y=({parent:e,target:t})=>{var o;console.log("parent",e),console.log("target",t);let a=e;null!=t&&(a=t),m.value.id!=a.id?(console.log("item",a),m.value=a,null==(o=v.value)||o.focusInput()):m.value={}},x=({content:o,replyInfo:a,origin:n})=>{let i=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",a);const l={content:o,origin:n,target_id:parseInt(d.value),type:1==s.origin?3:6,...a.id&&{reply_id:a.id,reply_for:a.comment,reply_user_id:a.user_id,parent_id:a.parent_id>0?a.parent_id:a.id}};e.index.request({url:t.websiteUrl+"/with-state/add-comment",method:"POST",header:{Authorization:i},data:l,success:t=>{var o,a;if("success"==t.data.status){const n=t.data.data;0===n.parent_id?null==(o=g.value)||o.addNewComment(n):null==(a=g.value)||a.addReplyComment(n),e.index.showToast({title:"评论成功",icon:"success"})}else e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{e.index.showToast({title:"网络请求失败",icon:"none"})}})};function S(e){const t=new Date(1e3*e),o=t.getFullYear(),a=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0"),i=t.getHours().toString().padStart(2,"0"),l=t.getMinutes().toString().padStart(2,"0");return t.getSeconds().toString().padStart(2,"0"),`${o}-${a}-${n} ${i}:${l}`}return e.onShow((()=>{console.log("注册键盘弹出事件"),e.index.onKeyboardHeightChange(keyboardHeightChangeHandler)})),e.onLoad((o=>{try{if(!o.collocation_id)return l.value=!0,void(r.value="缺少必要参数Id");if(!o.origin)return l.value=!0,void(r.value="缺少必要参数Origin");d.value=o.collocation_id,u.value=o.origin,_(o.collocation_id,o.origin),t.asyncGetUserInfo().then((e=>{console.log(e),h(o.collocation_id)}))}catch(a){console.error("onLoad Error:",a),e.index.showToast({title:"加载失败",icon:"none"})}})),(o,s)=>{var f;return e.e({a:!e.unref(c)},e.unref(c)?{c:e.p({type:"heart-filled",size:"28",color:"#ff4d4f"})}:{b:e.p({type:"heart",size:"28",color:"#ff4d4f"})},{d:e.t((null==(f=a.value)?void 0:f.like_count)?w(a.value.like_count):0),e:e.o((o=>function(){let o=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let n=1==u.value?3:4,i={id:parseInt(a.value.id),type:n},l=c.value?"/with-state/unlike":"/with-state/add-like";e.index.request({url:t.websiteUrl+l,method:"POST",header:{Authorization:o},data:i,success:t=>(console.log(t.data),"success"==t.data.status?(e.index.showToast({title:"操作成功",icon:"success"}),c.value=!c.value,h(a.value.id),void _(a.value.id,u.value)):void e.index.showToast({title:t.data.msg,icon:"none"})),fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}())),f:e.f(a.value.image_url_list,((t,o,n)=>({a:t,b:e.o((t=>function(t){console.log(a),e.index.previewImage({current:a.value.image_url_list[t],urls:a.value.image_url_list})}(o)),o),c:o}))),g:n.value.avatar,h:e.t(n.value.user_name||"未知用户"),i:e.t(S(a.value.created_at)),j:e.o((t=>{return o=a.value.uid,void e.index.navigateTo({url:"/pages/user_page/user_page?uid="+o});var o})),k:e.t(a.value.title),l:e.t(a.value.content),m:e.f(a.value.collocation_relation_list,((t,o,a)=>{var n,i;return e.e({a:0===t.relation_goods_id},0===t.relation_goods_id?{}:e.e({b:t.imageLoaded},t.imageLoaded?{c:(null==(i=null==(n=t.goodsInfo)?void 0:n.goods_images)?void 0:i[0])||"/static/goods-default.png"}:(t.imageError,{}),{d:t.imageError}),{e:e.t(t.relation_brand_name),f:e.t(t.relation_goods_name),g:e.t(t.type),h:e.t(t.goodsInfo&&t.goodsInfo.total_amount?t.goodsInfo.total_amount+t.goodsInfo.currency:"贩售价格未收录"),i:t.id,j:e.o((o=>{return t.relation_goods_id>0?void(0!=(a=t.relation_goods_id)?e.index.navigateTo({url:`/pages/goods/goods?goods_id=${a}`}):e.index.showToast({title:"商品暂时没有录入",icon:"none"})):null;var a}),t.id)})})),n:u.value>0},u.value>0?{o:e.sr(g,"600ec406-2",{k:"commentListRef"}),p:e.o(y),q:e.p({type:1==u.value?3:6,"relation-id":parseInt(d.value)})}:{},{r:e.sr(v,"600ec406-3",{k:"commentInputRef"}),s:e.o(x),t:e.o((t=>e.isRef(m)?m.value=t:m=t)),v:e.p({"reply-info":e.unref(m),"target-id":d.value}),w:i.value},(i.value,{}),{x:l.value},l.value?{y:e.t(r.value)}:{})}}},a=e._export_sfc(o,[["__scopeId","data-v-600ec406"]]);wx.createPage(a);
