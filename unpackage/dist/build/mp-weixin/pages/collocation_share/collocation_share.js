"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"collocation_share",setup(o){const a=e.ref({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),n=e.ref({userName:"",avatar:""}),i=e.index.getSystemInfoSync(),l=e.ref(0),s=e.ref(!1),r=e=>{console.log(e),l.value=e.height};function d(){s.value=!0}function u(){s.value=!1}const c=()=>{s.value=!1,e.index.hideKeyboard()};e.onShow((()=>{})),e.onHide((()=>{}));const g=e.computed((()=>{var e;let t=(null==(e=i.safeAreaInsets)?void 0:e.bottom)||10;l.value>0&&(t+=l.value);let o=`${t}px`;return console.log("footer-brand:"+o),o})),v=e.ref(!0),f=e.ref(!1),m=e.ref(""),_=e.ref(0),h=e.ref(0);let x=e.ref(!1),w=e.ref({}),p=e.ref(1),y=e.ref(""),S=e.ref({});e.index.setNavigationBarTitle({title:"搭配详情"});const T=async(o,n)=>{var i;try{const l=await e.index.request({url:t.websiteUrl+`/view-collocation?collocation_id=${o}&origin=${n}`});if("success"!==l.data.status)return void I(l.data.msg||"数据加载失败");const s={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async o=>{try{const a=o.relation_goods_id>0?await(o=>new Promise(((a,n)=>{o&&0!==o?e.index.request({url:`${t.websiteUrl}/goods?id=${o}`,method:"GET",timeout:5e3,success:e=>{"success"===e.data.status?a(e.data.data):n(e.data.msg||"获取商品信息失败")},fail:t=>{console.error(t),e.index.showToast({title:"网络请求失败",icon:"none"}),n(t)}}):n("无效的商品ID")})))(o.relation_goods_id):null;return{...o,goodsInfo:a,imageLoaded:!!a,imageError:!a}}catch(a){return console.error("商品信息获取失败:",a),{...o,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};a.value=s,(null==(i=l.data.data)?void 0:i.uid)&&await b(l.data.data.uid)}catch(l){I("数据加载失败")}finally{v.value=!1}},b=async o=>{try{const a=await e.index.request({url:`${t.websiteUrl}/user-info?uid=${o}`,method:"GET"});"success"===a.data.status?n.value=a.data.data:console.error("获取用户信息失败:",a.data.msg)}catch(a){console.error("用户信息请求失败:",a),e.index.showToast({title:"作者信息加载失败",icon:"none"})}},I=t=>{f.value=!0,m.value=t,e.index.showToast({title:t,icon:"none"})};function $(o){let a=e.index.getStorageSync("token");if(""==a)return;let n=1==h.value?3:4;e.index.request({url:t.websiteUrl+"/with-state/hasLike?id="+o+"&type="+n,method:"POST",header:{Authorization:a},success:t=>{"success"==t.data.status?t.data.data.id>0?x.value=!0:x.value=!1:e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function k(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}function q(){e.index.request({url:t.websiteUrl+"/collocation-comment?collocation_id="+_.value+"&page="+p.value,method:"GET",timeout:5e3,success:t=>{console.log(t.data.data),w.value.page_index=t.data.data.page_index,w.value.total=t.data.data.total,w.value.comment_list=w.value.comment_list?w.value.comment_list.concat(t.data.data.comment_list):t.data.data.comment_list,null!=t.data.data.comment_list&&(t.data.data.comment_list.length>0&&(p.value+=1),0==t.data.data.comment_list.length&&p.value>1&&e.index.showToast({title:"没有更多数据了",icon:"none"}))},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function A(){let o=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});if(""==y.value)return void e.index.showToast({title:"请输入评论内容",icon:"none"});let a=t.getScene(),n={content:y.value,target_id:parseInt(_.value),type:3,origin:a};S.value.id&&(n.reply_id=S.value.id,n.reply_for=S.value.comment,n.reply_user_id=S.value.user_id),console.log(n),e.index.request({url:t.websiteUrl+"/with-state/add-comment",method:"POST",header:{Authorization:o},data:n,success:t=>(console.log(t.data),"success"==t.data.status?(e.index.showToast({title:"评论成功",icon:"success"}),y.value="",p.value=1,w.value={},void q()):void e.index.showToast({title:t.data.msg,icon:"none"})),fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function E(e){const t=new Date(1e3*e),o=t.getFullYear(),a=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0"),i=t.getHours().toString().padStart(2,"0"),l=t.getMinutes().toString().padStart(2,"0");return t.getSeconds().toString().padStart(2,"0"),`${o}-${a}-${n} ${i}:${l}`}return e.onShow((()=>{console.log("注册键盘弹出事件"),e.index.onKeyboardHeightChange(r)})),e.onLoad((e=>e.collocation_id?e.origin?(_.value=e.collocation_id,h.value=e.origin,T(e.collocation_id,e.origin),t.asyncGetUserInfo().then((t=>{console.log(t),$(e.collocation_id)})),void q()):(f.value=!0,void(m.value="缺少必要参数Origin")):(f.value=!0,void(m.value="缺少必要参数Id")))),(o,i)=>{var l;return e.e({a:!e.unref(x)},e.unref(x)?{c:e.p({type:"heart-filled",size:"28",color:"#ff4d4f"})}:{b:e.p({type:"heart",size:"28",color:"#ff4d4f"})},{d:e.t((null==(l=a.value)?void 0:l.like_count)?k(a.value.like_count):0),e:e.o((o=>function(){let o=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let n=1==h.value?3:4,i={id:parseInt(a.value.id),type:n},l=x.value?"/with-state/unlike":"/with-state/add-like";e.index.request({url:t.websiteUrl+l,method:"POST",header:{Authorization:o},data:i,success:t=>(console.log(t.data),"success"==t.data.status?(e.index.showToast({title:"操作成功",icon:"success"}),x.value=!x.value,$(a.value.id),void T(a.value.id,h.value)):void e.index.showToast({title:t.data.msg,icon:"none"})),fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}())),f:e.f(a.value.image_url_list,((t,o,n)=>({a:t,b:e.o((t=>function(t){console.log(a),e.index.previewImage({current:a.value.image_url_list[t],urls:a.value.image_url_list})}(o)),o),c:o}))),g:n.value.avatar,h:e.t(n.value.user_name||"未知用户"),i:e.o((t=>{var o;(o=a.value.uid)&&e.index.navigateTo({url:`/pages/user/profile?uid=${o}`})})),j:e.t(a.value.title),k:e.t(a.value.content),l:e.f(a.value.collocation_relation_list,((t,o,a)=>{var n,i;return e.e({a:0===t.relation_goods_id},0===t.relation_goods_id?{}:e.e({b:t.imageLoaded},t.imageLoaded?{c:(null==(i=null==(n=t.goodsInfo)?void 0:n.goods_images)?void 0:i[0])||"/static/goods-default.png"}:(t.imageError,{}),{d:t.imageError}),{e:e.t(t.relation_brand_name),f:e.t(t.relation_goods_name),g:e.t(t.type),h:e.t(t.goodsInfo&&t.goodsInfo.total_amount?t.goodsInfo.total_amount+t.goodsInfo.currency:"贩售价格未收录"),i:t.id,j:e.o((o=>{return t.relation_goods_id>0?void(0!=(a=t.relation_goods_id)?e.index.navigateTo({url:`/pages/goods/goods?goods_id=${a}`}):e.index.showToast({title:"商品暂时没有录入",icon:"none"})):null;var a}),t.id)})})),m:e.unref(w).total},e.unref(w).total?{n:e.t(e.unref(w).total||0)}:{},{o:e.unref(w).comment_list},e.unref(w).comment_list?{p:e.f(e.unref(w).comment_list,((t,o,a)=>({a:t.avatar,b:e.t(t.username),c:e.t(t.comment),d:e.t(E(t.created_at)),e:e.t(t.floor),f:e.s(e.unref(S).id===t.id?{color:"#fd6669"}:{color:"#888"}),g:e.o((e=>function(e){S.value.id!=e.id?S.value=e:S.value={}}(t)),t.id),h:t.id}))),q:e.s({fontSize:"12px",position:"absolute",bottom:"3px",right:"15px",fontWeight:"1000"})}:{},{r:!e.unref(w).total},(e.unref(w).total,{}),{s:e.unref(w).total},e.unref(w).total?{t:e.o(q)}:{},{v:e.unref(S).id},e.unref(S).id?{w:e.t("@"+e.unref(S).username)}:{},{x:e.o(d),y:e.o(d),z:e.o(u),A:e.unref(y),B:e.o((t=>e.isRef(y)?y.value=t.detail.value:y=t.detail.value)),C:e.o(A),D:g.value,E:s.value,F:e.o(c),G:v.value},(v.value,{}),{H:f.value},f.value?{I:e.t(m.value)}:{})}}},a=e._export_sfc(o,[["__scopeId","data-v-98b6595c"]]);wx.createPage(a);
