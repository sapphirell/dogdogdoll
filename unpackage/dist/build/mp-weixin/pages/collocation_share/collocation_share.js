"use strict";const e=require("../../common/vendor.js"),a=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("uni-icons")+e.resolveComponent("report-button")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/report-button/report-button.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const t={__name:"collocation_share",props:{collocation_id:{type:String,default:0},origin:{type:String,default:0}},setup(t){const o=e.ref({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),n=e.ref({userName:"",avatar:""});e.index.getSystemInfoSync();const i=e.ref(!0),l=e.ref(!1),r=e.ref(""),s=e.ref(0),u=e.ref(0);let d=e.ref(!1);const c=e.ref(null),v=e.ref(null);e.ref(1);let m=e.ref({});e.index.setNavigationBarTitle({title:"搭配详情"});const g=async(t,n)=>{var l;try{const r=await e.index.request({url:a.websiteUrl.value+`/view-collocation?collocation_id=${t}&origin=${n}`});if("success"!==r.data.status)return void p(r.data.msg||"数据加载失败");const s={...r.data.data,image_url_list:Array.isArray(r.data.data.image_url_list)?r.data.data.image_url_list:[r.data.data.image_urls],collocation_relation_list:await Promise.all(r.data.data.collocation_relation_list.map((async t=>{try{const o=t.relation_goods_id>0?await(t=>new Promise(((o,n)=>{t&&0!==t?e.index.request({url:`${a.websiteUrl.value}/goods?id=${t}`,method:"GET",timeout:5e3,success:e=>{"success"===e.data.status?o(e.data.data):n(e.data.msg||"获取商品信息失败")},fail:a=>{console.error(a),e.index.showToast({title:"网络请求失败",icon:"none"}),n(a)}}):n("无效的商品ID")})))(t.relation_goods_id):null;return{...t,goodsInfo:o,imageLoaded:!!o,imageError:!o}}catch(o){return console.error("商品信息获取失败:",o),{...t,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};o.value=s,(null==(l=r.data.data)?void 0:l.uid)&&await _(r.data.data.uid)}catch(r){p("数据加载失败")}finally{i.value=!1}},_=async t=>{try{const o=await e.index.request({url:`${a.websiteUrl.value}/user-info?uid=${t}`,method:"GET"});"success"===o.data.status?n.value=o.data.data:console.error("获取用户信息失败:",o.data.msg)}catch(o){console.error("用户信息请求失败:",o),e.index.showToast({title:"作者信息加载失败",icon:"none"})}},p=a=>{l.value=!0,r.value=a,e.index.showToast({title:a,icon:"none"})};function f(t){let o=e.index.getStorageSync("token");if(""==o)return;let n=1==u.value?3:4;e.index.request({url:a.websiteUrl.value+"/with-state/hasLike?id="+t+"&type="+n,method:"POST",header:{Authorization:o},success:a=>{"success"==a.data.status?a.data.data.id>0?d.value=!0:d.value=!1:e.index.showToast({title:a.data.msg,icon:"none"})},fail:a=>{console.log(a),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function y(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}const h=({parent:e,target:a})=>{var t;console.log("parent",e),console.log("target",a);let o=e;null!=a&&(o=a),m.value.id!=o.id?(console.log("item",o),m.value=o,null==(t=v.value)||t.focusInput()):m.value={}},w=t=>{var o,n,i;let l=e.index.getStorageSync("token");if(!a.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});const r=1==u.value?3:6,d={content:t.content,origin:t.origin,target_id:parseInt(s.value),type:r,image_url:t.image_url||"",association_id:t.association_id||0,association_type:t.association_type||0,is_anonymous:t.is_anonymous||0,...m.value.id&&{reply_id:m.value.id,reply_for:m.value.comment,reply_uid:m.value.user_id,parent_id:m.value.parent_id>0?m.value.parent_id:m.value.id}},v={id:Date.now(),content:t.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...t.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:a.global.userInfo.avatar,username:a.global.userInfo.nickname,is_anonymous:0},...t.association_id&&{association_id:t.association_id,association_type:t.association_type},...t.image_url&&{image_url:t.image_url},...m.value.id&&{reply_id:m.value.id,reply_for:m.value.comment,reply_uid:m.value.user_id,parent_id:m.value.parent_id>0?m.value.parent_id:m.value.id,reply_username:m.value.is_anonymous?"匿名用户":m.value.username}};m.value.id?0===m.value.parent_id?null==(n=c.value)||n.addReplyComment({...v,parent_id:m.value.id}):null==(i=c.value)||i.addReplyComment({...v,parent_id:m.value.parent_id}):null==(o=c.value)||o.addNewComment(v),e.index.request({url:a.websiteUrl.value+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:d,success:o=>{var n,i;if("success"==o.data.status){const i=o.data.data,l={...i,...t.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:a.global.userInfo.avatar,username:a.global.userInfo.nickname,is_anonymous:0}};i.reply_uid&&m.value.is_anonymous&&(l.reply_username="匿名用户"),null==(n=c.value)||n.updateTempComment(v.id,l),e.index.showToast({title:"评论成功",icon:"success"})}else null==(i=c.value)||i.removeTempComment(v.id),e.index.showToast({title:o.data.msg,icon:"none"})},fail:a=>{var t;null==(t=c.value)||t.removeTempComment(v.id),e.index.showToast({title:"网络请求失败",icon:"none"})}})};function x(e){const a=new Date(1e3*e),t=a.getFullYear(),o=(a.getMonth()+1).toString().padStart(2,"0"),n=a.getDate().toString().padStart(2,"0"),i=a.getHours().toString().padStart(2,"0"),l=a.getMinutes().toString().padStart(2,"0");return a.getSeconds().toString().padStart(2,"0"),`${t}-${o}-${n} ${i}:${l}`}return e.onShow((()=>{console.log("注册键盘弹出事件"),e.index.onKeyboardHeightChange(keyboardHeightChangeHandler)})),e.onLoad((t=>{try{if(!t.collocation_id)return l.value=!0,void(r.value="缺少必要参数Id");if(!t.origin)return l.value=!0,void(r.value="缺少必要参数Origin");s.value=t.collocation_id,u.value=t.origin,g(t.collocation_id,t.origin),a.asyncGetUserInfo().then((e=>{console.log(e),f(t.collocation_id)}))}catch(o){console.error("onLoad Error:",o),e.index.showToast({title:"加载失败",icon:"none"})}})),(t,_)=>{var p;return e.e({a:!e.unref(d)},e.unref(d)?{c:e.p({type:"heart-filled",size:"28",color:"#ff4d4f"})}:{b:e.p({type:"heart",size:"28",color:"#ff4d4f"})},{d:e.t((null==(p=o.value)?void 0:p.like_count)?y(o.value.like_count):0),e:e.o((t=>function(){let t=e.index.getStorageSync("token");if(!a.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let n=1==u.value?3:4,i={id:parseInt(o.value.id),type:n},l=d.value?"/with-state/unlike":"/with-state/add-like";e.index.request({url:a.websiteUrl.value+l,method:"POST",header:{Authorization:t},data:i,success:a=>(console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"操作成功",icon:"success"}),d.value=!d.value,f(o.value.id),void g(o.value.id,u.value)):void e.index.showToast({title:a.data.msg,icon:"none"})),fail:a=>{console.log(a),e.index.showToast({title:"网络请求失败",icon:"none"})}})}())),f:e.f(o.value.image_url_list,((a,t,n)=>({a:a,b:e.o((a=>function(a){console.log(o),e.index.previewImage({current:o.value.image_url_list[a],urls:o.value.image_url_list})}(t)),t),c:t}))),g:n.value.avatar,h:e.t(n.value.user_name||"未知用户"),i:e.t(x(o.value.created_at)),j:e.o((a=>{return t=o.value.uid,void e.index.navigateTo({url:"/pages/user_page/user_page?uid="+t});var t})),k:e.t(o.value.title),l:e.p({"report-type":1===u.value?2:1,"relation-id":parseInt(s.value),"icon-type":"flag","icon-color":"#999"}),m:e.t(o.value.content),n:e.f(o.value.collocation_relation_list,((a,t,o)=>{var n,i;return e.e({a:0===a.relation_goods_id},0===a.relation_goods_id?{}:e.e({b:a.imageLoaded},a.imageLoaded?{c:(null==(i=null==(n=a.goodsInfo)?void 0:n.goods_images)?void 0:i[0])||"/static/goods-default.png"}:(a.imageError,{}),{d:a.imageError}),{e:e.t(a.relation_brand_name),f:e.t(a.relation_goods_name),g:e.t(a.type),h:e.t(a.goodsInfo&&a.goodsInfo.total_amount?a.goodsInfo.total_amount+a.goodsInfo.currency:"贩售价格未收录"),i:a.id,j:e.o((t=>(a=>{a.relation_goods_id>0?e.index.navigateTo({url:`/pages/goods/goods?goods_id=${a.relation_goods_id}`}):a.relation_brand_id>0?e.index.navigateTo({url:`/pages/brand/brand?brand_id=${a.relation_brand_id}`}):e.index.showToast({title:"暂无商品和品牌信息",icon:"none"})})(a)),a.id)})})),o:u.value>0},u.value>0?{p:e.sr(c,"e10d3b60-4",{k:"commentListRef"}),q:e.o(h),r:e.p({type:1==u.value?3:6,"relation-id":parseInt(s.value)})}:{},{s:o.value.title},o.value.title?{t:e.sr(v,"e10d3b60-5",{k:"commentInputRef"}),v:e.o(w),w:e.o((a=>e.isRef(m)?m.value=a:m=a)),x:e.p({"reply-info":e.unref(m),"target-id":s.value})}:{},{y:i.value},(i.value,{}),{z:l.value},l.value?{A:e.t(r.value)}:{})}}},o=e._export_sfc(t,[["__scopeId","data-v-e10d3b60"]]);t.__runtimeHooks=2,wx.createPage(o);
