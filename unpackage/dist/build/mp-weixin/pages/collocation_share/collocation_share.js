"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../common/config.js");if(!Array){e.resolveComponent("common-page")()}Math;const o={__name:"collocation_share",setup(o){const i=e.ref({title:"",content:"",image_url_list:[],collocation_relation_list:[]}),n=e.ref({userName:"",avatar:""}),l=e.index.getSystemInfoSync(),s=e.ref(0);e.onShow((()=>{})),e.onHide((()=>{}));const r=e.computed((()=>{var e;let t=(null==(e=l.safeAreaInsets)?void 0:e.bottom)||10;s.value>0&&(t+=s.value);let a=`${t}px`;return console.log("footer-brand:"+a),a})),d=e.ref(!0),u=e.ref(!1),c=e.ref(""),g=e.ref(0),v=e.ref(0);let m=e.ref(!1),_=e.ref({}),f=e.ref(1),h=e.ref(""),x=e.ref({});e.index.setNavigationBarTitle({title:"搭配详情"});const w=async(t,o)=>{var n;try{const l=await e.index.request({url:a.websiteUrl+`/view-collocation?collocation_id=${t}&origin=${o}`});if("success"!==l.data.status)return void T(l.data.msg||"数据加载失败");const s={...l.data.data,image_url_list:Array.isArray(l.data.data.image_url_list)?l.data.data.image_url_list:[l.data.data.image_urls],collocation_relation_list:await Promise.all(l.data.data.collocation_relation_list.map((async t=>{try{const o=t.relation_goods_id>0?await(t=>new Promise(((o,i)=>{t&&0!==t?e.index.request({url:`${a.websiteUrl}/goods?id=${t}`,method:"GET",timeout:5e3,success:e=>{"success"===e.data.status?o(e.data.data):i(e.data.msg||"获取商品信息失败")},fail:t=>{console.error(t),e.index.showToast({title:"网络请求失败",icon:"none"}),i(t)}}):i("无效的商品ID")})))(t.relation_goods_id):null;return{...t,goodsInfo:o,imageLoaded:!!o,imageError:!o}}catch(o){return console.error("商品信息获取失败:",o),{...t,goodsInfo:null,imageLoaded:!1,imageError:!0}}})))};i.value=s,(null==(n=l.data.data)?void 0:n.uid)&&await p(l.data.data.uid)}catch(l){T("数据加载失败")}finally{d.value=!1}},p=async t=>{try{const o=await e.index.request({url:`${a.websiteUrl}/user-info?uid=${t}`,method:"GET"});"success"===o.data.status?n.value=o.data.data:console.error("获取用户信息失败:",o.data.msg)}catch(o){console.error("用户信息请求失败:",o),e.index.showToast({title:"作者信息加载失败",icon:"none"})}},T=t=>{u.value=!0,c.value=t,e.index.showToast({title:t,icon:"none"})};function S(t){let o=e.index.getStorageSync("token");if(""==o)return;let i=1==v.value?3:4;e.index.request({url:a.websiteUrl+"/with-state/hasLike?id="+t+"&type="+i,method:"POST",header:{Authorization:o},success:t=>{"success"==t.data.status?t.data.data.id>0?m.value=!0:m.value=!1:e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function y(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}function b(){e.index.request({url:a.websiteUrl+"/collocation-comment?collocation_id="+g.value+"&page="+f.value,method:"GET",timeout:5e3,success:t=>{console.log(t.data.data),_.value.page_index=t.data.data.page_index,_.value.total=t.data.data.total,_.value.comment_list=_.value.comment_list?_.value.comment_list.concat(t.data.data.comment_list):t.data.data.comment_list,null!=t.data.data.comment_list&&(t.data.data.comment_list.length>0&&(f.value+=1),0==t.data.data.comment_list.length&&f.value>1&&e.index.showToast({title:"没有更多数据了",icon:"none"}))},fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function $(){let t=e.index.getStorageSync("token");if(!a.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});if(""==h.value)return void e.index.showToast({title:"请输入评论内容",icon:"none"});let o={content:h.value,target_id:parseInt(g.value),type:3};x.value.id&&(o.reply_id=x.value.id,o.reply_for=x.value.comment,o.reply_user_id=x.value.user_id),console.log(o),e.index.request({url:a.websiteUrl+"/with-state/add-comment",method:"POST",header:{Authorization:t},data:o,success:t=>(console.log(t.data),"success"==t.data.status?(e.index.showToast({title:"评论成功",icon:"success"}),h.value="",f.value=1,_.value={},void b()):void e.index.showToast({title:t.data.msg,icon:"none"})),fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function I(e){const t=new Date(1e3*e),a=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),i=t.getDate().toString().padStart(2,"0"),n=t.getHours().toString().padStart(2,"0"),l=t.getMinutes().toString().padStart(2,"0");return t.getSeconds().toString().padStart(2,"0"),`${a}-${o}-${i} ${n}:${l}`}return e.onLoad((e=>e.collocation_id?e.origin?(g.value=e.collocation_id,v.value=e.origin,w(e.collocation_id,e.origin),a.asyncGetUserInfo().then((t=>{console.log(t),S(e.collocation_id)})),void b()):(u.value=!0,void(c.value="缺少必要参数Origin")):(u.value=!0,void(c.value="缺少必要参数Id")))),(o,l)=>e.e({a:!e.unref(m)},e.unref(m)?{c:t._imports_1$4}:{b:t._imports_0$5},{d:e.t(y(i.value.like_count)),e:e.o((t=>function(){let t=e.index.getStorageSync("token");if(!a.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let o=1==v.value?3:4,n={id:parseInt(i.value.id),type:o},l=m.value?"/with-state/unlike":"/with-state/add-like";e.index.request({url:a.websiteUrl+l,method:"POST",header:{Authorization:t},data:n,success:t=>(console.log(t.data),"success"==t.data.status?(e.index.showToast({title:"操作成功",icon:"success"}),m.value=!m.value,S(i.value.id),void w(i.value.id,v.value)):void e.index.showToast({title:t.data.msg,icon:"none"})),fail:t=>{console.log(t),e.index.showToast({title:"网络请求失败",icon:"none"})}})}())),f:e.f(i.value.image_url_list,((t,a,o)=>({a:t,b:e.o((t=>function(t){console.log(i),e.index.previewImage({current:i.value.image_url_list[t],urls:i.value.image_url_list})}(a)),a),c:a}))),g:n.value.avatar,h:e.t(n.value.user_name||"未知用户"),i:e.o((t=>{var a;(a=i.value.uid)&&e.index.navigateTo({url:`/pages/user/profile?uid=${a}`})})),j:e.t(i.value.title),k:e.t(i.value.content),l:e.f(i.value.collocation_relation_list,((t,a,o)=>{var i,n;return e.e({a:0===t.relation_goods_id},0===t.relation_goods_id?{}:e.e({b:t.imageLoaded},t.imageLoaded?{c:(null==(n=null==(i=t.goodsInfo)?void 0:i.goods_images)?void 0:n[0])||"/static/goods-default.png"}:(t.imageError,{}),{d:t.imageError}),{e:e.t(t.relation_brand_name),f:e.t(t.type),g:e.t(t.relation_goods_name),h:t.id,i:e.o((a=>{return t.relation_goods_id>0?void(0!=(o=t.relation_goods_id)?e.index.navigateTo({url:`/pages/goods/goods?goods_id=${o}`}):e.index.showToast({title:"商品暂时没有录入",icon:"none"})):null;var o}),t.id)})})),m:e.t(e.unref(_).total||0),n:e.unref(_).comment_list},e.unref(_).comment_list?{o:e.f(e.unref(_).comment_list,((t,a,o)=>({a:t.avatar,b:e.t(t.username),c:e.t(t.comment),d:e.t(I(t.created_at)),e:e.t(t.floor),f:e.s(e.unref(x).id===t.id?{color:"#fd6669"}:{color:"#888"}),g:e.o((e=>function(e){x.value.id!=e.id?x.value=e:x.value={}}(t)),t.id),h:t.id}))),p:e.s({fontSize:"12px",position:"absolute",bottom:"3px",right:"15px",fontWeight:"1000"}),q:e.o(b)}:{},{r:e.unref(x).id},e.unref(x).id?{s:e.t("@"+e.unref(x).username)}:{},{t:e.unref(h),v:e.o((t=>e.isRef(h)?h.value=t.detail.value:h=t.detail.value)),w:e.o($),x:r.value,y:d.value},(d.value,{}),{z:u.value},u.value?{A:e.t(c.value)}:{})}},i=e._export_sfc(o,[["__scopeId","data-v-4cc6c60d"]]);wx.createPage(i);
