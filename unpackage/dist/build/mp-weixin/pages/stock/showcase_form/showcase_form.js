"use strict";const e=require("../../../common/vendor.js"),o=require("../../../common/assets.js"),a=require("../../../common/config.js"),n=require("../../../common/image.js");if(!Array){(e.resolveComponent("common-name-picker")+e.resolveComponent("common-search")+e.resolveComponent("custom-picker")+e.resolveComponent("common-modal")+e.resolveComponent("common-page"))()}Math||((()=>"../../../components/common-name-picker/common-name-picker.js")+(()=>"../../../components/common-search/common-search.js")+(()=>"../../../components/custom-picker/custom-picker.js")+(()=>"../../../components/common-modal/common-modal.js")+(()=>"../../../components/common-page/common-page.js"))();const t={__name:"showcase_form",props:["showcase_id"],setup(t){const i=t,s=e.ref([]),l=e.ref([]),d=e.ref([]),u=e.ref(!1),c=e.ref(""),r=e.ref(0),m=e.ref(""),v=e.ref(0),g=e.ref(""),p=e.computed((()=>[-1,1,3].includes(f.value))),h=e.computed((()=>!!i.showcase_id)),_=e.ref(""),w=e.ref(""),f=e.ref(-1);const x=e.ref([]);function T(o){e.index.previewImage({current:s.value[o],urls:s.value})}async function y(){e.index.showModal({title:"确认删除",content:"确定要删除这个展示吗？",success:async o=>{if(o.confirm)try{200===(await e.index.request({url:`${a.websiteUrl}/with-state/delete-showcase`,method:"DELETE",data:{id:i.showcase_id},header:{Authorization:e.index.getStorageSync("token")}})).data.code&&(e.index.showToast({title:"删除成功"}),setTimeout((()=>e.index.navigateBack()),1e3))}catch(n){e.index.showToast({title:"删除失败",icon:"none"})}}})}async function b(){if(!e.index.getStorageSync("token"))return void e.index.showToast({title:"请先登录",icon:"none"});if(!_.value.trim()||!w.value.trim())return void e.index.showToast({title:"标题和正文不能为空",icon:"none"});if(0===s.value.length)return void e.index.showToast({title:"请至少上传一张图片",icon:"none"});let o={name:_.value,description:w.value,image_urls:s.value.join(","),display:f.value,relations:x.value.map((e=>({relation_goods_id:e.goods_id,relation_goods_name:e.goods_name,relation_brand_id:e.brand_id,relation_brand_name:e.brand_name,type:e.type,relation_origin:2})))};try{const n=`${a.websiteUrl}/with-state/update-showcase`;i.showcase_id&&(o={...o,id:parseInt(i.showcase_id,10)});if("failed"===(await e.index.request({url:n,method:"POST",data:o,header:{"Content-Type":"application/json",Authorization:e.index.getStorageSync("token")}})).data.code)return void e.index.showToast({title:"提交失败",icon:"none"});e.index.showToast({title:"提交成功"}),setTimeout((()=>e.index.navigateBack()),1500)}catch(n){console.log(n),e.index.showToast({title:"提交失败",icon:"none"})}}function k(o,n){var t;console.log("收到品牌ID:",o),console.log("收到品牌Name:",n),r.value=parseInt(o,10),c.value=n,t=o,e.index.request({url:a.websiteUrl+"/goods-name-list?id="+t,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),l.value=e.data.data,console.log(l.value)},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function j(e,o){console.log("选中的 id:",e),console.log("选中的 name:",o),v.value=parseInt(e,10),m.value=o}function q(e){console.log("选中的值:",e),g.value=e,u.value=!0}function S(){if(""!=c.value)if(""!=m.value){if(0==v.value){let e={brand_id:r.value,goods_id:0,brand_name:c.value,goods_name:m.value,goods_image:"",type:g.value};return x.value.push(e),u.value=!1,r.value=0,c.value="",v.value=0,m.value="",void(g.value="")}var o;(o=v.value,new Promise(((n,t)=>{e.index.request({url:a.websiteUrl+"/goods?id="+o,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),n(e.data)},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"}),t(o)},complete:()=>{e.index.hideLoading()}})}))).then((e=>{let o={brand_id:r.value,goods_id:v.value,brand_name:c.value,goods_name:m.value,goods_image:e.data.goods_images[0],type:g.value};x.value.push(o),u.value=!1,r.value=0,c.value="",v.value=0,m.value="",g.value=""}))}else e.index.showToast({title:"请选择或填写商品名称",icon:"none"});else e.index.showToast({title:"请选择或填写品牌名称",icon:"none"})}return e.index.setNavigationBarTitle({title:"展示柜"}),e.onMounted((()=>{e.index.request({url:a.websiteUrl+"/goods-types",method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),d.value=e.data.data},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}}),async function(){var o;if(i.showcase_id)try{const n=(await e.index.request({url:`${a.websiteUrl}/with-state/showcase-detail?id=${i.showcase_id}`,method:"GET",header:{Authorization:e.index.getStorageSync("token")}})).data.data;_.value=n.name,w.value=n.description,f.value=n.display,s.value=(null==(o=n.image_urls)?void 0:o.split(","))||[],console.log(n),n.relations&&(x.value=n.relations.map((e=>({goods_id:e.relation_goods_id,goods_name:e.relation_goods_name,brand_id:e.relation_brand_id,brand_name:e.relation_brand_name,type:e.type,goods_image:e.relation_goods_image}))))}catch(n){e.index.showToast({title:"加载失败",icon:"none"})}}()})),(t,i)=>e.e({a:!p.value},(p.value,{}),{b:e.f(s.value,((a,n,t)=>e.e({a:a,b:e.o(T,n)},p.value?{c:o._imports_1$6,d:e.o((e=>function(e){s.value.splice(e,1)}(n)),n)}:{},{e:n}))),c:p.value,d:p.value},p.value?{e:o._imports_1$5,f:e.o((o=>(t.index,console.log("openSelect"),void n.chooseImage().then((o=>{n.getQiniuToken().then((t=>{console.log(t),n.uploadImageToQiniu(o,t.token,t.path).then((o=>{200!=o.statusCode&&e.index.showToast({title:"上传失败",icon:"none"}),console.log(a.image1Url+t.path),s.value.push(a.image1Url+t.path),e.index.showToast({title:"上传成功",icon:"success"})}))}))})))))}:{},{g:!p.value,h:_.value,i:e.o((e=>_.value=e.detail.value)),j:!p.value,k:w.value,l:e.o((e=>w.value=e.detail.value)),m:p.value},p.value?{n:e.o(q),o:e.p({dataList:d.value,placeholder:"关联娃物"}),p:o._imports_2$2}:{},{q:e.f(x.value,((a,n,t)=>e.e({a:a.goods_image},a.goods_image?{b:a.goods_image}:{},{c:e.t(a.type),d:e.t(a.brand_name),e:e.t(a.goods_name)},p.value?{f:o._imports_1$6,g:e.o((e=>function(e){x.value.splice(e,1)}(n)),n)}:{},{h:n}))),r:p.value,s:e.o(k),t:e.p({mode:"fill",width:"calc(100vw - 120px)"}),v:e.o(j),w:e.p({dataList:l.value,margin:"10px 0 0 8px"}),x:e.o(S),y:e.o((e=>u.value=e)),z:e.p({visible:u.value}),A:h.value},h.value?{B:e.o(y)}:{},{C:e.o(b)})}};wx.createPage(t);
