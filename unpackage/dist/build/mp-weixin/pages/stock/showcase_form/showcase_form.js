"use strict";const e=require("../../../common/vendor.js"),o=require("../../../common/assets.js"),a=require("../../../common/config.js"),t=require("../../../common/image.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("relation-picker"))()}Math||((()=>"../../../components/view-logs/view-logs.js")+(()=>"../../../components/relation-picker/relation-picker.js"))();const i={__name:"showcase_form",props:["showcase_id"],setup(i){const n=i,s=e.ref([]),d=e.ref([]),l=e.ref([]),r=e.ref(!1);e.ref(""),e.ref(0),e.ref(""),e.ref(0),e.ref("");const c=o=>{try{const a={goods_id:o.goods.id||0,goods_name:o.goods.name,goods_image:o.goods.image||"",brand_id:o.brand.id||0,brand_name:o.brand.name||(o.isFuzzy?"":"未知品牌"),type:o.type||(o.isFuzzy?"未知类型":"")};w.value.some((e=>0!==e.goods_id&&e.goods_id===a.goods_id||e.goods_name===a.goods_name))?e.index.showToast({title:"已存在相同关联项",icon:"none"}):w.value.push(a)}catch(a){console.error("保存关联数据失败:",a),e.index.showToast({title:"保存关联信息失败",icon:"none"})}},u=()=>{console.log("用户取消选择")},g=()=>{r.value=!0},m=e.computed((()=>[-1,1,3].includes(p.value))),_=e.computed((()=>n.showcase_id>0)),v=e.ref(""),h=e.ref(""),p=e.ref(-1);const w=e.ref([]);function f(o){e.index.previewImage({current:s.value[o],urls:s.value})}async function y(){e.index.showModal({title:"确认删除",content:"确定要删除这个展示吗？",success:async o=>{if(o.confirm)try{"success"===(await e.index.request({url:`${a.websiteUrl}/with-state/delete-showcase?id=`+n.showcase_id,method:"POST",header:{Authorization:e.index.getStorageSync("token")}})).data.status&&(e.index.showToast({title:"删除成功"}),setTimeout((()=>e.index.navigateBack()),1e3))}catch(t){e.index.showToast({title:"删除失败",icon:"none"})}}})}async function x(){if(!e.index.getStorageSync("token"))return void e.index.showToast({title:"请先登录",icon:"none"});if(!v.value.trim()||!h.value.trim())return void e.index.showToast({title:"标题和正文不能为空",icon:"none"});if(0===s.value.length)return void e.index.showToast({title:"请至少上传一张图片",icon:"none"});let o=a.getScene(),t={name:v.value,description:h.value,image_urls:s.value.join(","),display:p.value,origin:o,relations:w.value.map((e=>({relation_goods_id:e.goods_id,relation_goods_name:e.goods_name,relation_brand_id:e.brand_id,relation_brand_name:e.brand_name,type:e.type,relation_origin:2})))};try{let o=`${a.websiteUrl}/with-state/add-showcase`;n.showcase_id&&(o=`${a.websiteUrl}/with-state/update-showcase`,t={...t,id:parseInt(n.showcase_id,10)});if("failed"===(await e.index.request({url:o,method:"POST",data:t,header:{"Content-Type":"application/json",Authorization:e.index.getStorageSync("token")}})).data.code)return void e.index.showToast({title:"提交失败",icon:"none"});e.index.showToast({title:"提交成功"}),setTimeout((()=>e.index.navigateBack()),1500)}catch(i){console.log(i),e.index.showToast({title:"提交失败",icon:"none"})}}return e.index.setNavigationBarTitle({title:"展示柜"}),e.onLoad((async o=>{if(o.goods_id&&o.goods_name&&o.brand_id&&o.brand_name&&o.type){let n="";try{n=(await(t=parseInt(o.goods_id),new Promise(((o,i)=>{e.index.request({url:a.websiteUrl+"/goods?id="+t,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),o(e.data)},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"}),i(o)},complete:()=>{e.index.hideLoading()}})})))).data.goods_images[0]||""}catch(i){console.error("获取商品图片失败:",i)}w.value.push({brand_id:parseInt(o.brand_id,10),goods_id:parseInt(o.goods_id,10),brand_name:o.brand_name,goods_name:o.goods_name,goods_image:n,type:o.type})}var t;e.index.request({url:a.websiteUrl+"/goods-types",method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),l.value=e.data.data},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}}),async function(){var o;if(n.showcase_id)try{const t=(await e.index.request({url:`${a.websiteUrl}/with-state/showcase-detail?id=${n.showcase_id}`,method:"GET",header:{Authorization:e.index.getStorageSync("token")}})).data.data;v.value=t.name,h.value=t.description,p.value=t.display,s.value=(null==(o=t.image_urls)?void 0:o.split(","))||[],console.log(t),t.relations&&(w.value=t.relations.map((e=>({goods_id:e.relation_goods_id,goods_name:e.relation_goods_name,brand_id:e.relation_brand_id,brand_name:e.relation_brand_name,type:e.type,goods_image:e.relation_goods_image}))))}catch(t){e.index.showToast({title:"加载失败",icon:"none"})}}()})),(i,n)=>e.e({a:!m.value},(m.value,{}),{b:e.f(s.value,((a,t,i)=>e.e({a:a,b:e.o(f,t)},m.value?{c:o._imports_1$5,d:e.o((e=>function(e){s.value.splice(e,1)}(t)),t)}:{},{e:t}))),c:m.value,d:m.value},m.value?{e:o._imports_1$4,f:e.o((o=>async function(){try{const o=await t.chooseImageList(9);for(const e of o){const o=await t.getQiniuToken();await t.uploadImageToQiniu(e,o.token,o.path),s.value.push(a.image1Url+o.path)}e.index.showToast({title:`成功上传${o.length}张图片`,icon:"success"})}catch(o){console.error("上传出错:",o),e.index.showToast({title:"部分图片上传失败",icon:"none"})}}(i.index)))}:{},{g:!m.value,h:v.value,i:e.o((e=>v.value=e.detail.value)),j:!m.value,k:h.value,l:e.o((e=>h.value=e.detail.value)),m:m.value},m.value?{n:o._imports_2$3,o:e.o(g)}:{},{p:e.f(w.value,((a,t,i)=>e.e({a:a.goods_image},a.goods_image?{b:a.goods_image}:{},{c:e.t(a.type),d:e.t(a.brand_name),e:e.t(a.goods_name)},m.value?{f:o._imports_1$5,g:e.o((e=>function(e){w.value.splice(e,1)}(t)),t)}:{},{h:t}))),q:m.value,r:e.o(c),s:e.o(u),t:e.o((e=>r.value=e)),v:e.p({typeList:l.value,goodsList:d.value,visible:r.value}),w:_.value},_.value?{x:e.o(y)}:{},{y:e.o(x)})}};wx.createPage(i);
