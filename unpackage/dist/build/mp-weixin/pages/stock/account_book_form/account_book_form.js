"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../common/config.js"),o=require("../../../common/image.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("common-modal")+e.resolveComponent("goods-search")+e.resolveComponent("uni-data-picker"))()}Math||((()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/common-modal/common-modal.js")+(()=>"../../../components/goods-search/goods-search.js")+(()=>"../../../uni_modules/uni-data-picker/components/uni-data-picker/uni-data-picker.js"))();const i={__name:"account_book_form",props:["account_book_id"],setup(i){const n=i,s=!!n.account_book_id,l=e.ref(1),u=e.ref([]),c=e.index.getSystemInfoSync();e.ref(c.statusBarHeight);let r=e.ref(""),d=e.ref("");e.ref(1);const v=e.ref(!1),m=e.ref(""),f=e.ref([]),p=["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"],h=e.computed((()=>[...p,...f.value.map((e=>e.name))])),g=e.ref({isRemind:!1,finalPrice:0,finalTime:""}),w=e.ref(!1),x=e.ref([]);e.ref([]);const y=e.ref([]),T=e.ref({sizeDetail:"",color:"",remark:"",buyDate:"",position:""}),_=e=>{const a=e.detail.value;2===a.length?(y.value=[a[0].value,a[1].value],T.value.sizeDetail=a[1].value):(y.value=[],T.value.sizeDetail="")},b=async()=>{const a=e.index.getStorageSync("token");try{const o=await e.index.request({url:t.websiteUrl+"/with-state/account-types",method:"GET",header:{Authorization:a}});f.value=o.data.data||[]}catch(o){console.error("获取分类失败:",o)}},k=async()=>{if(!m.value.trim())return void e.index.showToast({title:"请输入分类名称",icon:"none"});const a=e.index.getStorageSync("token");try{await e.index.request({url:t.websiteUrl+"/with-state/add-account-type",method:"POST",header:{Authorization:a},data:{name:m.value.trim()}}),await b(),m.value="",e.index.showToast({title:"添加成功"})}catch(o){e.index.showToast({title:"添加失败",icon:"none"})}},z=e.ref(0);function S(e){z.value=e.detail.value}e.ref(["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"]),e.ref({});const P=async a=>{var o;try{const i=await e.index.request({url:t.websiteUrl+`/goods?id=${a.id}`,method:"GET"});if("success"===i.data.status){const e=i.data.data;r.value=e.name,d.value=e.fin_amount+e.sub_amount,l.value=1,(null==(o=e.goods_images)?void 0:o[0])&&(u.value=[e.goods_images[0]])}}catch(i){console.error("获取商品详情失败:",i),e.index.showToast({title:"获取商品信息失败",icon:"none"})}};function D(){e.index.showModal({title:"提示",content:"确定删除该账本吗？",success:a=>{if(a.confirm){const a=Number(n.account_book_id);if(isNaN(a)||a<=0)return void e.index.showToast({title:"参数错误",icon:"none"});e.index.request({url:t.websiteUrl+"/with-state/delete-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{id:a},success:a=>{console.log(a.data.status),"success"===a.data.status?(e.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>e.index.navigateBack()),500)):e.index.showToast({title:a.data.msg||"删除失败",icon:"none"})},fail:a=>{console.error("请求失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}})}}})}async function I(){e.index.chooseImage({count:9,success:async a=>{const i=a.tempFilePaths;for(const e of i)try{const a=await o.getQiniuToken(),i=await o.uploadImageToQiniu(e,a.token,a.path);if(console.log("res:",i),200===i.qiniuRes.statusCode){const e=t.image1Url+a.path;u.value.push(e)}else console.error("上传失败:",e)}catch(n){console.error("上传错误:",n)}e.index.showToast({title:`上传了${i.length}张图片`,icon:"success"})}})}function R(){q()&&(s?function(){let a={name:r.value,price:parseInt(d.value,10),count:parseInt(l.value,10),type:h.value[z.value],image_url:u.value.join(","),id:parseInt(n.account_book_id,10),is_remind:g.value.isRemind,final_price:parseInt(g.value.finalPrice,10),final_time:g.value.finalTime,size:y.value[0]||"",size_detail:T.value.sizeDetail||"",color:T.value.color,remark:T.value.remark,buy_date:T.value.buyDate,position:T.value.position};e.index.request({url:t.websiteUrl+"/with-state/update-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}():function(){let a={name:r.value,price:parseInt(d.value,10),count:parseInt(l.value,10),type:h.value[z.value],image_url:u.value.join(","),is_remind:g.value.isRemind,final_price:parseInt(g.value.finalPrice,10),final_time:g.value.finalTime,size:y.value[0]||"",size_detail:T.value.sizeDetail||"",color:T.value.color,remark:T.value.remark,buy_date:T.value.buyDate,position:T.value.position};console.log("提交数据:",a),e.index.request({url:t.websiteUrl+"/with-state/add-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}())}t.asyncGetUserInfo().then((a=>{s?(!function(a){let o=e.index.getStorageSync("token");e.index.request({url:t.websiteUrl+"/with-state/account-book-detail",method:"GET",header:{Authorization:o},data:{id:a},success:e=>{console.log(e.data.data),r.value=e.data.data.name,d.value=parseInt(e.data.data.price),l.value=e.data.data.count||1,z.value=h.value.indexOf(e.data.data.type),e.data.data.image_url&&(u.value=e.data.data.image_url.split(",")),g.value={isRemind:e.data.data.is_remind,finalPrice:e.data.data.final_price,finalTime:e.data.data.final_time},T.value={sizeDetail:e.data.data.size_detail||"",color:e.data.data.color||"",remark:e.data.data.remark||"",buyDate:e.data.data.buy_date?new Date(e.data.data.buy_date).toISOString().split("T")[0]:"",position:e.data.data.position||""},e.data.data.size&&(y.value=[e.data.data.size,e.data.data.size_detail||""]),console.log("f:",g)},fail:e=>{console.log(e)}})}(n.account_book_id),e.index.setNavigationBarTitle({title:"编辑账本"})):e.index.setNavigationBarTitle({title:"新增账本"})}));const q=()=>l.value<=0?(e.index.showToast({title:"个数必须大于0",icon:"none"}),!1):!(g.value.isRemind&&(!g.value.finalPrice||g.value.finalPrice<=0))||(e.index.showToast({title:"请输入正确的尾款金额",icon:"none"}),!1);return e.onShow((()=>{t.asyncGetUserInfo().then((()=>{b(),(async()=>{try{const a=await e.index.request({url:t.websiteUrl+"/sizes",method:"GET"});if("success"===a.data.status){const e=a.data.data,t=[];for(const[a,o]of Object.entries(e))t.push({text:a,value:a,children:o.map((e=>({text:e,value:e})))});x.value=t}}catch(a){console.error("获取尺寸数据失败:",a),e.index.showToast({title:"获取尺寸数据失败",icon:"none"})}})()}))})),(o,i)=>e.e({a:m.value,b:e.o((e=>m.value=e.detail.value)),c:e.o(k),d:e.f(f.value,((a,o,i)=>({a:e.t(a.name),b:e.o((o=>(async a=>{e.index.showModal({title:"确认删除",success:async o=>{if(o.confirm){const o=e.index.getStorageSync("token");try{const i=(await e.index.request({url:t.websiteUrl+"/with-state/delete-account-type",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{id:a}})).data;"success"===i.status?(await b(),e.index.showToast({title:"删除成功"})):e.index.showToast({title:i.msg||"删除失败",icon:"none"})}catch(i){console.error("删除失败:",i),e.index.showToast({title:i.errMsg||"请求失败",icon:"none"})}}}})})(a.id)),a.id),c:"0963bd25-1-"+i+",0963bd25-0",d:a.id}))),e:e.p({type:"trash",size:"22",color:"#ff6666"}),f:e.o((e=>v.value=e)),g:e.p({visible:v.value,top:"100rpx",height:"60%"}),h:e.t(h.value[z.value]||"请选择分类"),i:z.value,j:h.value,k:e.o(S),l:e.o((e=>v.value=!0)),m:e.o(P),n:e.o((a=>e.isRef(r)?r.value=a:r=a)),o:e.p({"font-size":"24rpx",mode:"fill",background:"#fff",width:"640rpx","show-icon":!1,modelValue:e.unref(r)}),p:e.unref(d),q:e.o((a=>e.isRef(d)?d.value=a.detail.value:d=a.detail.value)),r:l.value,s:e.o((e=>l.value=e.detail.value)),t:e.f(u.value,((a,t,o)=>({a:a,b:e.o((a=>{e.index.previewImage({current:u.value.index,urls:u.value})}),t),c:e.o((a=>function(a,t){t&&t.stopPropagation&&t.stopPropagation(),e.index.showModal({title:"删除图片",content:"确定删除这张图片吗？",success:e=>{e.confirm&&u.value.splice(a,1)}})}(t,a)),t),d:"0963bd25-3-"+o,e:t}))),v:e.p({type:"close",size:"22",color:"#fff"}),w:e.p({type:"plusempty",size:"40",color:"#ccc"}),x:e.o(I),y:e.o(_),z:e.p({placeholder:"请选择尺寸",localdata:x.value,value:y.value}),A:!w.value},w.value?{C:e.p({type:"down",size:"20",color:"#888"})}:{B:e.p({type:"right",size:"20",color:"#888"})},{D:e.o((e=>{w.value=!w.value})),E:w.value},w.value?{F:T.value.sizeDetail,G:e.o((e=>T.value.sizeDetail=e.detail.value)),H:T.value.color,I:e.o((e=>T.value.color=e.detail.value)),J:T.value.remark,K:e.o((e=>T.value.remark=e.detail.value)),L:e.t(T.value.buyDate||"选择购入日期"),M:T.value.buyDate,N:e.o((e=>T.value.buyDate=e.detail.value)),O:T.value.position,P:e.o((e=>T.value.position=e.detail.value))}:{},{Q:!g.value.isRemind},g.value.isRemind?{S:e.p({type:"down",size:"20",color:"#888"})}:{R:e.p({type:"right",size:"20",color:"#888"})},{T:g.value.finalPrice>0},(g.value.finalPrice,{}),{U:e.o((e=>(g.value.isRemind=!g.value.isRemind,void(g.value.isRemind||(g.value.finalPrice=0,g.value.finalTime=""))))),V:g.value.isRemind},g.value.isRemind?{W:g.value.finalPrice,X:e.o((e=>g.value.finalPrice=e.detail.value)),Y:e.t(g.value.finalTime||"选择截止日期"),Z:g.value.finalTime,aa:e.o((e=>g.value.finalTime=e.detail.value))}:{},{ab:a._imports_0$7,ac:e.unref(s)},e.unref(s)?{ad:e.o(D)}:{},{ae:e.t(e.unref(s)?"修改":"新增"),af:e.o(R)})}},n=e._export_sfc(i,[["__scopeId","data-v-0963bd25"]]);wx.createPage(n);
