"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../common/config.js"),o=require("../../../common/image.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("common-modal")+e.resolveComponent("goods-search")+e.resolveComponent("uni-data-picker"))()}Math||((()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/common-modal/common-modal.js")+(()=>"../../../components/goods-search/goods-search.js")+(()=>"../../../uni_modules/uni-data-picker/components/uni-data-picker/uni-data-picker.js"))();const i={__name:"account_book_form",props:["account_book_id"],setup(i){const n=i,s=!!n.account_book_id,l=e.index.getSystemInfoSync();e.ref(l.statusBarHeight);let u=e.ref(""),c=e.ref("");e.ref(1);const d=e.ref(!1),r=e.ref(""),v=e.ref([]),m=["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"],f=e.computed((()=>[...m,...v.value.map((e=>e.name))])),h=e.ref({isRemind:!1,finalPrice:0,finalTime:""}),p=e.ref(!1),g=e.ref([]);e.ref([]);const w=e.ref([]),x=e.ref({sizeDetail:"",color:"",remark:"",buyDate:"",position:""}),T=e=>{const a=e.detail.value;2===a.length?(w.value=[a[0].value,a[1].value],x.value.sizeDetail=a[1].value):(w.value=[],x.value.sizeDetail="")},y=async()=>{const a=e.index.getStorageSync("token");try{const o=await e.index.request({url:t.websiteUrl+"/with-state/account-types",method:"GET",header:{Authorization:a}});v.value=o.data.data||[]}catch(o){console.error("获取分类失败:",o)}},_=async()=>{if(!r.value.trim())return void e.index.showToast({title:"请输入分类名称",icon:"none"});const a=e.index.getStorageSync("token");try{await e.index.request({url:t.websiteUrl+"/with-state/add-account-type",method:"POST",header:{Authorization:a},data:{name:r.value.trim()}}),await y(),r.value="",e.index.showToast({title:"添加成功"})}catch(o){e.index.showToast({title:"添加失败",icon:"none"})}},b=e.ref(0);e.ref(["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"]),e.ref({});const k=e.ref("");function z(e){b.value=e.detail.value}const S=async a=>{var o;try{const i=await e.index.request({url:t.websiteUrl+`/goods?id=${a.id}`,method:"GET"});if("success"===i.data.status){const e=i.data.data;u.value=e.name,c.value=e.fin_amount+e.sub_amount,(null==(o=e.goods_images)?void 0:o[0])&&(k.value=e.goods_images[0])}}catch(i){console.error("获取商品详情失败:",i),e.index.showToast({title:"获取商品信息失败",icon:"none"})}};function D(){e.index.showModal({title:"提示",content:"确定删除该账本吗？",success:a=>{if(a.confirm){const a=Number(n.account_book_id);if(isNaN(a)||a<=0)return void e.index.showToast({title:"参数错误",icon:"none"});e.index.request({url:t.websiteUrl+"/with-state/delete-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{id:a},success:a=>{console.log(a.data.status),"success"===a.data.status?(e.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>e.index.navigateBack()),500)):e.index.showToast({title:a.data.msg||"删除失败",icon:"none"})},fail:a=>{console.error("请求失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}})}}})}function P(){o.chooseImage().then((a=>{o.getQiniuToken().then((i=>{console.log(i),o.uploadImageToQiniu(a,i.token,i.path).then((a=>{200!=a.statusCode&&e.index.showToast({title:"上传失败",icon:"none"}),console.log(t.image1Url+i.path),k.value=t.image1Url+i.path,e.index.showToast({title:"上传成功",icon:"success"})}))}))}))}function R(){q()&&(s?function(){let a={name:u.value,price:parseInt(c.value,10),type:f.value[b.value],image_url:k.value,id:parseInt(n.account_book_id,10),is_remind:h.value.isRemind,final_price:parseInt(h.value.finalPrice,10),final_time:h.value.finalTime,size:w.value[0]||"",size_detail:x.value.sizeDetail||"",color:x.value.color,remark:x.value.remark,buy_date:x.value.buyDate,position:x.value.position};e.index.request({url:t.websiteUrl+"/with-state/update-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}():function(){let a={name:u.value,price:parseInt(c.value,10),type:f.value[b.value],image_url:k.value,is_remind:h.value.isRemind,final_price:parseInt(h.value.finalPrice,10),final_time:h.value.finalTime,size:w.value[0]||"",size_detail:x.value.sizeDetail||"",color:x.value.color,remark:x.value.remark,buy_date:x.value.buyDate,position:x.value.position};console.log("提交数据:",a),e.index.request({url:t.websiteUrl+"/with-state/add-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}())}t.asyncGetUserInfo().then((a=>{s?(!function(a){let o=e.index.getStorageSync("token");e.index.request({url:t.websiteUrl+"/with-state/account-book-detail",method:"GET",header:{Authorization:o},data:{id:a},success:e=>{console.log(e.data.data),u.value=e.data.data.name,c.value=parseInt(e.data.data.price),b.value=f.value.indexOf(e.data.data.type),k.value=e.data.data.image_url,h.value={isRemind:e.data.data.is_remind,finalPrice:e.data.data.final_price,finalTime:e.data.data.final_time},x.value={sizeDetail:e.data.data.size_detail||"",color:e.data.data.color||"",remark:e.data.data.remark||"",buyDate:e.data.data.buy_date?new Date(e.data.data.buy_date).toISOString().split("T")[0]:"",position:e.data.data.position||""},e.data.data.size&&(w.value=[e.data.data.size,e.data.data.size_detail||""]),console.log("f:",h)},fail:e=>{console.log(e)}})}(n.account_book_id),e.index.setNavigationBarTitle({title:"编辑账本"})):e.index.setNavigationBarTitle({title:"新增账本"})}));const q=()=>{if(h.value.isRemind){if(!h.value.finalPrice||h.value.finalPrice<=0)return e.index.showToast({title:"请输入正确的尾款金额",icon:"none"}),!1;if(!h.value.finalTime||new Date(h.value.finalTime)<new Date)return e.index.showToast({title:"请选择未来的日期",icon:"none"}),!1}return!0};return e.onShow((()=>{t.asyncGetUserInfo().then((()=>{y(),(async()=>{try{const a=await e.index.request({url:t.websiteUrl+"/sizes",method:"GET"});if("success"===a.data.status){const e=a.data.data,t=[];for(const[a,o]of Object.entries(e))t.push({text:a,value:a,children:o.map((e=>({text:e,value:e})))});g.value=t}}catch(a){console.error("获取尺寸数据失败:",a),e.index.showToast({title:"获取尺寸数据失败",icon:"none"})}})()}))})),(o,i)=>e.e({a:r.value,b:e.o((e=>r.value=e.detail.value)),c:e.o(_),d:e.f(v.value,((a,o,i)=>({a:e.t(a.name),b:e.o((o=>(async a=>{e.index.showModal({title:"确认删除",success:async o=>{if(o.confirm){const o=e.index.getStorageSync("token");try{const i=(await e.index.request({url:t.websiteUrl+"/with-state/delete-account-type",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{id:a}})).data;"success"===i.status?(await y(),e.index.showToast({title:"删除成功"})):e.index.showToast({title:i.msg||"删除失败",icon:"none"})}catch(i){console.error("删除失败:",i),e.index.showToast({title:i.errMsg||"请求失败",icon:"none"})}}}})})(a.id)),a.id),c:"a5a20cad-1-"+i+",a5a20cad-0",d:a.id}))),e:e.p({type:"trash",size:"22",color:"#ff6666"}),f:e.o((e=>d.value=e)),g:e.p({visible:d.value,top:"5%",height:"60%"}),h:e.t(f.value[b.value]||"请选择分类"),i:b.value,j:f.value,k:e.o(z),l:e.o((e=>d.value=!0)),m:e.o(S),n:e.o((a=>e.isRef(u)?u.value=a:u=a)),o:e.p({"font-size":"24rpx",mode:"fill",background:"#fff",width:"640rpx","show-icon":!1,modelValue:e.unref(u)}),p:e.unref(c),q:e.o((a=>e.isRef(c)?c.value=a.detail.value:c=a.detail.value)),r:k.value},k.value?{s:k.value,t:e.o(P)}:{v:e.o(P)},{w:e.o(T),x:e.p({placeholder:"请选择尺寸",localdata:g.value,value:w.value}),y:!p.value},p.value?{A:e.p({type:"down",size:"20",color:"#888"})}:{z:e.p({type:"right",size:"20",color:"#888"})},{B:e.o((e=>{p.value=!p.value})),C:p.value},p.value?{D:x.value.sizeDetail,E:e.o((e=>x.value.sizeDetail=e.detail.value)),F:x.value.color,G:e.o((e=>x.value.color=e.detail.value)),H:x.value.remark,I:e.o((e=>x.value.remark=e.detail.value)),J:e.t(x.value.buyDate||"选择购入日期"),K:x.value.buyDate,L:e.o((e=>x.value.buyDate=e.detail.value)),M:x.value.position,N:e.o((e=>x.value.position=e.detail.value))}:{},{O:!h.value.isRemind},h.value.isRemind?{Q:e.p({type:"down",size:"20",color:"#888"})}:{P:e.p({type:"right",size:"20",color:"#888"})},{R:h.value.finalPrice>0},(h.value.finalPrice,{}),{S:e.o((e=>(h.value.isRemind=!h.value.isRemind,void(h.value.isRemind||(h.value.finalPrice=0,h.value.finalTime=""))))),T:h.value.isRemind},h.value.isRemind?{U:h.value.finalPrice,V:e.o((e=>h.value.finalPrice=e.detail.value)),W:e.t(h.value.finalTime||"选择截止日期"),X:h.value.finalTime,Y:e.o((e=>h.value.finalTime=e.detail.value))}:{},{Z:a._imports_0$4,aa:e.unref(s)},e.unref(s)?{ab:e.o(D)}:{},{ac:e.t(e.unref(s)?"修改":"新增"),ad:e.o(R)})}},n=e._export_sfc(i,[["__scopeId","data-v-a5a20cad"]]);wx.createPage(n);
