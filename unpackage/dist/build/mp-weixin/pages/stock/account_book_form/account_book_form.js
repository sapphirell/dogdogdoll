"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../common/config.js"),o=require("../../../common/image.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("common-modal")+e.resolveComponent("goods-search"))()}Math||((()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/common-modal/common-modal.js")+(()=>"../../../components/goods-search/goods-search.js"))();const i={__name:"account_book_form",props:["account_book_id"],setup(i){const n=i,s=!!n.account_book_id,l=e.index.getSystemInfoSync();e.ref(l.statusBarHeight);let c=e.ref(""),u=e.ref("");e.ref(1);const d=e.ref(!1),r=e.ref(""),m=e.ref([]),v=["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"],f=e.computed((()=>[...v,...m.value.map((e=>e.name))])),h=e.ref({isRemind:!1,finalPrice:0,finalTime:""}),g=async()=>{const a=e.index.getStorageSync("token");try{const o=await e.index.request({url:t.websiteUrl+"/with-state/account-types",method:"GET",header:{Authorization:a}});m.value=o.data.data||[]}catch(o){console.error("获取分类失败:",o)}},p=async()=>{if(!r.value.trim())return void e.index.showToast({title:"请输入分类名称",icon:"none"});const a=e.index.getStorageSync("token");try{await e.index.request({url:t.websiteUrl+"/with-state/add-account-type",method:"POST",header:{Authorization:a},data:{name:r.value.trim()}}),await g(),r.value="",e.index.showToast({title:"添加成功"})}catch(o){e.index.showToast({title:"添加失败",icon:"none"})}},w=e.ref(0);e.ref(["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"]),e.ref({});const x=e.ref("");function T(e){w.value=e.detail.value}const _=async a=>{var o;try{const i=await e.index.request({url:t.websiteUrl+`/goods?id=${a.id}`,method:"GET"});if("success"===i.data.status){const e=i.data.data;c.value=e.name,u.value=e.fin_amount+e.sub_amount,(null==(o=e.goods_images)?void 0:o[0])&&(x.value=e.goods_images[0])}}catch(i){console.error("获取商品详情失败:",i),e.index.showToast({title:"获取商品信息失败",icon:"none"})}};function y(){e.index.showModal({title:"提示",content:"确定删除该账本吗？",success:a=>{if(a.confirm){const a=Number(n.account_book_id);if(isNaN(a)||a<=0)return void e.index.showToast({title:"参数错误",icon:"none"});e.index.request({url:t.websiteUrl+"/with-state/delete-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{id:a},success:a=>{console.log(a.data.status),"success"===a.data.status?(e.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>e.index.navigateBack()),500)):e.index.showToast({title:a.data.msg||"删除失败",icon:"none"})},fail:a=>{console.error("请求失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}})}}})}function b(){o.chooseImage().then((a=>{o.getQiniuToken().then((i=>{console.log(i),o.uploadImageToQiniu(a,i.token,i.path).then((a=>{200!=a.statusCode&&e.index.showToast({title:"上传失败",icon:"none"}),console.log(t.image1Url+i.path),x.value=t.image1Url+i.path,e.index.showToast({title:"上传成功",icon:"success"})}))}))}))}function k(){S()&&(s?function(){let a={name:c.value,price:parseInt(u.value,10),type:f.value[w.value],image_url:x.value,id:parseInt(n.account_book_id,10),is_remind:h.value.isRemind,final_price:parseInt(h.value.finalPrice,10),final_time:h.value.finalTime};e.index.request({url:t.websiteUrl+"/with-state/update-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}():function(){let a={name:c.value,price:parseInt(u.value,10),type:f.value[w.value],image_url:x.value,is_remind:h.value.isRemind,final_price:parseInt(h.value.finalPrice,10),final_time:h.value.finalTime};console.log("提交数据:",a),e.index.request({url:t.websiteUrl+"/with-state/add-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}())}t.asyncGetUserInfo().then((a=>{s?(!function(a){let o=e.index.getStorageSync("token");e.index.request({url:t.websiteUrl+"/with-state/account-book-detail",method:"GET",header:{Authorization:o},data:{id:a},success:e=>{console.log(e.data.data),c.value=e.data.data.name,u.value=parseInt(e.data.data.price),w.value=f.value.indexOf(e.data.data.type),x.value=e.data.data.image_url,h.value={isRemind:e.data.data.is_remind,finalPrice:e.data.data.final_price,finalTime:e.data.data.final_time},console.log("f:",h)},fail:e=>{console.log(e)}})}(n.account_book_id),e.index.setNavigationBarTitle({title:"编辑账本"})):e.index.setNavigationBarTitle({title:"新增账本"})}));const S=()=>{if(h.value.isRemind){if(!h.value.finalPrice||h.value.finalPrice<=0)return e.index.showToast({title:"请输入正确的尾款金额",icon:"none"}),!1;if(!h.value.finalTime||new Date(h.value.finalTime)<new Date)return e.index.showToast({title:"请选择未来的日期",icon:"none"}),!1}return!0};return e.onShow((()=>{t.asyncGetUserInfo().then((()=>{g()}))})),(o,i)=>e.e({a:r.value,b:e.o((e=>r.value=e.detail.value)),c:e.o(p),d:e.f(m.value,((a,o,i)=>({a:e.t(a.name),b:e.o((o=>(async a=>{e.index.showModal({title:"确认删除",success:async o=>{if(o.confirm){const o=e.index.getStorageSync("token");try{const i=(await e.index.request({url:t.websiteUrl+"/with-state/delete-account-type",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{id:a}})).data;"success"===i.status?(await g(),e.index.showToast({title:"删除成功"})):e.index.showToast({title:i.msg||"删除失败",icon:"none"})}catch(i){console.error("删除失败:",i),e.index.showToast({title:i.errMsg||"请求失败",icon:"none"})}}}})})(a.id)),a.id),c:"56cf10a2-1-"+i+",56cf10a2-0",d:a.id}))),e:e.p({type:"trash",size:"22",color:"#ff6666"}),f:e.o((e=>d.value=e)),g:e.p({visible:d.value,top:"5%",height:"60%"}),h:e.t(f.value[w.value]||"请选择分类"),i:w.value,j:f.value,k:e.o(T),l:e.o((e=>d.value=!0)),m:e.o(_),n:e.o((a=>e.isRef(c)?c.value=a:c=a)),o:e.p({"font-size":"24rpx",mode:"fill",background:"#fff",width:"640rpx","show-icon":!1,modelValue:e.unref(c)}),p:e.unref(u),q:e.o((a=>e.isRef(u)?u.value=a.detail.value:u=a.detail.value)),r:x.value},x.value?{s:x.value,t:e.o(b)}:{v:e.o(b)},{w:!h.value.isRemind},h.value.isRemind?{y:e.p({type:"down",size:"20",color:"#888"})}:{x:e.p({type:"right",size:"20",color:"#888"})},{z:h.value.finalPrice>0},(h.value.finalPrice,{}),{A:e.o((e=>(h.value.isRemind=!h.value.isRemind,void(h.value.isRemind||(h.value.finalPrice=0,h.value.finalTime=""))))),B:h.value.isRemind},h.value.isRemind?{C:h.value.finalPrice,D:e.o((e=>h.value.finalPrice=e.detail.value)),E:e.t(h.value.finalTime||"选择截止日期"),F:h.value.finalTime,G:e.o((e=>h.value.finalTime=e.detail.value))}:{},{H:a._imports_0$4,I:e.unref(s)},e.unref(s)?{J:e.o(y)}:{},{K:e.t(e.unref(s)?"修改":"新增"),L:e.o(k)})}},n=e._export_sfc(i,[["__scopeId","data-v-56cf10a2"]]);wx.createPage(n);
