"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../common/config.js"),o=require("../../../common/image.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("uni-icons")+e.resolveComponent("common-modal")+e.resolveComponent("goods-search")+e.resolveComponent("uni-data-picker"))()}Math||((()=>"../../../components/view-logs/view-logs.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/common-modal/common-modal.js")+(()=>"../../../components/goods-search/goods-search.js")+(()=>"../../../uni_modules/uni-data-picker/components/uni-data-picker/uni-data-picker.js"))();const i={__name:"account_book_form",props:["account_book_id"],setup(i){const l=i,n=!!l.account_book_id,s=e.ref(1),u=e.ref([]),d=e.index.getSystemInfoSync();e.ref(d.statusBarHeight);let r=e.ref(""),c=e.ref("");e.ref(1);const v=e.ref(!1),m=e.ref(""),h=e.ref([]),p=[],f=e.computed((()=>[...p,...h.value.map((e=>e.name))])),g=e.ref({isRemind:!1,finalPrice:0,finalTime:""}),_=e.ref(!1),w=e.ref([]);e.ref([]);const x=e.ref([]),y=e.ref({sizeDetail:"",color:"",remark:"",buyDate:"",position:"",shopName:"",headCircumference:"",shoulderWidth:"",makeupArtist:"",arrivalDate:"",additionalValue:""}),T=e=>{const a=e.detail.value;2===a.length?(x.value=[a[0].value,a[1].value],y.value.sizeDetail=a[1].value):(x.value=[],y.value.sizeDetail="")},k=async()=>{const a=e.index.getStorageSync("token");try{const o=await e.index.request({url:t.websiteUrl.value+"/with-state/account-types",method:"GET",header:{Authorization:a}});h.value=o.data.data||[]}catch(o){console.error("获取分类失败:",o)}},b=async()=>{if(!m.value.trim())return void e.index.showToast({title:"请输入分类名称",icon:"none"});const a=e.index.getStorageSync("token");try{await e.index.request({url:t.websiteUrl.value+"/with-state/add-account-type",method:"POST",header:{Authorization:a},data:{name:m.value.trim()}}),await k(),m.value="",e.index.showToast({title:"添加成功"})}catch(o){e.index.showToast({title:"添加失败",icon:"none"})}},z=e.ref(0);function S(e){z.value=e.detail.value}function D(a){let o=e.index.getStorageSync("token");e.index.request({url:t.websiteUrl.value+"/with-state/account-book-detail",method:"GET",header:{Authorization:o},data:{id:a},success:e=>{console.log(e.data.data),r.value=e.data.data.name,c.value=parseInt(e.data.data.price),s.value=e.data.data.count||1,z.value=f.value.indexOf(e.data.data.type),e.data.data.image_url&&(u.value=e.data.data.image_url.split(",")),g.value={isRemind:e.data.data.is_remind,finalPrice:e.data.data.final_price,finalTime:e.data.data.final_time};const a=e.data.data.type,t=f.value.findIndex((e=>e===a));-1!==t?z.value=t:(console.warn(`未找到分类: ${a}`),z.value=0),y.value={sizeDetail:e.data.data.size_detail||"",color:e.data.data.color||"",remark:e.data.data.remark||"",buyDate:e.data.data.buy_date?new Date(e.data.data.buy_date).toISOString().split("T")[0]:"",position:e.data.data.position||"",shopName:e.data.data.shop_name||"",headCircumference:e.data.data.head_circumference||"",shoulderWidth:e.data.data.shoulder_width||"",makeupArtist:e.data.data.makeup_artist||"",arrivalDate:e.data.data.arrival_date?new Date(e.data.data.arrival_date).toISOString().split("T")[0]:"",additionalValue:e.data.data.additional_value||""},e.data.data.size&&(x.value=[e.data.data.size,e.data.data.size_detail||""]),console.log("f:",g)},fail:e=>{console.log(e)}})}e.ref(["请选择","娃衣","娃头","眼珠","假发","娃鞋","其它"]),e.ref({});const P=async a=>{var o;try{const i=await e.index.request({url:t.websiteUrl.value+`/goods?id=${a.id}`,method:"GET"});if("success"===i.data.status){const e=i.data.data;r.value=e.name,c.value=e.fin_amount+e.sub_amount,s.value=1,(null==(o=e.goods_images)?void 0:o[0])&&(u.value=[e.goods_images[0]])}}catch(i){console.error("获取商品详情失败:",i),e.index.showToast({title:"获取商品信息失败",icon:"none"})}};function I(){e.index.showModal({title:"提示",content:"确定删除该账本吗？",success:a=>{if(a.confirm){const a=Number(l.account_book_id);if(isNaN(a)||a<=0)return void e.index.showToast({title:"参数错误",icon:"none"});e.index.request({url:t.websiteUrl.value+"/with-state/delete-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{id:a},success:a=>{console.log(a.data.status),"success"===a.data.status?(e.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>e.index.navigateBack()),500)):e.index.showToast({title:a.data.msg||"删除失败",icon:"none"})},fail:a=>{console.error("请求失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}})}}})}async function j(){e.index.chooseImage({count:9,success:async a=>{const i=a.tempFilePaths;for(const e of i)try{const a=await o.getQiniuToken(),i=await o.uploadImageToQiniu(e,a.token,a.path);if(console.log("res:",i),200===i.qiniuRes.statusCode){const e=t.image1Url+a.path;u.value.push(e)}else console.error("上传失败:",e)}catch(l){console.error("上传错误:",l)}e.index.showToast({title:`上传了${i.length}张图片`,icon:"success"})}})}function q(){A()&&(n?function(){let a={name:r.value,price:parseInt(c.value,10),count:parseInt(s.value,10),type:f.value[z.value],image_url:u.value.join(","),id:parseInt(l.account_book_id,10),is_remind:g.value.isRemind,final_price:parseInt(g.value.finalPrice,10),final_time:g.value.finalTime,size:x.value[0]||"",size_detail:y.value.sizeDetail||"",color:y.value.color,remark:y.value.remark,buy_date:y.value.buyDate,position:y.value.position,shop_name:y.value.shopName,head_circumference:y.value.headCircumference,shoulder_width:y.value.shoulderWidth,makeup_artist:y.value.makeupArtist,arrival_date:y.value.arrivalDate,additional_value:y.value.additionalValue};e.index.request({url:t.websiteUrl.value+"/with-state/update-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}():function(){let a={name:r.value,price:parseInt(c.value,10),count:parseInt(s.value,10),type:f.value[z.value],image_url:u.value.join(","),is_remind:g.value.isRemind,final_price:parseInt(g.value.finalPrice,10),final_time:g.value.finalTime,size:x.value[0]||"",size_detail:y.value.sizeDetail||"",color:y.value.color,remark:y.value.remark,buy_date:y.value.buyDate,position:y.value.position,shop_name:y.value.shopName,head_circumference:y.value.headCircumference,shoulder_width:y.value.shoulderWidth,makeup_artist:y.value.makeupArtist,arrival_date:y.value.arrivalDate,additional_value:y.value.additionalValue};console.log("提交数据:",a),e.index.request({url:t.websiteUrl.value+"/with-state/add-account-book",method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:a,success:a=>{console.log(a.data),"success"==a.data.status?(e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),500)):e.index.showToast({title:a.data.msg,icon:"none"})}})}())}t.asyncGetUserInfo().then((a=>{n?(D(l.account_book_id),e.index.setNavigationBarTitle({title:"编辑账本"})):e.index.setNavigationBarTitle({title:"新增账本"})}));const A=()=>s.value<=0?(e.index.showToast({title:"个数必须大于0",icon:"none"}),!1):!(g.value.isRemind&&(!g.value.finalPrice||g.value.finalPrice<=0))||(e.index.showToast({title:"请输入正确的尾款金额",icon:"none"}),!1);e.onShow((async()=>{await t.asyncGetUserInfo(),await k(),await(async()=>{try{const a=await e.index.request({url:t.websiteUrl.value+"/sizes",method:"GET"});if("success"===a.data.status){const e=a.data.data,t=[];for(const[a,o]of Object.entries(e))t.push({text:a,value:a,children:o.map((e=>({text:e,value:e})))});w.value=t}}catch(a){console.error("获取尺寸数据失败:",a),e.index.showToast({title:"获取尺寸数据失败",icon:"none"})}})(),n?(await D(l.account_book_id),e.index.setNavigationBarTitle({title:"编辑账本"})):e.index.setNavigationBarTitle({title:"新增账本"})}));return e.onLoad((async a=>{if(console.log("接收到的参数:",a),a.goods_id)try{(e=>{r.value=e.name;const a=e.total_amount?e.total_amount:(parseFloat(e.sub_amount)||0)+(parseFloat(e.fin_amount)||0);c.value=a,e.goods_images&&e.goods_images.length>0&&(u.value=[e.goods_images[0]]),e.size&&(x.value=[e.size,e.size_detail||""],y.value.sizeDetail=e.size_detail||""),e.currency&&(r.value+=` (${e.currency})`),e.color&&(y.value.color=e.color)})(await(o=a.goods_id,new Promise(((a,i)=>{e.index.request({url:t.websiteUrl.value+"/goods?id="+o,method:"GET",timeout:5e3,success:e=>{"success"===e.data.status?a(e.data.data):i(new Error(e.data.msg||"获取商品信息失败"))},fail:e=>{console.error("商品详情获取失败",e),i(e)}})}))))}catch(i){console.error("获取商品信息失败:",i),e.index.showToast({title:"获取商品信息失败",icon:"none"})}var o})),(o,i)=>e.e({a:m.value,b:e.o((e=>m.value=e.detail.value)),c:e.o(b),d:e.f(h.value,((a,o,i)=>({a:e.t(a.name),b:e.o((o=>(async a=>{e.index.showModal({title:"确认删除",success:async o=>{if(o.confirm){const o=e.index.getStorageSync("token");try{const i=(await e.index.request({url:t.websiteUrl.value+"/with-state/delete-account-type",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{id:a}})).data;"success"===i.status?(await k(),e.index.showToast({title:"删除成功"})):e.index.showToast({title:i.msg||"删除失败",icon:"none"})}catch(i){console.error("删除失败:",i),e.index.showToast({title:i.errMsg||"请求失败",icon:"none"})}}}})})(a.id)),a.id),c:"c274674a-2-"+i+",c274674a-1",d:a.id}))),e:e.p({type:"trash",size:"22",color:"#ff6666"}),f:e.o((e=>v.value=e)),g:e.p({visible:v.value,top:"100rpx"}),h:e.t(f.value[z.value]||"请选择分类"),i:z.value,j:f.value,k:e.o(S),l:e.o((e=>v.value=!0)),m:e.o(P),n:e.o((a=>e.isRef(r)?r.value=a:r=a)),o:e.p({"font-size":"24rpx",mode:"fill",background:"#fff",width:"620rpx","show-icon":!1,modelValue:e.unref(r)}),p:e.unref(c),q:e.o((a=>e.isRef(c)?c.value=a.detail.value:c=a.detail.value)),r:s.value,s:e.o((e=>s.value=e.detail.value)),t:e.f(u.value,((a,t,o)=>({a:a,b:e.o((a=>{e.index.previewImage({current:u.value.index,urls:u.value})}),t),c:e.o((a=>function(a,t){t&&t.stopPropagation&&t.stopPropagation(),e.index.showModal({title:"删除图片",content:"确定删除这张图片吗？",success:e=>{e.confirm&&u.value.splice(a,1)}})}(t,a)),t),d:"c274674a-4-"+o,e:t}))),v:e.p({type:"close",size:"22",color:"#fff"}),w:e.p({type:"plusempty",size:"40",color:"#ccc"}),x:e.o(j),y:e.o(T),z:e.p({placeholder:"请选择尺寸",localdata:w.value,value:x.value}),A:_.value?1:"",B:e.o((e=>{_.value=!_.value})),C:_.value},_.value?{D:y.value.sizeDetail,E:e.o((e=>y.value.sizeDetail=e.detail.value)),F:y.value.color,G:e.o((e=>y.value.color=e.detail.value)),H:y.value.shopName,I:e.o((e=>y.value.shopName=e.detail.value)),J:y.value.headCircumference,K:e.o((e=>y.value.headCircumference=e.detail.value)),L:y.value.shoulderWidth,M:e.o((e=>y.value.shoulderWidth=e.detail.value)),N:y.value.makeupArtist,O:e.o((e=>y.value.makeupArtist=e.detail.value)),P:y.value.remark,Q:e.o((e=>y.value.remark=e.detail.value)),R:e.t(y.value.buyDate||"选择购入日期"),S:y.value.buyDate,T:e.o((e=>y.value.buyDate=e.detail.value)),U:e.t(y.value.arrivalDate||"选择到家日期"),V:y.value.arrivalDate,W:e.o((e=>y.value.arrivalDate=e.detail.value)),X:y.value.additionalValue,Y:e.o((e=>y.value.additionalValue=e.detail.value)),Z:y.value.position,aa:e.o((e=>y.value.position=e.detail.value))}:{},{ab:g.value.isRemind?1:"",ac:g.value.finalPrice>0},(g.value.finalPrice,{}),{ad:e.o((e=>(g.value.isRemind=!g.value.isRemind,void(g.value.isRemind||(g.value.finalPrice=0,g.value.finalTime=""))))),ae:g.value.isRemind},g.value.isRemind?{af:g.value.finalPrice,ag:e.o((e=>g.value.finalPrice=e.detail.value)),ah:e.t(g.value.finalTime||"选择截止日期"),ai:g.value.finalTime,aj:e.o((e=>g.value.finalTime=e.detail.value))}:{},{ak:a._imports_0$8,al:e.unref(n)},e.unref(n)?{am:e.o(I)}:{},{an:e.t(e.unref(n)?"修改":"新增"),ao:e.o(q)})}},l=e._export_sfc(i,[["__scopeId","data-v-c274674a"]]);wx.createPage(l);
