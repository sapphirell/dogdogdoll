"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),a=require("../../../common/image.js"),o=require("../../../common/config.js");if(!Array){(e.resolveComponent("uni-load-more")+e.resolveComponent("uni-icons")+e.resolveComponent("goods-search")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/goods-search/goods-search.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const n={__name:"news",setup(n){const l=e.ref([]),s=e.ref(1),i=e.ref(10),u=e.ref(0),r=e.ref(!1),c=e.ref(!1),v=e.ref("more"),d=e.ref(0),g=e.ref(null),m=e.ref(!1),p=e.ref(null),_=e.ref(!1),h=e.ref(0),f=e.ref(0),b=e.ref(""),w=e.ref({title:"",content:"",image_list:[],news_type:1,subscribe_goods_id:0,subscribe_goods_name:""}),y=e.ref([{value:1,label:"图透"},{value:2,label:"尾款"},{value:3,label:"截定"},{value:4,label:"公告"}]),x=e.ref(1),T=e=>{w.value.subscribe_goods_id=e.id,w.value.subscribe_goods_name=e.name},$=e=>{w.value.news_type=parseInt(e.detail.value)+1};e.onMounted((()=>{M(),e.index.setNavigationBarTitle({title:"品牌文章管理"})})),e.onShow((()=>{z(!0)}));const M=()=>{const t=e.index.getSystemInfoSync();d.value=t.windowHeight-50},S=()=>e.index.getStorageSync("token")||"",j=async()=>{try{const o=9-w.value.image_list.length;if(o<=0)return;const n=await a.chooseImageList(o);if(!n||0===n.length)return;const l=await a.getQiniuToken(),s=l.token,i=l.path;_.value=!0,f.value=n.length,h.value=0;const u=[];for(let r=0;r<n.length;r++)try{const e=n[r];b.value=`上传中 (${r+1}/${n.length})`,h.value=r+1;const t=await a.uploadImageToQiniu(e,s,i);t&&t.imageUrl&&u.push(t.imageUrl)}catch(t){console.error(`第 ${r+1} 张图片上传失败:`,t),e.index.showToast({title:`第 ${r+1} 张图片上传失败`,icon:"none"})}w.value.image_list=[...w.value.image_list,...u],u.length>0&&e.index.showToast({title:`成功上传 ${u.length} 张图片`,icon:"success"})}catch(o){console.error("图片选择或上传失败:",o),e.index.showToast({title:"图片上传失败: "+(o.message||"未知错误"),icon:"none"})}finally{_.value=!1,h.value=0,f.value=0}},z=async(t=!1)=>{if(!r.value){t&&(s.value=1,l.value=[],v.value="more"),r.value=!0,v.value="loading";try{const a=await e.index.request({url:o.websiteUrl.value+"/brand-manager/news/list",method:"GET",data:{page_index:s.value,page_size:i.value},header:{Authorization:S()}});if("success"===a.data.status){const e=a.data.data,o=e.news_list||[];u.value=e.total;const n=o.map((e=>{const t=e.image_urls?e.image_urls.split(",").filter((e=>""!==e.trim())):e.image_list||[];return{...e,image_list:t}}));l.value=t?n:[...l.value,...n],l.value.length>=u.value?v.value="noMore":(v.value="more",s.value++)}else e.index.showToast({title:a.data.message||"获取列表失败",icon:"none"})}catch(a){e.index.showToast({title:"网络错误",icon:"none"})}finally{r.value=!1}}},q=()=>{"noMore"!==v.value&&z()},H=()=>{I(),m.value=!1,g.value.open()},I=()=>{w.value={title:"",content:"",image_list:[]},p.value=null,c.value=!1},C=async()=>{if(!w.value.title)return void e.index.showToast({title:"请填写文章标题",icon:"none"});if(!w.value.content)return void e.index.showToast({title:"请填写文章内容",icon:"none"});const t={title:w.value.title,content:w.value.content,image_urls:w.value.image_list,news_type:w.value.news_type,subscribe_goods_id:w.value.subscribe_goods_id,subscribe_goods_name:w.value.subscribe_goods_name};m.value&&(t.id=p.value),c.value=!0;try{const a=o.websiteUrl.value+(m.value?"/brand-manager/news/update":"/brand-manager/news/create"),n="POST",l=await e.index.request({url:a,method:n,data:t,header:{Authorization:S(),"Content-Type":"application/json"}});"success"===l.data.status?(e.index.showToast({title:m.value?"更新成功":"添加成功",icon:"success"}),g.value.close(),z(!0)):e.index.showToast({title:l.data.message||(m.value?"更新失败":"添加失败"),icon:"none"})}catch(a){console.error("提交失败:",a),e.index.showToast({title:"请求失败，请稍后重试",icon:"none"})}finally{c.value=!1}},k=()=>{g.value.close()},A=async t=>{try{const a=await e.index.request({url:o.websiteUrl.value+"/brand-manager/news/delete?id="+t,method:"GET",header:{Authorization:S()}});"success"===a.data.status?(e.index.showToast({title:"删除成功",icon:"success"}),z(!0)):e.index.showToast({title:a.data.message||"删除失败",icon:"none"})}catch(a){console.error("删除失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}},U=(e,t="yyyy-MM-dd HH:mm")=>{if(!e)return"";const a=new Date(e),o=a.getFullYear(),n=(a.getMonth()+1).toString().padStart(2,"0"),l=a.getDate().toString().padStart(2,"0"),s=a.getHours().toString().padStart(2,"0"),i=a.getMinutes().toString().padStart(2,"0");return"yyyy-MM-dd"===t?`${o}-${n}-${l}`:"HH:mm"===t?`${s}:${i}`:`${o}-${n}-${l} ${s}:${i}`};return(a,o)=>{var n;return e.e({a:r.value},r.value?{b:e.p({status:"loading"})}:l.value.length>0?{d:e.f(l.value,((t,a,o)=>e.e({a:e.t(t.title),b:e.t(U(1e3*t.created_at)),c:e.o((e=>{return a=t,I(),m.value=!0,p.value=a.id,w.value={title:a.title,content:a.content,image_list:[...a.image_list||[]],news_type:a.news_type||1,subscribe_goods_id:a.subscribe_goods_id||0,subscribe_goods_name:a.subscribe_goods_name||""},void g.value.open();var a}),t.id),d:e.o((a=>{return o=t.id,void e.index.showModal({title:"提示",content:"确定要删除该文章吗？",success:e=>{e.confirm&&A(o)}});var o}),t.id),e:t.image_list&&t.image_list.length},t.image_list&&t.image_list.length?{f:e.f(t.image_list,((a,o,n)=>({a:o,b:a,c:e.o((a=>{return n=t.image_list,l=o,void e.index.previewImage({current:l,urls:n,indicator:"number"});var n,l}),o)})))}:{},{g:e.t(t.content.length>50?t.content.substring(0,50)+"...":t.content),h:t.id})))}:{},{c:l.value.length>0,e:!r.value},r.value?{}:e.e({f:"loading"===v.value},(v.value,{}),{g:"noMore"===v.value&&0!==l.value.length},("noMore"===v.value&&l.value.length,{})),{h:0===l.value.length&&!r.value},0!==l.value.length||r.value?{}:{i:t._imports_0$12},{j:e.o(q),k:d.value+"px",l:e.p({type:"plusempty",size:"30",color:"#fff"}),m:e.o(H),n:e.t(m.value?"编辑文章":"新增文章"),o:e.o(k),p:e.p({type:"closeempty",size:"24",color:"#999"}),q:e.t((null==(n=y.value.find((e=>e.value===w.value.news_type)))?void 0:n.label)||"请选择文章类型"),r:e.o($),s:w.value.news_type,t:y.value,v:w.value.title,w:e.o((e=>w.value.title=e.detail.value)),x:w.value.content,y:e.o((e=>w.value.content=e.detail.value)),z:e.o(T),A:e.p({mode:"fill",modelValue:w.value.subscribe_goods_name,brandId:x.value}),B:_.value},_.value?{C:e.p({status:"loading"}),D:e.t(h.value),E:e.t(f.value)}:{},{F:e.f(w.value.image_list,((t,a,o)=>({a:t,b:e.o((e=>(e=>{w.value.image_list.splice(e,1)})(a)),a),c:"7f1bac04-6-"+o+",7f1bac04-2",d:a}))),G:e.p({type:"close",size:"18",color:"#fff"}),H:w.value.image_list.length<9&&!_.value},w.value.image_list.length<9&&!_.value?{I:e.p({type:"plusempty",size:"28",color:"#999"}),J:e.o(j)}:{},{K:e.t(c.value?"提交中...":"提交"),L:e.o(C),M:c.value,N:e.sr(g,"7f1bac04-2",{k:"popup"}),O:e.p({type:"bottom"})})}}};wx.createPage(n);
