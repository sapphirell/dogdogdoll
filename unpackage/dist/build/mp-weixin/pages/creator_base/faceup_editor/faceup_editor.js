"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/image.js"),t=require("../../../common/config.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("cascade-multi-select")+e.resolveComponent("relation-picker"))()}Math||((()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/cascade-multi-select/cascade-multi-select.js")+(()=>"../../../components/relation-picker/relation-picker.js"))();const s={__name:"faceup_editor",setup(s){const o=e.ref(!1),l=e.ref({id:0,title:"",head_name:"",goods_id:"",sex:"男",styles_tags:[],face_up_image_urls:[]}),i=e.ref(!1),n=e.ref({}),u=e.ref(!1),c=e.ref({}),r=e.ref([]),d=e.ref(!1),v=e.ref(0),g=e.ref("");e.onLoad((async a=>{await _(),a.id&&(o.value=!0,h(a.id)),e.index.setNavigationBarTitle({title:o?"编辑妆面":"添加新妆面"})}));const _=async()=>{try{const a=await e.index.request({url:`${t.websiteUrl.value}/bjd-faceup-style-tags`,method:"GET"});"success"===a.data.status&&(n.value=a.data.data,c.value={"风格标签":Object.values(n.value)})}catch(a){console.error("获取风格标签失败:",a),e.index.showToast({title:"获取风格标签失败",icon:"none"})}},h=async a=>{try{e.index.showLoading({title:"加载中..."});const s=await e.index.request({url:`${t.websiteUrl.value}/faceup/detail?id=${a}`,method:"GET"});if("success"===s.data.status){const e=s.data.data;l.value={id:e.id,title:e.title,head_name:e.head_name,goods_id:e.goods_id,sex:1===e.sex?"男":"女",styles_tags:e.styles_tags?e.styles_tags.split(",").filter(Boolean):[],face_up_image_urls:e.images||(e.face_up_image_urls?e.face_up_image_urls.split(","):[])},r.value=l.value.styles_tags.map((e=>({category:"风格标签",size:n.value[e]})))}else e.index.showToast({title:s.data.msg,icon:"none"})}catch(s){console.log(s),e.index.showToast({title:"获取妆面详情失败",icon:"none"})}finally{e.index.hideLoading()}},m=e=>{e.isFuzzy,l.value.head_name=e.goods.name,l.value.goods_id=e.goods.id||"",i.value=!1},f=e=>{l.value.sex=e.detail.value},p=e=>{const a=e.map((e=>{const a=e.size;for(const[t,s]of Object.entries(n.value))if(s===a)return t;return null})).filter((e=>null!==e));l.value.styles_tags=a,u.value=!1},y=async()=>{try{const s=9-l.value.face_up_image_urls.length;if(s<=0)return void e.index.showToast({title:"最多只能上传9张图片",icon:"none"});const o=await a.chooseImageList(s);if(!o||0===o.length)return;d.value=!0,g.value="准备上传...",g.value="获取上传凭证...";const i=await a.getQiniuToken();if(!i||!i.token)throw new Error("获取上传凭证失败");for(let n=0;n<o.length;n++)try{const e=o[n];g.value=`上传中 (${n+1}/${o.length})`,v.value=n/o.length*100;const t=i.path,s=await a.uploadImageToQiniu(e,i.token,t);s&&s.imageUrl&&(l.value.face_up_image_urls.push(s.imageUrl),v.value=(n+1)/o.length*100)}catch(t){console.error(`第 ${n+1} 张图片上传失败:`,t),e.index.showToast({title:`第 ${n+1} 张图片上传失败`,icon:"none"})}e.index.showToast({title:`成功上传${o.length}张图片`,icon:"success"})}catch(t){console.error("上传图片失败:",t),e.index.showToast({title:"上传图片失败",icon:"none"})}finally{d.value=!1,v.value=0}},x=async()=>{if(l.value.title)if(l.value.head_name)if(l.value.goods_id)if(0!==l.value.face_up_image_urls.length)try{e.index.showLoading({title:"提交中..."});const a={id:l.value.id,title:l.value.title,head_name:l.value.head_name,goods_id:l.value.goods_id,sex:"男"===l.value.sex?1:2,styles_tags:l.value.styles_tags.join(","),face_up_image_urls:l.value.face_up_image_urls.join(",")},s=o.value?`${t.websiteUrl.value}/brand-manager/faceup/update`:`${t.websiteUrl.value}/brand-manager/faceup/add`,i=e.index.getStorageSync("token");if(!i)return error.value="未登录，请先登录",loading.value=!1,void(loadStatus.value="more");const n=await e.index.request({url:s,method:"POST",data:a,header:{"Content-Type":"application/json",Authorization:i}});"success"===n.data.status?(e.index.showToast({title:o.value?"更新成功":"添加成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)):e.index.showToast({title:n.data.msg||"提交失败",icon:"none"})}catch(a){console.error("提交失败:",a),e.index.showToast({title:"提交失败",icon:"none"})}finally{e.index.hideLoading()}else e.index.showToast({title:"请至少上传一张图片",icon:"none"});else e.index.showToast({title:"请选择关联商品",icon:"none"});else e.index.showToast({title:"请选择头型名称",icon:"none"});else e.index.showToast({title:"请输入妆面标题",icon:"none"})},w=()=>{e.index.navigateBack()};return(a,t)=>e.e({a:l.value.title,b:e.o((e=>l.value.title=e.detail.value)),c:l.value.head_name},l.value.head_name?{d:e.t(l.value.head_name)}:{},{e:e.p({type:"arrowright",size:"16",color:"#999"}),f:e.o((e=>i.value=!0)),g:l.value.goods_id,h:e.o((e=>l.value.goods_id=e.detail.value)),i:"男"===l.value.sex,j:"女"===l.value.sex,k:e.o(f),l:e.p({type:"arrowdown",size:"16",color:"#666"}),m:e.o((e=>u.value=!0)),n:e.f(l.value.styles_tags,((a,t,s)=>({a:e.t(n.value[a]),b:e.o((e=>(e=>{const a=l.value.styles_tags.indexOf(e);a>-1&&l.value.styles_tags.splice(a,1)})(a)),t),c:"1a0bcbe4-2-"+s,d:t}))),o:e.p({type:"close",size:"16",color:"#999"}),p:0===l.value.styles_tags.length},(l.value.styles_tags.length,{}),{q:e.f(l.value.face_up_image_urls,((a,t,s)=>({a:a,b:e.o((t=>{return s=a,void e.index.previewImage({current:s,urls:l.value.face_up_image_urls});var s}),t),c:"1a0bcbe4-3-"+s,d:e.o((a=>(a=>{e.index.showModal({title:"提示",content:"确定要删除这张图片吗？",success:t=>{t.confirm&&(l.value.face_up_image_urls.splice(a,1),e.index.showToast({title:"已删除",icon:"success"}))}})})(t)),t),e:"1a0bcbe4-4-"+s,f:t}))),r:e.p({type:"eye",size:"20",color:"#fff"}),s:e.p({type:"trash",size:"20",color:"#fff"}),t:l.value.face_up_image_urls.length<9},l.value.face_up_image_urls.length<9?{v:e.p({type:"plus",size:"32",color:"#999"}),w:e.o(y)}:{},{x:d.value},d.value?{y:v.value,z:e.t(g.value)}:{},{A:e.o(w),B:e.t(o.value?"保存修改":"添加妆面"),C:e.o(x),D:e.o((e=>u.value=!1)),E:e.o(p),F:e.p({show:u.value,sizeData:c.value,initialSelection:r.value,title:"选择风格标签"}),G:e.o((e=>i.value=e)),H:e.o(m),I:e.o((e=>i.value=!1)),J:e.p({visible:i.value,"hide-type":"true"})})}};wx.createPage(s);
