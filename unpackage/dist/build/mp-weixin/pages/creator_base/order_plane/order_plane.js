"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../common/image.js"),o=require("../../../common/config.js");if(!Array){(e.resolveComponent("uni-load-more")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-number-box")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../uni_modules/uni-number-box/components/uni-number-box/uni-number-box.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const l={__name:"order_plane",setup(l){const i=[{label:"全部",value:"all"},{label:"进行中",value:"active"},{label:"未开始",value:"upcoming"},{label:"已结束",value:"inactive"}],n=e.ref("all"),r=e.ref([]),s=e.ref(1),u=e.ref(10),c=e.ref(0),d=e.ref(!1),v=e.ref(!1),p=e.ref("more"),m=e.ref(0),_=e.ref(null),g=e.ref(!1),f=e.ref(null),h=e.ref(!1),b=e.ref(0),y=e.ref(0),x=e.ref(""),w=e.ref(null),T=e.ref(!1),M=e.ref(!1);e.ref([]),e.ref([]);const $=e.ref([{label:"添加空白档位",value:"blank"}]),S=e.ref([{label:"添加空白加购",value:"blank"}]),k=e.ref({artist_name:"",artist_type:1,order_type:1,max_participants:10,max_submissions_per_user:1,open_date:"",open_time:"",close_date:"",close_time:"",images:[],order_config:{tiers:[],addons:[]}}),j=[{value:1,text:"妆师"}],z=[{value:1,text:"长期接单"},{value:2,text:"限时手速"},{value:3,text:"限时抽选"},{value:4,text:"限时黑箱卡"},{value:9,text:"关闭投递"}];e.onMounted((()=>{U(),q(),e.index.setNavigationBarTitle({title:"接单计划管理"})})),e.onShow((()=>{D(!0)})),e.watch(T,(e=>{e?(_.value.close(),w.value.open()):w.value.close()})),e.watch(M,(e=>{e?(_.value.close(),addonPicker.value.open()):addonPicker.value.close()}));const q=async()=>{try{const a=await e.index.request({url:o.websiteUrl.value+"/brand-manager/order-plane/common-tiers",method:"GET",header:{Authorization:A()}});"success"===a.data.status&&($.value=[{label:"添加空白档位",value:"blank"},...a.data.data.map((e=>({label:e.title,value:e})))]);const t=await e.index.request({url:o.websiteUrl.value+"/brand-manager/order-plane/common-addons",method:"GET",header:{Authorization:A()}});"success"===t.data.status&&(S.value=[{label:"添加空白加购",value:"blank"},...t.data.data.map((e=>({label:e.title,value:e})))])}catch(a){console.error("获取默认配置失败:",a)}},H=e=>{const a=e.detail.value,t=$.value[a];"blank"===t.value?k.value.order_config.tiers.push({title:"",price:0,description:""}):k.value.order_config.tiers.push({...t.value,price:parseFloat(t.value.price)||0})},I=e=>{const a=e.detail.value,t=S.value[a];"blank"===t.value?k.value.order_config.addons.push({title:"",price:0,description:""}):k.value.order_config.addons.push({...t.value,price:parseFloat(t.value.price)||0})},U=()=>{const a=e.index.getSystemInfoSync();m.value=a.windowHeight-180},A=()=>e.index.getStorageSync("token")||"",C=async()=>{try{const o=9-k.value.images.length;if(o<=0)return;const l=await t.chooseImageList(o);if(!l||0===l.length)return;const i=await t.getQiniuToken(),n=i.token,r=i.path;h.value=!0,y.value=l.length,b.value=0;const s=[];for(let u=0;u<l.length;u++)try{const e=l[u];x.value=`上传中 (${u+1}/${l.length})`,b.value=u+1;const a=await t.uploadImageToQiniu(e,n,r);a&&a.imageUrl&&s.push(a.imageUrl)}catch(a){console.error(`第 ${u+1} 张图片上传失败:`,a),e.index.showToast({title:`第 ${u+1} 张图片上传失败`,icon:"none"})}k.value.images=[...k.value.images,...s],s.length>0&&e.index.showToast({title:`成功上传 ${s.length} 张图片`,icon:"success"})}catch(o){console.error("图片选择或上传失败:",o),e.index.showToast({title:"图片上传失败: "+(o.message||"未知错误"),icon:"none"})}finally{h.value=!1,b.value=0,y.value=0}},D=async(a=!1)=>{if(!d.value){a&&(s.value=1,r.value=[],p.value="more"),d.value=!0,p.value="loading";try{const t=await e.index.request({url:o.websiteUrl.value+"/brand-manager/order-plan/list",method:"GET",data:{page:s.value,page_size:u.value,status:n.value},header:{Authorization:A()}});if("success"===t.data.status){const e=t.data.data,o=e.list||[];c.value=e.total;const l=o.map((e=>{const a="string"==typeof e.images?e.images.split(",").filter((e=>""!==e.trim())):e.images||[];let t={};try{t=e.order_config?JSON.parse(e.order_config):{}}catch(o){console.error("解析 order_config 失败:",o)}return{...e,images:a,order_config:t}}));r.value=a?l:[...r.value,...l],r.value.length>=c.value?p.value="noMore":(p.value="more",s.value++)}else e.index.showToast({title:t.data.message||"获取列表失败",icon:"none"})}catch(t){e.index.showToast({title:"网络错误",icon:"none"})}finally{d.value=!1}}},F=()=>{"noMore"!==p.value&&D()},P=()=>{E(),g.value=!1,_.value.open()},E=()=>{k.value={artist_name:"",artist_type:1,order_type:1,max_participants:10,max_submissions_per_user:1,open_date:"",open_time:"",close_date:"",close_time:"",images:[],order_config:{tiers:[],addons:[]}},f.value=null,v.value=!1},G=e=>{k.value.open_date=e.detail.value},O=e=>{k.value.open_time=e.detail.value},N=e=>{k.value.close_date=e.detail.value},Q=e=>{k.value.close_time=e.detail.value},V=async()=>{if(!k.value.artist_name)return void e.index.showToast({title:"请填写计划名称",icon:"none"});if(!(k.value.open_date&&k.value.open_time&&k.value.close_date&&k.value.close_time))return void e.index.showToast({title:"请选择开始和结束时间",icon:"none"});const a=new Date(`${k.value.open_date} ${k.value.open_time}`).getTime()/1e3,t=new Date(`${k.value.close_date} ${k.value.close_time}`).getTime()/1e3;if(t<=a)return void e.index.showToast({title:"结束时间必须晚于开始时间",icon:"none"});const l={artist_name:k.value.artist_name,artist_type:k.value.artist_type,order_type:k.value.order_type,max_participants:k.value.max_participants,max_submissions_per_user:k.value.max_submissions_per_user,open_time:a,close_time:t,images:k.value.images,order_config:{tiers:k.value.order_config.tiers.map((e=>({...e,price:parseFloat(e.price)||0}))),addons:k.value.order_config.addons.map((e=>({...e,price:parseFloat(e.price)||0})))}};g.value&&(l.id=f.value),v.value=!0;try{const a=o.websiteUrl.value+(g.value?"/brand-manager/order-plan/update":"/brand-manager/order-plan/add"),t="POST",i=await e.index.request({url:a,method:t,data:l,header:{Authorization:A(),"Content-Type":"application/json"}});"success"===i.data.status?(e.index.showToast({title:g.value?"更新成功":"添加成功",icon:"success"}),_.value.close(),D(!0)):e.index.showToast({title:i.data.message||(g.value?"更新失败":"添加失败"),icon:"none"})}catch(i){console.error("提交失败:",i),e.index.showToast({title:"请求失败，请稍后重试",icon:"none"})}finally{v.value=!1}},B=()=>{_.value.close()},J=async a=>{try{const t=await e.index.request({url:o.websiteUrl.value+"/brand-manager/order-plan/delete?id="+a,method:"POST",header:{Authorization:A(),"Content-Type":"application/json"}});"success"===t.data.status?(e.index.showToast({title:"删除成功",icon:"success"}),D(!0)):e.index.showToast({title:t.data.message||"删除失败",icon:"none"})}catch(t){console.error("删除失败:",t),e.index.showToast({title:"网络错误",icon:"none"})}},L=e=>{k.value.artist_type=parseInt(e.detail.value)+1},Y=e=>{const a=parseInt(e.detail.value);k.value.order_type=z[a].value},K=(e,a="yyyy-MM-dd HH:mm")=>{if(!e)return"";const t=new Date(e),o=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),i=t.getDate().toString().padStart(2,"0"),n=t.getHours().toString().padStart(2,"0"),r=t.getMinutes().toString().padStart(2,"0");return"yyyy-MM-dd"===a?`${o}-${l}-${i}`:"HH:mm"===a?`${n}:${r}`:`${o}-${l}-${i} ${n}:${r}`},R=e=>{const a=Math.floor(Date.now()/1e3);return a<e.open_time?"未开始":a>e.close_time?"已结束":"进行中"},W=e=>{const a=Math.floor(Date.now()/1e3);return a<e.open_time?"upcoming":a>e.close_time?"inactive":"active"};return(t,o)=>{var l,s,u;return e.e({a:e.f(i,((a,t,o)=>({a:e.t(a.label),b:a.value,c:n.value===a.value?1:"",d:e.o((e=>(e=>{n.value=e,D(!0)})(a.value)),a.value)}))),b:d.value},d.value?{c:e.p({status:"loading"})}:r.value.length>0?{e:e.f(r.value,((a,t,o)=>{return e.e({a:e.t(a.artist_name),b:e.t((l=a.order_type,{1:"长期接单",2:"限时手速",3:"限时抽选",4:"限时黑箱卡",9:"关闭投递"}[l]||"未知类型")),c:e.t(R(a)),d:e.n(W(a)),e:e.o((e=>(e=>{var a,t;E(),g.value=!0,f.value=e.id,k.value={artist_name:e.artist_name,artist_type:e.artist_type,order_type:e.order_type,max_participants:e.max_participants,max_submissions_per_user:e.max_submissions_per_user,images:[...e.images||[]],order_config:{tiers:[...(null==(a=e.order_config)?void 0:a.tiers)||[]],addons:[...(null==(t=e.order_config)?void 0:t.addons)||[]]}},e.open_time&&(k.value.open_date=K(1e3*e.open_time,"yyyy-MM-dd"),k.value.open_time=K(1e3*e.open_time,"HH:mm")),e.close_time&&(k.value.close_date=K(1e3*e.close_time,"yyyy-MM-dd"),k.value.close_time=K(1e3*e.close_time,"HH:mm")),_.value.open()})(a)),a.id),f:e.o((t=>{return o=a.id,void e.index.showModal({title:"提示",content:"确定要删除该开单计划吗？",success:e=>{e.confirm&&J(o)}});var o}),a.id),g:a.images&&a.images.length},a.images&&a.images.length?{h:e.f(a.images,((t,o,l)=>({a:o,b:t,c:e.o((t=>{return l=a.images,i=o,void e.index.previewImage({current:i,urls:l,indicator:"number"});var l,i}),o)})))}:{},{i:"ab4eb003-1-"+o,j:e.t(a.max_participants),k:e.t(a.max_submissions_per_user),l:"ab4eb003-2-"+o,m:e.t(K(1e3*a.open_time)),n:e.t(K(1e3*a.close_time)),o:a.order_config&&a.order_config.tiers&&a.order_config.tiers.length},a.order_config&&a.order_config.tiers&&a.order_config.tiers.length?{p:e.f(a.order_config.tiers,((a,t,o)=>({a:e.t(a.title),b:e.t(a.price),c:e.t(a.description),d:t})))}:{},{q:a.id});var l})),f:e.p({type:"person",size:"16",color:"#666"}),g:e.p({type:"calendar",size:"16",color:"#666"})}:{},{d:r.value.length>0,h:!d.value},d.value?{}:e.e({i:"loading"===p.value},(p.value,{}),{j:"noMore"===p.value&&0!==r.value.length},("noMore"===p.value&&r.value.length,{})),{k:0===r.value.length&&!d.value},0!==r.value.length||d.value?{}:{l:a._imports_0$12},{m:e.o(F),n:m.value+"px",o:e.p({type:"plusempty",size:"30",color:"#fff"}),p:e.o(P),q:e.t(g.value?"编辑开单计划":"新增开单计划"),r:e.o(B),s:e.p({type:"closeempty",size:"24",color:"#999"}),t:k.value.artist_name,v:e.o((e=>k.value.artist_name=e.detail.value)),w:e.t((null==(l=j[k.value.artist_type-1])?void 0:l.text)||"请选择接单类型"),x:e.o(L),y:k.value.artist_type,z:j,A:e.t((null==(s=z.find((e=>e.value===k.value.order_type)))?void 0:s.text)||"请选择接单方式"),B:e.o(Y),C:(u=k.value.order_type,z.findIndex((e=>e.value===u))),D:z,E:e.o((e=>k.value.max_participants=e)),F:e.p({min:1,max:1e3,modelValue:k.value.max_participants}),G:e.o((e=>k.value.max_submissions_per_user=e)),H:e.p({min:1,max:10,modelValue:k.value.max_submissions_per_user}),I:e.t(k.value.open_date||"选择日期"),J:k.value.open_date,K:e.o(G),L:e.t(k.value.open_time||"选择时间"),M:k.value.open_time,N:e.o(O),O:e.t(k.value.close_date||"选择日期"),P:k.value.close_date,Q:e.o(N),R:e.t(k.value.close_time||"选择时间"),S:k.value.close_time,T:e.o(Q),U:h.value},h.value?{V:e.p({status:"loading"}),W:e.t(b.value),X:e.t(y.value)}:{},{Y:e.f(k.value.images,((a,t,o)=>({a:a,b:e.o((e=>(e=>{k.value.images.splice(e,1)})(t)),t),c:"ab4eb003-9-"+o+",ab4eb003-4",d:t}))),Z:e.p({type:"close",size:"18",color:"#fff"}),aa:k.value.images.length<9&&!h.value},k.value.images.length<9&&!h.value?{ab:e.p({type:"plusempty",size:"28",color:"#999"}),ac:e.o(C)}:{},{ad:$.value,ae:e.o(H),af:e.f(k.value.order_config.tiers,((a,t,o)=>e.e(k.value.order_config.tiers.length>1?{a:e.o((e=>(e=>{k.value.order_config.tiers.length>1&&k.value.order_config.tiers.splice(e,1)})(t)),t),b:"ab4eb003-11-"+o+",ab4eb003-4",c:e.p({type:"trash",size:"18",color:"#f56c6c"})}:{},{d:a.title,e:e.o((e=>a.title=e.detail.value),t),f:a.price,g:e.o((e=>a.price=e.detail.value),t),h:a.description,i:e.o((e=>a.description=e.detail.value),t),j:t}))),ag:k.value.order_config.tiers.length>1,ah:S.value,ai:e.o(I),aj:e.f(k.value.order_config.addons,((a,t,o)=>e.e({a:e.t(t+1)},k.value.order_config.addons.length>1?{b:e.o((e=>(e=>{k.value.order_config.addons.length>1&&k.value.order_config.addons.splice(e,1)})(t)),t),c:"ab4eb003-12-"+o+",ab4eb003-4",d:e.p({type:"trash",size:"18",color:"#f56c6c"})}:{},{e:a.title,f:e.o((e=>a.title=e.detail.value),t),g:a.price,h:e.o((e=>a.price=e.detail.value),t),i:a.description,j:e.o((e=>a.description=e.detail.value),t),k:t}))),ak:k.value.order_config.addons.length>1,al:e.t(v.value?"提交中...":"提交"),am:e.o(V),an:v.value,ao:e.sr(_,"ab4eb003-4",{k:"popup"}),ap:e.p({type:"bottom"})})}}},i=e._export_sfc(l,[["__scopeId","data-v-ab4eb003"]]);wx.createPage(i);
