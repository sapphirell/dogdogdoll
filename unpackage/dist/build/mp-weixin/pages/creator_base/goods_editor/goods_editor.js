"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/config.js"),o=require("../../../common/image.js");if(!Array){(e.resolveComponent("cascade-multi-select")+e.resolveComponent("uni-icons")+e.resolveComponent("shmily-drag-image"))()}Math||((()=>"../../../components/cascade-multi-select/cascade-multi-select.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../components/shmily-drag-image/shmily-drag-image.js"))();const t={__name:"goods_editor",props:{goods_id:{type:String}},setup(t){const s=t,i=e.computed((()=>s.goods_id&&"0"!==s.goods_id&&"new"!==s.goods_id)),n=e.ref({id:0,name:"",brand_id:0,brand_name:"",total_amount:0,currency:"CNY",size:"",size_detail:"",skin:"",type:"",desc_content:"",doll_material:"",goods_images:[],sizes:[]}),l=e.ref(!0),d=e.ref([]),u=e.ref([]);e.ref([]);const r=e.ref(!1),c=e.ref(null),v=e.ref([]),m=e.ref(-1),g=e.ref([]),h=e.ref(-1),_=e.ref({}),w=e.ref([]),f=e.ref(-1),p=e.ref(["白肌","浅烧","牡丹白","奶油","半白","粉白","普肌","粉普","烧肌"]),y=e.computed((()=>["整体","单体","单头"].includes(n.value.type))),x=e.ref([]),b=e.computed((()=>n.value.sizes&&Array.isArray(n.value.sizes)?n.value.sizes.map((e=>`${e.goods_size}/${e.size_detail}`)):[])),T=()=>{x.value=(n.value.sizes||[]).map((e=>({category:e.goods_size,size:e.size_detail}))),r.value=!0},z=e=>{n.value.sizes=e.map((e=>({goods_size:e.category,size_detail:e.size})))},k=a=>{console.log("点击了图片",a);const o=n.value.goods_images.map((e=>e.src)),t=n.value.goods_images.findIndex((e=>e.id===a.id));return e.index.previewImage({urls:o,current:t>=0?t:0,indicator:"default",loop:!0}),!1},$=async()=>{try{let o=`${a.websiteUrl.value}/materials`;"假发"===n.value.type&&(o=`${a.websiteUrl.value}/hair-materials`);const t=await e.index.request({url:o,method:"GET"});"success"===t.data.status&&(w.value=t.data.data)}catch(o){console.error("获取材质数据失败:",o),e.index.showToast({title:"获取材质数据失败",icon:"none"})}},S=e=>{const a=e.detail.value;m.value=a,n.value.type=v.value[a],$()},I=e=>{const a=e.detail.value;h.value=a,n.value.currency=g.value[a]},q=e=>{const a=e.detail.value;f.value=a,n.value.doll_material=w.value[a]},L=e=>{const a=[];e.forEach((e=>{const o=n.value.goods_images.find((a=>a.id===e));o&&a.push(o)})),n.value.goods_images=a},U=async()=>{try{if(e.index.showLoading({title:"保存中..."}),!n.value.name)return void e.index.showToast({title:"请填写商品名称",icon:"none"});if(!n.value.type)return void e.index.showToast({title:"请选择商品类型",icon:"none"});if(!n.value.goods_images||0===n.value.goods_images.length)return void e.index.showToast({title:"请至少上传一张商品图片",icon:"none"});const o={...n.value,goods_images:n.value.goods_images.map((e=>({id:e.id,url:e.src}))),sizes:n.value.sizes,total_amount:parseInt(n.value.total_amount)},t=e.index.getStorageSync("token");if(!t)return error.value="未登录，请先登录",loading.value=!1,void(loadStatus.value="more");const s=i.value?`${a.websiteUrl.value}/brand-manager/update-goods`:`${a.websiteUrl.value}/brand-manager/add-goods`,l=(i.value,"POST"),d=await e.index.request({url:s,method:l,data:o,header:{Authorization:t}});"success"===d.data.status?(e.index.showToast({title:i.value?"保存成功":"添加成功"}),setTimeout((()=>{e.index.navigateBack()}),1500)):e.index.showToast({title:d.data.msg||(i.value?"保存失败":"添加失败"),icon:"none"})}catch(o){console.error("操作失败",o),e.index.showToast({title:i.value?"保存失败":"添加失败",icon:"none"})}finally{e.index.hideLoading()}},j=async()=>{try{const t=9-n.value.goods_images.length;if(t<=0)return void e.index.showToast({title:"最多只能添加9张图片",icon:"none"});const s=await o.chooseImageList(t);e.index.showLoading({title:"上传中...",mask:!0});for(let i=0;i<s.length;i++)try{e.index.showLoading({title:`上传中 (${i+1}/${s.length})`,mask:!0});const a=await o.getQiniuToken();if(!a||!a.path||!a.token)throw new Error("获取上传凭证失败: 缺少必要字段");const t=a.path,l=await o.uploadImageToQiniu(s[i],a.token,t);l&&l.imageUrl&&n.value.goods_images.push({id:Date.now()+i,src:l.imageUrl,name:"",price:"",type:""})}catch(a){console.error(`第 ${i+1} 张图片上传失败:`,a),e.index.showToast({title:`第 ${i+1} 张图片上传失败: ${a.message||a}`,icon:"none",duration:3e3})}e.index.hideLoading(),e.index.showToast({title:`成功添加${s.length}张图片`,icon:"success"})}catch(a){console.error("添加图片失败",a),e.index.hideLoading(),e.index.showToast({title:`添加图片失败: ${a.message||a}`,icon:"none",duration:3e3})}},E=a=>{e.index.showModal({title:"删除确认",content:"确定要删除这张图片吗？",confirmText:"删除",confirmColor:"#ff3b30",success:o=>{o.confirm&&(n.value.goods_images=n.value.goods_images.filter((e=>e.id!==a)),e.index.showToast({title:"图片已删除",icon:"success"}))}})};return e.onMounted((async()=>{e.index.setNavigationBarTitle({title:i.value?"编辑商品信息":"添加新商品"}),await(async()=>{try{const o=await e.index.request({url:`${a.websiteUrl.value}/sizes`,method:"GET"});if("success"===o.data.status){d.value=o.data.data;const e=[];for(const[a,o]of Object.entries(d.value))e.push({text:a,value:a,children:o.map((e=>({text:e,value:e})))});u.value=e}}catch(o){console.error("获取尺寸数据失败:",o),e.index.showToast({title:"获取尺寸数据失败",icon:"none"})}})(),await(async()=>{try{const o=await e.index.request({url:`${a.websiteUrl.value}/goods-types`,method:"GET"});"success"===o.data.status&&(v.value=o.data.data)}catch(o){console.error("获取类型数据失败:",o),e.index.showToast({title:"获取类型数据失败",icon:"none"})}})(),await(async()=>{try{const o=await e.index.request({url:`${a.websiteUrl.value}/currency`,method:"GET"});"success"===o.data.status&&(_.value=o.data.data,g.value=Object.keys(o.data.data))}catch(o){console.error("获取货币数据失败:",o),e.index.showToast({title:"获取货币数据失败",icon:"none"})}})(),await(async()=>{try{if(!i.value){const a=e.index.getStorageSync("userInfo");return void(a&&a.brand&&(n.value.brand_id=a.brand.id,n.value.brand_name=a.brand.name))}e.index.showLoading({title:"加载中..."});const o=e.index.getStorageSync("token");if(!o)return error.value="未登录，请先登录",loading.value=!1,void(loadStatus.value="more");const t=await e.index.request({url:`${a.websiteUrl.value}/brand-manager/get-goods-info-by-id`,method:"GET",data:{id:s.goods_id},header:{Authorization:o}});if("success"===t.data.status){const e=t.data.data;n.value={...e,sizes:e.sizes||[],goods_images:e.goods_images.map((e=>({id:e.id,src:e.url,name:"",price:"",type:""})))},m.value=v.value.indexOf(n.value.type),h.value=g.value.findIndex((e=>e===n.value.currency)),f.value=w.value.indexOf(n.value.doll_material)}else e.index.showToast({title:t.data.msg,icon:"none"})}catch(o){console.error("获取商品信息失败",o),e.index.showToast({title:"获取商品信息失败",icon:"none"})}finally{e.index.hideLoading()}})(),await $()})),(a,o)=>e.e({a:n.value.name,b:e.o((e=>n.value.name=e.detail.value)),c:n.value.brand_name},n.value.brand_name?{d:n.value.brand_name,e:e.o((e=>n.value.brand_name=e.detail.value))}:{},{f:n.value.total_amount,g:e.o((e=>n.value.total_amount=e.detail.value)),h:e.t(n.value.currency),i:e.o(I),j:h.value,k:g.value,l:0===b.value.length},0===b.value.length?{}:{m:e.f(b.value,((a,o,t)=>({a:e.t(a),b:o})))},{n:e.o(T),o:e.sr(c,"8bcdb4cc-0",{k:"sizeSelector"}),p:e.o((e=>r.value=!1)),q:e.o(z),r:e.p({show:r.value,sizeData:d.value,initialSelection:x.value}),s:e.t(n.value.type||"请选择类型"),t:e.o(S),v:m.value,w:v.value,x:n.value.skin,y:e.o((e=>n.value.skin=e.detail.value)),z:y.value},y.value?{A:e.f(p.value,((a,o,t)=>({a:e.t(a),b:o,c:e.o((e=>(e=>{n.value.skin?n.value.skin+=` ${e}`:n.value.skin=e})(a)),o)})))}:{},{B:e.t(n.value.doll_material||"请选择材质"),C:e.o(q),D:f.value,E:w.value,F:n.value.desc_content,G:e.o((e=>n.value.desc_content=e.detail.value)),H:e.t(l.value?"，点击图片右上角可删除。":""),I:n.value.goods_images.length<9},n.value.goods_images.length<9?{J:e.p({type:"plusempty",size:"30",color:"#999"}),K:e.o(j)}:{},{L:e.o(L),M:e.o(k),N:e.o(E),O:e.o((e=>n.value.goods_images=e)),P:e.p({cols:3,showItemInfo:!1,itemMargin:10,showDelete:!0,"border-radius":"0","custom-click":!0,keyName:"src",modelValue:n.value.goods_images}),Q:e.t(i.value?"保存修改":"添加商品"),R:e.o(U)})}},s=e._export_sfc(t,[["__scopeId","data-v-8bcdb4cc"]]);wx.createPage(s);
