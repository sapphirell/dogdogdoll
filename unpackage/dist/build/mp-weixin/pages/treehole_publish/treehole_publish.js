"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../common/config.js"),n=require("../../common/image.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("common-page"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/common-page/common-page.js"))();const a={__name:"treehole_publish",setup(a){const i=e.ref(""),s=e.ref(0),l=e.ref([]),u=e.ref({}),c=e.ref(""),r=e.ref(-1),d=e.ref("");function v(o){e.index.previewImage({current:l.value[o],urls:l.value})}function m(e){s.value=e.detail.value.length>0?1:0}e.index.setNavigationBarTitle({title:"投稿树洞"});function h(e){const o=e.detail.value;o>=0&&u.value[o]&&(r.value=o,c.value=u.value[o].value,d.value=u.value[o].label)}const p=e.computed((()=>i.value.trim().length>0&&null!==c.value));async function g(){if(p.value)if(c.value)try{e.index.showLoading({title:"提交中..."});const o=e.index.getStorageSync("token");if(!o)return void e.index.showToast({title:"请先登录",icon:"none"});const n={content:i.value.trim(),images:l.value,is_anonymous:s.value,category_id:c.value},a=await e.index.request({url:t.websiteUrl+"/with-state/add-submission",method:"POST",data:n,header:{"Content-Type":"application/json",Authorization:o}});e.index.hideLoading(),"success"==a.data.status?(e.index.showToast({title:"我们很快审核完成",icon:"success"}),setTimeout((()=>{i.value="",l.value=[],s.value=0,e.index.navigateBack()}),1500)):e.index.showToast({title:a.data.msg||"提交失败",icon:"none"})}catch(o){e.index.hideLoading(),console.error("提交失败:",o),e.index.showToast({title:"网络请求失败",icon:"none"})}else e.index.showToast({title:"请选择分类",icon:"none"})}return e.onMounted((()=>{(async()=>{try{const o=await e.index.request({url:t.websiteUrl+"/treehole-typelist",method:"GET"});"success"===o.data.status&&(u.value=Object.entries(o.data.data).map((([e,o])=>({value:Number(e),label:o}))))}catch(o){console.error("获取分类失败:",o)}})()})),(a,f)=>({a:e.t(d.value||"请选择分类（必选）"),b:e.n(c.value?"":"placeholder"),c:e.p({type:"right",size:"22",color:"#888"}),d:u.value,e:e.o(h),f:r.value,g:e.f(l.value,((o,t,n)=>({a:o,b:e.o(v,t),c:e.o((e=>a.deleteImage(t)),t),d:t}))),h:o._imports_1$6,i:o._imports_1$5,j:e.o((o=>(a.index,console.log("openSelect"),void n.chooseImage().then((o=>{n.getQiniuToken().then((a=>{console.log(a),n.uploadImageToQiniu(o,a.token,a.path).then((o=>{200!=o.statusCode&&e.index.showToast({title:"上传失败",icon:"none"}),console.log(t.image1Url+a.path),l.value.push(t.image1Url+a.path),e.index.showToast({title:"上传成功",icon:"success"})}))}))}))))),k:i.value,l:e.o((e=>i.value=e.detail.value)),m:1===s.value,n:e.o(m),o:p.value?"":1,p:e.o(g),q:e.p({title:"发布树洞"})})}},i=e._export_sfc(a,[["__scopeId","data-v-d7628137"]]);wx.createPage(i);
