"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),a=require("../../common/config.js");if(!Array){(e.resolveComponent("goods-search")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-transition")+e.resolveComponent("common-modal")+e.resolveComponent("loading-toast")+e.resolveComponent("common-page"))()}Math||((()=>"../../components/goods-search/goods-search.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-transition/components/uni-transition/uni-transition.js")+(()=>"../../components/common-modal/common-modal.js")+(()=>"../../components/loading-toast/loading-toast.js")+(()=>"../../components/common-page/common-page.js"))();const l={__name:"collocation_square",setup(l){const n=e.ref("find"),t=e.ref([]),i=e.ref(!1),s=e.ref(!1),r=e.ref(1),u=e.ref(0),c=e.ref(0),d=e.reactive([0,0]),v=e.ref(!1),g=e.ref(""),f=e.ref([]),p=e.getCurrentInstance(),m=e.ref(null),_=e.ref([]);e.ref(null);const h=e.ref([]),w=e.ref(!1),y=e.ref(!1),x=e.ref(-1),b=e.ref("全部"),T=e.ref("全部"),$=e.ref([]),j=e.ref([]),q=e.ref(!1),P=()=>{q.value=!q.value},k=()=>{q.value=!1},z=()=>{k(),e.index.navigateTo({url:"/pages/collocation/collocation"})},C=()=>{k(),e.index.navigateTo({url:"/pages/stock/showcase_form/showcase_form"})},S=e=>{const o=t.value[e];return o.position?{left:`${o.position.left}px`,top:`${o.position.top}px`,width:`${c.value}px`}:{}},E=o=>{if(console.log("进入计算布局逻辑"),!o)return void console.log("无法获取instance");if(console.log("获取成功"),!t.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(o);const a=e.index.createSelectorQuery().in(o.proxy);console.log("获取到query");const l=t.value.map(((e,o)=>new Promise((e=>{a.select(`#card-${o}`).boundingClientRect((a=>{e({index:o,rect:a})}))}))));a.exec((async()=>{console.log("进入Query"),d[0]=0,d[1]=0;const e=await Promise.all(l);e.length?(e.forEach((({index:e,rect:o})=>{if(!o)return void console.error(`卡片${e}元素查询失败`);const a=t.value[e],l=d[0]<=d[1]?0:1,n=l*(c.value+10),i=d[l]+10;d[l]=i+o.height,a.position={left:n,top:i}})),u.value=Math.max(...d)+20):console.warn("未查询到任何卡片元素")}))},O=e=>{q.value=!1,v.value=!1,"view"===n.value&&(t.value.forEach((e=>{delete e.position})),d[0]=0,d[1]=0),R(e)},R=e=>{n.value=e,"find"===e&&(0===$.value.length&&(U(),A()),0===h.value.length&&D(!0)),"view"==e&&M()},U=async()=>{try{const o=await e.index.request({url:`${a.websiteUrl}/goods-types`,method:"GET"});"success"===o.data.status&&($.value=["全部",...o.data.data])}catch(o){console.error("获取商品分类失败:",o)}},A=async()=>{try{const o=await e.index.request({url:`${a.websiteUrl}/sizes?show_type=hot`,method:"GET"});if("success"===o.data.status){const e=Object.keys(o.data.data);j.value=["全部",...e]}}catch(o){console.error("获取尺寸分类失败:",o)}},D=async(o=!1)=>{if(o&&(h.value=[],x.value=-1,y.value=!1),!w.value&&!y.value)try{w.value=!0;const l={cursor:x.value,page_size:10,type:"全部"===b.value?"":b.value,size:"全部"===T.value?"":T.value},n=await e.index.request({url:`${a.websiteUrl}/random-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if("success"===n.data.status){const e=n.data.data,a=e.goods_list||[];h.value=o?a:[...h.value,...a],x.value=e.next_cursor,y.value=a.length<10}}catch(l){console.error("获取随机商品失败:",l),e.index.showToast({title:"加载失败",icon:"none"})}finally{w.value=!1}},I=()=>{D()};e.onMounted((()=>{const o=e.index.getSystemInfoSync();c.value=(o.windowWidth-30)/2,U(),A(),D(!0)})),e.onPullDownRefresh((async()=>{try{"view"===n.value?await M(!0):"find"===n.value&&await D(!0),e.index.stopPullDownRefresh()}catch(o){e.index.stopPullDownRefresh(),e.index.showToast({title:"刷新失败",icon:"none"})}}));const M=async(o=!1)=>{if(o&&(t.value=[],r.value=1,s.value=!1,i.value=!1),i.value||s.value)return console.log("正在加载或没有更多数据，停止请求"),void Q();try{i.value=!0;const l={page:r.value,page_size:10,filter_goods_id_list:_.value.map((e=>e.goods_id))};console.log("请求参数:",JSON.stringify(l,null,2));const n=await e.index.request({url:`${a.websiteUrl}/collocation-list`,method:"POST",data:l,header:{"content-type":"application/json"}});if(console.log("接口响应:",n),"success"===n.data.status){const a=n.data.data||{},l=Array.isArray(a.collocation_relation_list)?a.collocation_relation_list:[];t.value=o?l:[...t.value,...l],s.value=l.length<10,r.value++,o&&0===l.length&&e.index.showToast({title:"暂无相关搭配",icon:"none"}),Q()}}catch(l){console.error("请求失败:",l),e.index.showToast({title:"加载失败",icon:"none"})}finally{i.value=!1}},Q=async()=>{console.log("等待next tick"),await e.nextTick$1(),console.log("等待完成"),E(p),setTimeout((()=>{console.log("二次计算布局"),E(p)}),500)},G=()=>{v.value=!0},H=e=>{if(console.log("选择商品:",e),!(null==e?void 0:e.id))return;const o={goods_id:e.id,goods_name:`${e.brand_name?e.brand_name+"·":""}${e.name}`};_.value.some((e=>e.goods_id===o.goods_id))||(_.value=[..._.value,o])};const J=async()=>{v.value=!1,await M(!0)},N=()=>{v.value=!1},B=(e,o)=>{var a;null==(a=null==o?void 0:o.stopPropagation)||a.call(o),_.value=_.value.filter((o=>o.goods_id!==e)),s.value=!1,M(!0)},F=()=>{m.value=null,g.value="",_.value=[],f.value=[]};const K=()=>{s.value||M()};return(a,l)=>e.e({a:o._imports_0$8,b:"find"===n.value?1:"",c:e.o((e=>O("find"))),d:o._imports_1$6,e:"view"===n.value?1:"",f:e.o((e=>O("view"))),g:"find"===n.value},"find"===n.value?e.e({h:e.p({"hidden-icon":!1,width:"670rpx"}),i:e.f($.value,((o,a,l)=>({a:e.t(o),b:a,c:b.value===o?1:"",d:e.o((e=>(e=>{b.value=e,D(!0)})(o)),a)}))),j:e.f(j.value,((o,a,l)=>({a:e.t(o),b:a,c:T.value===o?1:"",d:e.o((e=>(e=>{T.value=e,D(!0)})(o)),a)}))),k:e.f(h.value,((o,a,l)=>({a:o.goods_images[0],b:e.t(o.name),c:e.t(o.brand_name),d:e.t(o.total_amount),e:e.t(o.currency),f:o.id,g:e.o((a=>{return l=o.id,void e.index.navigateTo({url:"/pages/goods/goods?goods_id="+l});var l}),o.id)}))),l:w.value},(w.value,{}),{m:y.value},(y.value,{}),{n:e.o(I)}):{},{o:"view"===n.value},"view"===n.value?e.e({p:e.f(_.value,((o,a,l)=>({a:e.t(o.goods_name),b:o.goods_id,c:e.o((e=>B(o.goods_id,e)),o.goods_id)}))),q:!_.value.length},(_.value.length,{}),{r:e.o(G),s:e.o((e=>M(!0))),t:e.f(t.value,((o,a,l)=>{var n,t,i;return e.e({a:o.avatar||"/default_avatar.jpg",b:e.t((i=o.username,i.length>10?`${i.toString().slice(-8)}...`:i)),c:"18bf4ac0-2-"+l+",18bf4ac0-0",d:e.t(o.like_count),e:e.o((a=>{return l=o.uid,void e.index.navigateTo({url:`/pages/user_page/user_page?uid=${l}`});var l}),o.collocation_id),f:(null==(n=o.image_urls)?void 0:n.length)>0},(null==(t=o.image_urls)?void 0:t.length)>0?{g:o.image_urls[0]}:{},{h:e.t(o.title),i:e.t(o.content),j:e.f(o.relation_list,((o,a,l)=>({a:e.t(o.relation_goods_name||"未命名商品"),b:a}))),k:o.collocation_id,l:"card-"+a,m:e.s(S(a)),n:e.o((a=>{return l=o.collocation_id,n=o.origin,void e.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+l+"&origin="+n});var l,n}),o.collocation_id)})})),v:e.p({type:"hand-up",size:"18",color:"#5f85a3"}),w:u.value+"px",x:i.value},(i.value,{}),{y:s.value},(s.value,{}),{z:e.o(K),A:e.p({type:"plusempty",size:"30",color:"#fff"}),B:e.o(P),C:q.value},q.value?{D:e.o(k)}:{},{E:e.p({name:"fade",mode:"out-in",duration:300}),F:e.p({type:"color",size:"24",color:"#5f85a3"}),G:e.o(z),H:e.p({type:"compose",size:"24",color:"#5f85a3"}),I:e.o(C),J:q.value?1:"",K:e.o(N),L:e.o(N),M:e.s("margin-top:60rpx"),N:e.o(H),O:e.p({mode:"fill",background:"#f8f8f8",width:"100%"}),P:e.f(_.value,((o,a,l)=>({a:e.t(o.goods_name),b:o.goods_id,c:e.o((e=>B(o.goods_id,e)),o.goods_id)}))),Q:e.o(F),R:e.o(J),S:e.o((e=>v.value=e)),T:e.p({top:"0",width:"100%",height:"100%",visible:v.value})}):{},{U:e.p({show:w.value||i.value}),V:e.p({head_color:"#def9ff"})})}},n=e._export_sfc(l,[["__scopeId","data-v-18bf4ac0"]]);l.__runtimeHooks=2,wx.createPage(n);
