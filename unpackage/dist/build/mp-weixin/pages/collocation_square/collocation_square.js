"use strict";const e=require("../../common/vendor.js"),o=require("../../common/config.js");if(!Array){(e.resolveComponent("common-search")+e.resolveComponent("custom-picker")+e.resolveComponent("common-modal")+e.resolveComponent("common-page"))()}Math||((()=>"../../components/common-search/common-search.js")+(()=>"../../components/custom-picker/custom-picker.js")+(()=>"../../components/common-modal/common-modal.js")+(()=>"../../components/common-page/common-page.js"))();const l={__name:"collocation_square",setup(l){const a=e.ref([]),t=e.ref(!1),n=e.ref(!1),s=e.ref(1),c=e.ref(0),i=e.ref(0),r=e.reactive([0,0]),u=e.ref(!1),v=e.ref(""),d=e.ref([]),m=e.getCurrentInstance(),g=e.ref(null),p=e.ref([]),f=e.ref(null),_=e=>{const o=a.value[e];return o.position?{left:`${o.position.left}px`,top:`${o.position.top}px`,width:`${i.value}px`}:{}},h=o=>{if(console.log("进入计算布局逻辑"),!o)return void console.log("无法获取instance");if(console.log("获取成功"),!a.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(o);const l=e.index.createSelectorQuery().in(o.proxy);console.log("获取到query");const t=a.value.map(((e,o)=>new Promise((e=>{l.select(`#card-${o}`).boundingClientRect((l=>{e({index:o,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),r[0]=0,r[1]=0;const e=await Promise.all(t);e.length?(e.forEach((({index:e,rect:o})=>{if(!o)return void console.error(`卡片${e}元素查询失败`);const l=a.value[e],t=r[0]<=r[1]?0:1,n=t*(i.value+10),s=r[t]+10;r[t]=s+o.height,l.position={left:n,top:s}})),c.value=Math.max(...r)+20):console.warn("未查询到任何卡片元素")}))};e.onMounted((()=>{const o=e.index.getSystemInfoSync();i.value=(o.windowWidth-30)/2}));const x=async(l=!1)=>{if(t.value||n.value)console.log("正在加载中或没有更多了");else try{t.value=!0,l&&(a.value=[],s.value=1);const c={page:s.value,page_size:10,filter_goods_id_list:p.value.map((e=>e.goods_id))},i=await e.index.request({url:`${o.websiteUrl}/collocation-list`,method:"POST",data:c});if("success"===i.data.status){const o=i.data.data,t=o.collocation_relation_list;a.value=l?t:[...a.value,...t],n.value=o.total<=10*s.value,s.value++,console.log("等待next tick"),await e.nextTick$1(),console.log("等待完成"),h(m),setTimeout((()=>{console.log("二次计算布局"),h(m)}),500)}}finally{t.value=!1}},w=()=>u.value=!0,y=(e,o)=>{g.value={id:e,name:o},v.value=o,e&&b(e)},b=async l=>{try{const a=await e.index.request({url:`${o.websiteUrl}/goods-name-list?id=${l}`,method:"GET"});console.log("商品列表:",a.data),"success"===a.data.status&&(d.value=a.data.data)}catch(a){console.error("加载商品失败:",a)}},$=(e,o)=>{if(e){for(const o of p.value)if(o.goods_id===e)return;f.value={goods_id:e,goods_name:o}}else console.log("未选择有效goods")},j=()=>{g.value=null,v.value="",p.value=[],d.value=[]};const q=async()=>{p.value.push(f.value),u.value=!1,n.value=!1,await x(!0)},k=()=>{n.value||x()};return e.onMounted(x),(o,l)=>e.e({a:true},{},{b:e.f(p.value,((o,l,a)=>({a:e.t(o.goods_name),b:e.o((e=>{return l=o.goods_id,event.stopPropagation(),p.value=p.value.filter((e=>e.goods_id!==l)),n.value=!1,void x(!0);var l}),o.goods_id),c:o.goods_id}))),c:!p.value.length},(p.value.length,{}),{d:e.o(w),e:e.o((e=>x(!0))),f:e.f(a.value,((o,l,a)=>({a:o.image_urls[0],b:e.t(o.title),c:e.t(o.content),d:e.f(o.relation_list,((o,l,a)=>({a:e.t(o.relation_goods_name||"未命名商品"),b:l}))),e:o.collocation_id,f:"card-"+l,g:e.s(_(l)),h:e.o((l=>{return a=o.collocation_id,t=o.origin,void e.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+a+"&origin="+t});var a,t}),o.collocation_id)}))),g:c.value+"px",h:t.value},(t.value,{}),{i:n.value},(n.value,{}),{j:e.o(k),k:u.value},u.value?e.e({l:e.o((e=>u.value=!1)),m:e.o(y),n:e.p({mode:"fill",width:"450rpx"}),o:g.value},g.value?{p:e.o($),q:e.p({dataList:d.value,multiple:!0})}:{},{r:e.o(j),s:e.o(q),t:e.o((e=>u.value=e)),v:e.p({visible:u.value,visible:u.value})}):{},{w:e.p({head_color:"#f5f5f5"})})}},a=e._export_sfc(l,[["__scopeId","data-v-b3258ec1"]]);wx.createPage(a);
