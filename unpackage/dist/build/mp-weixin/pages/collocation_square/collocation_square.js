"use strict";const o=require("../../common/vendor.js"),e=require("../../common/config.js");if(!Array){(o.resolveComponent("uni-icons")+o.resolveComponent("goods-search")+o.resolveComponent("common-modal")+o.resolveComponent("common-page"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/goods-search/goods-search.js")+(()=>"../../components/common-modal/common-modal.js")+(()=>"../../components/common-page/common-page.js"))();const n={__name:"collocation_square",setup(n){const l=o.ref([]),a=o.ref(!1),t=o.ref(!1),i=o.ref(1),s=o.ref(0),c=o.ref(0),r=o.reactive([0,0]),u=o.ref(!1),d=o.ref(""),v=o.ref([]),g=o.getCurrentInstance(),m=o.ref(null),_=o.ref([]);o.ref(null);const p=o=>{const e=l.value[o];return e.position?{left:`${e.position.left}px`,top:`${e.position.top}px`,width:`${c.value}px`}:{}},f=e=>{if(console.log("进入计算布局逻辑"),!e)return void console.log("无法获取instance");if(console.log("获取成功"),!l.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(e);const n=o.index.createSelectorQuery().in(e.proxy);console.log("获取到query");const a=l.value.map(((o,e)=>new Promise((o=>{n.select(`#card-${e}`).boundingClientRect((n=>{o({index:e,rect:n})}))}))));n.exec((async()=>{console.log("进入Query"),r[0]=0,r[1]=0;const o=await Promise.all(a);o.length?(o.forEach((({index:o,rect:e})=>{if(!e)return void console.error(`卡片${o}元素查询失败`);const n=l.value[o],a=r[0]<=r[1]?0:1,t=a*(c.value+10),i=r[a]+10;r[a]=i+e.height,n.position={left:t,top:i}})),s.value=Math.max(...r)+20):console.warn("未查询到任何卡片元素")}))};o.onMounted((()=>{const e=o.index.getSystemInfoSync();c.value=(e.windowWidth-30)/2}));const h=async(n=!1)=>{if(n&&(l.value=[],i.value=1,t.value=!1,a.value=!1),a.value||t.value)console.log("正在加载或没有更多数据，停止请求");else try{a.value=!0;const s={page:i.value,page_size:10,filter_goods_id_list:_.value.map((o=>o.goods_id))};console.log("请求参数:",JSON.stringify(s,null,2));const c=await o.index.request({url:`${e.websiteUrl}/collocation-list`,method:"POST",data:s,header:{"content-type":"application/json"}});if(console.log("接口响应:",c),"success"===c.data.status){const e=c.data.data||{},a=Array.isArray(e.collocation_relation_list)?e.collocation_relation_list:[];l.value=n?a:[...l.value,...a],t.value=a.length<10,i.value++,n&&0===a.length&&o.index.showToast({title:"暂无相关搭配",icon:"none"}),console.log("等待next tick"),await o.nextTick$1(),console.log("等待完成"),f(g),setTimeout((()=>{console.log("二次计算布局"),f(g)}),500)}}catch(s){console.error("请求失败:",s),o.index.showToast({title:"加载失败",icon:"none"})}finally{a.value=!1}},x=()=>{u.value=!0},y=o=>{if(console.log("选择商品:",o),!(null==o?void 0:o.id))return;const e={goods_id:o.id,goods_name:`${o.brand_name?o.brand_name+"·":""}${o.name}`};_.value.some((o=>o.goods_id===e.goods_id))||(_.value=[..._.value,e])},w=async()=>{u.value=!1,await h(!0)},b=()=>{u.value=!1},$=(o,e)=>{var n;null==(n=null==e?void 0:e.stopPropagation)||n.call(e),_.value=_.value.filter((e=>e.goods_id!==o)),t.value=!1,h(!0)},j=()=>{m.value=null,d.value="",_.value=[],v.value=[]};const k=()=>{t.value||h()};return o.onMounted(h),(e,n)=>o.e({a:o.f(_.value,((e,n,l)=>({a:o.t(e.goods_name),b:e.goods_id,c:o.o((o=>$(e.goods_id,o)),e.goods_id)}))),b:!_.value.length},(_.value.length,{}),{c:o.o(x),d:o.o((o=>h(!0))),e:o.s("width:500rpx"),f:o.f(l.value,((e,n,l)=>{var a,t,i;return o.e({a:e.avatar||"/default_avatar.jpg",b:o.t((i=e.username,i.length>10?`${i.toString().slice(-8)}...`:i)),c:"40a389e7-1-"+l+",40a389e7-0",d:o.t(e.like_count),e:o.o((n=>{return l=e.uid,void o.index.navigateTo({url:`/pages/user_page/user_page?uid=${l}`});var l}),e.collocation_id),f:(null==(a=e.image_urls)?void 0:a.length)>0},(null==(t=e.image_urls)?void 0:t.length)>0?{g:e.image_urls[0]}:{},{h:o.t(e.title),i:o.t(e.content),j:o.f(e.relation_list,((e,n,l)=>({a:o.t(e.relation_goods_name||"未命名商品"),b:n}))),k:e.collocation_id,l:"card-"+n,m:o.s(p(n)),n:o.o((n=>{return l=e.collocation_id,a=e.origin,void o.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+l+"&origin="+a});var l,a}),e.collocation_id)})})),g:o.p({type:"hand-up",size:"18",color:"#5f85a3"}),h:s.value+"px",i:a.value},(a.value,{}),{j:t.value},(t.value,{}),{k:o.o(k),l:o.o(b),m:o.o(b),n:o.s("margin-top:60rpx"),o:o.o(y),p:o.p({mode:"fill",background:"#f8f8f8",width:"100%"}),q:o.f(_.value,((e,n,l)=>({a:o.t(e.goods_name),b:e.goods_id,c:o.o((o=>$(e.goods_id,o)),e.goods_id)}))),r:o.o(j),s:o.o(w),t:o.o((o=>u.value=o)),v:o.p({top:"0",width:"100%",height:"100%",visible:u.value}),w:o.p({head_color:"#f5f5f5"})})}},l=o._export_sfc(n,[["__scopeId","data-v-40a389e7"]]);n.__runtimeHooks=2,wx.createPage(l);
