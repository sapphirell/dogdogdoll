"use strict";const o=require("../../common/vendor.js"),e=require("../../common/config.js");if(!Array){(o.resolveComponent("uni-icons")+o.resolveComponent("uni-transition")+o.resolveComponent("goods-search")+o.resolveComponent("common-modal")+o.resolveComponent("common-page"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-transition/components/uni-transition/uni-transition.js")+(()=>"../../components/goods-search/goods-search.js")+(()=>"../../components/common-modal/common-modal.js")+(()=>"../../components/common-page/common-page.js"))();const n={__name:"collocation_square",setup(n){const l=o.ref([]),a=o.ref(!1),t=o.ref(!1),i=o.ref(1),s=o.ref(0),r=o.ref(0),c=o.reactive([0,0]),u=o.ref(!1),d=o.ref(""),v=o.ref([]),g=o.getCurrentInstance(),p=o.ref(null),m=o.ref([]);o.ref(null);const _=o.ref(!1),f=()=>{_.value=!_.value},h=()=>{_.value=!1},x=()=>{h(),o.index.navigateTo({url:"/pages/collocation/collocation"})},y=()=>{h(),o.index.navigateTo({url:"/pages/stock/showcase_form/showcase_form"})},w=o=>{const e=l.value[o];return e.position?{left:`${e.position.left}px`,top:`${e.position.top}px`,width:`${r.value}px`}:{}},b=e=>{if(console.log("进入计算布局逻辑"),!e)return void console.log("无法获取instance");if(console.log("获取成功"),!l.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(e);const n=o.index.createSelectorQuery().in(e.proxy);console.log("获取到query");const a=l.value.map(((o,e)=>new Promise((o=>{n.select(`#card-${e}`).boundingClientRect((n=>{o({index:e,rect:n})}))}))));n.exec((async()=>{console.log("进入Query"),c[0]=0,c[1]=0;const o=await Promise.all(a);o.length?(o.forEach((({index:o,rect:e})=>{if(!e)return void console.error(`卡片${o}元素查询失败`);const n=l.value[o],a=c[0]<=c[1]?0:1,t=a*(r.value+10),i=c[a]+10;c[a]=i+e.height,n.position={left:t,top:i}})),s.value=Math.max(...c)+20):console.warn("未查询到任何卡片元素")}))};o.onMounted((()=>{const e=o.index.getSystemInfoSync();r.value=(e.windowWidth-30)/2}));const j=async(n=!1)=>{if(n&&(l.value=[],i.value=1,t.value=!1,a.value=!1),a.value||t.value)console.log("正在加载或没有更多数据，停止请求");else try{a.value=!0;const s={page:i.value,page_size:10,filter_goods_id_list:m.value.map((o=>o.goods_id))};console.log("请求参数:",JSON.stringify(s,null,2));const r=await o.index.request({url:`${e.websiteUrl}/collocation-list`,method:"POST",data:s,header:{"content-type":"application/json"}});if(console.log("接口响应:",r),"success"===r.data.status){const e=r.data.data||{},a=Array.isArray(e.collocation_relation_list)?e.collocation_relation_list:[];l.value=n?a:[...l.value,...a],t.value=a.length<10,i.value++,n&&0===a.length&&o.index.showToast({title:"暂无相关搭配",icon:"none"}),console.log("等待next tick"),await o.nextTick$1(),console.log("等待完成"),b(g),setTimeout((()=>{console.log("二次计算布局"),b(g)}),500)}}catch(s){console.error("请求失败:",s),o.index.showToast({title:"加载失败",icon:"none"})}finally{a.value=!1}},$=()=>{u.value=!0},T=o=>{if(console.log("选择商品:",o),!(null==o?void 0:o.id))return;const e={goods_id:o.id,goods_name:`${o.brand_name?o.brand_name+"·":""}${o.name}`};m.value.some((o=>o.goods_id===e.goods_id))||(m.value=[...m.value,e])},k=async()=>{u.value=!1,await j(!0)},C=()=>{u.value=!1},S=(o,e)=>{var n;null==(n=null==e?void 0:e.stopPropagation)||n.call(e),m.value=m.value.filter((e=>e.goods_id!==o)),t.value=!1,j(!0)},q=()=>{p.value=null,d.value="",m.value=[],v.value=[]};const z=()=>{t.value||j()};return o.onMounted(j),(e,n)=>o.e({a:o.f(m.value,((e,n,l)=>({a:o.t(e.goods_name),b:e.goods_id,c:o.o((o=>S(e.goods_id,o)),e.goods_id)}))),b:!m.value.length},(m.value.length,{}),{c:o.o($),d:o.o((o=>j(!0))),e:o.s("width:500rpx"),f:o.f(l.value,((e,n,l)=>{var a,t,i;return o.e({a:e.avatar||"/default_avatar.jpg",b:o.t((i=e.username,i.length>10?`${i.toString().slice(-8)}...`:i)),c:"d7642a3b-1-"+l+",d7642a3b-0",d:o.t(e.like_count),e:o.o((n=>{return l=e.uid,void o.index.navigateTo({url:`/pages/user_page/user_page?uid=${l}`});var l}),e.collocation_id),f:(null==(a=e.image_urls)?void 0:a.length)>0},(null==(t=e.image_urls)?void 0:t.length)>0?{g:e.image_urls[0]}:{},{h:o.t(e.title),i:o.t(e.content),j:o.f(e.relation_list,((e,n,l)=>({a:o.t(e.relation_goods_name||"未命名商品"),b:n}))),k:e.collocation_id,l:"card-"+n,m:o.s(w(n)),n:o.o((n=>{return l=e.collocation_id,a=e.origin,void o.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+l+"&origin="+a});var l,a}),e.collocation_id)})})),g:o.p({type:"hand-up",size:"18",color:"#5f85a3"}),h:s.value+"px",i:a.value},(a.value,{}),{j:t.value},(t.value,{}),{k:o.o(z),l:o.p({type:"plusempty",size:"30",color:"#fff"}),m:o.o(f),n:_.value},_.value?{o:o.o(h)}:{},{p:o.p({name:"fade",mode:"out-in",duration:300}),q:o.p({type:"color",size:"24",color:"#5f85a3"}),r:o.o(x),s:o.p({type:"compose",size:"24",color:"#5f85a3"}),t:o.o(y),v:_.value?1:"",w:o.o(C),x:o.o(C),y:o.s("margin-top:60rpx"),z:o.o(T),A:o.p({mode:"fill",background:"#f8f8f8",width:"100%"}),B:o.f(m.value,((e,n,l)=>({a:o.t(e.goods_name),b:e.goods_id,c:o.o((o=>S(e.goods_id,o)),e.goods_id)}))),C:o.o(q),D:o.o(k),E:o.o((o=>u.value=o)),F:o.p({top:"0",width:"100%",height:"100%",visible:u.value}),G:o.p({head_color:"#f5f5f5"})})}},l=o._export_sfc(n,[["__scopeId","data-v-d7642a3b"]]);n.__runtimeHooks=2,wx.createPage(l);
