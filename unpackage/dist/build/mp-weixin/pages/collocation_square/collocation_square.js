"use strict";const o=require("../../common/vendor.js"),e=require("../../common/config.js");if(!Array){(o.resolveComponent("goods-search")+o.resolveComponent("common-modal")+o.resolveComponent("common-page"))()}Math||((()=>"../../components/goods-search/goods-search.js")+(()=>"../../components/common-modal/common-modal.js")+(()=>"../../components/common-page/common-page.js"))();const l={__name:"collocation_square",setup(l){const n=o.ref([]),a=o.ref(!1),t=o.ref(!1),s=o.ref(1),i=o.ref(0),c=o.ref(0),r=o.reactive([0,0]),u=o.ref(!1),d=o.ref(""),v=o.ref([]),g=o.getCurrentInstance(),m=o.ref(null),f=o.ref([]);o.ref(null);const _=o=>{const e=n.value[o];return e.position?{left:`${e.position.left}px`,top:`${e.position.top}px`,width:`${c.value}px`}:{}},p=e=>{if(console.log("进入计算布局逻辑"),!e)return void console.log("无法获取instance");if(console.log("获取成功"),!n.value)return void console.log("无列表数据，不需要计算布局");console.log("获取成功，准备createSelectorQuery"),console.log(e);const l=o.index.createSelectorQuery().in(e.proxy);console.log("获取到query");const a=n.value.map(((o,e)=>new Promise((o=>{l.select(`#card-${e}`).boundingClientRect((l=>{o({index:e,rect:l})}))}))));l.exec((async()=>{console.log("进入Query"),r[0]=0,r[1]=0;const o=await Promise.all(a);o.length?(o.forEach((({index:o,rect:e})=>{if(!e)return void console.error(`卡片${o}元素查询失败`);const l=n.value[o],a=r[0]<=r[1]?0:1,t=a*(c.value+10),s=r[a]+10;r[a]=s+e.height,l.position={left:t,top:s}})),i.value=Math.max(...r)+20):console.warn("未查询到任何卡片元素")}))};o.onMounted((()=>{const e=o.index.getSystemInfoSync();c.value=(e.windowWidth-30)/2}));const h=async(l=!1)=>{if(l&&(n.value=[],s.value=1,t.value=!1,a.value=!1),a.value||t.value)console.log("正在加载或没有更多数据，停止请求");else try{a.value=!0;const i={page:s.value,page_size:10,filter_goods_id_list:f.value.map((o=>o.goods_id))};console.log("请求参数:",JSON.stringify(i,null,2));const c=await o.index.request({url:`${e.websiteUrl}/collocation-list`,method:"POST",data:i,header:{"content-type":"application/json"}});if(console.log("接口响应:",c),"success"===c.data.status){const e=c.data.data||{},a=Array.isArray(e.collocation_relation_list)?e.collocation_relation_list:[];n.value=l?a:[...n.value,...a],t.value=a.length<10,s.value++,l&&0===a.length&&o.index.showToast({title:"暂无相关搭配",icon:"none"}),console.log("等待next tick"),await o.nextTick$1(),console.log("等待完成"),p(g),setTimeout((()=>{console.log("二次计算布局"),p(g)}),500)}}catch(i){console.error("请求失败:",i),o.index.showToast({title:"加载失败",icon:"none"})}finally{a.value=!1}},x=()=>{u.value=!0},y=o=>{if(console.log("选择商品:",o),!(null==o?void 0:o.id))return;const e={goods_id:o.id,goods_name:`${o.brand_name?o.brand_name+"·":""}${o.name}`};f.value.some((o=>o.goods_id===e.goods_id))||(f.value=[...f.value,e])},w=async()=>{u.value=!1,await h(!0)},b=()=>{u.value=!1},$=(o,e)=>{var l;null==(l=null==e?void 0:e.stopPropagation)||l.call(e),f.value=f.value.filter((e=>e.goods_id!==o)),t.value=!1,h(!0)},j=()=>{m.value=null,d.value="",f.value=[],v.value=[]};const q=()=>{t.value||h()};return o.onMounted(h),(e,l)=>o.e({a:o.f(f.value,((e,l,n)=>({a:o.t(e.goods_name),b:e.goods_id,c:o.o((o=>$(e.goods_id,o)),e.goods_id)}))),b:!f.value.length},(f.value.length,{}),{c:o.o(x),d:o.o((o=>h(!0))),e:o.s("width:500rpx"),f:o.f(n.value,((e,l,n)=>({a:e.image_urls[0],b:o.t(e.title),c:o.t(e.content),d:o.f(e.relation_list,((e,l,n)=>({a:o.t(e.relation_goods_name||"未命名商品"),b:l}))),e:e.collocation_id,f:"card-"+l,g:o.s(_(l)),h:o.o((l=>{return n=e.collocation_id,a=e.origin,void o.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+n+"&origin="+a});var n,a}),e.collocation_id)}))),g:i.value+"px",h:a.value},(a.value,{}),{i:t.value},(t.value,{}),{j:o.o(q),k:o.o(b),l:o.o(y),m:o.p({mode:"fill",background:"#f8f8f8",width:"90%"}),n:o.f(f.value,((e,l,n)=>({a:o.t(e.goods_name),b:e.goods_id,c:o.o((o=>$(e.goods_id,o)),e.goods_id)}))),o:o.o(j),p:o.o(w),q:o.o((o=>u.value=o)),r:o.p({visible:u.value}),s:o.p({head_color:"#f5f5f5"})})}},n=o._export_sfc(l,[["__scopeId","data-v-bfa6e4e9"]]);wx.createPage(n);
