"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),n=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("uni-icons")+e.resolveComponent("item-impression")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/item-impression/item-impression.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const t={__name:"goods",props:["goods_id"],setup(t){const a=t;e.index.getSystemInfoSync(),e.ref(!1),e.ref(!1),e.ref("");const i=e.ref(null),s=e.ref(null);e.ref(1);let r=e.ref({}),l=e.ref({}),u=e.ref(1),d=e.ref(!1),c=e.ref(!1),_=e.ref(!1),m=e.ref(!1),g=e.ref(0);const f=e.ref(400),p=e.ref([]),v=e.ref(e.index.upx2px(1e3)),h=({parent:e,target:o})=>{var n;console.log("parent",e),console.log("target",o);let t=e;null!=o&&(t=o),r.value.id!=t.id?(console.log("item",t),r.value=t,null==(n=s.value)||n.focusInput()):r.value={}},y=o=>{var t,s,l;let u=e.index.getStorageSync("token");if(!n.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",r.value);const d={content:o.content,origin:o.origin,target_id:parseInt(a.goods_id),type:2,image_url:o.image_url||"",association_id:o.association_id||0,association_type:o.association_type||0,is_anonymous:o.is_anonymous||0,...r.value.id&&{reply_id:r.value.id,reply_for:r.value.comment,reply_uid:r.value.user_id,parent_id:r.value.parent_id>0?r.value.parent_id:r.value.id}},c={id:Date.now(),content:o.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...o.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:n.global.userInfo.avatar,username:n.global.userInfo.nickname,is_anonymous:0},...o.association_id&&{association_id:o.association_id,association_type:o.association_type},...o.image_url&&{image_url:o.image_url},...r.value.id&&{reply_id:r.value.id,reply_for:r.value.comment,reply_uid:r.value.user_id,parent_id:r.value.parent_id>0?r.value.parent_id:r.value.id,reply_username:r.value.is_anonymous?"匿名用户":r.value.username}};r.value.id?0===r.value.parent_id?null==(s=i.value)||s.addReplyComment({...c,parent_id:r.value.id}):null==(l=i.value)||l.addReplyComment({...c,parent_id:r.value.parent_id}):null==(t=i.value)||t.addNewComment(c),e.index.request({url:n.websiteUrl+"/with-state/add-comment",method:"POST",header:{Authorization:u},data:d,success:t=>{var a,s;if("success"==t.data.status){const s=t.data.data,l={...s,...o.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:n.global.userInfo.avatar,username:n.global.userInfo.nickname,is_anonymous:0}};s.reply_uid&&r.value.is_anonymous&&(l.reply_username="匿名用户"),null==(a=i.value)||a.updateTempComment(c.id,l),e.index.showToast({title:"评论成功",icon:"success"})}else null==(s=i.value)||s.removeTempComment(c.id),e.index.showToast({title:t.data.msg,icon:"none"})},fail:o=>{var n;null==(n=i.value)||n.removeTempComment(c.id),e.index.showToast({title:"网络请求失败",icon:"none"})}})};function b(e){console.log(e.detail.current),u.value=e.detail.current+1}function w(){e.index.request({url:n.websiteUrl+"/goods?id="+a.goods_id,method:"GET",timeout:5e3,success:o=>{console.log(o.data.data),l.value=o.data.data,function(){let o=e.index.getStorageSync("token");e.index.request({url:n.websiteUrl+"/with-state/wish-info?goods_id="+a.goods_id,method:"GET",header:o?{Authorization:o}:{},success:e=>{"success"===e.data.status&&(m.value=e.data.data.user_has_wished,g.value=e.data.data.wish_count)}})}()},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{e.index.hideLoading()}})}function x(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}function T(e){if(!e||e<=0)return"未知";const o=new Date(1e3*e);return`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")} ${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}`}function k(){let o=e.index.getStorageSync("token");""!=o&&e.index.request({url:n.websiteUrl+"/with-state/hasLike?id="+a.goods_id+"&type=1",method:"POST",header:{Authorization:o},success:o=>{console.log(o.data),"success"==o.data.status?o.data.data.id>0?d.value=!0:d.value=!1:e.index.showToast({title:o.data.msg,icon:"none"})},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function S(){e.index.navigateTo({url:"/pages/collocation/collocation?goods_id="+a.goods_id+"&brand_id="+l.value.brand_id+"&goods_name="+l.value.name+"&brand_name="+l.value.brand_name+"&type="+l.value.type})}function I(){if(!(l.value.id&&l.value.name&&l.value.brand_id&&l.value.brand_name&&l.value.type))return void e.index.showToast({title:"商品信息不完整",icon:"none"});const o={goods_id:l.value.id,goods_name:l.value.name,brand_id:l.value.brand_id,brand_name:l.value.brand_name,type:l.value.type},n=Object.keys(o).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(o[e])}`)).join("&");e.index.navigateTo({url:`/pages/stock/showcase_form/showcase_form?${n}`})}function z(e){if(!e)return"";return e.split(",")[0].trim()}function C(){e.index.navigateTo({url:`/pages/stock/account_book_form/account_book_form?goods_id=${a.goods_id}`})}function j(){if(_.value)return;let o=e.index.getStorageSync("token");n.global.isLogin?(_.value=!0,e.index.request({url:n.websiteUrl+"/with-state/wish-restock",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{goods_id:parseInt(a.goods_id)},success:o=>{"success"===o.data.status?(e.index.showToast({title:"许愿成功",icon:"success"}),m.value=!0,g.value=o.data.data.wish_count||g.value+1):e.index.showToast({title:o.data.msg||"许愿失败",icon:"none"})},fail:o=>{console.error("许愿请求失败:",o),e.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{_.value=!1}})):e.index.showToast({title:"请先登录",icon:"none"})}return e.index.showLoading({title:"加载中"}),w(),e.index.request({url:n.websiteUrl+"/goods-collocation?goods_id="+a.goods_id,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),c.value=e.data.data},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}}),n.asyncGetUserInfo().then((e=>{console.log(e),k()})),(t,_)=>e.e({a:e.unref(l).name},e.unref(l).name?e.e({b:e.p({type:e.unref(d)?"heart-filled":"heart",size:"28",color:"#ff4d4f"}),c:e.t(x(e.unref(l).goods_like_count)),d:e.o((o=>function(){let o=e.index.getStorageSync("token");if(!n.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let t={id:parseInt(a.goods_id),type:1},i=d.value?"/with-state/unlike":"/with-state/add-like";e.index.request({url:n.websiteUrl+i,method:"POST",header:{Authorization:o},data:t,success:o=>(console.log(o.data),"success"==o.data.status?(e.index.showToast({title:"操作成功",icon:"success"}),d.value=!d.value,k(),void w()):void e.index.showToast({title:o.data.msg,icon:"none"})),fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}())),e:e.f(e.unref(l).goods_images,((o,n,t)=>({a:o,b:e.n("swiper-image-"+n),c:e.o((o=>{e.index.previewImage({current:l.value.goods_images.index,urls:l.value.goods_images})}),n),d:e.o((o=>function(o){console.log("图片加载完成",o);const n=e.index.createSelectorQuery();setTimeout((()=>{n.select(`.swiper-image-${o}`).boundingClientRect((e=>{try{if(!e)return void console.warn("未找到图片元素");console.log(e),p.value[o]=e.height;const n=p.value.filter((e=>e>0));if(0===n.length)return;const t=Math.max(...n);f.value=Math.min(t,v.value)}catch(n){console.error("高度计算异常:",n)}})).exec()}),20)}(n)),n),e:n}))),f:e.o(b),g:f.value+"px",h:v.value+"px",i:e.t(e.unref(u)),j:e.t(e.unref(l).goods_images.length),k:e.p({type:"plus",size:"18",color:"#fff"}),l:e.o(C),m:e.p({type:"star",size:"18",color:"#fff"}),n:e.o(j),o:e.p({type:"vip",size:"18",color:"#fff"}),p:e.o(I),q:e.unref(l).goods_name_image,r:e.t(e.unref(l).type),s:e.o((o=>{e.unref(l).type})),t:e.unref(l).goods_price_image},e.unref(l).goods_price_image?{v:e.unref(l).goods_price_image}:e.unref(l).goods_sales&&e.unref(l).goods_sales.length>0?{x:e.t(e.unref(l).goods_sales[0].sub_amount+e.unref(l).goods_sales[0].fin_amount),y:e.t(e.unref(l).goods_sales[0].currency)}:{},{w:e.unref(l).goods_sales&&e.unref(l).goods_sales.length>0,z:e.t(e.unref(l).sub_time1>0?T(e.unref(l).sub_time1):"未知"),A:e.t(e.unref(l).size),B:e.t(e.unref(l).size_detail),C:e.o((o=>{e.unref(l).size})),D:"单体"===e.unref(l).type||"整体"===e.unref(l).type||"单头"===e.unref(l).type},"单体"===e.unref(l).type||"整体"===e.unref(l).type||"单头"===e.unref(l).type?{E:e.t(e.unref(l).body_size||"未知")}:{},{F:e.t(e.unref(l).skin),G:e.unref(l).goods_brand_name_image},e.unref(l).goods_brand_name_image?{H:e.o((o=>{return n=e.unref(l).brand_id,void e.index.navigateTo({url:"/pages/brand/brand?brand_id="+n});var n})),I:e.unref(l).goods_brand_name_image}:{},{J:e.t(e.unref(l).doll_material),K:e.t(e.unref(l).desc_content||"暂无备注信息"),L:e.unref(l).goods_sales&&e.unref(l).goods_sales.length>0},e.unref(l).goods_sales&&e.unref(l).goods_sales.length>0?{M:e.f(e.unref(l).goods_sales,((o,n,t)=>e.e({a:e.t(o.sale_type),b:e.t(o.sub_amount+o.fin_amount),c:e.t(o.currency),d:e.t(T(o.sub_time)),e:o.sub_time_end>0},(o.sub_time_end,{}),{f:o.sub_time_end>0},o.sub_time_end>0?{g:e.t(T(o.sub_time_end))}:{},{h:e.t(o.size),i:e.t(o.size_detail),j:"d473a49b-5-"+t,k:e.o((n=>function(o){const n={amount:o.fin_amount,currency:o.currency,name:l.value.name,sale_id:o.id},t=Object.keys(n).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)).join("&");e.index.navigateTo({url:`/pages/stock/bill_form/bill_form?${t}`})}(o)),o.id),l:o.id}))),N:e.p({type:"plus",size:"16",color:"#64c6dc"})}:{},{O:e.p({target_id:a.goods_id,type:"2","goods-type":e.unref(l).type}),P:o._imports_2$3,Q:e.o(S),R:e.f(e.unref(c).collocation_relation_list,((o,n,t)=>({a:z(o.image_urls),b:o.collocation_id,c:e.o((n=>{return t=o.collocation_id,a=o.relation_origin,void e.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+t+"&origin="+a});var t,a}),o.collocation_id)}))),S:e.p({type:"upload",size:"20",color:"#ccc"}),T:e.o(S),U:e.sr(i,"d473a49b-8",{k:"commentListRef"}),V:e.o(h),W:e.p({type:2,"relation-id":parseInt(a.goods_id)}),X:e.sr(s,"d473a49b-9",{k:"commentInputRef"}),Y:e.o(y),Z:e.o((o=>e.isRef(r)?r.value=o:r=o)),aa:e.p({"reply-info":e.unref(r),"target-id":a.goods_id})}):{})}},a=e._export_sfc(t,[["__scopeId","data-v-d473a49b"]]);t.__runtimeHooks=2,wx.createPage(a);
