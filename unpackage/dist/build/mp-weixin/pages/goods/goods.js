"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("uni-icons")+e.resolveComponent("item-impression")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../components/item-impression/item-impression.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const a={__name:"goods",props:["goods_id"],setup(a){const n=a;e.index.getSystemInfoSync(),e.ref(!1),e.ref(!1),e.ref("");const i=e.ref(null),s=e.ref(null);e.ref(1);let l=e.ref({}),r=e.ref({}),u=e.ref(1),d=e.ref(!1),c=e.ref(!1),_=e.ref(!1),m=e.ref(!1),g=e.ref(0);const f=e.ref(400),p=e.ref([]),v=e.ref(e.index.upx2px(1e3)),h=e.ref([]),y=e.ref(1),b=e.ref(!1),w=e.computed((()=>"单头"===r.value.type||"整体"===r.value.type)),x=async()=>{if(w.value){b.value=!0;try{const o=await e.index.request({url:`${t.websiteUrl.value}/rand-bjd-faceup?goods_id=${n.goods_id}&page=${y.value}`,method:"GET",timeout:5e3});"success"===o.data.status?1===y.value?h.value=o.data.data||[]:h.value=[...h.value,...o.data.data||[]]:e.index.showToast({title:o.data.msg||"获取妆图失败",icon:"none"})}catch(o){console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}finally{b.value=!1}}},T=()=>{x()},k=e=>{if(!e)return"";return e.split(",")[0].trim()},z=({parent:e,target:o})=>{var t;console.log("parent",e),console.log("target",o);let a=e;null!=o&&(a=o),l.value.id!=a.id?(console.log("item",a),l.value=a,null==(t=s.value)||t.focusInput()):l.value={}},S=o=>{var a,s,r;let u=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",l.value);const d={content:o.content,origin:o.origin,target_id:parseInt(n.goods_id),type:2,image_url:o.image_url||"",association_id:o.association_id||0,association_type:o.association_type||0,is_anonymous:o.is_anonymous||0,...l.value.id&&{reply_id:l.value.id,reply_for:l.value.comment,reply_uid:l.value.user_id,parent_id:l.value.parent_id>0?l.value.parent_id:l.value.id}},c={id:Date.now(),content:o.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...o.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:t.global.userInfo.avatar,username:t.global.userInfo.nickname,is_anonymous:0},...o.association_id&&{association_id:o.association_id,association_type:o.association_type},...o.image_url&&{image_url:o.image_url},...l.value.id&&{reply_id:l.value.id,reply_for:l.value.comment,reply_uid:l.value.user_id,parent_id:l.value.parent_id>0?l.value.parent_id:l.value.id,reply_username:l.value.is_anonymous?"匿名用户":l.value.username}};l.value.id?0===l.value.parent_id?null==(s=i.value)||s.addReplyComment({...c,parent_id:l.value.id}):null==(r=i.value)||r.addReplyComment({...c,parent_id:l.value.parent_id}):null==(a=i.value)||a.addNewComment(c),e.index.request({url:t.websiteUrl.value+"/with-state/add-comment",method:"POST",header:{Authorization:u},data:d,success:a=>{var n,s;if("success"==a.data.status){const s=a.data.data,r={...s,...o.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:t.global.userInfo.avatar,username:t.global.userInfo.nickname,is_anonymous:0}};s.reply_uid&&l.value.is_anonymous&&(r.reply_username="匿名用户"),null==(n=i.value)||n.updateTempComment(c.id,r),e.index.showToast({title:"评论成功",icon:"success"})}else null==(s=i.value)||s.removeTempComment(c.id),e.index.showToast({title:a.data.msg,icon:"none"})},fail:o=>{var t;null==(t=i.value)||t.removeTempComment(c.id),e.index.showToast({title:"网络请求失败",icon:"none"})}})},j=e.computed((()=>{if(!r.value.sizes||0===r.value.sizes.length)return[];const e={};return r.value.sizes.forEach((o=>{const t=o.goods_size;e[t]||(e[t]=[]),o.size_detail&&e[t].push(o.size_detail)})),Object.keys(e).map((o=>({category:o,details:e[o]})))}));function $(e){console.log(e.detail.current),u.value=e.detail.current+1}function I(){e.index.request({url:t.websiteUrl.value+"/goods?id="+n.goods_id,method:"GET",timeout:5e3,success:o=>{console.log(o.data.data),r.value=o.data.data,function(){let o=e.index.getStorageSync("token");e.index.request({url:t.websiteUrl.value+"/with-state/wish-info?goods_id="+n.goods_id,method:"GET",header:o?{Authorization:o}:{},success:e=>{"success"===e.data.status&&(m.value=e.data.data.user_has_wished,g.value=e.data.data.wish_count)}})}(),w.value&&(y.value=1,x())},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{e.index.hideLoading()}})}function C(e){if(e<1e3)return e.toString();return`${Math.floor(e/1e3)}k+`}function q(e){if(!e||e<=0)return"未知";const o=new Date(1e3*e);return`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")} ${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}`}function U(){let o=e.index.getStorageSync("token");""!=o&&e.index.request({url:t.websiteUrl.value+"/with-state/hasLike?id="+n.goods_id+"&type=1",method:"POST",header:{Authorization:o},success:o=>{console.log(o.data),"success"==o.data.status?o.data.data.id>0?d.value=!0:d.value=!1:e.index.showToast({title:o.data.msg,icon:"none"})},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}function L(){e.index.navigateTo({url:"/pages/collocation/collocation?goods_id="+n.goods_id+"&brand_id="+r.value.brand_id+"&goods_name="+r.value.name+"&brand_name="+r.value.brand_name+"&type="+r.value.type})}function M(){if(!(r.value.id&&r.value.name&&r.value.brand_id&&r.value.brand_name&&r.value.type))return void e.index.showToast({title:"商品信息不完整",icon:"none"});const o={goods_id:r.value.id,goods_name:r.value.name,brand_id:r.value.brand_id,brand_name:r.value.brand_name,type:r.value.type},t=Object.keys(o).map((e=>`${e}=${o[e]}`)).join("&");e.index.navigateTo({url:`/pages/stock/showcase_form/showcase_form?${t}`})}function O(e){if(!e)return"";return e.split(",")[0].trim()}function A(){e.index.navigateTo({url:`/pages/stock/account_book_form/account_book_form?goods_id=${n.goods_id}`})}function R(){if(_.value)return;let o=e.index.getStorageSync("token");t.global.isLogin?(_.value=!0,e.index.request({url:t.websiteUrl.value+"/with-state/wish-restock",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{goods_id:parseInt(n.goods_id)},success:o=>{"success"===o.data.status?(e.index.showToast({title:"许愿成功",icon:"success"}),m.value=!0,g.value=o.data.data.wish_count||g.value+1):e.index.showToast({title:o.data.msg||"许愿失败",icon:"none"})},fail:o=>{console.error("许愿请求失败:",o),e.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{_.value=!1}})):e.index.showToast({title:"请先登录",icon:"none"})}return e.index.showLoading({title:"加载中"}),I(),e.index.request({url:t.websiteUrl.value+"/goods-collocation?goods_id="+n.goods_id,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),c.value=e.data.data},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}}),t.asyncGetUserInfo().then((e=>{console.log(e),U()})),(a,_)=>e.e({a:e.unref(r).name},e.unref(r).name?e.e({b:e.p({type:e.unref(d)?"heart-filled":"heart",size:"28",color:"#ff4d4f"}),c:e.t(C(e.unref(r).goods_like_count)),d:e.o((o=>function(){let o=e.index.getStorageSync("token");if(!t.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});let a={id:parseInt(n.goods_id),type:1},i=d.value?"/with-state/unlike":"/with-state/add-like";e.index.request({url:t.websiteUrl.value+i,method:"POST",header:{Authorization:o},data:a,success:o=>(console.log(o.data),"success"==o.data.status?(e.index.showToast({title:"操作成功",icon:"success"}),d.value=!d.value,U(),void I()):void e.index.showToast({title:o.data.msg,icon:"none"})),fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}())),e:e.f(e.unref(r).goods_images,((o,t,a)=>({a:o,b:e.n("swiper-image-"+t),c:e.o((o=>function(o){console.log("图片加载完成",o);const t=e.index.createSelectorQuery();setTimeout((()=>{t.select(`.swiper-image-${o}`).boundingClientRect((e=>{try{if(!e)return void console.warn("未找到图片元素");console.log(e),p.value[o]=e.height;const t=p.value.filter((e=>e>0));if(0===t.length)return;const a=Math.max(...t);f.value=Math.min(a,v.value)}catch(t){console.error("高度计算异常:",t)}})).exec()}),20)}(t)),t),d:t,e:void e.index.previewImage({current:r.value.goods_images.index,urls:r.value.goods_images})}))),f:e.o($),g:f.value+"px",h:v.value+"px",i:e.t(e.unref(u)),j:e.t(e.unref(r).goods_images.length),k:e.p({type:"plus",size:"18",color:"#fff"}),l:e.o(A),m:e.p({type:"star",size:"18",color:"#fff"}),n:e.o(R),o:e.p({type:"vip",size:"18",color:"#fff"}),p:e.o(M),q:e.unref(r).goods_name_image,r:e.t(e.unref(r).type),s:e.o((o=>{e.unref(r).type})),t:e.unref(r).goods_price_image},e.unref(r).goods_price_image?{v:e.unref(r).goods_price_image}:e.unref(r).goods_sales&&e.unref(r).goods_sales.length>0?{x:e.t(e.unref(r).goods_sales[0].sub_amount+e.unref(r).goods_sales[0].fin_amount),y:e.t(e.unref(r).goods_sales[0].currency)}:{},{w:e.unref(r).goods_sales&&e.unref(r).goods_sales.length>0,z:e.t(e.unref(r).sub_time1>0?q(e.unref(r).sub_time1):"未知"),A:e.unref(r).sizes&&e.unref(r).sizes.length>0},e.unref(r).sizes&&e.unref(r).sizes.length>0?{B:e.f(j.value,((o,t,a)=>({a:e.t(o.category),b:e.t(o.details.join("、")),c:t})))}:{C:e.t(e.unref(r).size),D:e.t(e.unref(r).size_detail)},{E:e.o((o=>{e.unref(r).size})),F:"单体"===e.unref(r).type||"整体"===e.unref(r).type||"单头"===e.unref(r).type},"单体"===e.unref(r).type||"整体"===e.unref(r).type||"单头"===e.unref(r).type?{G:e.t(e.unref(r).body_size||"未知")}:{},{H:e.t(e.unref(r).skin),I:e.unref(r).goods_brand_name_image},e.unref(r).goods_brand_name_image?{J:e.o((o=>{return t=e.unref(r).brand_id,void e.index.navigateTo({url:"/pages/brand/brand?brand_id="+t});var t})),K:e.unref(r).goods_brand_name_image}:{},{L:e.t(e.unref(r).doll_material),M:e.t(e.unref(r).desc_content||"暂无备注信息"),N:e.unref(r).goods_sales&&e.unref(r).goods_sales.length>0},e.unref(r).goods_sales&&e.unref(r).goods_sales.length>0?{O:e.f(e.unref(r).goods_sales,((o,t,a)=>e.e({a:e.t(o.sale_type),b:e.t(o.sub_amount+o.fin_amount),c:e.t(o.currency),d:e.t(q(o.sub_time)),e:o.sub_time_end>0},(o.sub_time_end,{}),{f:o.sub_time_end>0},o.sub_time_end>0?{g:e.t(q(o.sub_time_end))}:{},{h:e.t(o.size),i:e.t(o.size_detail),j:"e2a163cb-5-"+a,k:e.o((t=>function(o){const t={amount:o.fin_amount,currency:o.currency,name:r.value.name,sale_id:o.id},a=Object.keys(t).map((e=>`${e}=${t[e]}`)).join("&");e.index.navigateTo({url:`/pages/stock/bill_form/bill_form?${a}`})}(o)),o.id),l:o.id}))),P:e.p({type:"plus",size:"16",color:"#64c6dc"})}:{},{Q:e.p({target_id:n.goods_id,type:"2","goods-type":e.unref(r).type}),R:o._imports_2$2,S:e.o(L),T:e.f(e.unref(c).collocation_relation_list,((o,t,a)=>({a:O(o.image_urls),b:o.collocation_id,c:e.o((t=>{return a=o.collocation_id,n=o.relation_origin,void e.index.navigateTo({url:"/pages/collocation_share/collocation_share?collocation_id="+a+"&origin="+n});var a,n}),o.collocation_id)}))),U:e.p({type:"upload",size:"20",color:"#ccc"}),V:e.o(L),W:w.value},w.value?{X:e.p({type:"refreshempty",size:"16",color:"#64c6dc"}),Y:e.o(T),Z:e.f(h.value,((o,t,a)=>({a:k(o.face_up_image_urls),b:e.t(o.title),c:t,d:e.o((t=>{return a=o.id,void e.index.navigateTo({url:"/pages/artwork/artwork?id="+a});var a}),t)})))}:{},{aa:e.sr(i,"e2a163cb-9",{k:"commentListRef"}),ab:e.o(z),ac:e.p({type:2,"relation-id":parseInt(n.goods_id)}),ad:e.sr(s,"e2a163cb-10",{k:"commentInputRef"}),ae:e.o(S),af:e.o((o=>e.isRef(l)?l.value=o:l=o)),ag:e.p({"reply-info":e.unref(l),"target-id":n.goods_id})}):{})}},n=e._export_sfc(a,[["__scopeId","data-v-e2a163cb"]]);a.__runtimeHooks=2,wx.createPage(n);
