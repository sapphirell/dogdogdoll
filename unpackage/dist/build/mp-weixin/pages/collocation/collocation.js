"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),n=require("../../common/config.js"),a=require("../../common/image.js");if(!Array){e.resolveComponent("relation-picker")()}Math;const t={__name:"collocation",props:["goods_id","goods_name","brand_id","brand_name","type"],setup(t){const i=t,s=e.ref([]),d=e.ref([]),l=e.ref([]),r=e.ref(!1);e.ref(""),e.ref(0),e.ref(""),e.ref(0),e.ref("");const c=o=>{try{const n={goods_id:o.goods.id||0,goods_name:o.goods.name,goods_image:o.goods.image||"",brand_id:o.brand.id||0,brand_name:o.brand.name||(o.isFuzzy?"":"未知品牌"),type:o.type||(o.isFuzzy?"未知类型":"")};m.value.some((e=>0!==e.goods_id&&e.goods_id===n.goods_id||e.goods_name===n.goods_name))?e.index.showToast({title:"已存在相同关联项",icon:"none"}):m.value.push(n)}catch(n){console.error("保存关联数据失败:",n),e.index.showToast({title:"保存关联信息失败",icon:"none"})}},u=()=>{console.log("用户取消选择")},g=()=>{r.value=!0};const m=e.ref([]);var _;i.goods_id&&i.goods_name&&i.brand_id&&i.brand_name&&i.type&&(_=i.goods_id,new Promise(((o,a)=>{e.index.request({url:n.websiteUrl+"/goods?id="+_,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),o(e.data)},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"}),a(o)},complete:()=>{e.index.hideLoading()}})}))).then((e=>{let o={brand_id:parseInt(i.brand_id,10),goods_id:parseInt(i.goods_id,10),brand_name:i.brand_name,goods_name:i.goods_name,goods_image:e.data.goods_images[0],type:i.type};console.log(o),m.value.push(o)}));const v=e.ref(""),p=e.ref("");function h(o){e.index.previewImage({current:s.value[o],urls:s.value})}function f(){const o=e.index.getStorageSync("token");if(!o)return void e.index.showToast({title:"请先登录",icon:"none"});if(!v.value.trim())return void e.index.showToast({title:"标题不能为空",icon:"none"});if(0===s.value.length)return void e.index.showToast({title:"请至少上传一张图片",icon:"none"});let a=n.getScene();const t={title:v.value,content:p.value,image_url_list:s.value,scene:a,relations:m.value.map((e=>({relation_goods_id:e.goods_id,relation_goods_name:e.goods_name,relation_brand_id:e.brand_id,relation_brand_name:e.brand_name,type:e.type,relation_origin:1})))};console.log(t),e.index.request({url:n.websiteUrl+"/with-state/add-collocation",method:"POST",data:t,header:{"Content-Type":"application/json",Authorization:o},timeout:5e3,success:o=>{"success"===o.data.status?(e.index.showToast({title:"提交成功"}),v.value="",p.value="",s.value=[],m.value=[],e.index.navigateBack()):e.index.showToast({title:o.data.msg||"提交失败",icon:"none"})},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}return e.index.request({url:n.websiteUrl+"/goods-types",method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),l.value=e.data.data},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}}),(t,i)=>({a:e.f(s.value,((o,n,a)=>({a:o,b:e.o(h,n),c:e.o((e=>function(e){s.value.splice(e,1)}(n)),n),d:n}))),b:o._imports_1$6,c:o._imports_1$5,d:e.o((o=>async function(){try{const o=await a.chooseImageList(9);for(const e of o){const o=await a.getQiniuToken();await a.uploadImageToQiniu(e,o.token,o.path),s.value.push(n.image1Url+o.path)}e.index.showToast({title:`成功上传${o.length}张图片`,icon:"success"})}catch(o){console.error("上传出错:",o),e.index.showToast({title:"部分图片上传失败",icon:"none"})}}(t.index))),e:v.value,f:e.o((e=>v.value=e.detail.value)),g:p.value,h:e.o((e=>p.value=e.detail.value)),i:o._imports_2$3,j:e.o(g),k:e.f(m.value,((o,n,a)=>e.e({a:o.goods_image},o.goods_image?{b:o.goods_image}:{},{c:e.t(o.type),d:e.t(o.brand_name),e:e.t(o.goods_name),f:e.o((e=>function(e){m.value.splice(e,1)}(n)),n),g:n}))),l:o._imports_1$6,m:e.o(c),n:e.o(u),o:e.o((e=>r.value=e)),p:e.p({typeList:l.value,goodsList:d.value,visible:r.value}),q:e.o(f)})}};wx.createPage(t);
