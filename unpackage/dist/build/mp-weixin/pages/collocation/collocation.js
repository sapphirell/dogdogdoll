"use strict";const o=require("../../common/vendor.js"),e=require("../../common/assets.js"),a=require("../../common/config.js"),t=require("../../common/image.js");if(!Array){(o.resolveComponent("view-logs")+o.resolveComponent("relation-picker"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../components/relation-picker/relation-picker.js"))();const n={__name:"collocation",props:["goods_id","goods_name","brand_id","brand_name","type","collocation_id"],setup(n){const i=n,s=o.ref(!1),l=o.ref([]),d=o.ref([]),r=o.ref([]),c=o.ref(!1),u=o.ref([]),_=o.ref(""),g=o.ref("");o.onMounted((()=>{var e;o.index.request({url:a.websiteUrl.value+"/goods-types",method:"GET",timeout:5e3,success:o=>{o.data&&o.data.data&&(r.value=o.data.data)},fail:e=>{console.log(e),o.index.showToast({title:"获取商品类型失败",icon:"none"})}}),i.collocation_id&&(s.value=!0,async function(){if(i.collocation_id)try{const e=await o.index.request({url:`${a.websiteUrl.value}/view-collocation?collocation_id=${i.collocation_id}&origin=1`,method:"GET",timeout:5e3});if("success"===e.data.status){const o=e.data.data;_.value=o.title||"",g.value=o.content||"",l.value=o.image_url_list||[],o.collocation_relation_list&&o.collocation_relation_list.length>0&&(u.value=o.collocation_relation_list.map((o=>({goods_id:o.relation_goods_id,goods_name:o.relation_goods_name,brand_id:o.relation_brand_id,brand_name:o.relation_brand_name,type:o.type,goods_image:o.relation_goods_image||""}))))}}catch(e){console.error("获取搭配详情失败:",e),o.index.showToast({title:"加载搭配详情失败",icon:"none"})}}()),i.goods_id&&i.goods_name&&i.brand_id&&i.brand_name&&i.type&&(e=i.goods_id,new Promise(((t,n)=>{o.index.request({url:a.websiteUrl.value+"/goods?id="+e,method:"GET",timeout:5e3,success:o=>{t(o.data)},fail:e=>{console.log(e),o.index.showToast({title:"网络请求失败",icon:"none"}),n(e)}})}))).then((o=>{let e={brand_id:parseInt(i.brand_id,10),goods_id:parseInt(i.goods_id,10),brand_name:i.brand_name,goods_name:i.goods_name,goods_image:o.data.goods_images[0],type:i.type};u.value.some((o=>o.goods_id===e.goods_id&&o.brand_id===e.brand_id))||u.value.push(e)}))}));const m=e=>{try{const a={goods_id:e.goods.id||0,goods_name:e.goods.name,goods_image:e.goods.image||"",brand_id:e.brand.id||0,brand_name:e.brand.name||(e.isFuzzy?"":"未知品牌"),type:e.type||(e.isFuzzy?"未知类型":"")};u.value.some((o=>0!==o.goods_id&&o.goods_id===a.goods_id||o.goods_name===a.goods_name))?o.index.showToast({title:"已存在相同关联项",icon:"none"}):u.value.push(a)}catch(a){console.error("保存关联数据失败:",a),o.index.showToast({title:"保存关联信息失败",icon:"none"})}},v=()=>{console.log("用户取消选择")},p=()=>{c.value=!0};async function h(){try{const e=9-l.value.length;if(e<=0)return void o.index.showToast({title:"最多只能上传9张图片",icon:"none"});const n=await t.chooseImageList(e);for(const o of n){const e=await t.getQiniuToken();await t.uploadImageToQiniu(o,e.token,e.path),l.value.push(a.image1Url+e.path)}o.index.showToast({title:`成功上传${n.length}张图片`,icon:"success"})}catch(e){console.error("上传出错:",e),o.index.showToast({title:"部分图片上传失败",icon:"none"})}}async function w(){const e=o.index.getStorageSync("token");if(!e)return void o.index.showToast({title:"请先登录",icon:"none"});if(!_.value.trim())return void o.index.showToast({title:"标题不能为空",icon:"none"});if(0===l.value.length)return void o.index.showToast({title:"请至少上传一张图片",icon:"none"});const t={title:_.value,content:g.value,image_url_list:l.value,relations:u.value.map((o=>({relation_goods_id:o.goods_id,relation_goods_name:o.goods_name,relation_brand_id:o.brand_id,relation_brand_name:o.brand_name,type:o.type,relation_origin:1})))};s.value&&(t.collocation_id=parseInt(i.collocation_id));try{const n=s.value?a.websiteUrl.value+"/with-state/update-collocation":a.websiteUrl.value+"/with-state/add-collocation",i=await o.index.request({url:n,method:"POST",data:t,header:{"Content-Type":"application/json",Authorization:e},timeout:8e3});"success"===i.data.status?(o.index.showToast({title:s.value?"更新成功":"提交成功"}),setTimeout((()=>o.index.navigateBack()),1500)):o.index.showToast({title:i[1].data.msg||(s.value?"更新失败":"提交失败"),icon:"none"})}catch(n){console.log(n),o.index.showToast({title:"网络请求失败",icon:"none"})}}return(a,t)=>o.e({a:o.f(l.value,((e,a,t)=>({a:e,b:o.o((e=>function(e){o.index.previewImage({current:l.value[e],urls:l.value})}(a)),a),c:o.o((o=>function(o){l.value.splice(o,1)}(a)),a),d:a}))),b:e._imports_1$5,c:l.value.length<9},l.value.length<9?{d:e._imports_1$4,e:o.o(h)}:{},{f:_.value,g:o.o((o=>_.value=o.detail.value)),h:g.value,i:o.o((o=>g.value=o.detail.value)),j:e._imports_2$2,k:o.o(p),l:o.f(u.value,((e,a,t)=>o.e({a:e.goods_image},e.goods_image?{b:e.goods_image}:{},{c:o.t(e.type),d:o.t(e.brand_name),e:o.t(e.goods_name),f:o.o((o=>function(o){u.value.splice(o,1)}(a)),a),g:a}))),m:e._imports_1$5,n:o.o(m),o:o.o(v),p:o.o((o=>c.value=o)),q:o.p({typeList:r.value,goodsList:d.value,visible:c.value}),r:o.t(s.value?"更新":"提交"),s:o.o(w)})}};wx.createPage(n);
