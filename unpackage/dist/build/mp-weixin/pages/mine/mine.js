"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),o=require("../../common/config.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const n={__name:"mine",setup(n){e.useCssVars((e=>({"529bdb46":q.value}))),console.log(o.global.isLogin),console.log(o.global.userInfo);let a=e.ref(""),i=e.ref(""),s=e.ref(0),r=e.ref(0),l=e.ref(0);e.ref(!1);let c=o.getScene(),u=e.ref(!1);function d(e){u.value=e.detail.value.length>0}function g(){e.index.navigateTo({url:"/pages/private/private"})}function f(){e.index.navigateTo({url:"/pages/permission/permission"})}function h(){e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),o.global.isLogin=!1}function p(){e.index.navigateTo({url:"/pages/register/register"})}function m(){e.index.navigateTo({url:"/pages/user_like/user_like"})}function x(){e.index.showTabBar({animation:!1}),e.index.switchTab({url:"/pages/index/index"})}function w(){e.index.navigateTo({url:"/pages/my_comment/my_comment"})}function v(){e.index.navigateTo({url:"/pages/message_list/message_list"})}function _(){e.index.navigateTo({url:"/pages/reset_password/reset_password"})}function y(){e.index.navigateTo({url:"/pages/my_collocation/my_collocation"})}function S(){new Promise((t=>{e.index.chooseImage({count:1,success:e=>{t(e.tempFilePaths[0])}})})).then((t=>{e.index.navigateTo({url:`/pages/pop_croper/pop_croper?src=${decodeURIComponent(t)}`})}))}function T(t){console.log("croperPath:"+t);let n=e.index.getStorageSync("token"),a="";e.index.request({url:o.websiteUrl+"/with-state/qiniu-token",method:"POST",header:{Authorization:n},success:n=>{if(null==n.data.data||""==n.data.data.token)return void e.index.showToast({title:"获取上传凭证失败",icon:"none"});a=n.data.data.token,console.log("获取到的七牛token："+n.data.data.token);let i=e.index.getStorageSync("userInfo");console.log(i);let s=n.data.data.path;console.log("fileName:"+s),e.index.uploadFile({url:"https://up-cn-east-2.qiniup.com",name:"file",method:"POST",filePath:t,fileType:"image",formData:{token:a,key:s,scope:"hobby-box:"+s},success:t=>{console.log("上传成功"),function(t,n){let a=e.index.getStorageSync("token");e.index.getStorageSync("userInfo"),e.index.request({url:o.websiteUrl+"/with-state/update-profile",method:"POST",header:{Authorization:a},data:{avatar:n},success:e=>{console.log("更新成功"),o.getUserInfo()},fail:t=>{e.index.showToast({title:"更新失败",icon:"none"})}})}(0,"https://images1.fantuanpu.com/"+s)},fail:t=>{console.log(t),e.index.showToast({title:"上传失败",icon:"none"})}})},fail:t=>{e.index.showToast({title:"获取上传凭证失败",icon:"none"})}})}function b(){if(!u.value)return void e.index.showToast({title:"请先阅读并同意协议",icon:"none"});if(""==i.value||""==a.value)return void e.index.showToast({title:"请输入手机号和密码",icon:"none"});if(!/^1[3456789]\d{9}$/.test(a.value))return void e.index.showToast({title:"手机号格式错误",icon:"none"});if(i.value.length<6)return void e.index.showToast({title:"密码必须大于6位",icon:"none"});let t=a.value,n=i.value;e.index.request({url:o.websiteUrl+"/login",method:"POST",data:{account:t,password:n},success:t=>{console.log(t);let n=t.data.data;"success"==t.data.status?(e.index.setStorageSync("token",n.jwt_token),e.index.setStorageSync("openid",n.open_id),e.index.setStorageSync("session_key",n.session_key),console.log("jwt:"+n.jwt_token),null!=n.jwt_token&&""!=n.jwt_token&&o.getUserInfo()):e.index.showToast({title:t.data.msg,icon:"none"})},fail:t=>{e.index.showToast({title:"登录失败",icon:"none"})}})}function k(){e.index.navigateTo({url:"/pages/setting/setting"})}const I=e.index.getSystemInfoSync(),P=e.computed((()=>{const t=e.index.getMenuButtonBoundingClientRect(),o=I.statusBarHeight||32;return t.bottom+t.top-2*o})),q=e.computed((()=>P.value+"px"));return e.watch((()=>o.global.isLogin),(t=>{console.log("watch",t),t?e.index.showTabBar({animation:!1}):e.index.hideTabBar({animation:!1})})),e.onShow((()=>{o.getUserInfo(),o.global.isLogin?e.index.showTabBar({animation:!1}):e.index.hideTabBar({animation:!1}),(async()=>{try{const t=await e.index.request({url:`${o.websiteUrl}/with-state/unread-message-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===t.data.status&&(s.value=t.data.data.count)}catch(t){console.log(t),e.index.showToast({title:"未读数获取失败",icon:"none"})}})(),(async()=>{try{const t=await e.index.request({url:`${o.websiteUrl}/with-state/user-likes-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===t.data.status&&(r.value=t.data.data.count)}catch(t){console.log(t),e.index.showToast({title:"关注数获取失败",icon:"none"})}})(),(async()=>{try{const t=await e.index.request({url:`${o.websiteUrl}/with-state/my-collocation-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===t.data.status&&(l.value=t.data.data)}catch(t){console.log(t),e.index.showToast({title:"搭配数获取失败",icon:"none"})}})();const t=getCurrentPages(),n=t[t.length-1];n.returnParam&&T(n.returnParam)})),(n,T)=>e.e({a:e.s(n.__cssVars()),b:e.unref(o.global).isLogin},e.unref(o.global).isLogin?{c:e.unref(o.global).userInfo.avatar,d:e.o(S),e:e.t(e.unref(o.global).userInfo.username),f:e.t(e.unref(o.global).userInfo.id),g:t._imports_0$4,h:e.t(e.unref(r)),i:e.o(m),j:t._imports_1$3,k:e.t(e.unref(s)),l:e.o(v),m:t._imports_2$2,n:e.t(e.unref(l)),o:e.o(y),p:e.p({type:"chatboxes",size:"24",color:"#606060"}),q:e.p({type:"right",size:"24",color:"#c0c0c0"}),r:e.o(w),s:e.p({type:"gear",size:"24",color:"#606060"}),t:e.p({type:"right",size:"24",color:"#c0c0c0"}),v:e.o(k),w:e.p({type:"arrow-right",size:"24",color:"#606060"}),x:e.p({type:"right",size:"24",color:"#c0c0c0"}),y:e.o(h)}:e.e({z:t._imports_3$1,A:e.unref(a),B:e.o((t=>e.isRef(a)?a.value=t.detail.value:a=t.detail.value)),C:t._imports_4,D:e.unref(i),E:e.o((t=>e.isRef(i)?i.value=t.detail.value:i=t.detail.value)),F:e.o(p),G:e.o(_),H:e.o(b),I:4==e.unref(c)},4==e.unref(c)?{J:e.o(((...t)=>e.unref(o.wechatSignLogin)&&e.unref(o.wechatSignLogin)(...t)))}:{},{K:e.o(x),L:e.unref(u),M:e.o(d),N:e.o(g),O:e.o(f)}),{P:e.s(n.__cssVars())})}},a=e._export_sfc(n,[["__scopeId","data-v-2619562a"]]);wx.createPage(a);
