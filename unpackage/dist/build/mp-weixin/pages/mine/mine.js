"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../common/config.js");if(!Array){e.resolveComponent("common-page")()}Math;const n={__name:"mine",setup(n){console.log(t.global.isLogin),console.log(t.global.userInfo);let a=e.ref(""),i=e.ref("");function s(){e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),t.global.isLogin=!1}function r(){}function l(){new Promise((o=>{e.index.chooseImage({count:1,success:e=>{o(e.tempFilePaths[0])}})})).then((o=>{e.index.navigateTo({url:`/pages/pop_croper/pop_croper?src=${decodeURIComponent(o)}`})}))}function u(o){console.log("croperPath:"+o);let n=e.index.getStorageSync("token"),a="";e.index.request({url:t.websiteUrl+"/with-state/qiniu-token",method:"POST",header:{Authorization:n},success:n=>{if(null==n.data.data||""==n.data.data.token)return void e.index.showToast({title:"获取上传凭证失败",icon:"none"});a=n.data.data.token,console.log("获取到的七牛token："+n.data.data.token);let i=e.index.getStorageSync("userInfo");console.log(i);let s=n.data.data.path;console.log("fileName:"+s),e.index.uploadFile({url:"https://up-cn-east-2.qiniup.com",name:"file",method:"POST",filePath:o,fileType:"image",formData:{token:a,key:s,scope:"hobby-box:"+s},success:o=>{console.log("上传成功"),function(o,n){let a=e.index.getStorageSync("token");e.index.getStorageSync("userInfo"),e.index.request({url:t.websiteUrl+"/with-state/update-profile",method:"POST",header:{Authorization:a},data:{avatar:n},success:e=>{console.log("更新成功"),t.getUserInfo()},fail:o=>{e.index.showToast({title:"更新失败",icon:"none"})}})}(0,"https://images1.fantuanpu.com/"+s)},fail:o=>{e.index.showToast({title:"上传失败",icon:"none"})}})},fail:o=>{e.index.showToast({title:"获取上传凭证失败",icon:"none"})}})}function c(){if(""==i.value||""==a.value)return void e.index.showToast({title:"请输入手机号和密码",icon:"none"});if(!/^1[3456789]\d{9}$/.test(a.value))return void e.index.showToast({title:"手机号格式错误",icon:"none"});if(i.value.length<6)return void e.index.showToast({title:"密码必须大于6位",icon:"none"});let o=a.value,n=i.value;e.index.request({url:t.websiteUrl+"/login",method:"POST",data:{account:o,password:n},success:o=>{console.log(o);let n=o.data.data;"success"==o.data.status?(e.index.setStorageSync("token",n.jwt_token),e.index.setStorageSync("openid",n.open_id),e.index.setStorageSync("session_key",n.session_key),console.log("jwt:"+n.jwt_token),null!=n.jwt_token&&""!=n.jwt_token&&t.getUserInfo()):e.index.showToast({title:o.data.msg,icon:"none"})},fail:o=>{e.index.showToast({title:"登录失败",icon:"none"})}})}function d(){e.index.navigateTo({url:"/pages/setting/setting"})}return e.onShow((()=>{t.getUserInfo();const e=getCurrentPages(),o=e[e.length-1];o.returnParam&&u(o.returnParam)})),(n,u)=>e.e({a:e.unref(t.global).isLogin},e.unref(t.global).isLogin?{b:e.unref(t.global).userInfo.avatar,c:e.o(l),d:e.t(e.unref(t.global).userInfo.username),e:e.t(e.unref(t.global).userInfo.id),f:o._imports_0$2,g:o._imports_0$3,h:o._imports_2$1,i:o._imports_0$3,j:e.o(d),k:o._imports_3$1,l:o._imports_0$3,m:e.o(s)}:{n:e.unref(a),o:e.o((o=>e.isRef(a)?a.value=o.detail.value:a=o.detail.value)),p:e.unref(i),q:e.o((o=>e.isRef(i)?i.value=o.detail.value:i=o.detail.value)),r:e.o(r),s:e.o(((...e)=>n.jump2forgetPassword&&n.jump2forgetPassword(...e))),t:e.o(c),v:e.o(((...o)=>e.unref(t.wechatSignLogin)&&e.unref(t.wechatSignLogin)(...o)))},{w:e.p({head_color:"#e0f3ff"})})}},a=e._export_sfc(n,[["__scopeId","data-v-edcd28a4"]]);wx.createPage(a);
