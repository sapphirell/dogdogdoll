"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../common/config.js");if(!Array){e.resolveComponent("common-page")()}Math;const n={__name:"mine",setup(n){console.log(t.global.isLogin),console.log(t.global.userInfo);let a=e.ref(""),i=e.ref(""),s=e.ref(0),r=e.ref(0),l=e.ref(0);function c(){e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),t.global.isLogin=!1}function u(){e.index.navigateTo({url:"/pages/register/register"})}function d(){e.index.navigateTo({url:"/pages/user_like/user_like"})}function g(){e.index.showTabBar({animation:!1}),e.index.switchTab({url:"/pages/index/index"})}function f(){e.index.navigateTo({url:"/pages/my_comment/my_comment"})}function m(){e.index.navigateTo({url:"/pages/message_list/message_list"})}function h(){e.index.navigateTo({url:"/pages/reset_password/reset_password"})}function p(){e.index.navigateTo({url:"/pages/my_collocation/my_collocation"})}function x(){new Promise((o=>{e.index.chooseImage({count:1,success:e=>{o(e.tempFilePaths[0])}})})).then((o=>{e.index.navigateTo({url:`/pages/pop_croper/pop_croper?src=${decodeURIComponent(o)}`})}))}function _(o){console.log("croperPath:"+o);let n=e.index.getStorageSync("token"),a="";e.index.request({url:t.websiteUrl+"/with-state/qiniu-token",method:"POST",header:{Authorization:n},success:n=>{if(null==n.data.data||""==n.data.data.token)return void e.index.showToast({title:"获取上传凭证失败",icon:"none"});a=n.data.data.token,console.log("获取到的七牛token："+n.data.data.token);let i=e.index.getStorageSync("userInfo");console.log(i);let s=n.data.data.path;console.log("fileName:"+s),e.index.uploadFile({url:"https://up-cn-east-2.qiniup.com",name:"file",method:"POST",filePath:o,fileType:"image",formData:{token:a,key:s,scope:"hobby-box:"+s},success:o=>{console.log("上传成功"),function(o,n){let a=e.index.getStorageSync("token");e.index.getStorageSync("userInfo"),e.index.request({url:t.websiteUrl+"/with-state/update-profile",method:"POST",header:{Authorization:a},data:{avatar:n},success:e=>{console.log("更新成功"),t.getUserInfo()},fail:o=>{e.index.showToast({title:"更新失败",icon:"none"})}})}(0,"https://images1.fantuanpu.com/"+s)},fail:o=>{console.log(o),e.index.showToast({title:"上传失败",icon:"none"})}})},fail:o=>{e.index.showToast({title:"获取上传凭证失败",icon:"none"})}})}function w(){if(""==i.value||""==a.value)return void e.index.showToast({title:"请输入手机号和密码",icon:"none"});if(!/^1[3456789]\d{9}$/.test(a.value))return void e.index.showToast({title:"手机号格式错误",icon:"none"});if(i.value.length<6)return void e.index.showToast({title:"密码必须大于6位",icon:"none"});let o=a.value,n=i.value;e.index.request({url:t.websiteUrl+"/login",method:"POST",data:{account:o,password:n},success:o=>{console.log(o);let n=o.data.data;"success"==o.data.status?(e.index.setStorageSync("token",n.jwt_token),e.index.setStorageSync("openid",n.open_id),e.index.setStorageSync("session_key",n.session_key),console.log("jwt:"+n.jwt_token),null!=n.jwt_token&&""!=n.jwt_token&&t.getUserInfo()):e.index.showToast({title:o.data.msg,icon:"none"})},fail:o=>{e.index.showToast({title:"登录失败",icon:"none"})}})}function v(){e.index.navigateTo({url:"/pages/setting/setting"})}return e.watch((()=>t.global.isLogin),(o=>{console.log("watch",o),o?e.index.showTabBar({animation:!1}):e.index.hideTabBar({animation:!1})})),e.onShow((()=>{t.getUserInfo(),t.global.isLogin?e.index.showTabBar({animation:!1}):e.index.hideTabBar({animation:!1}),(async()=>{try{const o=await e.index.request({url:`${t.websiteUrl}/with-state/unread-message-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===o.data.status&&(s.value=o.data.data.count)}catch(o){console.log(o),e.index.showToast({title:"未读数获取失败",icon:"none"})}})(),(async()=>{try{const o=await e.index.request({url:`${t.websiteUrl}/with-state/user-likes-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===o.data.status&&(r.value=o.data.data.count)}catch(o){console.log(o),e.index.showToast({title:"关注数获取失败",icon:"none"})}})(),(async()=>{try{const o=await e.index.request({url:`${t.websiteUrl}/with-state/my-collocation-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===o.data.status&&(l.value=o.data.data)}catch(o){console.log(o),e.index.showToast({title:"搭配数获取失败",icon:"none"})}})();const o=getCurrentPages(),n=o[o.length-1];n.returnParam&&_(n.returnParam)})),(n,_)=>e.e({a:e.unref(t.global).isLogin},e.unref(t.global).isLogin?{b:e.unref(t.global).userInfo.avatar,c:e.o(x),d:e.t(e.unref(t.global).userInfo.username),e:e.t(e.unref(t.global).userInfo.id),f:o._imports_0$2,g:e.t(e.unref(r)),h:e.o(d),i:o._imports_1$3,j:e.t(e.unref(s)),k:e.o(m),l:o._imports_2$2,m:e.t(e.unref(l)),n:e.o(p),o:o._imports_3$1,p:o._imports_0$3,q:e.o(f),r:o._imports_5$1,s:o._imports_0$3,t:e.o(v),v:o._imports_6$1,w:o._imports_0$3,x:e.o(c)}:{y:o._imports_7,z:o._imports_8,A:e.unref(a),B:e.o((o=>e.isRef(a)?a.value=o.detail.value:a=o.detail.value)),C:o._imports_9,D:e.unref(i),E:e.o((o=>e.isRef(i)?i.value=o.detail.value:i=o.detail.value)),F:e.o(u),G:e.o(h),H:e.o(w),I:e.o(((...o)=>e.unref(t.wechatSignLogin)&&e.unref(t.wechatSignLogin)(...o))),J:e.o(g)},{K:e.p({head_color:"#e0f3ff"})})}},a=e._export_sfc(n,[["__scopeId","data-v-8775c83b"]]);wx.createPage(a);
