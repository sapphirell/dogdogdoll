"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("uni-icons"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js"))();const n={__name:"mine",setup(n){e.useCssVars((e=>({c380b1de:q.value}))),console.log(t.global.isLogin),console.log(t.global.userInfo);let a=e.ref(""),i=e.ref(""),s=e.ref(0),r=e.ref(0),l=e.ref(0);e.ref(!1);let c=t.getScene(),u=e.ref(!1);function d(e){u.value=e.detail.value.length>0}function g(){e.index.navigateTo({url:"/pages/private/private"})}function f(){e.index.navigateTo({url:"/pages/permission/permission"})}function p(){e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),t.global.isLogin=!1}function h(){e.index.navigateTo({url:"/pages/register/register"})}function x(){e.index.navigateTo({url:"/pages/user_like/user_like"})}function m(){e.index.showTabBar({animation:!1}),e.index.switchTab({url:"/pages/index/index"})}function v(){e.index.navigateTo({url:"/pages/my_comment/my_comment"})}function w(){e.index.navigateTo({url:"/pages/message_list/message_list"})}function y(){e.index.navigateTo({url:"/pages/reset_password/reset_password"})}function _(){e.index.navigateTo({url:"/pages/my_collocation/my_collocation"})}function T(){new Promise((o=>{e.index.chooseImage({count:1,success:e=>{o(e.tempFilePaths[0])}})})).then((o=>{e.index.navigateTo({url:`/pages/pop_croper/pop_croper?src=${decodeURIComponent(o)}`})}))}const S=async()=>{e.index.navigateTo({url:"/pages/creator_base/creator_base"})};function b(o){console.log("croperPath:"+o);let n=e.index.getStorageSync("token"),a="";e.index.request({url:t.websiteUrl.value+"/with-state/qiniu-token",method:"POST",header:{Authorization:n},success:n=>{if(null==n.data.data||""==n.data.data.token)return void e.index.showToast({title:"获取上传凭证失败",icon:"none"});a=n.data.data.token,console.log("获取到的七牛token："+n.data.data.token);let i=e.index.getStorageSync("userInfo");console.log(i);let s=n.data.data.path;console.log("fileName:"+s),e.index.uploadFile({url:"https://up-cn-east-2.qiniup.com",name:"file",method:"POST",filePath:o,fileType:"image",formData:{token:a,key:s,scope:"hobby-box:"+s},success:o=>{console.log("上传成功"),function(o,n){let a=e.index.getStorageSync("token");e.index.getStorageSync("userInfo"),e.index.request({url:t.websiteUrl.value+"/with-state/update-profile",method:"POST",header:{Authorization:a},data:{avatar:n},success:e=>{console.log("更新成功"),t.getUserInfo()},fail:o=>{e.index.showToast({title:"更新失败",icon:"none"})}})}(0,"https://images1.fantuanpu.com/"+s)},fail:o=>{console.log(o),e.index.showToast({title:"上传失败",icon:"none"})}})},fail:o=>{e.index.showToast({title:"获取上传凭证失败",icon:"none"})}})}function k(){if(!u.value)return void e.index.showToast({title:"请先阅读并同意协议",icon:"none"});if(""==i.value||""==a.value)return void e.index.showToast({title:"请输入手机号和密码",icon:"none"});if(!/^1[3456789]\d{9}$/.test(a.value))return void e.index.showToast({title:"手机号格式错误",icon:"none"});if(i.value.length<6)return void e.index.showToast({title:"密码必须大于6位",icon:"none"});let o=a.value,n=i.value;e.index.request({url:t.websiteUrl.value+"/login",method:"POST",data:{account:o,password:n},success:o=>{console.log(o);let n=o.data.data;"success"==o.data.status?(e.index.setStorageSync("token",n.jwt_token),e.index.setStorageSync("openid",n.open_id),e.index.setStorageSync("session_key",n.session_key),console.log("jwt:"+n.jwt_token),null!=n.jwt_token&&""!=n.jwt_token&&t.getUserInfo()):e.index.showToast({title:o.data.msg,icon:"none"})},fail:o=>{e.index.showToast({title:"登录失败",icon:"none"})}})}function I(){e.index.navigateTo({url:"/pages/setting/setting"})}const z=e.index.getSystemInfoSync(),P=e.computed((()=>{const o=e.index.getMenuButtonBoundingClientRect(),t=z.statusBarHeight||32;return o.bottom+o.top-2*t})),q=e.computed((()=>P.value+"px"));function j(){e.index.navigateTo({url:"/pages/article_detail/article_detail?id=3"})}return e.watch((()=>t.global.isLogin),(o=>{console.log("watch",o),o?e.index.showTabBar({animation:!1}):e.index.hideTabBar({animation:!1})})),e.onShow((()=>{t.getUserInfo(),t.global.isLogin?e.index.showTabBar({animation:!1}):e.index.hideTabBar({animation:!1}),(async()=>{try{const o=await e.index.request({url:`${t.websiteUrl.value}/with-state/unread-message-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===o.data.status&&(s.value=o.data.data.count)}catch(o){console.log(o),e.index.showToast({title:"未读数获取失败",icon:"none"})}})(),(async()=>{try{const o=await e.index.request({url:`${t.websiteUrl.value}/with-state/user-likes-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===o.data.status&&(r.value=o.data.data.count)}catch(o){console.log(o),e.index.showToast({title:"关注数获取失败",icon:"none"})}})(),(async()=>{try{const o=await e.index.request({url:`${t.websiteUrl.value}/with-state/my-collocation-count`,header:{Authorization:e.index.getStorageSync("token")}});"success"===o.data.status&&(l.value=o.data.data)}catch(o){console.log(o),e.index.showToast({title:"搭配数获取失败",icon:"none"})}})();const o=getCurrentPages(),n=o[o.length-1];n.returnParam&&b(n.returnParam)})),(n,b)=>e.e({a:e.s(n.__cssVars()),b:e.s(n.__cssVars()),c:e.unref(t.global).isLogin},e.unref(t.global).isLogin?{d:e.unref(t.global).userInfo.avatar,e:e.o(T),f:e.t(e.unref(t.global).userInfo.username),g:e.t(e.unref(t.global).userInfo.id),h:e.t(e.unref(r)),i:e.o(x),j:e.t(e.unref(s)),k:e.o(w),l:e.t(e.unref(l)),m:e.o(_),n:e.p({type:"chatboxes",size:"24",color:"#606060"}),o:e.p({type:"right",size:"24",color:"#c0c0c0"}),p:e.o(v),q:e.p({type:"gear",size:"24",color:"#606060"}),r:e.p({type:"right",size:"24",color:"#c0c0c0"}),s:e.o(I),t:e.p({type:"shop",size:"24",color:"#606060"}),v:e.p({type:"right",size:"24",color:"#c0c0c0"}),w:e.o(S),x:e.p({type:"arrow-right",size:"24",color:"#606060"}),y:e.p({type:"right",size:"24",color:"#c0c0c0"}),z:e.o(p),A:e.o(j)}:e.e({B:o._imports_0$5,C:e.unref(a),D:e.o((o=>e.isRef(a)?a.value=o.detail.value:a=o.detail.value)),E:o._imports_1$3,F:e.unref(i),G:e.o((o=>e.isRef(i)?i.value=o.detail.value:i=o.detail.value)),H:e.o(h),I:e.o(y),J:e.o(k),K:4==e.unref(c)},4==e.unref(c)?{L:e.o(((...o)=>e.unref(t.wechatSignLogin)&&e.unref(t.wechatSignLogin)(...o)))}:{},{M:e.o(m),N:e.unref(u),O:e.o(d),P:e.o(g),Q:e.o(f)}),{R:e.s(n.__cssVars())})}},a=e._export_sfc(n,[["__scopeId","data-v-d855ab4f"]]);wx.createPage(a);
