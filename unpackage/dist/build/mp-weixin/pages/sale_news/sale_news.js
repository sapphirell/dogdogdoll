"use strict";const e=require("../../common/vendor.js"),a=require("../../common/config.js");if(!Array){(e.resolveComponent("view-logs")+e.resolveComponent("comment-list")+e.resolveComponent("comment-input"))()}Math||((()=>"../../components/view-logs/view-logs.js")+(()=>"../../components/comment-list/comment-list.js")+(()=>"../../components/comment-input/comment-input.js"))();const t={__name:"sale_news",setup(t){const n=e.ref({title:"",content:"",image_list:[],created_at:0}),o=e.ref({brand_name:"",logo:""}),i=e.ref(!0),l=e.ref(!1),s=e.ref(""),r=e.ref(0),u=e.ref(0),d=e.ref(!1),c=e.ref(null),v=e.ref(null);e.ref(1);let m=e.ref({});e.index.getSystemInfoSync();const _=({parent:e,target:a})=>{var t;console.log("parent",e),console.log("target",a);let n=e;null!=a&&(n=a),m.value.id!=n.id?(console.log("item",n),m.value=n,null==(t=v.value)||t.focusInput()):m.value={}};function g(a){e.index.navigateTo({url:"/pages/brand/brand?brand_id="+a})}e.index.setNavigationBarTitle({title:"图透详情"});const p=t=>{var n,o,i;let l=e.index.getStorageSync("token");if(!a.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});console.log("reply_info",m.value);const s={content:t.content,origin:t.origin,target_id:parseInt(r.value),type:4,image_url:t.image_url||"",association_id:t.association_id||0,association_type:t.association_type||0,is_anonymous:t.is_anonymous||0,...m.value.id&&{reply_id:m.value.id,reply_for:m.value.comment,reply_uid:m.value.user_id,parent_id:m.value.parent_id>0?m.value.parent_id:m.value.id}},u={id:Date.now(),content:t.content,created_at:Math.floor(Date.now()/1e3),like_count:0,reply_count:0,is_liked:!1,floor:0,...t.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:a.global.userInfo.avatar,username:a.global.userInfo.nickname,is_anonymous:0},...t.association_id&&{association_id:t.association_id,association_type:t.association_type},...t.image_url&&{image_url:t.image_url},...m.value.id&&{reply_id:m.value.id,reply_for:m.value.comment,reply_uid:m.value.user_id,parent_id:m.value.parent_id>0?m.value.parent_id:m.value.id,reply_username:m.value.is_anonymous?"匿名用户":m.value.username}};m.value.id?0===m.value.parent_id?null==(o=c.value)||o.addReplyComment({...u,parent_id:m.value.id}):null==(i=c.value)||i.addReplyComment({...u,parent_id:m.value.parent_id}):null==(n=c.value)||n.addNewComment(u),e.index.request({url:a.websiteUrl.value+"/with-state/add-comment",method:"POST",header:{Authorization:l},data:s,success:n=>{var o,i;if("success"==n.data.status){const i=n.data.data,l={...i,...t.is_anonymous?{avatar:"https://images1.fantuanpu.com/home/default_avatar.jpg",username:"匿名用户",is_anonymous:1}:{avatar:a.global.userInfo.avatar,username:a.global.userInfo.nickname,is_anonymous:0}};i.reply_uid&&m.value.is_anonymous&&(l.reply_username="匿名用户"),null==(o=c.value)||o.updateTempComment(u.id,l),e.index.showToast({title:"评论成功",icon:"success"})}else null==(i=c.value)||i.removeTempComment(u.id),e.index.showToast({title:n.data.msg,icon:"none"})},fail:a=>{var t;null==(t=c.value)||t.removeTempComment(u.id),e.index.showToast({title:"网络请求失败",icon:"none"})}})};function f(e){const a=new Date(1e3*e),t=a.getFullYear(),n=(a.getMonth()+1).toString().padStart(2,"0"),o=a.getDate().toString().padStart(2,"0"),i=a.getHours().toString().padStart(2,"0"),l=a.getMinutes().toString().padStart(2,"0");return a.getSeconds().toString().padStart(2,"0"),`${t}-${n}-${o} ${i}:${l}`}const y=()=>{e.index.request({url:a.websiteUrl.value+"/brand-info?id="+u.value,success:a=>{"success"===a.data.status&&(o.value=a.data.data,e.index.setNavigationBarTitle({title:a.data.data.brand_name}),w())},fail:()=>handleError("品牌信息加载失败")})},h=async()=>{if(!a.global.isLogin)return void e.index.showToast({title:"请先登录",icon:"none"});const t="/with-state/"+(d.value?"unlike":"add-like");e.index.request({url:a.websiteUrl.value+t,method:"POST",header:{Authorization:e.index.getStorageSync("token")},data:{id:parseInt(u.value),type:2},success:a=>{"success"===a.data.status&&(d.value=!d.value,e.index.showToast({title:d.value?"关注成功":"已取消关注",icon:"none"}))}})},w=()=>{a.global.isLogin&&e.index.request({url:`${a.websiteUrl.value}/with-state/hasLike?id=${u.value}&type=2`,method:"POST",header:{Authorization:e.index.getStorageSync("token")},success:e=>{var a;d.value=(null==(a=e.data.data)?void 0:a.id)>0}})};return e.onLoad((t=>{t.id?(r.value=t.id,(async t=>{try{const o=await e.index.request({url:`${a.websiteUrl.value}/sale-news-detail?id=${t}`,timeout:5e3});"success"===o.data.status?(n.value={...o.data.data,image_list:o.data.data.image_list||[]},u.value=o.data.data.brand_id,y()):handleError(o.data.msg||"数据加载失败")}catch(o){console.error("请求失败:",o),handleError("网络请求失败")}finally{i.value=!1}})(t.id),a.asyncGetUserInfo().then(w)):handleError("缺少必要参数")})),(a,t)=>e.e({a:e.f(n.value.image_list,((a,t,n)=>({a:a,b:e.o((a=>{e.index.previewImage({current:goods.value.goods_images.index,urls:goods.value.goods_images})}),t),c:t}))),b:o.value.logo_image,c:e.o((e=>g(o.value.id))),d:e.t(o.value.brand_name),e:e.t(f(n.value.created_at)),f:e.o((e=>g(o.value.id))),g:e.t(d.value?"已关注":"+ 关注品牌"),h:e.o(h),i:d.value?"#ff6a6c":"#65C3D6",j:e.t(n.value.title),k:e.t(n.value.content),l:e.sr(c,"dccba794-1",{k:"commentListRef"}),m:e.o(_),n:e.p({type:4,"relation-id":parseInt(r.value)}),o:i.value},(i.value,{}),{p:l.value},l.value?{q:e.t(s.value)}:{},{r:e.sr(v,"dccba794-2",{k:"commentInputRef"}),s:e.o(p),t:e.o((a=>e.isRef(m)?m.value=a:m=a)),v:e.p({"reply-info":e.unref(m),"target-id":r.value})})}},n=e._export_sfc(t,[["__scopeId","data-v-dccba794"]]);t.__runtimeHooks=2,wx.createPage(n);
