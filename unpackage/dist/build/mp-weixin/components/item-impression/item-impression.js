"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){e.resolveComponent("common-modal")()}Math;const a={__name:"item-impression",props:{target_id:{type:String,required:!0},type:{type:String,required:!0},goodsType:{type:Number,required:!0}},setup(a){const n=a,o=e.ref([]),s=e.ref([]),i=e.ref(0),d=e.ref(""),r=e.ref(!1),c=e.ref(null),u=e.computed((()=>{const e={};o.value.forEach((t=>{e[t.content]=t}));return[...s.value.map((t=>e[t]?{...e[t],isDefault:!0}:{content:t,count:0,selected:!1,isDefault:!0})),...o.value.filter((e=>!s.value.includes(e.content)))].sort(((e,t)=>t.count-e.count))})),l=async()=>{try{c.value=await t.asyncGetUserInfo();const a=await e.index.request({url:`${t.websiteUrl.value}/impression/counts`,method:"GET",data:{target_id:parseInt(n.target_id,10),type_id:parseInt(n.type,10)}}),s=await e.index.request({url:`${t.websiteUrl.value}/with-state/impression/status`,method:"GET",data:{target_id:parseInt(n.target_id,10),type_id:parseInt(n.type,10)},header:{Authorization:e.index.getStorageSync("token")}});if(200===a.statusCode&&"success"===a.data.status){const e=a.data.data;i.value=e.reduce(((e,t)=>e+t.count),0);const t=200===s.statusCode&&"success"===s.data.status?s.data.data.map((e=>e.id)):[];o.value=e.map((e=>({...e,selected:t.includes(e.id)})))}}catch(a){console.error("获取表态数据失败:",a),e.index.showToast({title:"获取表态数据失败",icon:"none"})}},p=(e,t,a=null)=>{const n=o.value.findIndex((t=>t.id===e.id||t.content===e.content));if(-1===n&&t){const t={id:a,content:e.content,count:1,selected:!0};return o.value=[...o.value,t],void i.value++}if(-1!==n){const e=[...o.value],s={...e[n]};t?(s.selected=!0,s.count=(s.count||0)+1,a&&(s.id=a),i.value++):(s.selected=!1,s.count=Math.max(0,s.count-1),i.value--),e[n]=s,o.value=e}},v=()=>{c.value?(d.value="",r.value=!0):e.index.showToast({title:"请先登录",icon:"none"})},m=()=>{r.value=!1},h=async()=>{if(d.value.trim())try{const a=await e.index.request({url:`${t.websiteUrl.value}/with-state/impression/add`,method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{target_id:parseInt(n.target_id,10),type_id:parseInt(n.type,10),content:d.value.trim()}});200===a.statusCode&&"success"===a.data.status&&(o.value=[...o.value,{id:a.data.data.impression_id,content:d.value.trim(),count:1,selected:!0}],i.value++,r.value=!1,e.index.showToast({title:"添加成功",icon:"success"}))}catch(a){console.error("添加表态失败:",a),e.index.showToast({title:"添加表态失败",icon:"none"})}else e.index.showToast({title:"请输入表态内容",icon:"none"})};return e.watch((()=>[n.target_id,n.type]),l,{immediate:!0}),e.onMounted((()=>{(async()=>{try{let a=9;switch(n.goodsType){case"整体":a=1;break;case"单头":a=2;break;case"娃衣":a=3;break;case"眼珠":a=4;break;case"假发":a=5;break;default:a=9}const o=await e.index.request({url:`${t.websiteUrl.value}/impression/default`,method:"GET",data:{type:a}});200===o.statusCode&&"success"===o.data.status?s.value=o.data.data:(console.error("获取默认表态失败:",o.data),e.index.showToast({title:"获取默认表态失败",icon:"none"}))}catch(a){console.error("获取默认表态失败:",a),e.index.showToast({title:"获取默认表态失败",icon:"none"})}})(),l()})),(a,o)=>({a:e.f(u.value,((a,o,s)=>({a:e.t(a.content),b:e.t(a.count),c:a.count>0?1:"",d:a.id||"default-"+a.content,e:e.n({active:a.selected}),f:e.o((o=>(async a=>{if(c.value)try{const o={target_id:parseInt(n.target_id,10),type_id:parseInt(n.type,10)};if(a.isDefault&&!a.id?o.content=a.content:o.impression_id=a.id,a.selected){const n=await e.index.request({url:`${t.websiteUrl.value}/with-state/impression/remove`,method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:{impression_id:a.id}});200===n.statusCode&&"success"===n.data.status&&p(a,!1)}else{const n=await e.index.request({url:`${t.websiteUrl.value}/with-state/impression/add`,method:"POST",header:{Authorization:e.index.getStorageSync("token"),"Content-Type":"application/json"},data:o});200===n.statusCode&&"success"===n.data.status&&p(a,!0,n.data.data.impression_id)}}catch(o){console.error("操作失败:",o),e.index.showToast({title:"操作失败",icon:"none"})}else e.index.showToast({title:"请先登录",icon:"none"})})(a)),a.id||"default-"+a.content)}))),b:e.o(v),c:e.o(h),d:d.value,e:e.o((e=>d.value=e.detail.value)),f:e.o(m),g:e.o(h),h:e.o((e=>r.value=e)),i:e.p({visible:r.value,width:"80%",top:"30%"})})}};wx.createComponent(a);
