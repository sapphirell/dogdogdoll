"use strict";const e=require("../../common/vendor.js");if(require("../../common/config.js"),!Array){e.resolveComponent("uni-icons")()}Math;const l={__name:"shmily-drag-image",props:{value:{type:Array,default:()=>[]},customClick:{type:Boolean,default:!1},modelValue:{type:Array,default:()=>[]},keyName:{type:String,default:"image_url"},number:{type:Number,default:6},imageWidth:{type:Number,default:0},cols:{type:Number,default:3},borderRadius:{type:String,default:0},padding:{type:Number,default:10},scale:{type:Number,default:1.1},opacity:{type:Number,default:.7},itemMargin:{type:Number,default:10},imageRatio:{type:Number,default:.7},showItemInfo:{type:Boolean,default:!0},showDelete:{type:Boolean,default:!1}},emits:["input","update:modelValue","sort-change","delete","item-click"],setup(l,{emit:a}){const u=l,t=a,o=e.ref([]),n=e.ref(0),i=e.ref({x:0,y:0}),d=e.ref(0),v=e.ref(0),r=e.ref(0),s=e.ref(null),c=e.ref(null),f=e.ref(!0);e.ref(!0);const m=e.ref(!0),p=e.ref(0),h=e.ref(null),x=e.ref(!1),y=e.ref(!1),b=e.computed((()=>o.value.length<u.number?Math.ceil((o.value.length+1)/d.value)*r.value+"px":Math.ceil(o.value.length/d.value)*r.value+"px")),g=e.computed((()=>v.value-2*V(u.padding)+"px")),Y=e.computed((()=>r.value-2*V(u.padding)+"px")),k=e=>null!==u.keyName?e[u.keyName]:e,w=e=>({id:e.id,src:k(e),name:e.name,price:e.price,type:e.type}),M=(e,l)=>{const a=o.value.findIndex((l=>l.id===e.id));-1!==a&&a!==l&&(o.value.splice(l,0,o.value.splice(a,1)[0]),o.value.forEach(((e,l)=>{e.index=l})),C())},X=(l,a)=>{l.index+=a,l.offset=0,l.x=l.oldX,l.y=l.oldY,l.absX=l.index%d.value,l.absY=Math.floor(l.index/d.value),setTimeout((()=>{e.nextTick$1((()=>{l.x=l.absX*v.value,l.y=l.absY*r.value}))}),0)},I=(e,l)=>{console.log("进入touchstart"),o.value.forEach((e=>{e.zIndex=e.index+9})),e.zIndex=99,e.moveEnd=!0,s.value=e,c.value=setTimeout((()=>{e.scale=u.scale,e.opacity=u.opacity,clearTimeout(c.value),c.value=null}),200)},T=e=>{var l;if(!e)return"";const a=(null==(l=e.split(",")[0])?void 0:l.trim())||"";return a.startsWith("http")?a:""},E=()=>{},N=()=>{},_=l=>{var a;t("item-click",l),u.customClick||(a=l.id,e.index.navigateTo({url:"/pages/account_book_preview/account_book_preview?account_book_id="+a}))};const C=()=>{const e=[],l=u.modelValue.length?u.modelValue:u.value,a=[...o.value].sort(((e,l)=>e.index-l.index));for(let t of a){const a=l.find((e=>k(e)===t.src));a?e.push(a):null!==u.keyName?e.push({[u.keyName]:t.src}):e.push(t.src)}t("input",e),t("update:modelValue",e)},V=e=>n.value*e/750,S=e.ref(null);e.onMounted((()=>{n.value=e.index.getSystemInfoSync().windowWidth,S.value=e.getCurrentInstance(),e.nextTick$1((()=>{e.index.createSelectorQuery().in(S.value.proxy).select(".con").boundingClientRect((e=>{if(!e)return void console.error("未找到 .con 元素");d.value=u.cols,v.value=e.width/u.cols,r.value=1.3*v.value,u.imageWidth>0&&(v.value=V(u.imageWidth),r.value=1.3*v.value,d.value=Math.floor(e.width/v.value));(u.modelValue.length?u.modelValue:u.value).forEach((e=>{(e=>{const l=w(e),a=o.value.length%d.value,u=Math.floor(o.value.length/d.value),t=a*v.value,n=u*r.value;o.value.push({...l,x:t,y:n,oldX:t,oldY:n,absX:a,absY:u,scale:1,zIndex:9,opacity:1,index:o.value.length,id:e.id,disable:!1,offset:0,moveEnd:!1}),i.value.x=o.value.length%d.value*v.value,i.value.y=Math.floor(o.value.length/d.value)*r.value})(e)})),m.value=!1})).exec()})),y.value=!0}));const W=()=>{o.value.forEach(((e,l)=>{e.index=l;const a=l%d.value,u=Math.floor(l/d.value);e.x=a*v.value,e.y=u*r.value,e.oldX=e.x,e.oldY=e.y,e.absX=a,e.absY=u}))};e.watch((()=>u.modelValue),(l=>{x.value||y.value&&e.nextTick$1((()=>{new Promise((l=>{if(!S.value||!S.value.proxy)return console.warn("Component instance not available for selector query"),l();e.index.createSelectorQuery().in(S.value.proxy).select(".con").boundingClientRect((e=>{if(!e)return l();d.value=u.cols,v.value=e.width/u.cols,r.value=1.3*v.value,u.imageWidth>0&&(v.value=V(u.imageWidth),r.value=1.3*v.value,d.value=Math.floor(e.width/v.value)),l()})).exec()})).then((()=>{z(l)}))}))}),{deep:!0,immediate:!0});const z=e=>{const l=o.value.reduce(((e,l)=>(e[l.id]=l,e)),{});o.value=e.map((e=>{const a=l[e.id];return a?{...a,...w(e)}:$(e)})),W()},$=e=>{const l=w(e),a=o.value.length%d.value,u=Math.floor(o.value.length/d.value);return{...l,x:a*v.value,y:u*r.value,oldX:a*v.value,oldY:u*r.value,absX:a,absY:u,scale:1,zIndex:9,opacity:1,index:o.value.length,disable:!1,offset:0,moveEnd:!1,ready:!1}};return(a,n)=>e.e({a:v.value},v.value?{b:e.f(o.value,((l,a,n)=>e.e(u.showDelete?{a:"85ceb8b9-0-"+n,b:e.p({type:"clear",color:"#9b9b9b",size:"30"}),c:e.o((e=>(e=>{t("delete",e.id);const l=o.value.findIndex((l=>l.id===e.id));-1!==l&&(o.value.splice(l,1),W(),C())})(l)),l.id)}:{},{d:T(l.src)},u.showItemInfo?{e:e.t(l.name),f:e.t(l.price),g:e.t(l.type)}:{},{h:"scale("+l.scale+")",i:!l.disable&&l.ready?1:"",j:l.id,k:l.y,l:l.x,m:l.disable||!l.ready,n:e.o((a=>((l,a)=>{if(a&&(a.oldX=l.detail.x,a.oldY=l.detail.y,"touch"===l.detail.source)){a.moveEnd&&(a.offset=Math.sqrt(Math.pow(a.oldX-a.absX*v.value,2)+Math.pow(a.oldY-a.absY*r.value,2)));let u=Math.floor((l.detail.x+v.value/2)/v.value);if(u>=d.value)return;let t=Math.floor((l.detail.y+r.value/2)/r.value),n=d.value*t+u;a.index!==n&&n<o.value.length&&(f.value=!1,o.value.forEach((l=>{a.index>n&&l.index>=n&&l.index<a.index?X(l,1):a.index<n&&l.index<=n&&l.index>a.index?X(l,-1):l.id!==a.id&&(l.offset=0,l.x=l.oldX,l.y=l.oldY,setTimeout((()=>{e.nextTick$1((()=>{l.x=l.absX*v.value,l.y=l.absY*r.value}))}),0))})),M(a,n),a.index=n,a.absX=u,a.absY=t,a.moveEnd||setTimeout((()=>{e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value}))}),0),C())}})(a,l)),l.id),o:e.o((a=>((l,a)=>{p.value=a.touches[0].clientY,h.value&&(clearTimeout(h.value),h.value=null),o.value.forEach((e=>{e.ready=!1,e.disable=!0})),console.log("长按开始"),h.value=setTimeout((()=>{console.log("长按成功！"),e.index.vibrateShort({success:()=>{console.log("触感反馈")}}),l.ready=!0,l.disable=!1,x.value=!0,I(l)}),240)})(l,a)),l.id),p:e.o((a=>(l=>{if(l.scale=1,l.opacity=1,l.x=l.oldX,l.y=l.oldY,l.offset=0,l.moveEnd=!1,console.log("结束点击，清理ready"),o.value.forEach((e=>{e.ready=!1,e.disable=!0})),1==x.value){console.log("来自于拖拽的结束,上报排序事件");const e=o.value.map((e=>e.id));t("sort-change",e),console.log("排序后的ID",e)}x.value=!1,h.value&&(clearTimeout(h.value),h.value=null),setTimeout((()=>{o.value.forEach((e=>{e.ready||(e.x=e.absX*v.value,e.y=e.absY*r.value,e.offset=0,e.moveEnd=!1)})),e.nextTick$1((()=>{l.x=l.absX*v.value,l.y=l.absY*r.value,s.value=null,f.value=!0}))}),50)})(l)),l.id),q:e.o((e=>_(l)),l.id),r:e.o((e=>((e,l)=>{if(x.value)return;const a=e.touches[0].clientY;Math.abs(a-p.value)>10&&h.value&&(clearTimeout(h.value),h.value=null)})(e)),l.id),s:l.zIndex,t:l.opacity}))),c:u.showDelete,d:u.showItemInfo,e:g.value,f:Y.value,g:l.borderRadius+"rpx",h:l.itemMargin+"px",i:v.value+"px",j:r.value+"px",k:b.value,l:e.o(E),m:e.o(N)}:{})}},a=e._export_sfc(l,[["__scopeId","data-v-85ceb8b9"]]);wx.createComponent(a);
