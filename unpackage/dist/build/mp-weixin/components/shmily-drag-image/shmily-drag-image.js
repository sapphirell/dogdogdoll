"use strict";const e=require("../../common/vendor.js");require("../../common/config.js");const a={__name:"shmily-drag-image",props:{value:{type:Array,default:()=>[]},modelValue:{type:Array,default:()=>[]},keyName:{type:String,default:"image_url"},number:{type:Number,default:6},imageWidth:{type:Number,default:0},cols:{type:Number,default:3},borderRadius:{type:String,default:0},padding:{type:Number,default:10},scale:{type:Number,default:1.1},opacity:{type:Number,default:.7},itemMargin:{type:Number,default:10},imageRatio:{type:Number,default:.7}},emits:["input","update:modelValue","sort-change"],setup(a,{emit:l}){const u=a,t=l,o=e.ref([]),i=e.ref(0),d=e.ref({x:0,y:0}),n=e.ref(0),v=e.ref(0),r=e.ref(0),s=e.ref(null),c=e.ref(null),p=e.ref(!0);e.ref(!0);const f=e.ref(!0),m=e.ref(0),x=e.ref(null),h=e.ref(!1),y=e.computed((()=>o.value.length<u.number?Math.ceil((o.value.length+1)/n.value)*r.value+"px":Math.ceil(o.value.length/n.value)*r.value+"px")),b=e.computed((()=>v.value-2*I(u.padding)+"px")),g=e.computed((()=>r.value-2*I(u.padding)+"px")),T=e=>null!==u.keyName?e[u.keyName]:e,Y=(e,a)=>{const l=o.value.findIndex((a=>a.id===e.id));-1!==l&&l!==a&&(o.value.splice(a,0,o.value.splice(l,1)[0]),o.value.forEach(((e,a)=>{e.index=a})),w())},k=(a,l)=>{a.index+=l,a.offset=0,a.x=a.oldX,a.y=a.oldY,a.absX=a.index%n.value,a.absY=Math.floor(a.index/n.value),setTimeout((()=>{e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value}))}),0)},M=(e,a)=>{console.log("进入touchstart"),o.value.forEach((e=>{e.zIndex=e.index+9})),e.zIndex=99,e.moveEnd=!0,s.value=e,c.value=setTimeout((()=>{e.scale=u.scale,e.opacity=u.opacity,clearTimeout(c.value),c.value=null}),200)},X=e=>{var a;if(!e)return"";const l=(null==(a=e.split(",")[0])?void 0:a.trim())||"";return l.startsWith("http")?l:""},N=()=>{},_=()=>{};const w=()=>{const e=[],a=u.modelValue.length?u.modelValue:u.value,l=[...o.value].sort(((e,a)=>e.index-a.index));for(let t of l){const l=a.find((e=>T(e)===t.src));l?e.push(l):null!==u.keyName?e.push({[u.keyName]:t.src}):e.push(t.src)}t("input",e),t("update:modelValue",e)},E=e=>{const a=(e=>({id:e.id,src:T(e),name:e.name,price:e.price,type:e.type}))(e),l=o.value.length%n.value,u=Math.floor(o.value.length/n.value),t=l*v.value,i=u*r.value;o.value.push({...a,x:t,y:i,oldX:t,oldY:i,absX:l,absY:u,scale:1,zIndex:9,opacity:1,index:o.value.length,id:e.id,disable:!1,offset:0,moveEnd:!1}),d.value.x=o.value.length%n.value*v.value,d.value.y=Math.floor(o.value.length/n.value)*r.value},I=e=>i.value*e/750;e.onMounted((()=>{i.value=e.index.getSystemInfoSync().windowWidth;const a=e.getCurrentInstance();e.nextTick$1((()=>{e.index.createSelectorQuery().in(a.proxy).select(".con").boundingClientRect((e=>{if(!e)return void console.error("未找到 .con 元素");n.value=u.cols,v.value=e.width/u.cols,r.value=1.3*v.value,u.imageWidth>0&&(v.value=I(u.imageWidth),r.value=1.3*v.value,n.value=Math.floor(e.width/v.value));(u.modelValue.length?u.modelValue:u.value).forEach((e=>{E(e)})),f.value=!1})).exec()}))})),e.watch((()=>u.value),(e=>{!f.value&&p.value&&V(e)}),{deep:!0}),e.watch((()=>u.modelValue),(e=>{!f.value&&p.value&&V(e)}),{deep:!0});const V=e=>{let a=!1;for(let l=0;l<e.length;l++)a?E(T(e[l])):o.value.length!==l&&o.value[l].src===T(e[l])||(a=!0,o.value.splice(l),E(T(e[l])))};return(l,u)=>e.e({a:v.value},v.value?{b:e.f(o.value,((a,l,u)=>({a:X(a.src),b:e.t(a.name),c:e.t(a.price),d:e.t(a.type),e:"scale("+a.scale+")",f:!a.disable&&a.ready?1:"",g:a.id,h:a.y,i:a.x,j:a.disable||!a.ready,k:e.o((l=>((a,l)=>{if(l&&(l.oldX=a.detail.x,l.oldY=a.detail.y,"touch"===a.detail.source)){l.moveEnd&&(l.offset=Math.sqrt(Math.pow(l.oldX-l.absX*v.value,2)+Math.pow(l.oldY-l.absY*r.value,2)));let u=Math.floor((a.detail.x+v.value/2)/v.value);if(u>=n.value)return;let t=Math.floor((a.detail.y+r.value/2)/r.value),i=n.value*t+u;l.index!==i&&i<o.value.length&&(p.value=!1,o.value.forEach((a=>{l.index>i&&a.index>=i&&a.index<l.index?k(a,1):l.index<i&&a.index<=i&&a.index>l.index?k(a,-1):a.id!==l.id&&(a.offset=0,a.x=a.oldX,a.y=a.oldY,setTimeout((()=>{e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value}))}),0))})),Y(l,i),l.index=i,l.absX=u,l.absY=t,l.moveEnd||setTimeout((()=>{e.nextTick$1((()=>{l.x=l.absX*v.value,l.y=l.absY*r.value}))}),0),w())}})(l,a)),a.id),l:e.o((l=>((a,l)=>{m.value=l.touches[0].clientY,x.value&&(clearTimeout(x.value),x.value=null),o.value.forEach((e=>{e.ready=!1,e.disable=!0})),console.log("长按开始"),x.value=setTimeout((()=>{console.log("长按成功！"),e.index.vibrateShort({success:()=>{console.log("触感反馈")}}),a.ready=!0,a.disable=!1,h.value=!0,M(a)}),240)})(a,l)),a.id),m:e.o((l=>(a=>{if(a.scale=1,a.opacity=1,a.x=a.oldX,a.y=a.oldY,a.offset=0,a.moveEnd=!1,console.log("结束点击，清理ready"),o.value.forEach((e=>{e.ready=!1,e.disable=!0})),1==h.value){console.log("来自于拖拽的结束,上报排序事件");const e=o.value.map((e=>e.id));t("sort-change",e)}h.value=!1,x.value&&(clearTimeout(x.value),x.value=null),setTimeout((()=>{e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value,s.value=null,p.value=!0}))}),0)})(a)),a.id),n:e.o((l=>{return u=a.id,void e.index.navigateTo({url:"/pages/account_book_preview/account_book_preview?account_book_id="+u});var u}),a.id),o:e.o((e=>((e,a)=>{if(h.value)return;const l=e.touches[0].clientY;Math.abs(l-m.value)>10&&x.value&&(clearTimeout(x.value),x.value=null)})(e)),a.id),p:a.zIndex,q:a.opacity}))),c:b.value,d:g.value,e:a.borderRadius+"rpx",f:a.itemMargin+"px",g:v.value+"px",h:r.value+"px",i:y.value,j:e.o(N),k:e.o(_)}:{})}},l=e._export_sfc(a,[["__scopeId","data-v-78d2bd2f"]]);wx.createComponent(l);
