"use strict";const e=require("../../common/vendor.js");require("../../common/config.js");const a={__name:"shmily-drag-image",props:{value:{type:Array,default:()=>[]},modelValue:{type:Array,default:()=>[]},keyName:{type:String,default:"image_url"},number:{type:Number,default:6},imageWidth:{type:Number,default:0},cols:{type:Number,default:3},borderRadius:{type:String,default:0},padding:{type:Number,default:10},scale:{type:Number,default:1.1},opacity:{type:Number,default:.7},itemMargin:{type:Number,default:10},imageRatio:{type:Number,default:.7}},emits:["input","update:modelValue","sort-change"],setup(a,{emit:l}){const u=a,t=l,o=e.ref([]),n=e.ref(0),i=e.ref({x:0,y:0}),d=e.ref(0),v=e.ref(0),r=e.ref(0),s=e.ref(null),c=e.ref(null),f=e.ref(!0);e.ref(!0);const m=e.ref(!0),p=e.ref(0),x=e.ref(null),h=e.ref(!1),y=e.ref(!1),b=e.computed((()=>o.value.length<u.number?Math.ceil((o.value.length+1)/d.value)*r.value+"px":Math.ceil(o.value.length/d.value)*r.value+"px")),g=e.computed((()=>v.value-2*V(u.padding)+"px")),Y=e.computed((()=>r.value-2*V(u.padding)+"px")),X=e=>null!==u.keyName?e[u.keyName]:e,M=e=>({id:e.id,src:X(e),name:e.name,price:e.price,type:e.type}),T=(e,a)=>{const l=o.value.findIndex((a=>a.id===e.id));-1!==l&&l!==a&&(o.value.splice(a,0,o.value.splice(l,1)[0]),o.value.forEach(((e,a)=>{e.index=a})),I())},k=(a,l)=>{a.index+=l,a.offset=0,a.x=a.oldX,a.y=a.oldY,a.absX=a.index%d.value,a.absY=Math.floor(a.index/d.value),setTimeout((()=>{e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value}))}),0)},E=(e,a)=>{console.log("进入touchstart"),o.value.forEach((e=>{e.zIndex=e.index+9})),e.zIndex=99,e.moveEnd=!0,s.value=e,c.value=setTimeout((()=>{e.scale=u.scale,e.opacity=u.opacity,clearTimeout(c.value),c.value=null}),200)},w=e=>{var a;if(!e)return"";const l=(null==(a=e.split(",")[0])?void 0:a.trim())||"";return l.startsWith("http")?l:""},N=()=>{},_=()=>{};const I=()=>{const e=[],a=u.modelValue.length?u.modelValue:u.value,l=[...o.value].sort(((e,a)=>e.index-a.index));for(let t of l){const l=a.find((e=>X(e)===t.src));l?e.push(l):null!==u.keyName?e.push({[u.keyName]:t.src}):e.push(t.src)}t("input",e),t("update:modelValue",e)},V=e=>n.value*e/750,S=e.ref(null);e.onMounted((()=>{n.value=e.index.getSystemInfoSync().windowWidth,S.value=e.getCurrentInstance(),e.nextTick$1((()=>{e.index.createSelectorQuery().in(S.value.proxy).select(".con").boundingClientRect((e=>{if(!e)return void console.error("未找到 .con 元素");d.value=u.cols,v.value=e.width/u.cols,r.value=1.3*v.value,u.imageWidth>0&&(v.value=V(u.imageWidth),r.value=1.3*v.value,d.value=Math.floor(e.width/v.value));(u.modelValue.length?u.modelValue:u.value).forEach((e=>{(e=>{const a=M(e),l=o.value.length%d.value,u=Math.floor(o.value.length/d.value),t=l*v.value,n=u*r.value;o.value.push({...a,x:t,y:n,oldX:t,oldY:n,absX:l,absY:u,scale:1,zIndex:9,opacity:1,index:o.value.length,id:e.id,disable:!1,offset:0,moveEnd:!1}),i.value.x=o.value.length%d.value*v.value,i.value.y=Math.floor(o.value.length/d.value)*r.value})(e)})),m.value=!1})).exec()})),y.value=!0}));e.watch((()=>u.modelValue),(a=>{y.value&&e.nextTick$1((()=>{new Promise((a=>{if(!S.value||!S.value.proxy)return console.warn("Component instance not available for selector query"),a();e.index.createSelectorQuery().in(S.value.proxy).select(".con").boundingClientRect((e=>{if(!e)return a();d.value=u.cols,v.value=e.width/u.cols,r.value=1.3*v.value,u.imageWidth>0&&(v.value=V(u.imageWidth),r.value=1.3*v.value,d.value=Math.floor(e.width/v.value)),a()})).exec()})).then((()=>{W(a)}))}))}),{deep:!0,immediate:!0});const W=e=>{const a=o.value.reduce(((e,a)=>(e[a.id]=a,e)),{});o.value=e.map((e=>{const l=a[e.id];return l?{...l,...M(e)}:$(e)})),o.value.forEach(((e,a)=>{e.index=a;const l=a%d.value,u=Math.floor(a/d.value);e.x=l*v.value,e.y=u*r.value,e.oldX=e.x,e.oldY=e.y,e.absX=l,e.absY=u}))},$=e=>{const a=M(e),l=o.value.length%d.value,u=Math.floor(o.value.length/d.value);return{...a,x:l*v.value,y:u*r.value,oldX:l*v.value,oldY:u*r.value,absX:l,absY:u,scale:1,zIndex:9,opacity:1,index:o.value.length,disable:!1,offset:0,moveEnd:!1,ready:!1}};return(l,u)=>e.e({a:v.value},v.value?{b:e.f(o.value,((a,l,u)=>({a:w(a.src),b:e.t(a.name),c:e.t(a.price),d:e.t(a.type),e:"scale("+a.scale+")",f:!a.disable&&a.ready?1:"",g:a.id,h:a.y,i:a.x,j:a.disable||!a.ready,k:e.o((l=>((a,l)=>{if(l&&(l.oldX=a.detail.x,l.oldY=a.detail.y,"touch"===a.detail.source)){l.moveEnd&&(l.offset=Math.sqrt(Math.pow(l.oldX-l.absX*v.value,2)+Math.pow(l.oldY-l.absY*r.value,2)));let u=Math.floor((a.detail.x+v.value/2)/v.value);if(u>=d.value)return;let t=Math.floor((a.detail.y+r.value/2)/r.value),n=d.value*t+u;l.index!==n&&n<o.value.length&&(f.value=!1,o.value.forEach((a=>{l.index>n&&a.index>=n&&a.index<l.index?k(a,1):l.index<n&&a.index<=n&&a.index>l.index?k(a,-1):a.id!==l.id&&(a.offset=0,a.x=a.oldX,a.y=a.oldY,setTimeout((()=>{e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value}))}),0))})),T(l,n),l.index=n,l.absX=u,l.absY=t,l.moveEnd||setTimeout((()=>{e.nextTick$1((()=>{l.x=l.absX*v.value,l.y=l.absY*r.value}))}),0),I())}})(l,a)),a.id),l:e.o((l=>((a,l)=>{p.value=l.touches[0].clientY,x.value&&(clearTimeout(x.value),x.value=null),o.value.forEach((e=>{e.ready=!1,e.disable=!0})),console.log("长按开始"),x.value=setTimeout((()=>{console.log("长按成功！"),e.index.vibrateShort({success:()=>{console.log("触感反馈")}}),a.ready=!0,a.disable=!1,h.value=!0,E(a)}),240)})(a,l)),a.id),m:e.o((l=>(a=>{if(a.scale=1,a.opacity=1,a.x=a.oldX,a.y=a.oldY,a.offset=0,a.moveEnd=!1,console.log("结束点击，清理ready"),o.value.forEach((e=>{e.ready=!1,e.disable=!0})),1==h.value){console.log("来自于拖拽的结束,上报排序事件");const e=o.value.map((e=>e.id));t("sort-change",e)}h.value=!1,x.value&&(clearTimeout(x.value),x.value=null),setTimeout((()=>{o.value.forEach((e=>{e.ready||(e.x=e.absX*v.value,e.y=e.absY*r.value,e.offset=0,e.moveEnd=!1)})),e.nextTick$1((()=>{a.x=a.absX*v.value,a.y=a.absY*r.value,s.value=null,f.value=!0}))}),50)})(a)),a.id),n:e.o((l=>{return u=a.id,void e.index.navigateTo({url:"/pages/account_book_preview/account_book_preview?account_book_id="+u});var u}),a.id),o:e.o((e=>((e,a)=>{if(h.value)return;const l=e.touches[0].clientY;Math.abs(l-p.value)>10&&x.value&&(clearTimeout(x.value),x.value=null)})(e)),a.id),p:a.zIndex,q:a.opacity}))),c:g.value,d:Y.value,e:a.borderRadius+"rpx",f:a.itemMargin+"px",g:v.value+"px",h:r.value+"px",i:b.value,j:e.o(N),k:e.o(_)}:{})}},l=e._export_sfc(a,[["__scopeId","data-v-def919f4"]]);wx.createComponent(l);
