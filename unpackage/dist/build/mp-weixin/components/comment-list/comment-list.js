"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("attitude-widget")+e.resolveComponent("uni-icons"))()}Math||((()=>"../attitude-widget/attitude-widget.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js"))();const l={__name:"comment-list",props:{type:{type:Number,required:!0},relationId:{type:Number,required:!0}},emits:["reply"],setup(l,{expose:a,emit:o}){const i=l,n=e.ref([]),d=e.ref(1),s=e.ref(0),u=e.ref(!0);e.reactive({});const r=o,c=e.ref(!1),h=(e,{status:t,counts:l})=>{e.attitudeStatus=t,e.attitudeCounts=l};a({addNewComment:e=>{n.value.unshift({...e,showAll:!1,localChildren:[],childTotal:0})},addReplyComment:e=>{const t=n.value.find((t=>t.id===e.parent_id));t&&(t.localChildren||(t.localChildren=[]),"number"!=typeof t.childTotal&&(t.childTotal=0),t.localChildren.unshift(e),t.childTotal+=1,!t.showAll&&t.childTotal<=5&&(t.showAll=!0))}}),e.onMounted((()=>{w()}));const p=e=>!e.showAll&&e.localChildren.length>5?e.localChildren.slice(0,5):e.localChildren,g=async()=>{if(!c.value&&u.value)try{c.value=!0,d.value+=1,await w()}finally{c.value=!1}},m=async l=>{if(t.global.isLogin)try{const a=e.index.getStorageSync("token"),o=`${t.websiteUrl}/with-state/${l.user_like?"unlike":"add-like"}`,i=await e.index.request({url:o,method:"POST",header:{Authorization:a},data:{id:l.id,type:6}});"success"===i.data.status?(l.user_like=!l.user_like,l.user_like?l.like_count=(l.like_count||0)+1:l.like_count=Math.max(0,(l.like_count||0)-1),e.index.showToast({title:l.user_like?"点赞成功":"已取消点赞",icon:"none"})):e.index.showToast({title:i.data.msg||"操作失败",icon:"none"})}catch(a){console.error("点赞失败:",a),e.index.showToast({title:"操作失败",icon:"none"})}else e.index.showToast({title:"请先登录",icon:"none"})},_=t=>{e.index.navigateTo({url:"/pages/user_page/user_page?uid="+t})},v=e=>{const t=new Date(1e3*e);return`${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}`},y=e=>e.length>12?e.slice(0,12)+"...":e,w=async()=>{try{c.value=!0;let l=e.index.getStorageSync("token");const a=await e.index.request({url:`${t.websiteUrl}/get-comments`,data:{relation_id:i.relationId,type:i.type,page:d.value,page_size:10},header:{Authorization:l}});if("success"===a.data.status){const e=a.data.data,t=e.comment_list.map((e=>({...e,showAll:!1,localChildren:e.children||[],childTotal:e.childTotal||(e.children?e.children.length:0),attitudeStatus:e.user_attitude||0,attitudeCounts:e.attitude_counts||{1:e.count_1||0,2:e.count_2||0,3:e.count_3||0,4:e.count_4||0,5:e.count_5||0}})));1===d.value?n.value=t:n.value.push(...t),console.log("total",e.total),u.value=e.total>n.value.length,s.value=e.total,console.log("是否还有更多?",u.value)}}catch(l){e.index.showToast({title:"加载失败",icon:"none"})}finally{c.value=!1}},f=(e,t=null)=>{r("reply",{parent:e,target:t,relationId:i.relationId})},C=e=>e.childTotal>5&&!e.showAll,k=e=>e.childTotal-Math.min(e.localChildren.length,5);return(l,a)=>e.e({a:n.value.length>0},n.value.length>0?{b:e.t(s.value)}:{},{c:e.f(n.value,((l,a,o)=>e.e({a:e.o((e=>_(l.uid)),l.id),b:l.avatar,c:e.t(y(l.username)),d:e.o((e=>_(l.uid)),l.id),e:e.t(l.floor),f:e.t(l.comment),g:e.o((e=>f(l)),l.id),h:e.o((e=>h(l,e)),l.id),i:"779bedea-0-"+o,j:e.p({"target-id":l.id,type:6,"attitude-status":l.attitudeStatus,"attitude-counts":l.attitudeCounts}),k:e.t(v(l.created_at)),l:"779bedea-1-"+o,m:e.p({type:l.user_like?"hand-up-filled":"hand-up",size:"18",color:l.user_like?"rgb(100 198 220)":"#999"}),n:e.t(l.like_count||0),o:l.user_like?1:"",p:e.o((e=>m(l)),l.id),q:e.o((e=>f(l)),l.id),r:l.localChildren&&l.localChildren.length},l.localChildren&&l.localChildren.length?e.e({s:e.f(p(l),((t,a,i)=>e.e({a:e.o((e=>_(t.uid)),t.id),b:t.avatar,c:e.t(y(t.username)),d:e.o((e=>_(t.uid)),t.id),e:t.reply_for},t.reply_for?{f:e.t(t.reply_for)}:{},{g:e.t(t.comment),h:e.o((e=>f(l)),t.id),i:e.o((e=>h(l,e)),t.id),j:"779bedea-2-"+o+"-"+i,k:e.p({"target-id":t.id,type:6,"attitude-status":l.attitudeStatus,"attitude-counts":l.attitudeCounts}),l:e.t(v(t.created_at)),m:"779bedea-3-"+o+"-"+i,n:e.p({type:t.user_like?"hand-up-filled":"hand-up",size:"18",color:t.user_like?"rgb(100 198 220)":"#999"}),o:e.t(t.like_count||0),p:t.user_like?1:"",q:e.o((e=>m(t)),t.id),r:e.o((e=>f(l,t)),t.id),s:t.id}))),t:C(l)},C(l)?{v:e.t(k(l)),w:"779bedea-4-"+o,x:e.p({type:"arrow-down",size:"18",color:"#007AFF"}),y:e.o((a=>(async l=>{if(l.localChildren.length<l.childTotal){const o=Math.ceil(l.localChildren.length/5)+1;try{const a=await e.index.request({url:`${t.websiteUrl}/get-comments-by-parent-id`,data:{parent_id:l.id,page:o}});"success"===a.data.status&&(l.localChildren=[...l.localChildren,...a.data.data.comment_list],l.childTotal=a.data.data.total,l.localChildren.length>=5&&!l.showAll&&(l.showAll=!0))}catch(a){e.index.showToast({title:"加载失败",icon:"none"})}}else l.showAll=!l.showAll})(l)),l.id)}:{}):{},{z:l.id}))),d:n.value.length>0},n.value.length>0?e.e({e:u.value},u.value?e.e({f:!c.value},c.value?{h:e.p({type:"spinner-cycle",size:"16",color:"#888"})}:{g:e.p({type:"arrow-down",size:"18",color:"#007AFF"})},{i:e.o(g),j:c.value?1:""}):{}):{})}};wx.createComponent(l);
