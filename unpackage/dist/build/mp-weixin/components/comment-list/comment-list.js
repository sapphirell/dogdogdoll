"use strict";const e=require("../../common/vendor.js"),t=require("../../common/config.js");if(!Array){(e.resolveComponent("report-button")+e.resolveComponent("uni-icons")+e.resolveComponent("attitude-widget"))()}Math||((()=>"../report-button/report-button.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../attitude-widget/attitude-widget.js"))();const l={__name:"comment-list",props:{type:{type:Number,required:!0},relationId:{type:Number,required:!0}},emits:["reply"],setup(l,{expose:i,emit:a}){const o=l,n=e.ref([]),d=e.ref(1),s=e.ref(0),r=e.ref(!0);e.reactive({});const u=a,c=e.ref(!1),h=e.ref({}),p=(e,{status:t,counts:l})=>{e.attitudeStatus=t,e.attitudeCounts=l};i({addNewComment:e=>{const t={...e,isTemp:!0,showAll:!1,localChildren:[],childTotal:0};h.value[e.id]=t,n.value.unshift(t)},addReplyComment:e=>{const t=e.parent_id,l=n.value.find((e=>e.id===t));if(l){const t={...e,isTemp:!0};h.value[e.id]=t,l.localChildren||(l.localChildren=[]),"number"!=typeof l.childTotal&&(l.childTotal=0),l.localChildren.unshift(t),l.childTotal+=1,!l.showAll&&l.childTotal<=5&&(l.showAll=!0)}},updateTempComment:(e,t)=>{const l=n.value.findIndex((t=>t.id===e));if(-1!==l)return n.value[l]={...t,showAll:n.value[l].showAll,localChildren:n.value[l].localChildren||[],childTotal:n.value[l].childTotal||0},void delete h.value[e];for(const i of n.value)if(i.localChildren&&i.localChildren.length){const l=i.localChildren.findIndex((t=>t.id===e));if(-1!==l)return i.localChildren[l]={...t,parent_id:i.localChildren[l].parent_id},void delete h.value[e]}},removeTempComment:e=>{const t=n.value.findIndex((t=>t.id===e));if(-1!==t)return n.value.splice(t,1),void delete h.value[e];for(const l of n.value)if(l.localChildren&&l.localChildren.length){const t=l.localChildren.findIndex((t=>t.id===e));if(-1!==t)return l.localChildren.splice(t,1),l.childTotal=Math.max(0,l.childTotal-1),void delete h.value[e]}}}),e.onMounted((()=>{w()}));const g=e=>!e.showAll&&e.localChildren.length>5?e.localChildren.slice(0,5):e.localChildren,m=async()=>{if(!c.value&&r.value)try{c.value=!0,d.value+=1,await w()}finally{c.value=!1}},v=t=>{e.index.previewImage({urls:[t],current:t})},_=async l=>{if(t.global.isLogin)try{const i=e.index.getStorageSync("token"),a=`${t.websiteUrl.value}/with-state/${l.user_like?"unlike":"add-like"}`,o=await e.index.request({url:a,method:"POST",header:{Authorization:i},data:{id:l.id,type:6}});"success"===o.data.status?(l.user_like=!l.user_like,l.user_like?l.like_count=(l.like_count||0)+1:l.like_count=Math.max(0,(l.like_count||0)-1),e.index.showToast({title:l.user_like?"点赞成功":"已取消点赞",icon:"none"})):e.index.showToast({title:o.data.msg||"操作失败",icon:"none"})}catch(i){console.error("点赞失败:",i),e.index.showToast({title:"操作失败",icon:"none"})}else e.index.showToast({title:"请先登录",icon:"none"})},C=t=>{e.index.navigateTo({url:"/pages/user_page/user_page?uid="+t})},y=e=>{const t=new Date(1e3*e);return`${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes()}`},f=e=>e?e.length>12?e.slice(0,12)+"...":e:"未知用户",w=async()=>{try{c.value=!0;let l=e.index.getStorageSync("token");const i=await e.index.request({url:`${t.websiteUrl.value}/get-comments`,data:{relation_id:o.relationId,type:o.type,page:d.value,page_size:10},header:{Authorization:l}});if("success"===i.data.status){const e=i.data.data,t=e.comment_list.map((e=>({...e,showAll:!1,localChildren:e.children||[],childTotal:e.childTotal||(e.children?e.children.length:0),attitudeStatus:e.user_attitude||0,attitudeCounts:e.attitude_counts||{1:e.count_1||0,2:e.count_2||0,3:e.count_3||0,4:e.count_4||0,5:e.count_5||0}})));1===d.value?n.value=t:n.value.push(...t),console.log("total",e.total),r.value=e.total>n.value.length,s.value=e.total,console.log("是否还有更多?",r.value)}}catch(l){e.index.showToast({title:"加载失败",icon:"none"})}finally{c.value=!1}},b=(e,t=null)=>{u("reply",{parent:e,target:t,relationId:o.relationId})},T=e=>1===e?"娃物":2===e?"店铺":"关联内容",x=t=>{t.association_id&&(1===t.association_type?e.index.navigateTo({url:`/pages/goods/goods?goods_id=${t.association_id}`}):2===t.association_type&&e.index.navigateTo({url:`/pages/brand/brand?brand_id=${t.association_id}`}))},k=e=>e.childTotal>5&&!e.showAll,A=e=>e.childTotal-Math.min(e.localChildren.length,5);return(l,i)=>e.e({a:n.value.length>0},n.value.length>0?{b:e.t(s.value)}:{},{c:e.f(n.value,((l,i,a)=>e.e({a:e.o((e=>C(l.uid)),l.id),b:l.avatar,c:e.t(f(l.username)),d:e.o((e=>C(l.uid)),l.id),e:e.t(l.floor),f:"779bedea-0-"+a,g:e.p({"report-type":5,"relation-id":l.id,"button-text":"举报","icon-color":"#999","theme-color":"#64c6dc","icon-size":"24"}),h:l.image_url},l.image_url?{i:l.image_url,j:e.o((e=>v(l.image_url)),l.id)}:{},{k:e.t(l.comment),l:e.o((e=>b(l)),l.id),m:l.association_id},l.association_id?{n:l.association_image,o:e.t(l.association_name),p:e.t(T(l.association_type)),q:"779bedea-1-"+a,r:e.p({type:"arrow-right",size:"20",color:"#999"}),s:e.o((e=>x(l)),l.id)}:{},{t:e.t(y(l.created_at)),v:"779bedea-2-"+a,w:e.p({type:l.user_like?"hand-up-filled":"hand-up",size:"18",color:l.user_like?"rgb(100 198 220)":"#999"}),x:e.t(l.like_count||0),y:l.user_like?1:"",z:e.o((e=>_(l)),l.id),A:e.o((e=>p(l,e)),l.id),B:"779bedea-3-"+a,C:e.p({"target-id":l.id,type:6,"attitude-status":l.attitudeStatus,"attitude-counts":l.attitudeCounts}),D:e.o((e=>b(l)),l.id),E:l.localChildren&&l.localChildren.length},l.localChildren&&l.localChildren.length?e.e({F:e.f(g(l),((t,i,o)=>e.e({a:e.o((e=>C(t.uid)),t.id),b:t.avatar,c:e.t(f(t.username)),d:e.o((e=>C(t.uid)),t.id),e:"779bedea-4-"+a+"-"+o,f:e.p({"report-type":5,"relation-id":t.id,"button-text":"举报","icon-color":"#999","theme-color":"#64c6dc"}),g:t.image_url},t.image_url?{h:t.image_url,i:e.o((e=>v(t.image_url)),t.id)}:{},{j:e.t(t.comment),k:e.o((e=>b(l)),t.id),l:t.association_id},t.association_id?{m:t.association_image,n:e.t(t.association_name),o:e.t(T(t.association_type)),p:"779bedea-5-"+a+"-"+o,q:e.p({type:"arrow-right",size:"20",color:"#999"}),r:e.o((e=>x(t)),t.id)}:{},{s:e.t(y(t.created_at)),t:"779bedea-6-"+a+"-"+o,v:e.p({type:t.user_like?"hand-up-filled":"hand-up",size:"18",color:t.user_like?"rgb(100 198 220)":"#999"}),w:e.t(t.like_count||0),x:t.user_like?1:"",y:e.o((e=>_(t)),t.id),z:e.o((e=>p(l,e)),t.id),A:"779bedea-7-"+a+"-"+o,B:e.p({"target-id":t.id,type:6,"attitude-status":l.attitudeStatus,"attitude-counts":l.attitudeCounts}),C:e.o((e=>b(l,t)),t.id),D:t.id}))),G:k(l)},k(l)?{H:e.t(A(l)),I:"779bedea-8-"+a,J:e.p({type:"arrow-down",size:"18",color:"#007AFF"}),K:e.o((i=>(async l=>{if(l.localChildren.length<l.childTotal){const a=Math.ceil(l.localChildren.length/5)+1;try{const i=await e.index.request({url:`${t.websiteUrl.value}/get-comments-by-parent-id`,data:{parent_id:l.id,page:a}});"success"===i.data.status&&(l.localChildren=[...l.localChildren,...i.data.data.comment_list],l.childTotal=i.data.data.total,l.localChildren.length>=5&&!l.showAll&&(l.showAll=!0))}catch(i){e.index.showToast({title:"加载失败",icon:"none"})}}else l.showAll=!l.showAll})(l)),l.id)}:{}):{},{L:l.id}))),d:n.value.length>0},n.value.length>0?e.e({e:r.value},r.value?e.e({f:!c.value},c.value?{h:e.p({type:"spinner-cycle",size:"16",color:"#888"})}:{g:e.p({type:"arrow-down",size:"18",color:"#007AFF"})},{i:e.o(m),j:c.value?1:""}):{}):{})}};wx.createComponent(l);
