"use strict";const e=require("../../common/vendor.js"),l=require("../../common/config.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"comment-list",props:{type:{type:Number,required:!0},relationId:{type:Number,required:!0}},emits:["reply"],setup(t,{expose:a,emit:o}){const n=t,i=e.ref([]),r=e.ref(1),d=e.ref(0),c=e.ref(!0);e.reactive({});const s=o,h=e.ref(!1);a({addNewComment:e=>{i.value.unshift({...e,showAll:!1,localChildren:[],childTotal:0})},addReplyComment:e=>{const l=i.value.find((l=>l.id===e.parent_id));l&&(l.localChildren||(l.localChildren=[]),"number"!=typeof l.childTotal&&(l.childTotal=0),l.localChildren.unshift(e),l.childTotal+=1,!l.showAll&&l.childTotal<=5&&(l.showAll=!0))}}),e.onMounted((()=>{y()}));const u=e=>!e.showAll&&e.localChildren.length>5?e.localChildren.slice(0,5):e.localChildren,p=async()=>{if(!h.value&&c.value)try{h.value=!0,r.value+=1,await y()}finally{h.value=!1}},m=l=>{e.index.navigateTo({url:"/pages/user_page/user_page?uid="+l})},g=e=>{const l=new Date(1e3*e);return`${l.getMonth()+1}-${l.getDate()} ${l.getHours()}:${l.getMinutes()}`},v=e=>e.length>12?e.slice(0,12)+"...":e,y=async()=>{try{h.value=!0;const t=await e.index.request({url:`${l.websiteUrl}/get-comments`,data:{relation_id:n.relationId,type:n.type,page:r.value,page_size:10}});if("success"===t.data.status){const e=t.data.data,l=e.comment_list.map((e=>({...e,showAll:!1,localChildren:e.children||[],childTotal:e.childTotal||(e.children?e.children.length:0)})));1===r.value?i.value=l:i.value.push(...l),console.log("total",e.total),c.value=e.total>i.value.length,d.value=e.total,console.log("是否还有更多?",c.value)}}catch(t){e.index.showToast({title:"加载失败",icon:"none"})}finally{h.value=!1}},f=(e,l=null)=>{s("reply",{parent:e,target:l,relationId:n.relationId})},w=e=>e.childTotal>5&&!e.showAll,C=e=>e.childTotal-Math.min(e.localChildren.length,5);return(t,a)=>e.e({a:i.value.length>0},i.value.length>0?{b:e.t(d.value)}:{},{c:e.f(i.value,((t,a,o)=>e.e({a:e.o((e=>m(t.uid)),t.id),b:t.avatar,c:e.t(v(t.username)),d:e.o((e=>m(t.uid)),t.id),e:e.t(t.floor),f:e.t(t.comment),g:e.o((e=>f(t)),t.id),h:e.t(g(t.created_at)),i:e.o((e=>f(t)),t.id),j:t.localChildren&&t.localChildren.length},t.localChildren&&t.localChildren.length?e.e({k:e.f(u(t),((l,a,o)=>e.e({a:e.o((e=>m(l.uid)),l.id),b:l.avatar,c:e.t(v(l.username)),d:e.o((e=>m(l.uid)),l.id),e:l.reply_for},l.reply_for?{f:e.t(l.reply_for)}:{},{g:e.t(l.comment),h:e.o((e=>f(t)),l.id),i:e.t(g(l.created_at)),j:e.o((e=>f(t,l)),l.id),k:l.id}))),l:w(t)},w(t)?{m:e.t(C(t)),n:"779bedea-0-"+o,o:e.p({type:"arrow-down",size:"18",color:"#007AFF"}),p:e.o((a=>(async t=>{if(t.localChildren.length<t.childTotal){const o=Math.ceil(t.localChildren.length/5)+1;try{const a=await e.index.request({url:`${l.websiteUrl}/get-comments-by-parent-id`,data:{parent_id:t.id,page:o}});"success"===a.data.status&&(t.localChildren=[...t.localChildren,...a.data.data.comment_list],t.childTotal=a.data.data.total,t.localChildren.length>=5&&!t.showAll&&(t.showAll=!0))}catch(a){e.index.showToast({title:"加载失败",icon:"none"})}}else t.showAll=!t.showAll})(t)),t.id)}:{}):{},{q:t.id}))),d:i.value.length>0},i.value.length>0?e.e({e:c.value},c.value?e.e({f:!h.value},h.value?{h:e.p({type:"spinner-cycle",size:"16",color:"#888"})}:{g:e.p({type:"arrow-down",size:"18",color:"#007AFF"})},{i:e.o(p),j:h.value?1:""}):{}):{})}};wx.createComponent(t);
