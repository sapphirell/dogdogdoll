"use strict";const e=require("../../common/vendor.js"),n=require("../../common/config.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("common-modal"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../common-modal/common-modal.js"))();const o={__name:"server-selector",emits:["server-change"],setup(o,{emit:t}){const a=e.reactive([{name:"中国",url:n.cnURL,ping:-1},{name:"美国",url:n.usURL,ping:-1},{name:"Localhost",url:n.devUrl,ping:-1}]),s=e.ref(!1),l=e.ref(""),r=e.ref(-1);let i=null;const c=t;e.onMounted((()=>{const o=e.index.getStorageSync("selectedServer");l.value=o||n.cnURL,n.websiteUrl.value=l.value,v(),u()})),e.onUnmounted((()=>{clearInterval(i)}));const u=()=>{i=setInterval((()=>{v()}),5e3)},v=async()=>{try{const e=Date.now();await p(l.value),r.value=Date.now()-e}catch(e){r.value=-2}};e.watch(s,(e=>{e&&m()}));const m=async()=>{for(const n of a){n.ping=-1;try{const e=Date.now();await p(n.url),n.ping=Date.now()-e,n.url===l.value&&(r.value=n.ping)}catch(e){n.ping=-2,n.url===l.value&&(r.value=-2)}}},p=n=>new Promise(((o,t)=>{e.index.request({url:`${n}/ping`,method:"GET",timeout:5e3,success:()=>o(),fail:()=>t()})}));return(o,t)=>({a:e.p({type:"paperplane",size:"24",color:"#5db7ff"}),b:e.t(r.value>=0?r.value+"ms":"9999ms"),c:e.o((e=>s.value=!0)),d:e.t(r.value>=0?r.value+"ms":"-1ms"),e:e.f(a,((o,t,a)=>e.e({a:e.t(o.name),b:-1===o.ping},-1===o.ping?{c:"47f41f1f-2-"+a+",47f41f1f-1",d:e.p({type:"spinner-cycle",size:"16",color:"#999"})}:-2===o.ping?{}:{f:e.t(o.ping)},{e:-2===o.ping,g:t,h:o.url===l.value?1:"",i:-1===o.ping?1:"",j:e.o((t=>(o=>{-2!==o.ping?(l.value=o.url,n.websiteUrl.value=o.url,e.index.setStorageSync("selectedServer",o.url),r.value=o.ping,e.index.showToast({title:`已切换到${o.name}`,icon:"success"}),s.value=!1,c("server-change",{server:o,ping:o.ping})):e.index.showToast({title:"服务器连接失败，无法选择",icon:"none"})})(o)),t)}))),f:e.o((e=>s.value=e)),g:e.p({visible:s.value,top:"15vh"})})}};wx.createComponent(o);
