"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../common/config.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("shmily-drag-image")+e.resolveComponent("common-modal"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../shmily-drag-image/shmily-drag-image.js")+(()=>"../common-modal/common-modal.js"))();const o={__name:"stock-myitems",props:{accountBookData:Object},emits:["go2editor","update-type","init-request","update:accountBookData"],setup(o,{emit:n}){const i=o,l=n,u=e.ref(!0),s=e.ref(!1),c=e.ref(""),r=e.ref([]),d=e.ref(0),v=e.ref("全部"),p=e.ref(null),m=e.ref(""),h=e.ref(!1),y=e.ref(!1),f=e.ref([]),g=["全部"],w=e.computed((()=>[...g,...r.value.map((e=>e.name))]));e.watch([r,v],(()=>{const e=w.value,t=v.value||"全部",a=e.findIndex((e=>e===t));d.value=a>=0?a:0}));const x=e.computed((()=>i.accountBookData.account_books?i.accountBookData.account_books.reduce(((e,t)=>e+(parseFloat(t.price)||0)),0).toFixed(2):0)),k=async()=>{const t=e.index.getStorageSync("token");try{const o=await e.index.request({url:a.websiteUrl.value+"/with-state/account-types",method:"GET",header:{Authorization:t}});r.value=o.data.data||[],f.value=r.value.map((e=>e.id))}catch(o){console.error("获取分类失败:",o)}},S=async()=>{if(!c.value)return void e.index.showToast({title:"请输入分类名称",icon:"none"});if(c.value.length>10)return void e.index.showToast({title:"不能超过10个字符",icon:"none"});const t=e.index.getStorageSync("token");try{await e.index.request({url:a.websiteUrl.value+"/with-state/add-account-type",method:"POST",header:{Authorization:t},data:{name:c.value}}),c.value="",await k(),e.index.showToast({title:"添加成功"})}catch(o){e.index.showToast({title:"添加失败",icon:"none"})}},T=t=>{const o=e.index.getStorageSync("token");e.index.request({url:a.websiteUrl.value+"/with-state/sort-account-book",method:"POST",header:{Authorization:o,"Content-Type":"application/json"},data:{sorted_ids:t},success:e=>{},fail:e=>{console.error("排序失败:",e)}})},b=()=>{p.value=null,m.value=""},_=async t=>{var o,n;if(h.value)return;const i=(m.value||"").trim();if(!i)return void e.index.showToast({title:"请输入分类名称",icon:"none"});if(i.length>10)return void e.index.showToast({title:"不能超过10个字符",icon:"none"});h.value=!0;const u=e.index.getStorageSync("token"),s=t.name;try{const c=await e.index.request({url:a.websiteUrl.value+"/with-state/update-account-book-type",method:"POST",header:{Authorization:u,"Content-Type":"application/json"},data:{id:t.id,name:i}});if((null==(o=c.data)?void 0:o.status)&&"success"!==c.data.status)throw new Error((null==(n=c.data)?void 0:n.msg)||"更新失败");v.value===s&&(v.value=i,l("update-type",i)),await k(),e.index.showToast({title:"修改成功"})}catch(c){e.index.showToast({title:(null==c?void 0:c.message)||"修改失败",icon:"none"})}finally{h.value=!1,b()}},z=(e,t,a)=>{if(t===a)return;const o=e.splice(t,1)[0];e.splice(a,0,o)},j=e.computed((()=>{const e=r.value.map((e=>e.id));if(e.length!==f.value.length)return!0;for(let t=0;t<e.length;t++)if(e[t]!==f.value[t])return!0;return!1})),B=async()=>{var t,o;if(!j.value||y.value)return;y.value=!0;const n=e.index.getStorageSync("token"),i=r.value.map((e=>e.id));try{const l=await e.index.request({url:a.websiteUrl.value+"/with-state/sort-account-book-type",method:"POST",header:{Authorization:n,"Content-Type":"application/json"},data:{sorted_ids:i}});if((null==(t=l.data)?void 0:t.status)&&"success"!==l.data.status)throw new Error((null==(o=l.data)?void 0:o.msg)||"保存失败");f.value=[...i],e.index.showToast({title:"排序已保存"})}catch(l){e.index.showToast({title:(null==l?void 0:l.message)||"保存失败",icon:"none"})}finally{y.value=!1}},q=t=>{d.value=t.detail.value,v.value=w.value[d.value],e.index.setStorageSync("accountBookSelectedType",v.value),l("update-type","全部"===v.value?"":v.value)};return e.watch(u,(t=>e.index.setStorageSync("accountBookPriceVisible",String(t)))),e.onShow((async()=>{const t=e.index.getStorageSync("accountBookPriceVisible");""!==t&&(u.value="true"===t),(()=>{const t=e.index.getStorageSync("accountBookSelectedType");v.value=t&&""!==t?t:"全部"})(),await k(),l("update-type","全部"===v.value?"":v.value)})),(n,i)=>{var f,g;return e.e({a:e.t(w.value[d.value]),b:e.p({type:"arrowdown",size:"14",color:"#747EE5"}),c:d.value,d:w.value,e:e.o(q),f:e.p({type:"gear",size:"16",color:"#fff"}),g:e.o((e=>s.value=!0)),h:e.p({type:"money",size:"18",color:"#74c9e5"}),i:u.value},u.value?{j:e.t(x.value)}:{},{k:e.o((e=>u.value=!u.value)),l:e.p({type:u.value?"eye":"eye-slash",size:"18",color:"#74c9e5"}),m:(null==(f=o.accountBookData.account_books)?void 0:f.length)>0},(null==(g=o.accountBookData.account_books)?void 0:g.length)>0?{n:e.o(T),o:e.o((e=>o.accountBookData.account_books=e)),p:e.p({"border-radius":"20",modelValue:o.accountBookData.account_books})}:{q:t._imports_0$3},{r:e.f(r.value,((t,o,n)=>e.e({a:p.value===t.id},p.value===t.id?{b:e.o((e=>_(t)),t.id),c:e.o((e=>(e=>{p.value===e.id&&_(e)})(t)),t.id),d:m.value,e:e.o(e.m((e=>m.value=e.detail.value),{trim:!0}),t.id)}:{f:e.t(t.name)},{g:p.value!==t.id},p.value!==t.id?{h:0===o||y.value,i:e.o((e=>{var t;(t=o)>0&&z(r.value,t,t-1)}),t.id),j:o===r.value.length-1||y.value,k:e.o((e=>{var t;(t=o)<r.value.length-1&&z(r.value,t,t+1)}),t.id)}:{},{l:p.value===t.id},p.value===t.id?{m:h.value,n:h.value,o:e.o((e=>_(t)),t.id),p:h.value,q:e.o(b,t.id)}:{r:e.o((e=>(e=>{p.value=e.id,m.value=e.name})(t)),t.id),s:"933a2509-6-"+n+",933a2509-5",t:e.p({type:"compose",size:"20",color:"#74c9e5"}),v:e.o((o=>(async t=>{e.index.showModal({title:"确认删除",success:async o=>{if(!o.confirm)return;const n=e.index.getStorageSync("token");try{const o=(await e.index.request({url:a.websiteUrl.value+"/with-state/delete-account-type",method:"POST",header:{Authorization:n,"Content-Type":"application/json"},data:{id:t}})).data;if((null==o?void 0:o.status)&&"success"!==o.status)return void e.index.showToast({title:(null==o?void 0:o.msg)||"删除失败",icon:"none"});await k(),"全部"===v.value||r.value.some((e=>e.name===v.value))||(v.value="全部",l("update-type","")),e.index.showToast({title:"删除成功"})}catch(i){console.error("删除失败:",i),e.index.showToast({title:i.errMsg||"请求失败",icon:"none"})}}})})(t.id)),t.id),w:"933a2509-7-"+n+",933a2509-5",x:e.p({type:"trash",size:"20",color:"#ff6666"})},{y:t.id}))),s:0===r.value.length},0===r.value.length?{t:t._imports_1$8}:{},{v:c.value,w:e.o(e.m((e=>c.value=e.detail.value),{trim:!0})),x:e.p({type:"plus",size:"16",color:"#fff"}),y:e.o(S),z:j.value},j.value?{A:e.p({type:"save",size:"16",color:"#fff"}),B:y.value,C:y.value||!j.value,D:e.o(B)}:{},{E:e.o((e=>s.value=e)),F:e.p({visible:s.value,top:"10%"})})}}},n=e._export_sfc(o,[["__scopeId","data-v-933a2509"]]);wx.createComponent(n);
