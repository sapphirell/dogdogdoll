"use strict";const e=require("../../common/vendor.js"),o=require("../../common/config.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("common-name-picker")+e.resolveComponent("common-search")+e.resolveComponent("custom-picker")+e.resolveComponent("goods-search")+e.resolveComponent("common-modal"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../common-name-picker/common-name-picker.js")+(()=>"../common-search/common-search.js")+(()=>"../custom-picker/custom-picker.js")+(()=>"../goods-search/goods-search.js")+(()=>"../common-modal/common-modal.js"))();const a={__name:"relation-picker",props:{typeList:{type:Array,default:()=>[]},visible:{type:Boolean,default:!1}},emits:["update:visible","confirm","cancel"],setup(a,{emit:n}){const l=a,i=n,s=e.ref([]),d=e.ref(),r=e.ref(),t=e.ref(),u=e.ref(),c=e.ref(!1),m=e.ref(!0),v=e.ref({type:null,brand:{id:0,name:""},goods:{id:0,name:"",image:""}}),g=e.ref(""),p=e=>{m.value=e,y(),v.value={type:null,brand:{id:0,name:""},goods:{id:0,name:"",image:""}}},f=e=>{const o={type:d,brand:r,goods:t,fuzzy:u};Object.entries(o).forEach((([o,a])=>{var n;o!==e&&(null==(n=a.value)?void 0:n.close)&&a.value.close()}))},y=()=>{[d,r,t,u].forEach((e=>{var o;(null==(o=e.value)?void 0:o.reset)&&e.value.reset()}))},b=async o=>{var a;try{if(!(null==o?void 0:o.id))return g.value=o.name,void(v.value={type:"未知类型",brand:{id:0,name:""},goods:{id:0,name:o.name,image:""}});const e=await k(o.id);g.value=o.name,v.value={type:e.type||"未知类型",brand:{id:e.brand_id||0,name:e.brand_name||""},goods:{id:o.id,name:o.name,image:(null==(a=null==e?void 0:e.goods_images)?void 0:a[0])||""}}}catch(n){console.error("商品信息获取失败",n),e.index.showToast({title:"详细信息获取失败，已保存基本信息",icon:"none"}),g.value=o.name,v.value={type:"未知类型",brand:{id:0,name:""},goods:{id:(null==o?void 0:o.id)||0,name:o.name,image:""}}}},h=()=>{c.value=!1,g.value="",y(),e.nextTick$1((()=>{v.value={type:null,brand:{id:0,name:""},goods:{id:0,name:"",image:""}}}))};e.watch((()=>l.visible),(e=>{c.value=e})),e.watch(c,(e=>{i("update:visible",e)}));const j=e=>{c.value=e,e||h()},w=e=>{v.value.type=e},k=a=>new Promise(((n,l)=>{e.index.request({url:o.websiteUrl+"/goods?id="+a,method:"GET",timeout:5e3,success:e=>{n(e.data.data)},fail:e=>{console.error("商品详情获取失败",e),l(e)}})})),z=(a,n)=>{v.value.brand={id:a||0,name:n},a&&function(a){e.index.request({url:o.websiteUrl+"/goods-name-list?id="+a,method:"GET",timeout:5e3,success:e=>{console.log(e.data.data),s.value=e.data.data,console.log(s.value)},fail:o=>{console.log(o),e.index.showToast({title:"网络请求失败",icon:"none"})}})}(a)},_=async(o,a)=>{var n;try{if(v.value.goods={id:o||0,name:a,image:""},o&&0!==o){const e=await k(o);v.value.goods.image=(null==(n=null==e?void 0:e.goods_images)?void 0:n[0])||""}}catch(l){console.error("商品信息获取失败",l),e.index.showToast({title:"图片信息获取失败，已保存基本信息",icon:"none"})}};const x=async()=>{var o,a;try{let e=null;if(m.value)if(v.value.goods.id&&0!==v.value.goods.id)try{const a=await k(v.value.goods.id);e={isFuzzy:!0,keyword:g.value,goods:{id:a.id||v.value.goods.id,name:a.goods_name||v.value.goods.name,image:(null==(o=null==a?void 0:a.goods_images)?void 0:o[0])||""},brand:{id:a.brand_id||0,name:a.brand_name||""},type:a.type||"未知类型"}}catch(n){console.error("商品信息获取失败，使用缓存数据",n),e={isFuzzy:!0,keyword:g.value,goods:v.value.goods,brand:v.value.brand,type:v.value.type||"未知类型"}}else e={isFuzzy:!0,keyword:g.value,goods:{id:0,name:g.value,image:""},brand:{id:0,name:""},type:"未知类型"};else{if(console.log("jjjjjjjjjjjjjjjj"),v.value.goods.id&&0!==v.value.goods.id)try{const e=await k(v.value.goods.id);v.value.goods.image=(null==(a=null==e?void 0:e.goods_images)?void 0:a[0])||"",v.value.type=e.type||v.value.type}catch(n){console.error("商品信息获取失败，使用缓存数据",n)}if(!v.value.type)throw new Error("请选择商品类型");if(!v.value.brand.name)throw new Error("请填写或选择品牌");if(!v.value.goods.name)throw new Error("请填写或选择商品");e={isFuzzy:!1,type:v.value.type,brand:v.value.brand,goods:v.value.goods}}console.log("确认数据:",e),i("confirm",e),h()}catch(n){e.index.showToast({title:n.message,icon:"none"})}},C=()=>{i("cancel"),h()};return(o,n)=>e.e({a:m.value},m.value?{b:e.p({type:"search",size:"18",color:"#fff"}),c:e.o((e=>p(!1)))}:{},{d:!m.value},m.value?{}:{e:e.p({type:"list",size:"18",color:"#fff"}),f:e.o((e=>p(!0)))},{g:!m.value},m.value?{t:e.sr(u,"33fea23d-6,33fea23d-0",{k:"fuzzySearch"}),v:e.o(b),w:e.o((e=>f("fuzzy"))),x:e.o((e=>g.value=e)),y:e.p({mode:"fill",modelValue:g.value})}:{h:e.sr(d,"33fea23d-3,33fea23d-0",{k:"typePicker"}),i:e.o(w),j:e.o((e=>f("type"))),k:e.p({dataList:a.typeList}),l:e.sr(r,"33fea23d-4,33fea23d-0",{k:"brandSearch"}),m:e.o(z),n:e.o((e=>f("brand"))),o:e.p({mode:"fill"}),p:e.sr(t,"33fea23d-5,33fea23d-0",{k:"goodsPicker"}),q:e.o(_),r:e.o((e=>f("goods"))),s:e.p({dataList:s.value})},{z:e.o(C),A:e.o(x),B:e.o(j),C:e.p({visible:c.value,top:"3%"})})}},n=e._export_sfc(a,[["__scopeId","data-v-33fea23d"]]);wx.createComponent(n);
