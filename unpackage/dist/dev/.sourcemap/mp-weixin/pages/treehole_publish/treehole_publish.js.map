{"version":3,"file":"treehole_publish.js","sources":["pages/treehole_publish/treehole_publish.vue","pages/treehole_publish/treehole_publish.vue?type=page"],"sourcesContent":["<template>\r\n\t<common-page title=\"发布树洞\">\n\t\t<meta name=\"theme-color\" content=\"#F8F8F8\"></meta>\n\t\t<view-logs />\r\n\t\t<view class=\"publish-box\">\r\n\t\t\t<!-- 分类选择 -->\r\n\t\t\t<picker class=\"category-picker\" :range=\"categories\" range-key=\"label\" @change=\"handleCategoryChange\"\r\n\t\t\t\t:value=\"selectedIndex\">\r\n\t\t\t\t<view class=\"picker-content\">\r\n\t\t\t\t\t<text :class=\"['picker-text', selectedCategory ? '' : 'placeholder']\">\r\n\t\t\t\t\t\t{{ selectedCategoryLabel || '请选择分类（必选）' }}\r\n\t\t\t\t\t</text>\r\n\t\t\t\t\t<uni-icons type=\"right\" size=\"22\" color=\"#888\"></uni-icons>\r\n\t\t\t\t</view>\r\n\t\t\t</picker>\r\n\t\t\t<!-- 上传图片列表 -->\r\n\t\t\t<scroll-view scroll-x=\"true\" class=\"upload_box\" ll-with-animation=\"true\" :show-scrollbar=\"false\">\r\n\t\t\t\t<view class=\"upload_item\" v-for=\"(item, index) in uploadList\" :key=\"index\">\r\n\t\t\t\t\t<image :src=\"item\" class=\"uploaded_image\" @tap=\"viewFullImage\" mode=\"aspectFill\" />\r\n\t\t\t\t\t<image src=\"/static/cancel.png\" class=\"close_icon\" @tap=\"deleteImage(index)\" />\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"uploadImageBox\" style=\"background: #f8f8f8;\">\r\n\t\t\t\t\t<image src=\"/static/add2.png\" class=\"upload_img\" @tap=\"selectImage(index)\"\r\n\t\t\t\t\t\tstyle=\"width: 50px;height: 50px;margin: 25px;\" />\r\n\t\t\t\t</view>\r\n\r\n\t\t\t</scroll-view>\r\n\t\t\t<textarea v-model=\"content\" placeholder=\"写下你想说的话...\" class=\"textarea\" maxlength=\"500\" />\r\n\r\n\r\n\t\t\t<view class=\"anonymous\">\r\n\t\t\t\t<checkbox-group @change=\"handleAnonymous\">\r\n\t\t\t\t\t<label>\r\n\t\t\t\t\t\t<checkbox :checked=\"isAnonymous === 1\" color=\"#4cbbd0\" />\r\n\t\t\t\t\t\t<text>匿名发布</text>\r\n\t\t\t\t\t</label>\r\n\t\t\t\t</checkbox-group>\r\n\t\t\t</view>\r\n\r\n\r\n\t\t\t<view class=\"publish-detail\">\r\n\t\t\t\t<text>* 目前树洞为非审稿发布，只接受娃圈相关内容。</text>\r\n\t\t\t\t<!-- <text>* 我们会在工作时间进行审稿，您可以在个人投稿中心查看投稿状态，审核通过后稿件才被可见。</text> -->\r\n\t\t\t\t<text>* 如果勾选匿名发布，他人将无法通过稿件进入您的主页。如果稿件遭到过多点踩或投诉，我们可能会隐藏这封稿件。</text>\r\n\t\t\t</view>\r\n\r\n\t\t\t<button class=\"submit-btn\" :class=\"{ disabled: !canSubmit }\" @click=\"handleSubmit\">\r\n\t\t\t\t提交\r\n\t\t\t</button>\r\n\t\t</view>\r\n\t</common-page>\r\n</template>\r\n\r\n<script setup>\r\n\timport {\r\n\t\tonMounted,\r\n\t\tref,\r\n\t\tcomputed,\r\n\t} from 'vue';\r\n\timport {\r\n\t\twebsiteUrl,\r\n\t\timage1Url,\r\n\t\twechatSignLogin,\r\n\t\tgetUserInfo,\r\n\t\tglobal,\r\n\t\tasyncGetUserInfo,\r\n\t} from \"../../common/config.js\";\r\n\r\n\timport {\r\n\t\tchooseImage,\r\n\t\tjumpToCroper,\r\n\t\tgetQiniuToken,\r\n\t\tuploadImageToQiniu\r\n\t} from \"../../common/image.js\";\r\n\r\n\tconst content = ref('')\r\n\r\n\tconst isAnonymous = ref(0)\r\n\tconst uploadList = ref([]);\r\n\r\n\t// 新增分类相关数据\r\n\tconst categories = ref([]) // 存储分类数据\r\n\tconst selectedCategory = ref('') // 选中的分类ID\r\n\r\n\tconst selectedIndex = ref(-1)\r\n\tconst selectedCategoryLabel = ref('')\r\n\r\n\r\n\tfunction viewFullImage(index) {\r\n\t\tuni.previewImage({\r\n\t\t\tcurrent: uploadList.value[index],\r\n\t\t\turls: uploadList.value\r\n\t\t});\r\n\t}\r\n\r\n\r\n\tfunction handleAnonymous(e) {\r\n\t\tisAnonymous.value = e.detail.value.length > 0 ? 1 : 0\r\n\t}\r\n\t// 设置标题\r\n\tuni.setNavigationBarTitle({\r\n\t\ttitle: '投稿树洞'\r\n\t})\r\n\r\n\r\n\r\n\t//选择图片\r\n\tfunction selectImage() {\r\n\t\tconsole.log(\"openSelect\")\r\n\t\tchooseImage().then((res) => {\r\n\t\t\tgetQiniuToken().then((tokenData) => {\r\n\t\t\t\tconsole.log(tokenData)\r\n\r\n\t\t\t\tuploadImageToQiniu(res, tokenData.token, tokenData.path).then((uploadRes) => {\r\n\t\t\t\t\tif (uploadRes.statusCode != 200) {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: '上传失败',\r\n\t\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconsole.log(image1Url + tokenData.path)\r\n\t\t\t\t\t//image1Url + tokenData.path;\r\n\t\t\t\t\tuploadList.value.push(image1Url + tokenData.path);\r\n\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '上传成功',\r\n\t\t\t\t\t\ticon: 'success'\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t}) //uploadImageToQiniu\r\n\t\t\t}) //getQiniuToken\r\n\t\t}) //chooseImage\r\n\t}\r\n\r\n\r\n\t// 获取分类列表\r\n\tconst fetchCategories = async () => {\r\n\t\ttry {\r\n\t\t\tconst res = await uni.request({\r\n\t\t\t\turl: websiteUrl + '/treehole-typelist',\r\n\t\t\t\tmethod: 'GET'\r\n\t\t\t})\r\n\t\t\tif (res.data.status === \"success\") {\r\n\t\t\t\t// 转换数据结构为 {value, label} 格式\r\n\t\t\t\tcategories.value = Object.entries(res.data.data).map(([value, label]) => ({\r\n\t\t\t\t\tvalue: Number(value),\r\n\t\t\t\t\tlabel\r\n\t\t\t\t}))\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error('获取分类失败:', err)\r\n\t\t}\r\n\t}\r\n\r\n\t// 处理选择事件\r\n\tfunction handleCategoryChange(e) {\r\n\t\tconst index = e.detail.value\r\n\t\tif (index >= 0 && categories.value[index]) {\r\n\t\t\tselectedIndex.value = index\r\n\t\t\tselectedCategory.value = categories.value[index].value\r\n\t\t\tselectedCategoryLabel.value = categories.value[index].label\r\n\t\t}\r\n\t}\r\n\r\n\t// 修改提交校验逻辑\r\n\tconst canSubmit = computed(() => {\r\n\t\treturn content.value.trim().length > 0 && selectedCategory.value !== null\r\n\t})\r\n\tasync function handleSubmit() {\r\n\t\tif (!canSubmit.value) return\r\n\r\n\r\n\t\tif (!selectedCategory.value) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '请选择分类',\r\n\t\t\t\ticon: 'none'\r\n\t\t\t})\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\r\n\t\ttry {\r\n\t\t\tuni.showLoading({\r\n\t\t\t\ttitle: '提交中...'\r\n\t\t\t})\r\n\r\n\t\t\t// 检查登录状态\r\n\t\t\tconst token = uni.getStorageSync('token')\r\n\t\t\tif (!token) {\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: '请先登录',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t})\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\t// 构造提交数据\r\n\t\t\tconst postData = {\r\n\t\t\t\tcontent: content.value.trim(),\r\n\t\t\t\timages: uploadList.value,\r\n\t\t\t\tis_anonymous: isAnonymous.value,\r\n\t\t\t\tcategory_id: selectedCategory.value,\r\n\t\t\t}\r\n\r\n\t\t\tconst res = await uni.request({\r\n\t\t\t\turl: websiteUrl + '/with-state/add-submission',\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\tdata: postData,\r\n\t\t\t\theader: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t'Authorization': token,\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t\tuni.hideLoading()\r\n\r\n\t\t\tif (res.data.status == \"success\") {\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: '已收到您的投稿',\r\n\t\t\t\t\ticon: 'success'\r\n\t\t\t\t})\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t// 提交成功后清空数据\r\n\t\t\t\t\tcontent.value = ''\r\n\t\t\t\t\tuploadList.value = []\r\n\t\t\t\t\tisAnonymous.value = 0\r\n\t\t\t\t\tuni.navigateBack()\r\n\t\t\t\t}, 1500)\r\n\t\t\t} else {\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: res.data.msg || '提交失败',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tuni.hideLoading()\r\n\t\t\tconsole.error('提交失败:', err)\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: '网络请求失败',\r\n\t\t\t\ticon: 'none'\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tonMounted(() => {\r\n\t\tfetchCategories()\r\n\t})\r\n</script>\r\n\r\n<style lang=\"less\" scoped>\r\n\t.publish-box {\r\n\t\tpadding: 30rpx;\r\n\t}\r\n\r\n\t.textarea {\r\n\t\twidth: 650rpx;\r\n\t\theight: 300rpx;\r\n\t\tpadding: 20rpx;\r\n\t\tbackground: #f8f8f8;\r\n\t\tborder-radius: 12rpx;\r\n\t\tmargin-bottom: 30rpx;\r\n\t}\r\n\r\n\t.anonymous {\r\n\t\tmargin: 30rpx 0;\r\n\r\n\t\ttext {\r\n\t\t\tcolor: #666;\r\n\t\t\tfont-size: 28rpx;\r\n\t\t\tmargin-left: 10rpx;\r\n\t\t}\r\n\t}\r\n\r\n\t.submit-btn {\r\n\t\tbackground: #4cbbd0;\r\n\t\tcolor: #fff;\r\n\t\tborder-radius: 50rpx;\r\n\r\n\t\t&.disabled {\r\n\t\t\tbackground: #ccc;\r\n\t\t\tcolor: #999;\r\n\t\t}\r\n\t}\r\n\r\n\t.uploaded_image {\r\n\t\twidth: 100px;\r\n\t\theight: 100px;\r\n\t\tmargin-right: 10px;\r\n\r\n\t}\r\n\r\n\t.upload_box {\r\n\t\t// 核心修改点：\r\n\t\twidth: 100%; // 避免使用 100vw（可能因滚动条导致宽度溢出）\r\n\t\twhite-space: nowrap; // 强制子元素不换行\r\n\t\toverflow-x: auto; // 确保横向滚动生效（UniApp的scroll-view组件已封装滚动逻辑，此处为保险可保留）\r\n\t\tdisplay: block; // 明确容器为块级元素\r\n\t\tmargin-bottom: 35rpx;\r\n\r\n\r\n\t\tview {\r\n\t\t\tdisplay: inline-block; // 关键！强制子元素横向排列（替代 float）\r\n\t\t\tvertical-align: top; // 对齐方式（避免图片底部留白）\r\n\t\t}\r\n\r\n\t\t.upload_item {\r\n\t\t\tposition: relative;\r\n\t\t\twidth: 100px;\r\n\t\t\tmargin-right: 10px;\r\n\r\n\t\t\tborder-radius: 5px;\r\n\t\t\toverflow: hidden;\r\n\r\n\t\t\t.uploaded_image {\r\n\t\t\t\twidth: 100px;\r\n\t\t\t\theight: 100px;\r\n\t\t\t}\r\n\r\n\t\t\t.close_icon {\r\n\t\t\t\tposition: absolute;\r\n\t\t\t\tright: 0;\r\n\t\t\t\ttop: 0;\r\n\t\t\t\twidth: 20px;\r\n\t\t\t\theight: 20px;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t.publish-detail {\r\n\t\ttext {\r\n\t\t\tdisplay: block;\r\n\t\t\tcolor: #888;\r\n\t\t\tmargin: 20rpx 20rpx;\r\n\t\t}\r\n\t}\r\n\r\n\t// 分类选择\r\n\t.category-picker {\r\n\t\tdisplay: block;\r\n\t\theight: 70rpx;\r\n\t\tline-height: 70rpx;\r\n\t\tpadding: 0 30rpx;\r\n\t\tmargin: 30rpx 0;\r\n\t\tbackground: #f8f8f8;\r\n\t\tborder-radius: 12rpx;\r\n\t\tborder: 1px solid #e0e0e0;\r\n\r\n\t\t.picker-content {\r\n\t\t\tdisplay: flex;\r\n\t\t\talign-items: center;\r\n\t\t\tjustify-content: space-between;\r\n\t\t}\r\n\r\n\t\t.picker-text {\r\n\t\t\tcolor: #333;\r\n\t\t\tfont-size: 24rpx;\r\n\r\n\t\t\t&.placeholder {\r\n\t\t\t\tcolor: #999;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t&:active {\r\n\t\t\tbackground: #f0f0f0;\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t// 优化提交按钮间距\r\n\t.submit-btn {\r\n\t\tmargin-top: 50rpx;\r\n\t}\r\n\r\n\r\n\t/deep/ .uni-picker-action-confirm {\r\n\t\tcolor: #4cbbd0!important;\r\n\r\n\t}\r\n</style>","import MiniProgramPage from '/Users/sapphirell/Documents/git/dogdogdoll-uniapp/pages/treehole_publish/treehole_publish.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","chooseImage","getQiniuToken","uploadImageToQiniu","image1Url","websiteUrl","computed","onMounted"],"mappings":"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"}