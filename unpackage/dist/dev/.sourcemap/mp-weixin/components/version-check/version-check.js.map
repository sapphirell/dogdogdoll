{"version":3,"file":"version-check.js","sources":["components/version-check/version-check.vue","/Users/sapphirell/Documents/git/dogdogdoll-uniapp/components/version-check/version-check.vue?type=component"],"sourcesContent":["<template>\r\n\t<!-- 版本检查组件 -->\r\n\t<view>\r\n\t\t<!-- 新版本提示弹窗 -->\r\n\t\t<common-modal :visible=\"modalVisible\" @update:visible=\"modalVisible = $event\" top=\"15vh\">\r\n\t\t\t<view class=\"version-update-container\">\r\n\t\t\t\t<view class=\"update-title\">发现新版本 v{{newVersionInfo?.version}} 当前 v{{}}</view>\r\n\r\n\t\t\t\t<scroll-view class=\"update-content\" scroll-y>\r\n\t\t\t\t\t<view class=\"update-section\">\r\n\t\t\t\t\t\t<view class=\"section-title\">更新内容</view>\r\n\t\t\t\t\t\t<view class=\"section-content\">{{newVersionInfo?.note || '优化用户体验，修复已知问题'}}</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"update-section\">\r\n\t\t\t\t\t\t<view class=\"section-title\">更新日期</view>\r\n\t\t\t\t\t\t<view class=\"section-content\">{{formatTime(newVersionInfo?.created_at)}}</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</scroll-view>\r\n\r\n\t\t\t\t<view class=\"update-buttons\">\r\n\t\t\t\t\t<button class=\"update-btn ignore\" @tap=\"ignoreUpdate\">暂不更新</button>\r\n\t\t\t\t\t<button class=\"update-btn confirm\" @tap=\"handleUpdate\">立即更新</button>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</common-modal>\r\n\r\n\t\t<!-- 已是最新版本提示 -->\r\n\t\t<view v-if=\"showUpToDateToast\" class=\"toast-message\">\r\n\t\t\t<text>已是最新版本</text>\r\n\t\t</view>\r\n\t</view>\r\n</template>\r\n\r\n<script setup>\r\n\timport {\r\n\t\tref,\r\n\t\tonMounted,\r\n\t\tcomputed\r\n\t} from 'vue';\r\n\timport {\r\n\t\twebsiteUrl,\r\n\t\tgetScene,\n\t\tdogdogdollVersion,\r\n\t} from '../../common/config.js';\r\n\r\n\t// 组件属性\r\n\tconst props = defineProps({\r\n\t\t// 是否显示已是最新版本的提示\r\n\t\tshowUpToDateToast: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false\r\n\t\t},\r\n\t\t// 当前版本号\r\n\t\tcurrentVersion: {\r\n\t\t\ttype: String,\r\n\t\t\trequired: false\r\n\t\t},\r\n\t\t// 是否自动检查版本\r\n\t\tautoCheck: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: true\r\n\t\t}\r\n\t});\r\n\r\n\t// 弹窗可见性\r\n\tconst modalVisible = ref(false);\r\n\t// 新版本信息\r\n\tconst newVersionInfo = ref(null);\r\n\t// 显示已是最新提示\r\n\tconst showUpToDateToast = ref(false);\r\n\tconst cv = ref(\"1.0.0\")\r\n\t// 获取平台信息\r\n\tconst platform = computed(() => {\r\n\t\tconst systemInfo = uni.getSystemInfoSync();\r\n\t\treturn systemInfo.platform || 'unknown';\r\n\t});\r\n\r\n\t// 格式化时间\r\n\tconst formatTime = (timestamp) => {\r\n\t\tif (!timestamp) return '未知日期';\r\n\t\tconst date = new Date(timestamp * 1000);\r\n\t\treturn `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;\r\n\t}\r\n\r\n\t// 检查是否在忽略期内\r\n\tconst isIgnored = () => {\r\n\t\tconst ignoreTime = uni.getStorageSync('ignoreUpdateTime');\n\t\tconsole.log(\"忽略时间：\", ignoreTime)\r\n\t\tif (!ignoreTime) return false;\r\n\r\n\t\t// 检查是否在3天（259200000毫秒）内\r\n\t\tconst now = Date.now();\n\t\tconsole.log(\"当前时间\", now)\r\n\t\treturn (now - ignoreTime) < 259200000;\r\n\t}\r\n\r\n\t// 检查版本更新\r\n\tconst checkVersion = async () => {\r\n\t\ttry {\r\n\t\t\t// 平台检查：H5或小程序不弹出\r\n\t\t\tlet scene = getScene()\r\n\t\t\tif (scene === 1 || scene === 4) {\r\n\t\t\t\tconsole.log(\"scene:\", scene)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\t\t\t// 检查是否在忽略期内\r\n\t\t\tif (isIgnored()) {\r\n\t\t\t\tconsole.log('在忽略期内，不显示更新提示 ');\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst cv = uni.getAppBaseInfo().appVersion;\r\n\t\t\tconst res = await uni.request({\r\n\t\t\t\turl: `${websiteUrl}/latest-version?version=${dogdogdollVersion}`,\r\n\t\t\t\tmethod: 'GET'\r\n\t\t\t});\r\n\r\n\t\t\tif (res && res.data) {\r\n\t\t\t\tif (res.data.status === 'success' && res.data.data) {\r\n\t\t\t\t\t// 有新版本\r\n\t\t\t\t\tnewVersionInfo.value = res.data.data;\r\n\t\t\t\t\tmodalVisible.value = true;\r\n\t\t\t\t} else if (res.data.status === 'failed' && props.showUpToDateToast) {\r\n\t\t\t\t\t// 已是最新版本\r\n\t\t\t\t\tshowUpToDateToast.value = true;\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tshowUpToDateToast.value = false;\r\n\t\t\t\t\t}, 2000);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error('版本检查失败:', err);\r\n\t\t}\r\n\t};\r\n\r\n\t// 处理更新操作\r\n\tconst handleUpdate = () => {\r\n\t\t// 记录用户选择了更新（3天内不再提示）\r\n\t\tuni.setStorageSync('ignoreUpdateTime', Date.now());\r\n\r\n\t\tmodalVisible.value = false;\r\n\r\n\t\t// 平台特定的更新处理\r\n\t\tconst platformValue = platform.value.toLowerCase();\r\n\t\tconsole.log(platformValue)\r\n\r\n\t\tlet scene = getScene()\r\n\r\n\t\tif (scene === 2) {\r\n\t\t\t// iOS 跳转 App Store\r\n\t\t\tplus.runtime.openURL('https://apps.apple.com/app/id6747564362');\r\n\t\t} else if (scene === 3) {\r\n\t\t\tplus.runtime.openURL('https://apps.apple.com/app/id6747564362');\r\n\t\t} else {\r\n\t\t\t// 其他平台提示\r\n\t\t\tuni.showModal({\r\n\t\t\t\ttitle: '更新提示',\r\n\t\t\t\tcontent: '请前往应用商店更新最新版本',\r\n\t\t\t\tshowCancel: false\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\t// 忽略更新\r\n\tconst ignoreUpdate = () => {\r\n\t\t// 记录忽略时间（3天内不再提示）\r\n\t\tuni.setStorageSync('ignoreUpdateTime', Date.now());\r\n\t\tmodalVisible.value = false;\r\n\t};\r\n\r\n\t// 暴露检查方法给父组件\r\n\tdefineExpose({\r\n\t\tcheckVersion\r\n\t});\r\n\r\n\t// 自动检查版本\r\n\tonMounted(() => {\r\n\t\tcv.value = uni.getAppBaseInfo().appVersion;\r\n\t\tif (props.autoCheck) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tcheckVersion();\r\n\t\t\t}, 1500);\r\n\t\t}\r\n\t});\r\n</script>\r\n\r\n<style lang=\"less\">\r\n\t.version-update-container {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\talign-items: center;\r\n\t\tpadding: 30rpx;\r\n\t\twidth: 600rpx;\r\n\t\tbox-sizing: border-box;\r\n\r\n\t\t.update-icon {\r\n\t\t\twidth: 160rpx;\r\n\t\t\theight: 160rpx;\r\n\t\t\tmargin-bottom: 20rpx;\r\n\t\t}\r\n\r\n\t\t.update-title {\r\n\t\t\tfont-size: 32rpx;\r\n\t\t\tfont-weight: bold;\r\n\t\t\tcolor: #333;\r\n\t\t\tmargin-bottom: 30rpx;\r\n\t\t\ttext-align: center;\r\n\t\t}\r\n\r\n\t\t.update-content {\r\n\t\t\twidth: 100%;\r\n\t\t\tmax-height: 300rpx;\r\n\t\t\tmargin-bottom: 40rpx;\r\n\t\t\tborder-radius: 12rpx;\r\n\t\t\tbackground-color: #f8f9fa;\r\n\t\t\tpadding: 20rpx;\r\n\t\t\tbox-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\r\n\r\n\t\t\t.update-section {\r\n\t\t\t\tmargin-bottom: 40rpx;\r\n\r\n\t\t\t\t.section-title {\r\n\t\t\t\t\tfont-size: 26rpx;\r\n\t\t\t\t\tfont-weight: bold;\r\n\t\t\t\t\tcolor: #4a90e2;\r\n\t\t\t\t\tmargin-bottom: 10rpx;\r\n\t\t\t\t\tposition: relative;\r\n\t\t\t\t\tpadding-left: 20rpx;\r\n\r\n\t\t\t\t\t&::before {\r\n\t\t\t\t\t\tcontent: '';\r\n\t\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\t\tleft: 0;\r\n\t\t\t\t\t\ttop: 50%;\r\n\t\t\t\t\t\ttransform: translateY(-50%);\r\n\t\t\t\t\t\twidth: 8rpx;\r\n\t\t\t\t\t\theight: 26rpx;\r\n\t\t\t\t\t\tbackground: linear-gradient(to bottom, #4facfe, #00f2fe);\r\n\t\t\t\t\t\tborder-radius: 4rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.section-content {\r\n\t\t\t\t\tfont-size: 24rpx;\r\n\t\t\t\t\tcolor: #666;\r\n\t\t\t\t\tline-height: 1.6;\r\n\t\t\t\t\tpadding-left: 20rpx;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t.update-buttons {\r\n\t\t\tdisplay: flex;\r\n\t\t\tjustify-content: space-between;\r\n\t\t\twidth: 100%;\r\n\t\t\tgap: 20rpx;\r\n\r\n\t\t\t.update-btn {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\theight: 60rpx;\r\n\t\t\t\tborder-radius: 40rpx;\r\n\t\t\t\tfont-size: 24rpx;\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tjustify-content: center;\r\n\t\t\t\ttransition: all 0.3s;\r\n\t\t\t\tposition: relative;\r\n\t\t\t\toverflow: hidden;\r\n\r\n\t\t\t\t&::after {\r\n\t\t\t\t\tborder: none;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t&.ignore {\r\n\t\t\t\t\tbackground-color: #f5f5f5;\r\n\t\t\t\t\tcolor: #666;\r\n\t\t\t\t\tborder: 1rpx solid #e5e5e5;\r\n\r\n\t\t\t\t\t&:active {\r\n\t\t\t\t\t\tbackground-color: #e5e5e5;\r\n\t\t\t\t\t\ttransform: translateY(2rpx);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t&.confirm {\r\n\t\t\t\t\tbackground: linear-gradient(135deg, #a6e9f7, #1ed1e1);\r\n\t\t\t\t\tcolor: white;\r\n\t\t\t\t\tbox-shadow: 0 4rpx 12rpx rgba(30, 209, 225, 0.4);\r\n\r\n\t\t\t\t\t&:active {\r\n\t\t\t\t\t\topacity: 0.9;\r\n\t\t\t\t\t\ttransform: translateY(2rpx);\r\n\t\t\t\t\t\tbox-shadow: 0 2rpx 6rpx rgba(30, 209, 225, 0.4);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// &::before {\r\n\t\t\t\t\t//   content: '';\r\n\t\t\t\t\t//   position: absolute;\r\n\t\t\t\t\t//   top: -50%;\r\n\t\t\t\t\t//   left: -50%;\r\n\t\t\t\t\t//   width: 200%;\r\n\t\t\t\t\t//   height: 200%;\r\n\t\t\t\t\t//   background: linear-gradient(\r\n\t\t\t\t\t//     to right,\r\n\t\t\t\t\t//     rgba(255, 255, 255, 0) 0%,\r\n\t\t\t\t\t//     rgba(255, 255, 255, 0.8) 50%,\r\n\t\t\t\t\t//     rgba(255, 255, 255, 0) 100%\r\n\t\t\t\t\t//   );\r\n\t\t\t\t\t//   transform: rotate(30deg);\r\n\t\t\t\t\t//   animation: shine 2s infinite;\r\n\t\t\t\t\t// }\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t.toast-message {\r\n\t\tposition: fixed;\r\n\t\tbottom: 150rpx;\r\n\t\tleft: 50%;\r\n\t\ttransform: translateX(-50%);\r\n\t\tbackground-color: rgba(0, 0, 0, 0.7);\r\n\t\tcolor: white;\r\n\t\tpadding: 20rpx 40rpx;\r\n\t\tborder-radius: 50rpx;\r\n\t\tfont-size: 26rpx;\r\n\t\tz-index: 9999;\r\n\t\tanimation: fadeInOut 2s forwards;\r\n\t}\r\n\r\n\t@keyframes fadeInOut {\r\n\t\t0% {\r\n\t\t\topacity: 0;\r\n\t\t}\r\n\r\n\t\t20% {\r\n\t\t\topacity: 1;\r\n\t\t}\r\n\r\n\t\t80% {\r\n\t\t\topacity: 1;\r\n\t\t}\r\n\r\n\t\t100% {\r\n\t\t\topacity: 0;\r\n\t\t}\r\n\t}\r\n\r\n\t@keyframes shine {\r\n\t\t0% {\r\n\t\t\ttransform: translateX(-100%) rotate(30deg);\r\n\t\t}\r\n\r\n\t\t100% {\r\n\t\t\ttransform: translateX(100%) rotate(30deg);\r\n\t\t}\r\n\t}\r\n</style>","import Component from '/Users/sapphirell/Documents/git/dogdogdoll-uniapp/components/version-check/version-check.vue'\nwx.createComponent(Component)"],"names":["ref","computed","uni","getScene","cv","websiteUrl","dogdogdollVersion","onMounted","Component"],"mappings":"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"}