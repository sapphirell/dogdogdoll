{"version":3,"file":"chat-record-mode.js","sources":["uni_modules/z-paging/components/z-paging/js/modules/chat-record-mode.js"],"sourcesContent":["// [z-paging]聊天记录模式模块\nimport u from '.././z-paging-utils'\n\nexport default {\n\tprops: {\n\t\t// 使用聊天记录模式，默认为否\n\t\tuseChatRecordMode: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: u.gc('useChatRecordMode', false)\n\t\t},\n\t\t// 使用聊天记录模式时滚动到顶部后，列表垂直移动偏移距离。默认0rpx。单位px（暂时无效）\n\t\tchatRecordMoreOffset: {\n\t\t\ttype: [Number, String],\n\t\t\tdefault: u.gc('chatRecordMoreOffset', '0rpx')\n\t\t},\n\t\t// 使用聊天记录模式时是否自动隐藏键盘：在用户触摸列表时候自动隐藏键盘，默认为是\n\t\tautoHideKeyboardWhenChat: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: u.gc('autoHideKeyboardWhenChat', true)\n\t\t},\n\t\t// 使用聊天记录模式中键盘弹出时是否自动调整slot=\"bottom\"高度，默认为是\n\t\tautoAdjustPositionWhenChat: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: u.gc('autoAdjustPositionWhenChat', true)\n\t\t},\n\t\t// 使用聊天记录模式中键盘弹出时占位高度偏移距离。默认0rpx。单位px\n\t\tchatAdjustPositionOffset: {\n\t\t\ttype: [Number, String],\n\t\t\tdefault: u.gc('chatAdjustPositionOffset', '0rpx')\n\t\t},\n\t\t// 使用聊天记录模式中键盘弹出时是否自动滚动到底部，默认为否\n\t\tautoToBottomWhenChat: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: u.gc('autoToBottomWhenChat', false)\n\t\t},\n\t\t// 使用聊天记录模式中reload时是否显示chatLoading，默认为否\n\t\tshowChatLoadingWhenReload: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: u.gc('showChatLoadingWhenReload', false)\n\t\t},\n\t\t// 在聊天记录模式中滑动到顶部状态为默认状态时，以加载中的状态展示，默认为是。若设置为否，则默认会显示【点击加载更多】，然后才会显示loading\n\t\tchatLoadingMoreDefaultAsLoading: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: u.gc('chatLoadingMoreDefaultAsLoading', true)\n\t\t},\n\t},\n\tdata() {\n\t\treturn {\n\t\t\t// 键盘高度\n\t\t\tkeyboardHeight: 0,\n\t\t\t// 键盘高度是否未改变，此时占位高度变化不需要动画效果\n\t\t\tisKeyboardHeightChanged: false,\n\t\t}\n\t},\n\tcomputed: {\n\t\tfinalChatRecordMoreOffset() {\n\t\t\treturn u.convertToPx(this.chatRecordMoreOffset);\n\t\t},\n\t\tfinalChatAdjustPositionOffset() {\n\t\t\treturn u.convertToPx(this.chatAdjustPositionOffset);\n\t\t},\n\t\t// 聊天记录模式旋转180度style\n\t\tchatRecordRotateStyle() {\n\t\t\tlet cellStyle;\n\t\t\t// 在vue中，直接将列表倒置，因此在vue的cell中，也直接写style=\"transform: scaleY(-1)\"转回来即可。\n\t\t\t// #ifndef APP-NVUE\n\t\t\tcellStyle = this.useChatRecordMode ? { transform: 'scaleY(-1)' } : {};\n\t\t\t// #endif\n\t\t\t\n\t\t\t// 在nvue中，需要考虑数据量不满一页的情况，因为nvue中的list无法通过flex-end修改不满一页的起始位置，会导致不满一页时列表数据从底部开始，因此需要特别判断\n\t\t\t// 当数据不满一屏的时候，不进行列表倒置\n\t\t\t// #ifdef APP-NVUE\n\t\t\tcellStyle = this.useChatRecordMode ? { transform: this.isFirstPageAndNoMore ? 'scaleY(1)' : 'scaleY(-1)' } : {};\n\t\t\t// #endif\n\t\t\t\n\t\t\tthis.$emit('update:cellStyle', cellStyle);\n\t\t\tthis.$emit('cellStyleChange', cellStyle);\n\t\t\t\n\t\t\t// 在聊天记录模式中，如果列表没有倒置并且当前是第一页，则需要自动滚动到最底部\n\t\t\tthis.$nextTick(() => {\n\t\t\t\tif (this.isFirstPage && this.isChatRecordModeAndNotInversion) {\n\t\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\t\t// 这里多次触发滚动到底部是为了避免在某些情况下，即使是在nextTick但是cell未渲染完毕导致滚动到底部位置不正确的问题\n\t\t\t\t\t\tthis._scrollToBottom(false);\n\t\t\t\t\t\tu.delay(() => {\n\t\t\t\t\t\t\tthis._scrollToBottom(false);\n\t\t\t\t\t\t\tu.delay(() => {\n\t\t\t\t\t\t\t\tthis._scrollToBottom(false);\n\t\t\t\t\t\t\t}, 50)\n\t\t\t\t\t\t}, 50)\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t\treturn cellStyle;\n\t\t},\n\t\t// 是否是聊天记录列表并且有配置transform\n\t\tisChatRecordModeHasTransform() {\n\t\t\treturn this.useChatRecordMode && this.chatRecordRotateStyle && this.chatRecordRotateStyle.transform;\n\t\t},\n\t\t// 是否是聊天记录列表并且列表未倒置\n\t\tisChatRecordModeAndNotInversion() {\n\t\t\treturn this.isChatRecordModeHasTransform && this.chatRecordRotateStyle.transform === 'scaleY(1)';\n\t\t},\n\t\t// 是否是聊天记录列表并且列表倒置\n\t\tisChatRecordModeAndInversion() {\n\t\t\treturn this.isChatRecordModeHasTransform && this.chatRecordRotateStyle.transform === 'scaleY(-1)';\n\t\t},\n\t\t// 最终的聊天记录模式中底部安全区域的高度，如果开启了底部安全区域并且键盘未弹出，则添加底部区域高度\n\t\tchatRecordModeSafeAreaBottom() {\n\t\t\treturn this.safeAreaInsetBottom && !this.keyboardHeight ? this.safeAreaBottom : 0;\n\t\t}\n\t},\n\tmounted() {\n\t\t// 监听键盘高度变化（H5、百度小程序、抖音小程序、飞书小程序不支持）\n\t\t// #ifndef H5 || MP-BAIDU || MP-TOUTIAO\n\t\tif (this.useChatRecordMode) {\n\t\t\tuni.onKeyboardHeightChange(this._handleKeyboardHeightChange);\n\t\t}\n\t\t// #endif\n\t},\n\tmethods: {\n\t\t// 添加聊天记录\n\t\taddChatRecordData(data, toBottom = true, toBottomWithAnimate = true) {\n\t\t\tif (!this.useChatRecordMode) return;\n\t\t\tthis.isTotalChangeFromAddData = true;\n\t\t\tthis.addDataFromTop(data, toBottom, toBottomWithAnimate);\n\t\t},\n\t\t// 手动触发滚动到顶部加载更多，聊天记录模式时有效\n\t\tdoChatRecordLoadMore() {\n\t\t\tthis.useChatRecordMode && this._onLoadingMore('click');\n\t\t},\n\t\t// 处理键盘高度变化\n\t\t_handleKeyboardHeightChange(res) {\n\t\t\tthis.$emit('keyboardHeightChange', res);\n\t\t\tif (this.autoAdjustPositionWhenChat) {\n\t\t\t\tthis.isKeyboardHeightChanged = true;\n\t\t\t\tthis.keyboardHeight = res.height > 0 ? res.height + this.finalChatAdjustPositionOffset : res.height;\n\t\t\t}\n\t\t\tif (this.autoToBottomWhenChat && this.keyboardHeight > 0) {\n\t\t\t\tu.delay(() => {\n\t\t\t\t\tthis.scrollToBottom(false);\n\t\t\t\t\tu.delay(() => {\n\t\t\t\t\t\tthis.scrollToBottom(false);\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t} \n\t\t}\n\t}\n}\n"],"names":["u","uni"],"mappings":"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"}